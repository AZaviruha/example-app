webpackJsonp([2],{25:function(e,t,r){t.render=function(){return r(27)()},t.start=function(){function e(){o=new n.OrthographicCamera(-400,400,400,-400,-2e3,1e3),o.position.x=200,o.position.y=100,o.position.z=200,a=new n.Scene,a.add(o);var e=new n.Geometry;e.vertices.push(new n.Vertex(new n.Vector3(-500,0,0))),e.vertices.push(new n.Vertex(new n.Vector3(500,0,0)));for(var t=0;20>=t;t++){var r=new n.Line(e,new n.LineBasicMaterial({color:0,opacity:.2}));r.position.z=50*t-500,a.add(r),r=new n.Line(e,new n.LineBasicMaterial({color:0,opacity:.2})),r.position.x=50*t-500,r.rotation.y=90*Math.PI/180,a.add(r)}e=new n.CubeGeometry(50,50,50);var i=new n.MeshLambertMaterial({color:16777215,shading:n.FlatShading,overdraw:!0});for(t=0;100>t;t++){var l=new n.Mesh(e,i);l.scale.y=Math.floor(2*Math.random()+1),l.position.x=50*Math.floor((1e3*Math.random()-500)/50)+25,l.position.y=50*l.scale.y/2,l.position.z=50*Math.floor((1e3*Math.random()-500)/50)+25,a.add(l)}var c=new n.AmbientLight(16*Math.random());a.add(c);var h=new n.DirectionalLight(16777215*Math.random());h.position.x=Math.random()-.5,h.position.y=Math.random()-.5,h.position.z=Math.random()-.5,h.position.normalize(),a.add(h),h=new n.DirectionalLight(16777215*Math.random()),h.position.x=Math.random()-.5,h.position.y=Math.random()-.5,h.position.z=Math.random()-.5,h.position.normalize(),a.add(h),s=new n.CanvasRenderer,s.setSize(400,400),$(".three-container").append(s.domElement)}function t(){$(".three-container").length>0&&(requestAnimationFrame(t),i())}function i(){var e=1e-4*(new Date).getTime();o.position.x=200*Math.cos(e),o.position.z=200*Math.sin(e),o.lookAt(a.position),s.render(a,o)}var n=r(35);r(7);var o,a,s;e(),t()}},26:function(e){"use strict";var t=t||{REVISION:"48"};self.Int32Array||(self.Int32Array=Array,self.Float32Array=Array),function(){for(var e=0,t=["ms","moz","webkit","o"],r=0;r<t.length&&!window.requestAnimationFrame;++r)window.requestAnimationFrame=window[t[r]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[r]+"CancelAnimationFrame"]||window[t[r]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var r=(new Date).getTime(),i=Math.max(0,16-(r-e)),n=window.setTimeout(function(){t(r+i)},i);return e=r+i,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),t.Clock=function(e){this.autoStart=void 0!==e?e:!0,this.elapsedTime=this.oldTime=this.startTime=0,this.running=!1},t.Clock.prototype.start=function(){this.oldTime=this.startTime=Date.now(),this.running=!0},t.Clock.prototype.stop=function(){this.getElapsedTime(),this.running=!1},t.Clock.prototype.getElapsedTime=function(){return this.elapsedTime+=this.getDelta()},t.Clock.prototype.getDelta=function(){var e=0;if(this.autoStart&&!this.running&&this.start(),this.running){var t=Date.now(),e=.001*(t-this.oldTime);this.oldTime=t,this.elapsedTime+=e}return e},t.Color=function(e){return void 0!==e&&this.setHex(e),this},t.Color.prototype={constructor:t.Color,r:1,g:1,b:1,copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e){return this.r=e.r*e.r,this.g=e.g*e.g,this.b=e.b*e.b,this},copyLinearToGamma:function(e){return this.r=Math.sqrt(e.r),this.g=Math.sqrt(e.g),this.b=Math.sqrt(e.b),this},convertGammaToLinear:function(){var e=this.r,t=this.g,r=this.b;return this.r=e*e,this.g=t*t,this.b=r*r,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},setRGB:function(e,t,r){return this.r=e,this.g=t,this.b=r,this},setHSV:function(e,t,r){var i,n,o;if(0===r)this.r=this.g=this.b=0;else switch(i=Math.floor(6*e),n=6*e-i,e=r*(1-t),o=r*(1-t*n),t=r*(1-t*(1-n)),i){case 1:this.r=o,this.g=r,this.b=e;break;case 2:this.r=e,this.g=r,this.b=t;break;case 3:this.r=e,this.g=o,this.b=r;break;case 4:this.r=t,this.g=e,this.b=r;break;case 5:this.r=r,this.g=e,this.b=o;break;case 6:case 0:this.r=r,this.g=t,this.b=e}return this},setHex:function(e){return e=Math.floor(e),this.r=(255&e>>16)/255,this.g=(255&e>>8)/255,this.b=(255&e)/255,this},getHex:function(){return Math.floor(255*this.r)<<16^Math.floor(255*this.g)<<8^Math.floor(255*this.b)},getContextStyle:function(){return"rgb("+Math.floor(255*this.r)+","+Math.floor(255*this.g)+","+Math.floor(255*this.b)+")"},clone:function(){return(new t.Color).setRGB(this.r,this.g,this.b)}},t.Vector2=function(e,t){this.x=e||0,this.y=t||0},t.Vector2.prototype={constructor:t.Vector2,set:function(e,t){return this.x=e,this.y=t,this},copy:function(e){return this.x=e.x,this.y=e.y,this},clone:function(){return new t.Vector2(this.x,this.y)},add:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addSelf:function(e){return this.x+=e.x,this.y+=e.y,this},sub:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},subSelf:function(e){return this.x-=e.x,this.y-=e.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},divideScalar:function(e){return e?(this.x/=e,this.y/=e):this.set(0,0),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,e=this.y-e.y;return t*t+e*e},setLength:function(e){return this.normalize().multiplyScalar(e)},lerpSelf:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},equals:function(e){return e.x===this.x&&e.y===this.y},isZero:function(){return 1e-4>this.lengthSq()}},t.Vector3=function(e,t,r){this.x=e||0,this.y=t||0,this.z=r||0},t.Vector3.prototype={constructor:t.Vector3,set:function(e,t,r){return this.x=e,this.y=t,this.z=r,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},clone:function(){return new t.Vector3(this.x,this.y,this.z)},add:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},addSelf:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},sub:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},subSelf:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},multiply:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},multiplySelf:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},divideSelf:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return e?(this.x/=e,this.y/=e,this.z/=e):this.z=this.y=this.x=0,this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.lengthSq())},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){return this.normalize().multiplyScalar(e)},lerpSelf:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},cross:function(e,t){return this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this},crossSelf:function(e){var t=this.x,r=this.y,i=this.z;return this.x=r*e.z-i*e.y,this.y=i*e.x-t*e.z,this.z=t*e.y-r*e.x,this},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){return(new t.Vector3).sub(this,e).lengthSq()},getPositionFromMatrix:function(e){return this.x=e.n14,this.y=e.n24,this.z=e.n34,this},getRotationFromMatrix:function(e,t){var r=t?t.x:1,i=t?t.y:1,n=t?t.z:1,o=e.n11/r,a=e.n12/i,r=e.n21/r,i=e.n22/i,s=e.n23/n,l=e.n33/n;return this.y=Math.asin(e.n13/n),n=Math.cos(this.y),1e-5<Math.abs(n)?(this.x=Math.atan2(-s/n,l/n),this.z=Math.atan2(-a/n,o/n)):(this.x=0,this.z=Math.atan2(r,i)),this},getScaleFromMatrix:function(e){var t=this.set(e.n11,e.n21,e.n31).length(),r=this.set(e.n12,e.n22,e.n32).length(),e=this.set(e.n13,e.n23,e.n33).length();this.x=t,this.y=r,this.z=e},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},isZero:function(){return 1e-4>this.lengthSq()}},t.Vector4=function(e,t,r,i){this.x=e||0,this.y=t||0,this.z=r||0,this.w=void 0!==i?i:1},t.Vector4.prototype={constructor:t.Vector4,set:function(e,t,r,i){return this.x=e,this.y=t,this.z=r,this.w=i,this},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this},clone:function(){return new t.Vector4(this.x,this.y,this.z,this.w)},add:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},addSelf:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},sub:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},subSelf:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},divideScalar:function(e){return e?(this.x/=e,this.y/=e,this.z/=e,this.w/=e):(this.z=this.y=this.x=0,this.w=1),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.dot(this)},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){return this.normalize().multiplyScalar(e)},lerpSelf:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}},t.Frustum=function(){this.planes=[new t.Vector4,new t.Vector4,new t.Vector4,new t.Vector4,new t.Vector4,new t.Vector4]},t.Frustum.prototype.setFromMatrix=function(e){var t,r=this.planes;for(r[0].set(e.n41-e.n11,e.n42-e.n12,e.n43-e.n13,e.n44-e.n14),r[1].set(e.n41+e.n11,e.n42+e.n12,e.n43+e.n13,e.n44+e.n14),r[2].set(e.n41+e.n21,e.n42+e.n22,e.n43+e.n23,e.n44+e.n24),r[3].set(e.n41-e.n21,e.n42-e.n22,e.n43-e.n23,e.n44-e.n24),r[4].set(e.n41-e.n31,e.n42-e.n32,e.n43-e.n33,e.n44-e.n34),r[5].set(e.n41+e.n31,e.n42+e.n32,e.n43+e.n33,e.n44+e.n34),e=0;6>e;e++)t=r[e],t.divideScalar(Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z))},t.Frustum.prototype.contains=function(e){for(var r=this.planes,i=e.matrixWorld,n=t.Frustum.__v1.set(i.getColumnX().length(),i.getColumnY().length(),i.getColumnZ().length()),n=-e.geometry.boundingSphere.radius*Math.max(n.x,Math.max(n.y,n.z)),o=0;6>o;o++)if(e=r[o].x*i.n14+r[o].y*i.n24+r[o].z*i.n34+r[o].w,n>=e)return!1;return!0},t.Frustum.__v1=new t.Vector3,t.Ray=function(e,r){function i(e,t,r){return T.sub(r,e),m=T.dot(t),g=C.add(e,A.copy(t).multiplyScalar(m)),b=r.distanceTo(g)}function n(e,t,r,i){return T.sub(i,t),C.sub(r,t),A.sub(e,t),v=T.dot(T),x=T.dot(C),y=T.dot(A),w=C.dot(C),_=C.dot(A),M=1/(v*w-x*x),S=(w*y-x*_)*M,k=(v*_-x*y)*M,S>=0&&k>=0&&1>S+k}this.origin=e||new t.Vector3,this.direction=r||new t.Vector3,this.intersectObjects=function(e){var t,r,i=[];for(t=0,r=e.length;r>t;t++)Array.prototype.push.apply(i,this.intersectObject(e[t]));return i.sort(function(e,t){return e.distance-t.distance}),i};var o=1e-4;this.setPrecision=function(e){o=e};var a=new t.Vector3,s=new t.Vector3,l=new t.Vector3,c=new t.Vector3,h=new t.Vector3,p=new t.Vector3,d=new t.Vector3,u=new t.Vector3,f=new t.Vector3;this.intersectObject=function(e){var r,m=[];if(e instanceof t.Particle){var g=i(this.origin,this.direction,e.matrixWorld.getPosition());if(g>e.scale.x)return[];r={distance:g,point:e.position,face:null,object:e},m.push(r)}else if(e instanceof t.Mesh){var g=i(this.origin,this.direction,e.matrixWorld.getPosition()),b=t.Frustum.__v1.set(e.matrixWorld.getColumnX().length(),e.matrixWorld.getColumnY().length(),e.matrixWorld.getColumnZ().length());if(g>e.geometry.boundingSphere.radius*Math.max(b.x,Math.max(b.y,b.z)))return m;var v,x,y,w=e.geometry,_=w.vertices;for(e.matrixRotationWorld.extractRotation(e.matrixWorld),g=0,b=w.faces.length;b>g;g++)r=w.faces[g],h.copy(this.origin),p.copy(this.direction),y=e.matrixWorld,d=y.multiplyVector3(d.copy(r.centroid)).subSelf(h),u=e.matrixRotationWorld.multiplyVector3(u.copy(r.normal)),v=p.dot(u),Math.abs(v)<o||(x=u.dot(d)/v,0>x||!e.doubleSided&&!(e.flipSided?v>0:0>v))||(f.add(h,p.multiplyScalar(x)),r instanceof t.Face3?(a=y.multiplyVector3(a.copy(_[r.a].position)),s=y.multiplyVector3(s.copy(_[r.b].position)),l=y.multiplyVector3(l.copy(_[r.c].position)),n(f,a,s,l)&&(r={distance:h.distanceTo(f),point:f.clone(),face:r,object:e},m.push(r))):r instanceof t.Face4&&(a=y.multiplyVector3(a.copy(_[r.a].position)),s=y.multiplyVector3(s.copy(_[r.b].position)),l=y.multiplyVector3(l.copy(_[r.c].position)),c=y.multiplyVector3(c.copy(_[r.d].position)),n(f,a,s,c)||n(f,s,l,c))&&(r={distance:h.distanceTo(f),point:f.clone(),face:r,object:e},m.push(r)))}return m};var m,g,b,v,x,y,w,_,M,S,k,T=new t.Vector3,C=new t.Vector3,A=new t.Vector3},t.Rectangle=function(){function e(){o=i-t,a=n-r}var t,r,i,n,o,a,s=!0;this.getX=function(){return t},this.getY=function(){return r},this.getWidth=function(){return o},this.getHeight=function(){return a},this.getLeft=function(){return t},this.getTop=function(){return r},this.getRight=function(){return i},this.getBottom=function(){return n},this.set=function(o,a,l,c){s=!1,t=o,r=a,i=l,n=c,e()},this.addPoint=function(o,a){s?(s=!1,t=o,r=a,i=o,n=a):(t=o>t?t:o,r=a>r?r:a,i=i>o?i:o,n=n>a?n:a),e()},this.add3Points=function(o,a,l,c,h,p){s?(s=!1,t=l>o?h>o?o:h:h>l?l:h,r=c>a?p>a?a:p:p>c?c:p,i=o>l?o>h?o:h:l>h?l:h,n=a>c?a>p?a:p:c>p?c:p):(t=l>o?h>o?t>o?o:t:t>h?h:t:h>l?t>l?l:t:t>h?h:t,r=c>a?p>a?r>a?a:r:r>p?p:r:p>c?r>c?c:r:r>p?p:r,i=o>l?o>h?o>i?o:i:h>i?h:i:l>h?l>i?l:i:h>i?h:i,n=a>c?a>p?a>n?a:n:p>n?p:n:c>p?c>n?c:n:p>n?p:n),e()},this.addRectangle=function(o){s?(s=!1,t=o.getLeft(),r=o.getTop(),i=o.getRight(),n=o.getBottom()):(t=t<o.getLeft()?t:o.getLeft(),r=r<o.getTop()?r:o.getTop(),i=i>o.getRight()?i:o.getRight(),n=n>o.getBottom()?n:o.getBottom()),e()},this.inflate=function(o){t-=o,r-=o,i+=o,n+=o,e()},this.minSelf=function(o){t=t>o.getLeft()?t:o.getLeft(),r=r>o.getTop()?r:o.getTop(),i=i<o.getRight()?i:o.getRight(),n=n<o.getBottom()?n:o.getBottom(),e()},this.intersects=function(e){return i<e.getLeft()||t>e.getRight()||n<e.getTop()||r>e.getBottom()?!1:!0},this.empty=function(){s=!0,n=i=r=t=0,e()},this.isEmpty=function(){return s}},t.Math={clamp:function(e,t,r){return t>e?t:e>r?r:e},clampBottom:function(e,t){return t>e?t:e},mapLinear:function(e,t,r,i,n){return i+(e-t)*(n-i)/(r-t)},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},sign:function(e){return 0>e?-1:e>0?1:0}},t.Matrix3=function(){this.m=[]},t.Matrix3.prototype={constructor:t.Matrix3,transposeIntoArray:function(e){var t=this.m;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}},t.Matrix4=function(e,r,i,n,o,a,s,l,c,h,p,d,u,f,m,g){this.set(void 0!==e?e:1,r||0,i||0,n||0,o||0,void 0!==a?a:1,s||0,l||0,c||0,h||0,void 0!==p?p:1,d||0,u||0,f||0,m||0,void 0!==g?g:1),this.m33=new t.Matrix3},t.Matrix4.prototype={constructor:t.Matrix4,set:function(e,t,r,i,n,o,a,s,l,c,h,p,d,u,f,m){return this.n11=e,this.n12=t,this.n13=r,this.n14=i,this.n21=n,this.n22=o,this.n23=a,this.n24=s,this.n31=l,this.n32=c,this.n33=h,this.n34=p,this.n41=d,this.n42=u,this.n43=f,this.n44=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},copy:function(e){return this.set(e.n11,e.n12,e.n13,e.n14,e.n21,e.n22,e.n23,e.n24,e.n31,e.n32,e.n33,e.n34,e.n41,e.n42,e.n43,e.n44),this},lookAt:function(e,r,i){var n=t.Matrix4.__v1,o=t.Matrix4.__v2,a=t.Matrix4.__v3;return a.sub(e,r).normalize(),0===a.length()&&(a.z=1),n.cross(i,a).normalize(),0===n.length()&&(a.x+=1e-4,n.cross(i,a).normalize()),o.cross(a,n),this.n11=n.x,this.n12=o.x,this.n13=a.x,this.n21=n.y,this.n22=o.y,this.n23=a.y,this.n31=n.z,this.n32=o.z,this.n33=a.z,this},multiply:function(e,t){var r=e.n11,i=e.n12,n=e.n13,o=e.n14,a=e.n21,s=e.n22,l=e.n23,c=e.n24,h=e.n31,p=e.n32,d=e.n33,u=e.n34,f=e.n41,m=e.n42,g=e.n43,b=e.n44,v=t.n11,x=t.n12,y=t.n13,w=t.n14,_=t.n21,M=t.n22,S=t.n23,k=t.n24,T=t.n31,C=t.n32,A=t.n33,E=t.n34,L=t.n41,R=t.n42,z=t.n43,N=t.n44;return this.n11=r*v+i*_+n*T+o*L,this.n12=r*x+i*M+n*C+o*R,this.n13=r*y+i*S+n*A+o*z,this.n14=r*w+i*k+n*E+o*N,this.n21=a*v+s*_+l*T+c*L,this.n22=a*x+s*M+l*C+c*R,this.n23=a*y+s*S+l*A+c*z,this.n24=a*w+s*k+l*E+c*N,this.n31=h*v+p*_+d*T+u*L,this.n32=h*x+p*M+d*C+u*R,this.n33=h*y+p*S+d*A+u*z,this.n34=h*w+p*k+d*E+u*N,this.n41=f*v+m*_+g*T+b*L,this.n42=f*x+m*M+g*C+b*R,this.n43=f*y+m*S+g*A+b*z,this.n44=f*w+m*k+g*E+b*N,this},multiplySelf:function(e){return this.multiply(this,e)},multiplyToArray:function(e,t,r){return this.multiply(e,t),r[0]=this.n11,r[1]=this.n21,r[2]=this.n31,r[3]=this.n41,r[4]=this.n12,r[5]=this.n22,r[6]=this.n32,r[7]=this.n42,r[8]=this.n13,r[9]=this.n23,r[10]=this.n33,r[11]=this.n43,r[12]=this.n14,r[13]=this.n24,r[14]=this.n34,r[15]=this.n44,this},multiplyScalar:function(e){return this.n11*=e,this.n12*=e,this.n13*=e,this.n14*=e,this.n21*=e,this.n22*=e,this.n23*=e,this.n24*=e,this.n31*=e,this.n32*=e,this.n33*=e,this.n34*=e,this.n41*=e,this.n42*=e,this.n43*=e,this.n44*=e,this},multiplyVector3:function(e){var t=e.x,r=e.y,i=e.z,n=1/(this.n41*t+this.n42*r+this.n43*i+this.n44);return e.x=(this.n11*t+this.n12*r+this.n13*i+this.n14)*n,e.y=(this.n21*t+this.n22*r+this.n23*i+this.n24)*n,e.z=(this.n31*t+this.n32*r+this.n33*i+this.n34)*n,e},multiplyVector4:function(e){var t=e.x,r=e.y,i=e.z,n=e.w;return e.x=this.n11*t+this.n12*r+this.n13*i+this.n14*n,e.y=this.n21*t+this.n22*r+this.n23*i+this.n24*n,e.z=this.n31*t+this.n32*r+this.n33*i+this.n34*n,e.w=this.n41*t+this.n42*r+this.n43*i+this.n44*n,e},rotateAxis:function(e){var t=e.x,r=e.y,i=e.z;return e.x=t*this.n11+r*this.n12+i*this.n13,e.y=t*this.n21+r*this.n22+i*this.n23,e.z=t*this.n31+r*this.n32+i*this.n33,e.normalize(),e},crossVector:function(e){var r=new t.Vector4;return r.x=this.n11*e.x+this.n12*e.y+this.n13*e.z+this.n14*e.w,r.y=this.n21*e.x+this.n22*e.y+this.n23*e.z+this.n24*e.w,r.z=this.n31*e.x+this.n32*e.y+this.n33*e.z+this.n34*e.w,r.w=e.w?this.n41*e.x+this.n42*e.y+this.n43*e.z+this.n44*e.w:1,r},determinant:function(){var e=this.n11,t=this.n12,r=this.n13,i=this.n14,n=this.n21,o=this.n22,a=this.n23,s=this.n24,l=this.n31,c=this.n32,h=this.n33,p=this.n34,d=this.n41,u=this.n42,f=this.n43,m=this.n44;return i*a*c*d-r*s*c*d-i*o*h*d+t*s*h*d+r*o*p*d-t*a*p*d-i*a*l*u+r*s*l*u+i*n*h*u-e*s*h*u-r*n*p*u+e*a*p*u+i*o*l*f-t*s*l*f-i*n*c*f+e*s*c*f+t*n*p*f-e*o*p*f-r*o*l*m+t*a*l*m+r*n*c*m-e*a*c*m-t*n*h*m+e*o*h*m},transpose:function(){var e;return e=this.n21,this.n21=this.n12,this.n12=e,e=this.n31,this.n31=this.n13,this.n13=e,e=this.n32,this.n32=this.n23,this.n23=e,e=this.n41,this.n41=this.n14,this.n14=e,e=this.n42,this.n42=this.n24,this.n24=e,e=this.n43,this.n43=this.n34,this.n34=e,this},clone:function(){var e=new t.Matrix4;return e.n11=this.n11,e.n12=this.n12,e.n13=this.n13,e.n14=this.n14,e.n21=this.n21,e.n22=this.n22,e.n23=this.n23,e.n24=this.n24,e.n31=this.n31,e.n32=this.n32,e.n33=this.n33,e.n34=this.n34,e.n41=this.n41,e.n42=this.n42,e.n43=this.n43,e.n44=this.n44,e},flattenToArray:function(e){return e[0]=this.n11,e[1]=this.n21,e[2]=this.n31,e[3]=this.n41,e[4]=this.n12,e[5]=this.n22,e[6]=this.n32,e[7]=this.n42,e[8]=this.n13,e[9]=this.n23,e[10]=this.n33,e[11]=this.n43,e[12]=this.n14,e[13]=this.n24,e[14]=this.n34,e[15]=this.n44,e},flattenToArrayOffset:function(e,t){return e[t]=this.n11,e[t+1]=this.n21,e[t+2]=this.n31,e[t+3]=this.n41,e[t+4]=this.n12,e[t+5]=this.n22,e[t+6]=this.n32,e[t+7]=this.n42,e[t+8]=this.n13,e[t+9]=this.n23,e[t+10]=this.n33,e[t+11]=this.n43,e[t+12]=this.n14,e[t+13]=this.n24,e[t+14]=this.n34,e[t+15]=this.n44,e},setTranslation:function(e,t,r){return this.set(1,0,0,e,0,1,0,t,0,0,1,r,0,0,0,1),this},setScale:function(e,t,r){return this.set(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1),this},setRotationX:function(e){var t=Math.cos(e),e=Math.sin(e);return this.set(1,0,0,0,0,t,-e,0,0,e,t,0,0,0,0,1),this},setRotationY:function(e){var t=Math.cos(e),e=Math.sin(e);return this.set(t,0,e,0,0,1,0,0,-e,0,t,0,0,0,0,1),this},setRotationZ:function(e){var t=Math.cos(e),e=Math.sin(e);return this.set(t,-e,0,0,e,t,0,0,0,0,1,0,0,0,0,1),this},setRotationAxis:function(e,t){var r=Math.cos(t),i=Math.sin(t),n=1-r,o=e.x,a=e.y,s=e.z,l=n*o,c=n*a;return this.set(l*o+r,l*a-i*s,l*s+i*a,0,l*a+i*s,c*a+r,c*s-i*o,0,l*s-i*a,c*s+i*o,n*s*s+r,0,0,0,0,1),this},setPosition:function(e){return this.n14=e.x,this.n24=e.y,this.n34=e.z,this},getPosition:function(){return t.Matrix4.__v1.set(this.n14,this.n24,this.n34)},getColumnX:function(){return t.Matrix4.__v1.set(this.n11,this.n21,this.n31)},getColumnY:function(){return t.Matrix4.__v1.set(this.n12,this.n22,this.n32)},getColumnZ:function(){return t.Matrix4.__v1.set(this.n13,this.n23,this.n33)},getInverse:function(e){var t=e.n11,r=e.n12,i=e.n13,n=e.n14,o=e.n21,a=e.n22,s=e.n23,l=e.n24,c=e.n31,h=e.n32,p=e.n33,d=e.n34,u=e.n41,f=e.n42,m=e.n43,g=e.n44;return this.n11=s*d*f-l*p*f+l*h*m-a*d*m-s*h*g+a*p*g,this.n12=n*p*f-i*d*f-n*h*m+r*d*m+i*h*g-r*p*g,this.n13=i*l*f-n*s*f+n*a*m-r*l*m-i*a*g+r*s*g,this.n14=n*s*h-i*l*h-n*a*p+r*l*p+i*a*d-r*s*d,this.n21=l*p*u-s*d*u-l*c*m+o*d*m+s*c*g-o*p*g,this.n22=i*d*u-n*p*u+n*c*m-t*d*m-i*c*g+t*p*g,this.n23=n*s*u-i*l*u-n*o*m+t*l*m+i*o*g-t*s*g,this.n24=i*l*c-n*s*c+n*o*p-t*l*p-i*o*d+t*s*d,this.n31=a*d*u-l*h*u+l*c*f-o*d*f-a*c*g+o*h*g,this.n32=n*h*u-r*d*u-n*c*f+t*d*f+r*c*g-t*h*g,this.n33=r*l*u-n*a*u+n*o*f-t*l*f-r*o*g+t*a*g,this.n34=n*a*c-r*l*c-n*o*h+t*l*h+r*o*d-t*a*d,this.n41=s*h*u-a*p*u-s*c*f+o*p*f+a*c*m-o*h*m,this.n42=r*p*u-i*h*u+i*c*f-t*p*f-r*c*m+t*h*m,this.n43=i*a*u-r*s*u-i*o*f+t*s*f+r*o*m-t*a*m,this.n44=r*s*c-i*a*c+i*o*h-t*s*h-r*o*p+t*a*p,this.multiplyScalar(1/e.determinant()),this},setRotationFromEuler:function(e,t){var r=e.x,i=e.y,n=e.z,o=Math.cos(r),r=Math.sin(r),a=Math.cos(i),i=Math.sin(i),s=Math.cos(n),n=Math.sin(n);switch(t){case"YXZ":var l=a*s,c=a*n,h=i*s,p=i*n;this.n11=l+p*r,this.n12=h*r-c,this.n13=o*i,this.n21=o*n,this.n22=o*s,this.n23=-r,this.n31=c*r-h,this.n32=p+l*r,this.n33=o*a;break;case"ZXY":l=a*s,c=a*n,h=i*s,p=i*n,this.n11=l-p*r,this.n12=-o*n,this.n13=h+c*r,this.n21=c+h*r,this.n22=o*s,this.n23=p-l*r,this.n31=-o*i,this.n32=r,this.n33=o*a;break;case"ZYX":l=o*s,c=o*n,h=r*s,p=r*n,this.n11=a*s,this.n12=h*i-c,this.n13=l*i+p,this.n21=a*n,this.n22=p*i+l,this.n23=c*i-h,this.n31=-i,this.n32=r*a,this.n33=o*a;break;case"YZX":l=o*a,c=o*i,h=r*a,p=r*i,this.n11=a*s,this.n12=p-l*n,this.n13=h*n+c,this.n21=n,this.n22=o*s,this.n23=-r*s,this.n31=-i*s,this.n32=c*n+h,this.n33=l-p*n;break;case"XZY":l=o*a,c=o*i,h=r*a,p=r*i,this.n11=a*s,this.n12=-n,this.n13=i*s,this.n21=l*n+p,this.n22=o*s,this.n23=c*n-h,this.n31=h*n-c,this.n32=r*s,this.n33=p*n+l;break;default:l=o*s,c=o*n,h=r*s,p=r*n,this.n11=a*s,this.n12=-a*n,this.n13=i,this.n21=c+h*i,this.n22=l-p*i,this.n23=-r*a,this.n31=p-l*i,this.n32=h+c*i,this.n33=o*a}return this},setRotationFromQuaternion:function(e){var t=e.x,r=e.y,i=e.z,n=e.w,o=t+t,a=r+r,s=i+i,e=t*o,l=t*a,t=t*s,c=r*a,r=r*s,i=i*s,o=n*o,a=n*a,n=n*s;return this.n11=1-(c+i),this.n12=l-n,this.n13=t+a,this.n21=l+n,this.n22=1-(e+i),this.n23=r-o,this.n31=t-a,this.n32=r+o,this.n33=1-(e+c),this},scale:function(e){var t=e.x,r=e.y,e=e.z;return this.n11*=t,this.n12*=r,this.n13*=e,this.n21*=t,this.n22*=r,this.n23*=e,this.n31*=t,this.n32*=r,this.n33*=e,this.n41*=t,this.n42*=r,this.n43*=e,this},compose:function(e,r,i){var n=t.Matrix4.__m1,o=t.Matrix4.__m2;return n.identity(),n.setRotationFromQuaternion(r),o.setScale(i.x,i.y,i.z),this.multiply(n,o),this.n14=e.x,this.n24=e.y,this.n34=e.z,this},decompose:function(e,r,i){var n=t.Matrix4.__v1,o=t.Matrix4.__v2,a=t.Matrix4.__v3;return n.set(this.n11,this.n21,this.n31),o.set(this.n12,this.n22,this.n32),a.set(this.n13,this.n23,this.n33),e=e instanceof t.Vector3?e:new t.Vector3,r=r instanceof t.Quaternion?r:new t.Quaternion,i=i instanceof t.Vector3?i:new t.Vector3,i.x=n.length(),i.y=o.length(),i.z=a.length(),e.x=this.n14,e.y=this.n24,e.z=this.n34,n=t.Matrix4.__m1,n.copy(this),n.n11/=i.x,n.n21/=i.x,n.n31/=i.x,n.n12/=i.y,n.n22/=i.y,n.n32/=i.y,n.n13/=i.z,n.n23/=i.z,n.n33/=i.z,r.setFromRotationMatrix(n),[e,r,i]},extractPosition:function(e){return this.n14=e.n14,this.n24=e.n24,this.n34=e.n34,this},extractRotation:function(e){var r=t.Matrix4.__v1,i=1/r.set(e.n11,e.n21,e.n31).length(),n=1/r.set(e.n12,e.n22,e.n32).length(),r=1/r.set(e.n13,e.n23,e.n33).length();return this.n11=e.n11*i,this.n21=e.n21*i,this.n31=e.n31*i,this.n12=e.n12*n,this.n22=e.n22*n,this.n32=e.n32*n,this.n13=e.n13*r,this.n23=e.n23*r,this.n33=e.n33*r,this},rotateByAxis:function(e,t){if(1===e.x&&0===e.y&&0===e.z)return this.rotateX(t);if(0===e.x&&1===e.y&&0===e.z)return this.rotateY(t);if(0===e.x&&0===e.y&&1===e.z)return this.rotateZ(t);var r=e.x,i=e.y,n=e.z,o=Math.sqrt(r*r+i*i+n*n),r=r/o,i=i/o,n=n/o,o=r*r,a=i*i,s=n*n,l=Math.cos(t),c=Math.sin(t),h=1-l,p=r*i*h,d=r*n*h,h=i*n*h,r=r*c,u=i*c,c=n*c,n=o+(1-o)*l,o=p+c,i=d-u,p=p-c,a=a+(1-a)*l,c=h+r,d=d+u,h=h-r,s=s+(1-s)*l,l=this.n11,r=this.n21,u=this.n31,f=this.n41,m=this.n12,g=this.n22,b=this.n32,v=this.n42,x=this.n13,y=this.n23,w=this.n33,_=this.n43;return this.n11=n*l+o*m+i*x,this.n21=n*r+o*g+i*y,this.n31=n*u+o*b+i*w,this.n41=n*f+o*v+i*_,this.n12=p*l+a*m+c*x,this.n22=p*r+a*g+c*y,this.n32=p*u+a*b+c*w,this.n42=p*f+a*v+c*_,this.n13=d*l+h*m+s*x,this.n23=d*r+h*g+s*y,this.n33=d*u+h*b+s*w,this.n43=d*f+h*v+s*_,this},rotateX:function(e){var t=this.n12,r=this.n22,i=this.n32,n=this.n42,o=this.n13,a=this.n23,s=this.n33,l=this.n43,c=Math.cos(e),e=Math.sin(e);return this.n12=c*t+e*o,this.n22=c*r+e*a,this.n32=c*i+e*s,this.n42=c*n+e*l,this.n13=c*o-e*t,this.n23=c*a-e*r,this.n33=c*s-e*i,this.n43=c*l-e*n,this},rotateY:function(e){var t=this.n11,r=this.n21,i=this.n31,n=this.n41,o=this.n13,a=this.n23,s=this.n33,l=this.n43,c=Math.cos(e),e=Math.sin(e);return this.n11=c*t-e*o,this.n21=c*r-e*a,this.n31=c*i-e*s,this.n41=c*n-e*l,this.n13=c*o+e*t,this.n23=c*a+e*r,this.n33=c*s+e*i,this.n43=c*l+e*n,this},rotateZ:function(e){var t=this.n11,r=this.n21,i=this.n31,n=this.n41,o=this.n12,a=this.n22,s=this.n32,l=this.n42,c=Math.cos(e),e=Math.sin(e);return this.n11=c*t+e*o,this.n21=c*r+e*a,this.n31=c*i+e*s,this.n41=c*n+e*l,this.n12=c*o-e*t,this.n22=c*a-e*r,this.n32=c*s-e*i,this.n42=c*l-e*n,this},translate:function(e){var t=e.x,r=e.y,e=e.z;return this.n14=this.n11*t+this.n12*r+this.n13*e+this.n14,this.n24=this.n21*t+this.n22*r+this.n23*e+this.n24,this.n34=this.n31*t+this.n32*r+this.n33*e+this.n34,this.n44=this.n41*t+this.n42*r+this.n43*e+this.n44,this}},t.Matrix4.makeInvert3x3=function(e){var t=e.m33,r=t.m,i=e.n33*e.n22-e.n32*e.n23,n=-e.n33*e.n21+e.n31*e.n23,o=e.n32*e.n21-e.n31*e.n22,a=-e.n33*e.n12+e.n32*e.n13,s=e.n33*e.n11-e.n31*e.n13,l=-e.n32*e.n11+e.n31*e.n12,c=e.n23*e.n12-e.n22*e.n13,h=-e.n23*e.n11+e.n21*e.n13,p=e.n22*e.n11-e.n21*e.n12,e=e.n11*i+e.n21*a+e.n31*c;return 0===e?null:(e=1/e,r[0]=e*i,r[1]=e*n,r[2]=e*o,r[3]=e*a,r[4]=e*s,r[5]=e*l,r[6]=e*c,r[7]=e*h,r[8]=e*p,t)},t.Matrix4.makeFrustum=function(e,r,i,n,o,a){var s;return s=new t.Matrix4,s.n11=2*o/(r-e),s.n12=0,s.n13=(r+e)/(r-e),s.n14=0,s.n21=0,s.n22=2*o/(n-i),s.n23=(n+i)/(n-i),s.n24=0,s.n31=0,s.n32=0,s.n33=-(a+o)/(a-o),s.n34=-2*a*o/(a-o),s.n41=0,s.n42=0,s.n43=-1,s.n44=0,s},t.Matrix4.makePerspective=function(e,r,i,n){var o,e=i*Math.tan(e*Math.PI/360);return o=-e,t.Matrix4.makeFrustum(o*r,e*r,o,e,i,n)},t.Matrix4.makeOrtho=function(e,r,i,n,o,a){var s,l,c,h;return s=new t.Matrix4,l=r-e,c=i-n,h=a-o,s.n11=2/l,s.n12=0,s.n13=0,s.n14=-((r+e)/l),s.n21=0,s.n22=2/c,s.n23=0,s.n24=-((i+n)/c),s.n31=0,s.n32=0,s.n33=-2/h,s.n34=-((a+o)/h),s.n41=0,s.n42=0,s.n43=0,s.n44=1,s},t.Matrix4.__v1=new t.Vector3,t.Matrix4.__v2=new t.Vector3,t.Matrix4.__v3=new t.Vector3,t.Matrix4.__m1=new t.Matrix4,t.Matrix4.__m2=new t.Matrix4,t.Object3D=function(){this.id=t.Object3DCount++,this.name="",this.parent=void 0,this.children=[],this.up=new t.Vector3(0,1,0),this.position=new t.Vector3,this.rotation=new t.Vector3,this.eulerOrder="XYZ",this.scale=new t.Vector3(1,1,1),this.flipSided=this.doubleSided=!1,this.renderDepth=null,this.rotationAutoUpdate=!0,this.matrix=new t.Matrix4,this.matrixWorld=new t.Matrix4,this.matrixRotationWorld=new t.Matrix4,this.matrixWorldNeedsUpdate=this.matrixAutoUpdate=!0,this.quaternion=new t.Quaternion,this.useQuaternion=!1,this.boundRadius=0,this.boundRadiusScale=1,this.visible=!0,this.receiveShadow=this.castShadow=!1,this.frustumCulled=!0,this._vector=new t.Vector3},t.Object3D.prototype={constructor:t.Object3D,applyMatrix:function(e){this.matrix.multiply(e,this.matrix),this.scale.getScaleFromMatrix(this.matrix),this.rotation.getRotationFromMatrix(this.matrix,this.scale),this.position.getPositionFromMatrix(this.matrix)},translate:function(e,t){this.matrix.rotateAxis(t),this.position.addSelf(t.multiplyScalar(e))},translateX:function(e){this.translate(e,this._vector.set(1,0,0))},translateY:function(e){this.translate(e,this._vector.set(0,1,0))},translateZ:function(e){this.translate(e,this._vector.set(0,0,1))},lookAt:function(e){this.matrix.lookAt(e,this.position,this.up),this.rotationAutoUpdate&&this.rotation.getRotationFromMatrix(this.matrix)},add:function(e){if(e===this)console.warn("THREE.Object3D.add: An object can't be added as a child of itself.");else if(-1===this.children.indexOf(e)){void 0!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e);for(var r=this;void 0!==r.parent;)r=r.parent;void 0!==r&&r instanceof t.Scene&&r.__addObject(e)}},remove:function(e){var r=this.children.indexOf(e);if(-1!==r){for(e.parent=void 0,this.children.splice(r,1),r=this;void 0!==r.parent;)r=r.parent;void 0!==r&&r instanceof t.Scene&&r.__removeObject(e)}},getChildByName:function(e,t){var r,i,n;for(r=0,i=this.children.length;i>r;r++)if(n=this.children[r],n.name===e||t&&(n=n.getChildByName(e,t),void 0!==n))return n},updateMatrix:function(){this.matrix.setPosition(this.position),this.useQuaternion?this.matrix.setRotationFromQuaternion(this.quaternion):this.matrix.setRotationFromEuler(this.rotation,this.eulerOrder),(1!==this.scale.x||1!==this.scale.y||1!==this.scale.z)&&(this.matrix.scale(this.scale),this.boundRadiusScale=Math.max(this.scale.x,Math.max(this.scale.y,this.scale.z))),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(this.parent?this.matrixWorld.multiply(this.parent.matrixWorld,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=0,r=this.children.length;r>t;t++)this.children[t].updateMatrixWorld(e)}},t.Object3DCount=0,t.Projector=function(){function e(){var e=g[a]=g[a]||new t.RenderableObject;return a++,e}function r(){var e=b[l]=b[l]||new t.RenderableVertex;return l++,e}function i(e,t){return t.z-e.z}function n(e,t){var r=0,i=1,n=e.z+e.w,o=t.z+t.w,a=-e.z+e.w,s=-t.z+t.w;return n>=0&&o>=0&&a>=0&&s>=0?!0:0>n&&0>o||0>a&&0>s?!1:(0>n?r=Math.max(r,n/(n-o)):0>o&&(i=Math.min(i,n/(n-o))),0>a?r=Math.max(r,a/(a-s)):0>s&&(i=Math.min(i,a/(a-s))),r>i?!1:(e.lerpSelf(t,r),t.lerpSelf(e,1-i),!0))}var o,a,s,l,c,h,p,d,u,f,m,g=[],b=[],v=[],x=[],y=[],w=[],_={objects:[],sprites:[],lights:[],elements:[]},M=new t.Vector3,S=new t.Vector4,k=new t.Matrix4,T=new t.Matrix4,C=new t.Frustum,A=new t.Vector4,E=new t.Vector4;this.projectVector=function(e,t){return t.matrixWorldInverse.getInverse(t.matrixWorld),k.multiply(t.projectionMatrix,t.matrixWorldInverse),k.multiplyVector3(e),e},this.unprojectVector=function(e,t){return t.projectionMatrixInverse.getInverse(t.projectionMatrix),k.multiply(t.matrixWorld,t.projectionMatrixInverse),k.multiplyVector3(e),e},this.pickingRay=function(e,r){var i;return e.z=-1,i=new t.Vector3(e.x,e.y,1),this.unprojectVector(e,r),this.unprojectVector(i,r),i.subSelf(e).normalize(),new t.Ray(e,i)},this.projectGraph=function(r,n){a=0,_.objects.length=0,_.sprites.length=0,_.lights.length=0;
var s=function(r){if(!1!==r.visible){(r instanceof t.Mesh||r instanceof t.Line)&&(!1===r.frustumCulled||C.contains(r))?(k.multiplyVector3(M.copy(r.position)),o=e(),o.object=r,o.z=M.z,_.objects.push(o)):r instanceof t.Sprite||r instanceof t.Particle?(k.multiplyVector3(M.copy(r.position)),o=e(),o.object=r,o.z=M.z,_.sprites.push(o)):r instanceof t.Light&&_.lights.push(r);for(var i=0,n=r.children.length;n>i;i++)s(r.children[i])}};return s(r),n&&_.objects.sort(i),_},this.projectScene=function(e,o,a){var g,M,L,R,z,N,P,D,F,V,B,U,O,I,j,W=o.near,H=o.far,G=!1;for(m=u=p=h=0,_.elements.length=0,void 0===o.parent&&(console.warn("DEPRECATED: Camera hasn't been added to a Scene. Adding it..."),e.add(o)),e.updateMatrixWorld(),o.matrixWorldInverse.getInverse(o.matrixWorld),k.multiply(o.projectionMatrix,o.matrixWorldInverse),C.setFromMatrix(k),_=this.projectGraph(e,!1),e=0,g=_.objects.length;g>e;e++)if(F=_.objects[e].object,V=F.matrixWorld,l=0,F instanceof t.Mesh){for(B=F.geometry,U=F.geometry.materials,R=B.vertices,O=B.faces,I=B.faceVertexUvs,B=F.matrixRotationWorld.extractRotation(V),M=0,L=R.length;L>M;M++)s=r(),s.positionWorld.copy(R[M].position),V.multiplyVector3(s.positionWorld),s.positionScreen.copy(s.positionWorld),k.multiplyVector4(s.positionScreen),s.positionScreen.x/=s.positionScreen.w,s.positionScreen.y/=s.positionScreen.w,s.visible=s.positionScreen.z>W&&s.positionScreen.z<H;for(R=0,M=O.length;M>R;R++){if(L=O[R],L instanceof t.Face3){if(z=b[L.a],N=b[L.b],P=b[L.c],!(z.visible&&N.visible&&P.visible))continue;if(G=0>(P.positionScreen.x-z.positionScreen.x)*(N.positionScreen.y-z.positionScreen.y)-(P.positionScreen.y-z.positionScreen.y)*(N.positionScreen.x-z.positionScreen.x),!F.doubleSided&&G==F.flipSided)continue;D=v[h]=v[h]||new t.RenderableFace3,h++,c=D,c.v1.copy(z),c.v2.copy(N),c.v3.copy(P)}else if(L instanceof t.Face4){if(z=b[L.a],N=b[L.b],P=b[L.c],D=b[L.d],!(z.visible&&N.visible&&P.visible&&D.visible))continue;if(G=0>(D.positionScreen.x-z.positionScreen.x)*(N.positionScreen.y-z.positionScreen.y)-(D.positionScreen.y-z.positionScreen.y)*(N.positionScreen.x-z.positionScreen.x)||0>(N.positionScreen.x-P.positionScreen.x)*(D.positionScreen.y-P.positionScreen.y)-(N.positionScreen.y-P.positionScreen.y)*(D.positionScreen.x-P.positionScreen.x),!F.doubleSided&&G==F.flipSided)continue;j=x[p]=x[p]||new t.RenderableFace4,p++,c=j,c.v1.copy(z),c.v2.copy(N),c.v3.copy(P),c.v4.copy(D)}for(c.normalWorld.copy(L.normal),!G&&(F.flipSided||F.doubleSided)&&c.normalWorld.negate(),B.multiplyVector3(c.normalWorld),c.centroidWorld.copy(L.centroid),V.multiplyVector3(c.centroidWorld),c.centroidScreen.copy(c.centroidWorld),k.multiplyVector3(c.centroidScreen),P=L.vertexNormals,z=0,N=P.length;N>z;z++)D=c.vertexNormalsWorld[z],D.copy(P[z]),!G&&(F.flipSided||F.doubleSided)&&D.negate(),B.multiplyVector3(D);for(z=0,N=I.length;N>z;z++)if(j=I[z][R])for(P=0,D=j.length;D>P;P++)c.uvs[z][P]=j[P];c.material=F.material,c.faceMaterial=null!==L.materialIndex?U[L.materialIndex]:null,c.z=c.centroidScreen.z,_.elements.push(c)}}else if(F instanceof t.Line)for(T.multiply(k,V),R=F.geometry.vertices,z=r(),z.positionScreen.copy(R[0].position),T.multiplyVector4(z.positionScreen),M=1,L=R.length;L>M;M++)z=r(),z.positionScreen.copy(R[M].position),T.multiplyVector4(z.positionScreen),N=b[l-2],A.copy(z.positionScreen),E.copy(N.positionScreen),n(A,E)&&(A.multiplyScalar(1/A.w),E.multiplyScalar(1/E.w),V=y[u]=y[u]||new t.RenderableLine,u++,d=V,d.v1.positionScreen.copy(A),d.v2.positionScreen.copy(E),d.z=Math.max(A.z,E.z),d.material=F.material,_.elements.push(d));for(e=0,g=_.sprites.length;g>e;e++)F=_.sprites[e].object,V=F.matrixWorld,F instanceof t.Particle&&(S.set(V.n14,V.n24,V.n34,1),k.multiplyVector4(S),S.z/=S.w,0<S.z&&1>S.z)&&(W=w[m]=w[m]||new t.RenderableParticle,m++,f=W,f.x=S.x/S.w,f.y=S.y/S.w,f.z=S.z,f.rotation=F.rotation.z,f.scale.x=F.scale.x*Math.abs(f.x-(S.x+o.projectionMatrix.n11)/(S.w+o.projectionMatrix.n14)),f.scale.y=F.scale.y*Math.abs(f.y-(S.y+o.projectionMatrix.n22)/(S.w+o.projectionMatrix.n24)),f.material=F.material,_.elements.push(f));return a&&_.elements.sort(i),_}},t.Quaternion=function(e,t,r,i){this.x=e||0,this.y=t||0,this.z=r||0,this.w=void 0!==i?i:1},t.Quaternion.prototype={constructor:t.Quaternion,set:function(e,t,r,i){return this.x=e,this.y=t,this.z=r,this.w=i,this},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},clone:function(){return new t.Quaternion(this.x,this.y,this.z,this.w)},setFromEuler:function(e){var t=Math.PI/360,r=e.x*t,i=e.y*t,n=e.z*t,e=Math.cos(i),i=Math.sin(i),t=Math.cos(-n),n=Math.sin(-n),o=Math.cos(r),r=Math.sin(r),a=e*t,s=i*n;return this.w=a*o-s*r,this.x=a*r+s*o,this.y=i*t*o+e*n*r,this.z=e*n*o-i*t*r,this},setFromAxisAngle:function(e,t){var r=t/2,i=Math.sin(r);return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=Math.cos(r),this},setFromRotationMatrix:function(e){var t=Math.pow(e.determinant(),1/3);return this.w=Math.sqrt(Math.max(0,t+e.n11+e.n22+e.n33))/2,this.x=Math.sqrt(Math.max(0,t+e.n11-e.n22-e.n33))/2,this.y=Math.sqrt(Math.max(0,t-e.n11+e.n22-e.n33))/2,this.z=Math.sqrt(Math.max(0,t-e.n11-e.n22+e.n33))/2,this.x=0>e.n32-e.n23?-Math.abs(this.x):Math.abs(this.x),this.y=0>e.n13-e.n31?-Math.abs(this.y):Math.abs(this.y),this.z=0>e.n21-e.n12?-Math.abs(this.z):Math.abs(this.z),this.normalize(),this},calculateW:function(){return this.w=-Math.sqrt(Math.abs(1-this.x*this.x-this.y*this.y-this.z*this.z)),this},inverse:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?this.w=this.z=this.y=this.x=0:(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},multiplySelf:function(e){var t=this.x,r=this.y,i=this.z,n=this.w,o=e.x,a=e.y,s=e.z,e=e.w;return this.x=t*e+n*o+r*s-i*a,this.y=r*e+n*a+i*o-t*s,this.z=i*e+n*s+t*a-r*o,this.w=n*e-t*o-r*a-i*s,this},multiply:function(e,t){return this.x=e.x*t.w+e.y*t.z-e.z*t.y+e.w*t.x,this.y=-e.x*t.z+e.y*t.w+e.z*t.x+e.w*t.y,this.z=e.x*t.y-e.y*t.x+e.z*t.w+e.w*t.z,this.w=-e.x*t.x-e.y*t.y-e.z*t.z+e.w*t.w,this},multiplyVector3:function(e,t){t||(t=e);var r=e.x,i=e.y,n=e.z,o=this.x,a=this.y,s=this.z,l=this.w,c=l*r+a*n-s*i,h=l*i+s*r-o*n,p=l*n+o*i-a*r,r=-o*r-a*i-s*n;return t.x=c*l+r*-o+h*-s-p*-a,t.y=h*l+r*-a+p*-o-c*-s,t.z=p*l+r*-s+c*-a-h*-o,t}},t.Quaternion.slerp=function(e,t,r,i){var n=e.w*t.w+e.x*t.x+e.y*t.y+e.z*t.z;if(0>n?(r.w=-t.w,r.x=-t.x,r.y=-t.y,r.z=-t.z,n=-n):r.copy(t),1<=Math.abs(n))return r.w=e.w,r.x=e.x,r.y=e.y,r.z=e.z,r;var o=Math.acos(n),n=Math.sqrt(1-n*n);return.001>Math.abs(n)?(r.w=.5*(e.w+t.w),r.x=.5*(e.x+t.x),r.y=.5*(e.y+t.y),r.z=.5*(e.z+t.z),r):(t=Math.sin((1-i)*o)/n,i=Math.sin(i*o)/n,r.w=e.w*t+r.w*i,r.x=e.x*t+r.x*i,r.y=e.y*t+r.y*i,r.z=e.z*t+r.z*i,r)},t.Vertex=function(e){this.position=e||new t.Vector3},t.Vertex.prototype={constructor:t.Vertex,clone:function(){return new t.Vertex(this.position.clone())}},t.Face3=function(e,r,i,n,o,a){this.a=e,this.b=r,this.c=i,this.normal=n instanceof t.Vector3?n:new t.Vector3,this.vertexNormals=n instanceof Array?n:[],this.color=o instanceof t.Color?o:new t.Color,this.vertexColors=o instanceof Array?o:[],this.vertexTangents=[],this.materialIndex=a,this.centroid=new t.Vector3},t.Face3.prototype={constructor:t.Face3,clone:function(){var e=new t.Face3(this.a,this.b,this.c);e.normal.copy(this.normal),e.color.copy(this.color),e.centroid.copy(this.centroid),e.materialIndex=this.materialIndex;var r,i;for(r=0,i=this.vertexNormals.length;i>r;r++)e.vertexNormals[r]=this.vertexNormals[r].clone();for(r=0,i=this.vertexColors.length;i>r;r++)e.vertexColors[r]=this.vertexColors[r].clone();for(r=0,i=this.vertexTangents.length;i>r;r++)e.vertexTangents[r]=this.vertexTangents[r].clone();return e}},t.Face4=function(e,r,i,n,o,a,s){this.a=e,this.b=r,this.c=i,this.d=n,this.normal=o instanceof t.Vector3?o:new t.Vector3,this.vertexNormals=o instanceof Array?o:[],this.color=a instanceof t.Color?a:new t.Color,this.vertexColors=a instanceof Array?a:[],this.vertexTangents=[],this.materialIndex=s,this.centroid=new t.Vector3},t.Face4.prototype={constructor:t.Face4,clone:function(){var e=new t.Face4(this.a,this.b,this.c,this.d);e.normal.copy(this.normal),e.color.copy(this.color),e.centroid.copy(this.centroid),e.materialIndex=this.materialIndex;var r,i;for(r=0,i=this.vertexNormals.length;i>r;r++)e.vertexNormals[r]=this.vertexNormals[r].clone();for(r=0,i=this.vertexColors.length;i>r;r++)e.vertexColors[r]=this.vertexColors[r].clone();for(r=0,i=this.vertexTangents.length;i>r;r++)e.vertexTangents[r]=this.vertexTangents[r].clone();return e}},t.UV=function(e,t){this.u=e||0,this.v=t||0},t.UV.prototype={constructor:t.UV,set:function(e,t){return this.u=e,this.v=t,this},copy:function(e){return this.u=e.u,this.v=e.v,this},lerpSelf:function(e,t){return this.u+=(e.u-this.u)*t,this.v+=(e.v-this.v)*t,this},clone:function(){return new t.UV(this.u,this.v)}},t.Geometry=function(){this.id=t.GeometryCount++,this.vertices=[],this.colors=[],this.materials=[],this.faces=[],this.faceUvs=[[]],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphColors=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.boundingSphere=this.boundingBox=null,this.dynamic=this.hasTangents=!1},t.Geometry.prototype={constructor:t.Geometry,applyMatrix:function(e){var r=new t.Matrix4;r.extractRotation(e);for(var i=0,n=this.vertices.length;n>i;i++)e.multiplyVector3(this.vertices[i].position);for(i=0,n=this.faces.length;n>i;i++){var o=this.faces[i];r.multiplyVector3(o.normal);for(var a=0,s=o.vertexNormals.length;s>a;a++)r.multiplyVector3(o.vertexNormals[a]);e.multiplyVector3(o.centroid)}},computeCentroids:function(){var e,r,i;for(e=0,r=this.faces.length;r>e;e++)i=this.faces[e],i.centroid.set(0,0,0),i instanceof t.Face3?(i.centroid.addSelf(this.vertices[i.a].position),i.centroid.addSelf(this.vertices[i.b].position),i.centroid.addSelf(this.vertices[i.c].position),i.centroid.divideScalar(3)):i instanceof t.Face4&&(i.centroid.addSelf(this.vertices[i.a].position),i.centroid.addSelf(this.vertices[i.b].position),i.centroid.addSelf(this.vertices[i.c].position),i.centroid.addSelf(this.vertices[i.d].position),i.centroid.divideScalar(4))},computeFaceNormals:function(){var e,r,i,n,o,a,s=new t.Vector3,l=new t.Vector3;for(e=0,r=this.faces.length;r>e;e++)i=this.faces[e],n=this.vertices[i.a],o=this.vertices[i.b],a=this.vertices[i.c],s.sub(a.position,o.position),l.sub(n.position,o.position),s.crossSelf(l),s.isZero()||s.normalize(),i.normal.copy(s)},computeVertexNormals:function(){var e,r,i,n;if(void 0===this.__tmpVertices){for(n=this.__tmpVertices=Array(this.vertices.length),e=0,r=this.vertices.length;r>e;e++)n[e]=new t.Vector3;for(e=0,r=this.faces.length;r>e;e++)i=this.faces[e],i instanceof t.Face3?i.vertexNormals=[new t.Vector3,new t.Vector3,new t.Vector3]:i instanceof t.Face4&&(i.vertexNormals=[new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3])}else for(n=this.__tmpVertices,e=0,r=this.vertices.length;r>e;e++)n[e].set(0,0,0);for(e=0,r=this.faces.length;r>e;e++)i=this.faces[e],i instanceof t.Face3?(n[i.a].addSelf(i.normal),n[i.b].addSelf(i.normal),n[i.c].addSelf(i.normal)):i instanceof t.Face4&&(n[i.a].addSelf(i.normal),n[i.b].addSelf(i.normal),n[i.c].addSelf(i.normal),n[i.d].addSelf(i.normal));for(e=0,r=this.vertices.length;r>e;e++)n[e].normalize();for(e=0,r=this.faces.length;r>e;e++)i=this.faces[e],i instanceof t.Face3?(i.vertexNormals[0].copy(n[i.a]),i.vertexNormals[1].copy(n[i.b]),i.vertexNormals[2].copy(n[i.c])):i instanceof t.Face4&&(i.vertexNormals[0].copy(n[i.a]),i.vertexNormals[1].copy(n[i.b]),i.vertexNormals[2].copy(n[i.c]),i.vertexNormals[3].copy(n[i.d]))},computeMorphNormals:function(){var e,r,i,n,o;for(i=0,n=this.faces.length;n>i;i++)for(o=this.faces[i],o.__originalFaceNormal?o.__originalFaceNormal.copy(o.normal):o.__originalFaceNormal=o.normal.clone(),o.__originalVertexNormals||(o.__originalVertexNormals=[]),e=0,r=o.vertexNormals.length;r>e;e++)o.__originalVertexNormals[e]?o.__originalVertexNormals[e].copy(o.vertexNormals[e]):o.__originalVertexNormals[e]=o.vertexNormals[e].clone();var a=new t.Geometry;for(a.faces=this.faces,e=0,r=this.morphTargets.length;r>e;e++){if(!this.morphNormals[e]){this.morphNormals[e]={},this.morphNormals[e].faceNormals=[],this.morphNormals[e].vertexNormals=[];var s,l,c=this.morphNormals[e].faceNormals,h=this.morphNormals[e].vertexNormals;for(i=0,n=this.faces.length;n>i;i++)o=this.faces[i],s=new t.Vector3,l=o instanceof t.Face3?{a:new t.Vector3,b:new t.Vector3,c:new t.Vector3}:{a:new t.Vector3,b:new t.Vector3,c:new t.Vector3,d:new t.Vector3},c.push(s),h.push(l)}for(c=this.morphNormals[e],a.vertices=this.morphTargets[e].vertices,a.computeFaceNormals(),a.computeVertexNormals(),i=0,n=this.faces.length;n>i;i++)o=this.faces[i],s=c.faceNormals[i],l=c.vertexNormals[i],s.copy(o.normal),o instanceof t.Face3?(l.a.copy(o.vertexNormals[0]),l.b.copy(o.vertexNormals[1]),l.c.copy(o.vertexNormals[2])):(l.a.copy(o.vertexNormals[0]),l.b.copy(o.vertexNormals[1]),l.c.copy(o.vertexNormals[2]),l.d.copy(o.vertexNormals[3]))}for(i=0,n=this.faces.length;n>i;i++)o=this.faces[i],o.normal=o.__originalFaceNormal,o.vertexNormals=o.__originalVertexNormals},computeTangents:function(){function e(e,t,r,i,n,o,a){l=e.vertices[t].position,c=e.vertices[r].position,h=e.vertices[i].position,p=s[n],d=s[o],u=s[a],f=c.x-l.x,m=h.x-l.x,g=c.y-l.y,b=h.y-l.y,v=c.z-l.z,x=h.z-l.z,y=d.u-p.u,w=u.u-p.u,_=d.v-p.v,M=u.v-p.v,S=1/(y*M-w*_),A.set((M*f-_*m)*S,(M*g-_*b)*S,(M*v-_*x)*S),E.set((y*m-w*f)*S,(y*b-w*g)*S,(y*x-w*v)*S),T[t].addSelf(A),T[r].addSelf(A),T[i].addSelf(A),C[t].addSelf(E),C[r].addSelf(E),C[i].addSelf(E)}var r,i,n,o,a,s,l,c,h,p,d,u,f,m,g,b,v,x,y,w,_,M,S,k,T=[],C=[],A=new t.Vector3,E=new t.Vector3,L=new t.Vector3,R=new t.Vector3,z=new t.Vector3;for(r=0,i=this.vertices.length;i>r;r++)T[r]=new t.Vector3,C[r]=new t.Vector3;for(r=0,i=this.faces.length;i>r;r++)a=this.faces[r],s=this.faceVertexUvs[0][r],a instanceof t.Face3?e(this,a.a,a.b,a.c,0,1,2):a instanceof t.Face4&&(e(this,a.a,a.b,a.c,0,1,2),e(this,a.a,a.b,a.d,0,1,3));var N=["a","b","c","d"];for(r=0,i=this.faces.length;i>r;r++)for(a=this.faces[r],n=0;n<a.vertexNormals.length;n++)z.copy(a.vertexNormals[n]),o=a[N[n]],k=T[o],L.copy(k),L.subSelf(z.multiplyScalar(z.dot(k))).normalize(),R.cross(a.vertexNormals[n],k),o=R.dot(C[o]),o=0>o?-1:1,a.vertexTangents[n]=new t.Vector4(L.x,L.y,L.z,o);this.hasTangents=!0},computeBoundingBox:function(){if(this.boundingBox||(this.boundingBox={min:new t.Vector3,max:new t.Vector3}),0<this.vertices.length){var e;e=this.vertices[0].position,this.boundingBox.min.copy(e),this.boundingBox.max.copy(e);for(var r=this.boundingBox.min,i=this.boundingBox.max,n=1,o=this.vertices.length;o>n;n++)e=this.vertices[n].position,e.x<r.x?r.x=e.x:e.x>i.x&&(i.x=e.x),e.y<r.y?r.y=e.y:e.y>i.y&&(i.y=e.y),e.z<r.z?r.z=e.z:e.z>i.z&&(i.z=e.z)}else this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0)},computeBoundingSphere:function(){this.boundingSphere||(this.boundingSphere={radius:0});for(var e,t=0,r=0,i=this.vertices.length;i>r;r++)e=this.vertices[r].position.length(),e>t&&(t=e);this.boundingSphere.radius=t},mergeVertices:function(){var e,r,i,n={},o=[],a=[],s=Math.pow(10,4);for(r=0,i=this.vertices.length;i>r;r++)e=this.vertices[r].position,e=[Math.round(e.x*s),Math.round(e.y*s),Math.round(e.z*s)].join("_"),void 0===n[e]?(n[e]=r,o.push(this.vertices[r]),a[r]=o.length-1):a[r]=a[n[e]];for(r=0,i=this.faces.length;i>r;r++)n=this.faces[r],n instanceof t.Face3?(n.a=a[n.a],n.b=a[n.b],n.c=a[n.c]):n instanceof t.Face4&&(n.a=a[n.a],n.b=a[n.b],n.c=a[n.c],n.d=a[n.d]);this.vertices=o}},t.GeometryCount=0,t.Spline=function(e){function r(e,t,r,i,n,o,a){return e=.5*(r-e),i=.5*(i-t),(2*(t-r)+e+i)*a+(-3*(t-r)-2*e-i)*o+e*n+t}this.points=e;var i,n,o,a,s,l,c,h,p,d=[],u={x:0,y:0,z:0};this.initFromArray=function(e){this.points=[];for(var t=0;t<e.length;t++)this.points[t]={x:e[t][0],y:e[t][1],z:e[t][2]}},this.getPoint=function(e){return i=(this.points.length-1)*e,n=Math.floor(i),o=i-n,d[0]=0===n?n:n-1,d[1]=n,d[2]=n>this.points.length-2?n:n+1,d[3]=n>this.points.length-3?n:n+2,l=this.points[d[0]],c=this.points[d[1]],h=this.points[d[2]],p=this.points[d[3]],a=o*o,s=o*a,u.x=r(l.x,c.x,h.x,p.x,o,a,s),u.y=r(l.y,c.y,h.y,p.y,o,a,s),u.z=r(l.z,c.z,h.z,p.z,o,a,s),u},this.getControlPointsArray=function(){var e,t,r=this.points.length,i=[];for(e=0;r>e;e++)t=this.points[e],i[e]=[t.x,t.y,t.z];return i},this.getLength=function(e){var r,i,n,o=r=r=0,a=new t.Vector3,s=new t.Vector3,l=[],c=0;for(l[0]=0,e||(e=100),i=this.points.length*e,a.copy(this.points[0]),e=1;i>e;e++)r=e/i,n=this.getPoint(r),s.copy(n),c+=s.distanceTo(a),a.copy(n),r*=this.points.length-1,r=Math.floor(r),r!=o&&(l[r]=c,o=r);return l[l.length]=c,{chunks:l,total:c}},this.reparametrizeByArcLength=function(e){var r,i,n,o,a,s,l=[],c=new t.Vector3,h=this.getLength();for(l.push(c.copy(this.points[0]).clone()),r=1;r<this.points.length;r++){for(i=h.chunks[r]-h.chunks[r-1],s=Math.ceil(e*i/h.total),o=(r-1)/(this.points.length-1),a=r/(this.points.length-1),i=1;s-1>i;i++)n=o+i*(1/s)*(a-o),n=this.getPoint(n),l.push(c.copy(n).clone());l.push(c.copy(this.points[r]).clone())}this.points=l}},t.Camera=function(){t.Object3D.call(this),this.matrixWorldInverse=new t.Matrix4,this.projectionMatrix=new t.Matrix4,this.projectionMatrixInverse=new t.Matrix4},t.Camera.prototype=new t.Object3D,t.Camera.prototype.constructor=t.Camera,t.Camera.prototype.lookAt=function(e){this.matrix.lookAt(this.position,e,this.up),this.rotationAutoUpdate&&this.rotation.getRotationFromMatrix(this.matrix)},t.OrthographicCamera=function(e,r,i,n,o,a){t.Camera.call(this),this.left=e,this.right=r,this.top=i,this.bottom=n,this.near=void 0!==o?o:.1,this.far=void 0!==a?a:2e3,this.updateProjectionMatrix()},t.OrthographicCamera.prototype=new t.Camera,t.OrthographicCamera.prototype.constructor=t.OrthographicCamera,t.OrthographicCamera.prototype.updateProjectionMatrix=function(){this.projectionMatrix=t.Matrix4.makeOrtho(this.left,this.right,this.top,this.bottom,this.near,this.far)},t.PerspectiveCamera=function(e,r,i,n){t.Camera.call(this),this.fov=void 0!==e?e:50,this.aspect=void 0!==r?r:1,this.near=void 0!==i?i:.1,this.far=void 0!==n?n:2e3,this.updateProjectionMatrix()},t.PerspectiveCamera.prototype=new t.Camera,t.PerspectiveCamera.prototype.constructor=t.PerspectiveCamera,t.PerspectiveCamera.prototype.setLens=function(e,t){this.fov=2*Math.atan((void 0!==t?t:24)/(2*e))*(180/Math.PI),this.updateProjectionMatrix()},t.PerspectiveCamera.prototype.setViewOffset=function(e,t,r,i,n,o){this.fullWidth=e,this.fullHeight=t,this.x=r,this.y=i,this.width=n,this.height=o,this.updateProjectionMatrix()},t.PerspectiveCamera.prototype.updateProjectionMatrix=function(){if(this.fullWidth){var e=this.fullWidth/this.fullHeight,r=Math.tan(this.fov*Math.PI/360)*this.near,i=-r,n=e*i,e=Math.abs(e*r-n),i=Math.abs(r-i);this.projectionMatrix=t.Matrix4.makeFrustum(n+this.x*e/this.fullWidth,n+(this.x+this.width)*e/this.fullWidth,r-(this.y+this.height)*i/this.fullHeight,r-this.y*i/this.fullHeight,this.near,this.far)}else this.projectionMatrix=t.Matrix4.makePerspective(this.fov,this.aspect,this.near,this.far)},t.Light=function(e){t.Object3D.call(this),this.color=new t.Color(e)},t.Light.prototype=new t.Object3D,t.Light.prototype.constructor=t.Light,t.Light.prototype.supr=t.Object3D.prototype,t.AmbientLight=function(e){t.Light.call(this,e)},t.AmbientLight.prototype=new t.Light,t.AmbientLight.prototype.constructor=t.AmbientLight,t.DirectionalLight=function(e,r,i){t.Light.call(this,e),this.position=new t.Vector3(0,1,0),this.target=new t.Object3D,this.intensity=void 0!==r?r:1,this.distance=void 0!==i?i:0,this.onlyShadow=this.castShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraLeft=-500,this.shadowCameraTop=this.shadowCameraRight=500,this.shadowCameraBottom=-500,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapHeight=this.shadowMapWidth=512,this.shadowCascade=!1,this.shadowCascadeOffset=new t.Vector3(0,0,-1e3),this.shadowCascadeCount=2,this.shadowCascadeBias=[0,0,0],this.shadowCascadeWidth=[512,512,512],this.shadowCascadeHeight=[512,512,512],this.shadowCascadeNearZ=[-1,.99,.998],this.shadowCascadeFarZ=[.99,.998,1],this.shadowCascadeArray=[],this.shadowMatrix=this.shadowCamera=this.shadowMapSize=this.shadowMap=null},t.DirectionalLight.prototype=new t.Light,t.DirectionalLight.prototype.constructor=t.DirectionalLight,t.PointLight=function(e,r,i){t.Light.call(this,e),this.position=new t.Vector3(0,0,0),this.intensity=void 0!==r?r:1,this.distance=void 0!==i?i:0},t.PointLight.prototype=new t.Light,t.PointLight.prototype.constructor=t.PointLight,t.SpotLight=function(e,r,i,n){t.Light.call(this,e),this.position=new t.Vector3(0,1,0),this.target=new t.Object3D,this.intensity=void 0!==r?r:1,this.distance=void 0!==i?i:0,this.castShadow=void 0!==n?n:!1,this.onlyShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraFov=50,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapHeight=this.shadowMapWidth=512,this.shadowMatrix=this.shadowCamera=this.shadowMapSize=this.shadowMap=null},t.SpotLight.prototype=new t.Light,t.SpotLight.prototype.constructor=t.SpotLight,t.Material=function(e){e=e||{},this.id=t.MaterialCount++,this.name="",this.opacity=void 0!==e.opacity?e.opacity:1,this.transparent=void 0!==e.transparent?e.transparent:!1,this.blending=void 0!==e.blending?e.blending:t.NormalBlending,this.depthTest=void 0!==e.depthTest?e.depthTest:!0,this.depthWrite=void 0!==e.depthWrite?e.depthWrite:!0,this.polygonOffset=void 0!==e.polygonOffset?e.polygonOffset:!1,this.polygonOffsetFactor=void 0!==e.polygonOffsetFactor?e.polygonOffsetFactor:0,this.polygonOffsetUnits=void 0!==e.polygonOffsetUnits?e.polygonOffsetUnits:0,this.alphaTest=void 0!==e.alphaTest?e.alphaTest:0,this.overdraw=void 0!==e.overdraw?e.overdraw:!1},t.MaterialCount=0,t.NoShading=0,t.FlatShading=1,t.SmoothShading=2,t.NoColors=0,t.FaceColors=1,t.VertexColors=2,t.NoBlending=0,t.NormalBlending=1,t.AdditiveBlending=2,t.SubtractiveBlending=3,t.MultiplyBlending=4,t.AdditiveAlphaBlending=5,t.LineBasicMaterial=function(e){t.Material.call(this,e),e=e||{},this.color=void 0!==e.color?new t.Color(e.color):new t.Color(16777215),this.linewidth=void 0!==e.linewidth?e.linewidth:1,this.linecap=void 0!==e.linecap?e.linecap:"round",this.linejoin=void 0!==e.linejoin?e.linejoin:"round",this.vertexColors=e.vertexColors?e.vertexColors:!1,this.fog=void 0!==e.fog?e.fog:!0},t.LineBasicMaterial.prototype=new t.Material,t.LineBasicMaterial.prototype.constructor=t.LineBasicMaterial,t.MeshBasicMaterial=function(e){t.Material.call(this,e),e=e||{},this.color=void 0!==e.color?new t.Color(e.color):new t.Color(16777215),this.map=void 0!==e.map?e.map:null,this.lightMap=void 0!==e.lightMap?e.lightMap:null,this.envMap=void 0!==e.envMap?e.envMap:null,this.combine=void 0!==e.combine?e.combine:t.MultiplyOperation,this.reflectivity=void 0!==e.reflectivity?e.reflectivity:1,this.refractionRatio=void 0!==e.refractionRatio?e.refractionRatio:.98,this.fog=void 0!==e.fog?e.fog:!0,this.shading=void 0!==e.shading?e.shading:t.SmoothShading,this.wireframe=void 0!==e.wireframe?e.wireframe:!1,this.wireframeLinewidth=void 0!==e.wireframeLinewidth?e.wireframeLinewidth:1,this.wireframeLinecap=void 0!==e.wireframeLinecap?e.wireframeLinecap:"round",this.wireframeLinejoin=void 0!==e.wireframeLinejoin?e.wireframeLinejoin:"round",this.vertexColors=void 0!==e.vertexColors?e.vertexColors:!1,this.skinning=void 0!==e.skinning?e.skinning:!1,this.morphTargets=void 0!==e.morphTargets?e.morphTargets:!1},t.MeshBasicMaterial.prototype=new t.Material,t.MeshBasicMaterial.prototype.constructor=t.MeshBasicMaterial,t.MeshLambertMaterial=function(e){t.Material.call(this,e),e=e||{},this.color=void 0!==e.color?new t.Color(e.color):new t.Color(16777215),this.ambient=void 0!==e.ambient?new t.Color(e.ambient):new t.Color(16777215),this.wrapAround=void 0!==e.wrapAround?e.wrapAround:!1,this.wrapRGB=new t.Vector3(1,1,1),this.map=void 0!==e.map?e.map:null,this.lightMap=void 0!==e.lightMap?e.lightMap:null,this.envMap=void 0!==e.envMap?e.envMap:null,this.combine=void 0!==e.combine?e.combine:t.MultiplyOperation,this.reflectivity=void 0!==e.reflectivity?e.reflectivity:1,this.refractionRatio=void 0!==e.refractionRatio?e.refractionRatio:.98,this.fog=void 0!==e.fog?e.fog:!0,this.shading=void 0!==e.shading?e.shading:t.SmoothShading,this.wireframe=void 0!==e.wireframe?e.wireframe:!1,this.wireframeLinewidth=void 0!==e.wireframeLinewidth?e.wireframeLinewidth:1,this.wireframeLinecap=void 0!==e.wireframeLinecap?e.wireframeLinecap:"round",this.wireframeLinejoin=void 0!==e.wireframeLinejoin?e.wireframeLinejoin:"round",this.vertexColors=void 0!==e.vertexColors?e.vertexColors:!1,this.skinning=void 0!==e.skinning?e.skinning:!1,this.morphTargets=void 0!==e.morphTargets?e.morphTargets:!1,this.morphNormals=void 0!==e.morphNormals?e.morphNormals:!1},t.MeshLambertMaterial.prototype=new t.Material,t.MeshLambertMaterial.prototype.constructor=t.MeshLambertMaterial,t.MeshPhongMaterial=function(e){t.Material.call(this,e),e=e||{},this.color=void 0!==e.color?new t.Color(e.color):new t.Color(16777215),this.ambient=void 0!==e.ambient?new t.Color(e.ambient):new t.Color(16777215),this.specular=void 0!==e.specular?new t.Color(e.specular):new t.Color(1118481),this.shininess=void 0!==e.shininess?e.shininess:30,this.metal=void 0!==e.metal?e.metal:!1,this.perPixel=void 0!==e.perPixel?e.perPixel:!1,this.wrapAround=void 0!==e.wrapAround?e.wrapAround:!1,this.wrapRGB=new t.Vector3(1,1,1),this.map=void 0!==e.map?e.map:null,this.lightMap=void 0!==e.lightMap?e.lightMap:null,this.envMap=void 0!==e.envMap?e.envMap:null,this.combine=void 0!==e.combine?e.combine:t.MultiplyOperation,this.reflectivity=void 0!==e.reflectivity?e.reflectivity:1,this.refractionRatio=void 0!==e.refractionRatio?e.refractionRatio:.98,this.fog=void 0!==e.fog?e.fog:!0,this.shading=void 0!==e.shading?e.shading:t.SmoothShading,this.wireframe=void 0!==e.wireframe?e.wireframe:!1,this.wireframeLinewidth=void 0!==e.wireframeLinewidth?e.wireframeLinewidth:1,this.wireframeLinecap=void 0!==e.wireframeLinecap?e.wireframeLinecap:"round",this.wireframeLinejoin=void 0!==e.wireframeLinejoin?e.wireframeLinejoin:"round",this.vertexColors=void 0!==e.vertexColors?e.vertexColors:!1,this.skinning=void 0!==e.skinning?e.skinning:!1,this.morphTargets=void 0!==e.morphTargets?e.morphTargets:!1,this.morphNormals=void 0!==e.morphNormals?e.morphNormals:!1},t.MeshPhongMaterial.prototype=new t.Material,t.MeshPhongMaterial.prototype.constructor=t.MeshPhongMaterial,t.MeshDepthMaterial=function(e){t.Material.call(this,e),e=e||{},this.shading=void 0!==e.shading?e.shading:t.SmoothShading,this.wireframe=void 0!==e.wireframe?e.wireframe:!1,this.wireframeLinewidth=void 0!==e.wireframeLinewidth?e.wireframeLinewidth:1},t.MeshDepthMaterial.prototype=new t.Material,t.MeshDepthMaterial.prototype.constructor=t.MeshDepthMaterial,t.MeshNormalMaterial=function(e){t.Material.call(this,e),e=e||{},this.shading=e.shading?e.shading:t.FlatShading,this.wireframe=e.wireframe?e.wireframe:!1,this.wireframeLinewidth=e.wireframeLinewidth?e.wireframeLinewidth:1},t.MeshNormalMaterial.prototype=new t.Material,t.MeshNormalMaterial.prototype.constructor=t.MeshNormalMaterial,t.MeshFaceMaterial=function(){},t.ParticleBasicMaterial=function(e){t.Material.call(this,e),e=e||{},this.color=void 0!==e.color?new t.Color(e.color):new t.Color(16777215),this.map=void 0!==e.map?e.map:null,this.size=void 0!==e.size?e.size:1,this.sizeAttenuation=void 0!==e.sizeAttenuation?e.sizeAttenuation:!0,this.vertexColors=void 0!==e.vertexColors?e.vertexColors:!1,this.fog=void 0!==e.fog?e.fog:!0},t.ParticleBasicMaterial.prototype=new t.Material,t.ParticleBasicMaterial.prototype.constructor=t.ParticleBasicMaterial,t.ParticleCanvasMaterial=function(e){t.Material.call(this,e),e=e||{},this.color=void 0!==e.color?new t.Color(e.color):new t.Color(16777215),this.program=void 0!==e.program?e.program:function(){}},t.ParticleCanvasMaterial.prototype=new t.Material,t.ParticleCanvasMaterial.prototype.constructor=t.ParticleCanvasMaterial,t.ParticleDOMMaterial=function(e){t.Material.call(this),this.domElement=e},t.ShaderMaterial=function(e){t.Material.call(this,e),e=e||{},this.fragmentShader=void 0!==e.fragmentShader?e.fragmentShader:"void main() {}",this.vertexShader=void 0!==e.vertexShader?e.vertexShader:"void main() {}",this.uniforms=void 0!==e.uniforms?e.uniforms:{},this.attributes=e.attributes,this.shading=void 0!==e.shading?e.shading:t.SmoothShading,this.wireframe=void 0!==e.wireframe?e.wireframe:!1,this.wireframeLinewidth=void 0!==e.wireframeLinewidth?e.wireframeLinewidth:1,this.fog=void 0!==e.fog?e.fog:!1,this.lights=void 0!==e.lights?e.lights:!1,this.vertexColors=void 0!==e.vertexColors?e.vertexColors:!1,this.skinning=void 0!==e.skinning?e.skinning:!1,this.morphTargets=void 0!==e.morphTargets?e.morphTargets:!1},t.ShaderMaterial.prototype=new t.Material,t.ShaderMaterial.prototype.constructor=t.ShaderMaterial,t.Texture=function(e,r,i,n,o,a,s,l){this.id=t.TextureCount++,this.image=e,this.mapping=void 0!==r?r:new t.UVMapping,this.wrapS=void 0!==i?i:t.ClampToEdgeWrapping,this.wrapT=void 0!==n?n:t.ClampToEdgeWrapping,this.magFilter=void 0!==o?o:t.LinearFilter,this.minFilter=void 0!==a?a:t.LinearMipMapLinearFilter,this.format=void 0!==s?s:t.RGBAFormat,this.type=void 0!==l?l:t.UnsignedByteType,this.offset=new t.Vector2(0,0),this.repeat=new t.Vector2(1,1),this.generateMipmaps=!0,this.needsUpdate=!1,this.onUpdate=null},t.Texture.prototype={constructor:t.Texture,clone:function(){var e=new t.Texture(this.image,this.mapping,this.wrapS,this.wrapT,this.magFilter,this.minFilter,this.format,this.type);return e.offset.copy(this.offset),e.repeat.copy(this.repeat),e}},t.TextureCount=0,t.MultiplyOperation=0,t.MixOperation=1,t.CubeReflectionMapping=function(){},t.CubeRefractionMapping=function(){},t.LatitudeReflectionMapping=function(){},t.LatitudeRefractionMapping=function(){},t.SphericalReflectionMapping=function(){},t.SphericalRefractionMapping=function(){},t.UVMapping=function(){},t.RepeatWrapping=0,t.ClampToEdgeWrapping=1,t.MirroredRepeatWrapping=2,t.NearestFilter=3,t.NearestMipMapNearestFilter=4,t.NearestMipMapLinearFilter=5,t.LinearFilter=6,t.LinearMipMapNearestFilter=7,t.LinearMipMapLinearFilter=8,t.ByteType=9,t.UnsignedByteType=10,t.ShortType=11,t.UnsignedShortType=12,t.IntType=13,t.UnsignedIntType=14,t.FloatType=15,t.AlphaFormat=16,t.RGBFormat=17,t.RGBAFormat=18,t.LuminanceFormat=19,t.LuminanceAlphaFormat=20,t.DataTexture=function(e,r,i,n,o,a,s,l,c,h){t.Texture.call(this,null,a,s,l,c,h,n,o),this.image={data:e,width:r,height:i}},t.DataTexture.prototype=new t.Texture,t.DataTexture.prototype.constructor=t.DataTexture,t.DataTexture.prototype.clone=function(){var e=new t.DataTexture(this.image.data,this.image.width,this.image.height,this.format,this.type,this.mapping,this.wrapS,this.wrapT,this.magFilter,this.minFilter);return e.offset.copy(this.offset),e.repeat.copy(this.repeat),e},t.Particle=function(e){t.Object3D.call(this),this.material=e},t.Particle.prototype=new t.Object3D,t.Particle.prototype.constructor=t.Particle,t.ParticleSystem=function(e,r){t.Object3D.call(this),this.geometry=e,this.material=void 0!==r?r:new t.ParticleBasicMaterial({color:16777215*Math.random()}),this.sortParticles=!1,this.geometry&&(this.geometry.boundingSphere||this.geometry.computeBoundingSphere(),this.boundRadius=e.boundingSphere.radius),this.frustumCulled=!1},t.ParticleSystem.prototype=new t.Object3D,t.ParticleSystem.prototype.constructor=t.ParticleSystem,t.Line=function(e,r,i){t.Object3D.call(this),this.geometry=e,this.material=void 0!==r?r:new t.LineBasicMaterial({color:16777215*Math.random()}),this.type=void 0!==i?i:t.LineStrip,this.geometry&&(this.geometry.boundingSphere||this.geometry.computeBoundingSphere())},t.LineStrip=0,t.LinePieces=1,t.Line.prototype=new t.Object3D,t.Line.prototype.constructor=t.Line,t.Mesh=function(e,r){if(t.Object3D.call(this),this.geometry=e,this.material=void 0!==r?r:new t.MeshBasicMaterial({color:16777215*Math.random(),wireframe:!0}),this.geometry&&(this.geometry.boundingSphere||this.geometry.computeBoundingSphere(),this.boundRadius=e.boundingSphere.radius,this.geometry.morphTargets.length)){this.morphTargetBase=-1,this.morphTargetForcedOrder=[],this.morphTargetInfluences=[],this.morphTargetDictionary={};
for(var i=0;i<this.geometry.morphTargets.length;i++)this.morphTargetInfluences.push(0),this.morphTargetDictionary[this.geometry.morphTargets[i].name]=i}},t.Mesh.prototype=new t.Object3D,t.Mesh.prototype.constructor=t.Mesh,t.Mesh.prototype.supr=t.Object3D.prototype,t.Mesh.prototype.getMorphTargetIndexByName=function(e){return void 0!==this.morphTargetDictionary[e]?this.morphTargetDictionary[e]:(console.log("THREE.Mesh.getMorphTargetIndexByName: morph target "+e+" does not exist. Returning 0."),0)},t.Bone=function(e){t.Object3D.call(this),this.skin=e,this.skinMatrix=new t.Matrix4},t.Bone.prototype=new t.Object3D,t.Bone.prototype.constructor=t.Bone,t.Bone.prototype.supr=t.Object3D.prototype,t.Bone.prototype.update=function(e,t){this.matrixAutoUpdate&&(t|=this.updateMatrix()),(t||this.matrixWorldNeedsUpdate)&&(e?this.skinMatrix.multiply(e,this.matrix):this.skinMatrix.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);var r,i=this.children.length;for(r=0;i>r;r++)this.children[r].update(this.skinMatrix,t)},t.SkinnedMesh=function(e,r){t.Mesh.call(this,e,r),this.identityMatrix=new t.Matrix4,this.bones=[],this.boneMatrices=[];var i,n,o,a,s,l;if(void 0!==this.geometry.bones){for(i=0;i<this.geometry.bones.length;i++)o=this.geometry.bones[i],a=o.pos,s=o.rotq,l=o.scl,n=this.addBone(),n.name=o.name,n.position.set(a[0],a[1],a[2]),n.quaternion.set(s[0],s[1],s[2],s[3]),n.useQuaternion=!0,void 0!==l?n.scale.set(l[0],l[1],l[2]):n.scale.set(1,1,1);for(i=0;i<this.bones.length;i++)o=this.geometry.bones[i],n=this.bones[i],-1===o.parent?this.add(n):this.bones[o.parent].add(n);this.boneMatrices=new Float32Array(16*this.bones.length),this.pose()}},t.SkinnedMesh.prototype=new t.Mesh,t.SkinnedMesh.prototype.constructor=t.SkinnedMesh,t.SkinnedMesh.prototype.addBone=function(e){return void 0===e&&(e=new t.Bone(this)),this.bones.push(e),e},t.SkinnedMesh.prototype.updateMatrixWorld=function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(this.parent?this.matrixWorld.multiply(this.parent.matrixWorld,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1);for(var e=0,r=this.children.length;r>e;e++){var i=this.children[e];i instanceof t.Bone?i.update(this.identityMatrix,!1):i.updateMatrixWorld(!0)}for(var r=this.bones.length,i=this.bones,n=this.boneMatrices,e=0;r>e;e++)i[e].skinMatrix.flattenToArrayOffset(n,16*e)},t.SkinnedMesh.prototype.pose=function(){this.updateMatrixWorld(!0);for(var e,r=[],i=0;i<this.bones.length;i++){e=this.bones[i];var n=new t.Matrix4;n.getInverse(e.skinMatrix),r.push(n),e.skinMatrix.flattenToArrayOffset(this.boneMatrices,16*i)}if(void 0===this.geometry.skinVerticesA)for(this.geometry.skinVerticesA=[],this.geometry.skinVerticesB=[],e=0;e<this.geometry.skinIndices.length;e++){var i=this.geometry.vertices[e].position,o=this.geometry.skinIndices[e].x,a=this.geometry.skinIndices[e].y,n=new t.Vector3(i.x,i.y,i.z);this.geometry.skinVerticesA.push(r[o].multiplyVector3(n)),n=new t.Vector3(i.x,i.y,i.z),this.geometry.skinVerticesB.push(r[a].multiplyVector3(n)),1!==this.geometry.skinWeights[e].x+this.geometry.skinWeights[e].y&&(i=.5*(1-(this.geometry.skinWeights[e].x+this.geometry.skinWeights[e].y)),this.geometry.skinWeights[e].x+=i,this.geometry.skinWeights[e].y+=i)}},t.MorphAnimMesh=function(e,r){t.Mesh.call(this,e,r),this.duration=1e3,this.mirroredLoop=!1,this.currentKeyframe=this.lastKeyframe=this.time=0,this.direction=1,this.directionBackwards=!1,this.setFrameRange(0,this.geometry.morphTargets.length-1)},t.MorphAnimMesh.prototype=new t.Mesh,t.MorphAnimMesh.prototype.constructor=t.MorphAnimMesh,t.MorphAnimMesh.prototype.setFrameRange=function(e,t){this.startKeyframe=e,this.endKeyframe=t,this.length=this.endKeyframe-this.startKeyframe+1},t.MorphAnimMesh.prototype.setDirectionForward=function(){this.direction=1,this.directionBackwards=!1},t.MorphAnimMesh.prototype.setDirectionBackward=function(){this.direction=-1,this.directionBackwards=!0},t.MorphAnimMesh.prototype.parseAnimations=function(){var e=this.geometry;e.animations||(e.animations={});for(var t,r=e.animations,i=/([a-z]+)(\d+)/,n=0,o=e.morphTargets.length;o>n;n++){var a=e.morphTargets[n].name.match(i);if(a&&1<a.length){a=a[1],r[a]||(r[a]={start:1/0,end:-1/0});var s=r[a];n<s.start&&(s.start=n),n>s.end&&(s.end=n),t||(t=a)}}e.firstAnimation=t},t.MorphAnimMesh.prototype.setAnimationLabel=function(e,t,r){this.geometry.animations||(this.geometry.animations={}),this.geometry.animations[e]={start:t,end:r}},t.MorphAnimMesh.prototype.playAnimation=function(e,t){var r=this.geometry.animations[e];r?(this.setFrameRange(r.start,r.end),this.duration=1e3*((r.end-r.start)/t),this.time=0):console.warn("animation["+e+"] undefined")},t.MorphAnimMesh.prototype.updateAnimation=function(e){var r=this.duration/this.length;this.time+=this.direction*e,this.mirroredLoop?(this.time>this.duration||0>this.time)&&(this.direction*=-1,this.time>this.duration&&(this.time=this.duration,this.directionBackwards=!0),0>this.time&&(this.time=0,this.directionBackwards=!1)):(this.time%=this.duration,0>this.time&&(this.time+=this.duration)),e=this.startKeyframe+t.Math.clamp(Math.floor(this.time/r),0,this.length-1),e!==this.currentKeyframe&&(this.morphTargetInfluences[this.lastKeyframe]=0,this.morphTargetInfluences[this.currentKeyframe]=1,this.morphTargetInfluences[e]=0,this.lastKeyframe=this.currentKeyframe,this.currentKeyframe=e),r=this.time%r/r,this.directionBackwards&&(r=1-r),this.morphTargetInfluences[this.currentKeyframe]=r,this.morphTargetInfluences[this.lastKeyframe]=1-r},t.Ribbon=function(e,r){t.Object3D.call(this),this.geometry=e,this.material=r},t.Ribbon.prototype=new t.Object3D,t.Ribbon.prototype.constructor=t.Ribbon,t.LOD=function(){t.Object3D.call(this),this.LODs=[]},t.LOD.prototype=new t.Object3D,t.LOD.prototype.constructor=t.LOD,t.LOD.prototype.supr=t.Object3D.prototype,t.LOD.prototype.addLevel=function(e,t){void 0===t&&(t=0);for(var t=Math.abs(t),r=0;r<this.LODs.length&&!(t<this.LODs[r].visibleAtDistance);r++);this.LODs.splice(r,0,{visibleAtDistance:t,object3D:e}),this.add(e)},t.LOD.prototype.update=function(e){if(1<this.LODs.length){e.matrixWorldInverse.getInverse(e.matrixWorld),e=e.matrixWorldInverse,e=-(e.n31*this.matrixWorld.n14+e.n32*this.matrixWorld.n24+e.n33*this.matrixWorld.n34+e.n34),this.LODs[0].object3D.visible=!0;for(var t=1;t<this.LODs.length&&e>=this.LODs[t].visibleAtDistance;t++)this.LODs[t-1].object3D.visible=!1,this.LODs[t].object3D.visible=!0;for(;t<this.LODs.length;t++)this.LODs[t].object3D.visible=!1}},t.Sprite=function(e){t.Object3D.call(this),this.color=void 0!==e.color?new t.Color(e.color):new t.Color(16777215),this.map=void 0!==e.map?e.map:new t.Texture,this.blending=void 0!==e.blending?e.blending:t.NormalBlending,this.useScreenCoordinates=void 0!==e.useScreenCoordinates?e.useScreenCoordinates:!0,this.mergeWith3D=void 0!==e.mergeWith3D?e.mergeWith3D:!this.useScreenCoordinates,this.affectedByDistance=void 0!==e.affectedByDistance?e.affectedByDistance:!this.useScreenCoordinates,this.scaleByViewport=void 0!==e.scaleByViewport?e.scaleByViewport:!this.affectedByDistance,this.alignment=e.alignment instanceof t.Vector2?e.alignment:t.SpriteAlignment.center,this.rotation3d=this.rotation,this.rotation=0,this.opacity=1,this.uvOffset=new t.Vector2(0,0),this.uvScale=new t.Vector2(1,1)},t.Sprite.prototype=new t.Object3D,t.Sprite.prototype.constructor=t.Sprite,t.Sprite.prototype.updateMatrix=function(){this.matrix.setPosition(this.position),this.rotation3d.set(0,0,this.rotation),this.matrix.setRotationFromEuler(this.rotation3d),(1!==this.scale.x||1!==this.scale.y)&&(this.matrix.scale(this.scale),this.boundRadiusScale=Math.max(this.scale.x,this.scale.y)),this.matrixWorldNeedsUpdate=!0},t.SpriteAlignment={},t.SpriteAlignment.topLeft=new t.Vector2(1,-1),t.SpriteAlignment.topCenter=new t.Vector2(0,-1),t.SpriteAlignment.topRight=new t.Vector2(-1,-1),t.SpriteAlignment.centerLeft=new t.Vector2(1,0),t.SpriteAlignment.center=new t.Vector2(0,0),t.SpriteAlignment.centerRight=new t.Vector2(-1,0),t.SpriteAlignment.bottomLeft=new t.Vector2(1,1),t.SpriteAlignment.bottomCenter=new t.Vector2(0,1),t.SpriteAlignment.bottomRight=new t.Vector2(-1,1),t.Scene=function(){t.Object3D.call(this),this.overrideMaterial=this.fog=null,this.matrixAutoUpdate=!1,this.__objects=[],this.__lights=[],this.__objectsAdded=[],this.__objectsRemoved=[]},t.Scene.prototype=new t.Object3D,t.Scene.prototype.constructor=t.Scene,t.Scene.prototype.__addObject=function(e){if(e instanceof t.Light)-1===this.__lights.indexOf(e)&&this.__lights.push(e);else if(!(e instanceof t.Camera||e instanceof t.Bone)&&-1===this.__objects.indexOf(e)){this.__objects.push(e),this.__objectsAdded.push(e);var r=this.__objectsRemoved.indexOf(e);-1!==r&&this.__objectsRemoved.splice(r,1)}for(r=0;r<e.children.length;r++)this.__addObject(e.children[r])},t.Scene.prototype.__removeObject=function(e){if(e instanceof t.Light){var r=this.__lights.indexOf(e);-1!==r&&this.__lights.splice(r,1)}else e instanceof t.Camera||(r=this.__objects.indexOf(e),-1!==r&&(this.__objects.splice(r,1),this.__objectsRemoved.push(e),r=this.__objectsAdded.indexOf(e),-1!==r&&this.__objectsAdded.splice(r,1)));for(r=0;r<e.children.length;r++)this.__removeObject(e.children[r])},t.Fog=function(e,r,i){this.color=new t.Color(e),this.near=void 0!==r?r:1,this.far=void 0!==i?i:1e3},t.FogExp2=function(e,r){this.color=new t.Color(e),this.density=void 0!==r?r:25e-5},t.DOMRenderer=function(){var e,r,i,n,o,a,s=new t.Projector;this.domElement=document.createElement("div"),this.setSize=function(e,t){i=e,n=t,o=i/2,a=n/2},this.render=function(i,n){var l,c,h,p,d;for(e=s.projectScene(i,n),r=e.elements,l=0,c=r.length;c>l;l++)h=r[l],h instanceof t.RenderableParticle&&(p=h.x*o+o,d=h.y*a+a,h=h.material,h instanceof t.ParticleDOMMaterial)&&(h=h.domElement,h.style.left=p+"px",h.style.top=d+"px")}},t.CanvasRenderer=function(e){function r(e){$!=e&&(q.globalAlpha=$=e)}function i(e){if(Q!=e){switch(e){case t.NormalBlending:q.globalCompositeOperation="source-over";break;case t.AdditiveBlending:q.globalCompositeOperation="lighter";break;case t.SubtractiveBlending:q.globalCompositeOperation="darker"}Q=e}}function n(e){J!=e&&(q.strokeStyle=J=e)}function o(e){et!=e&&(q.fillStyle=et=e)}var a,s,l,c,h,p,d,u,f,m,g,b,v,x,y,w,_,M,S,k,T,C,A,E,L,R,z,N,P,D,F,V,B,U,O,I,j,W,H,e=e||{},G=this,X=new t.Projector,Y=void 0!==e.canvas?e.canvas:document.createElement("canvas"),q=Y.getContext("2d"),Z=new t.Color(0),K=0,$=1,Q=0,J=null,et=null,tt=null,rt=null,it=null,nt=new t.RenderableVertex,ot=new t.RenderableVertex,at=new t.Color,st=new t.Color,lt=new t.Color,ct=new t.Color,ht=new t.Color,pt=[],dt=[],ut=new t.Rectangle,ft=new t.Rectangle,mt=new t.Rectangle,gt=!1,bt=new t.Color,vt=new t.Color,xt=new t.Color,yt=new t.Vector3,e=16;U=document.createElement("canvas"),U.width=U.height=2,O=U.getContext("2d"),O.fillStyle="rgba(0,0,0,1)",O.fillRect(0,0,2,2),I=O.getImageData(0,0,2,2),j=I.data,W=document.createElement("canvas"),W.width=W.height=e,H=W.getContext("2d"),H.translate(-e/2,-e/2),H.scale(e,e),e--,this.domElement=Y,this.sortElements=this.sortObjects=this.autoClear=!0,this.info={render:{vertices:0,faces:0}},this.setSize=function(e,t){c=e,h=t,p=Math.floor(c/2),d=Math.floor(h/2),Y.width=c,Y.height=h,ut.set(-p,-d,p,d),ft.set(-p,-d,p,d),$=1,Q=0,it=rt=tt=et=J=null},this.setClearColor=function(e,t){Z.copy(e),K=t,ft.set(-p,-d,p,d)},this.setClearColorHex=function(e,t){Z.setHex(e),K=t,ft.set(-p,-d,p,d)},this.clear=function(){q.setTransform(1,0,0,-1,p,d),ft.isEmpty()||(ft.minSelf(ut),ft.inflate(2),1>K&&q.clearRect(Math.floor(ft.getX()),Math.floor(ft.getY()),Math.floor(ft.getWidth()),Math.floor(ft.getHeight())),K>0&&(i(t.NormalBlending),r(1),o("rgba("+Math.floor(255*Z.r)+","+Math.floor(255*Z.g)+","+Math.floor(255*Z.b)+","+K+")"),q.fillRect(Math.floor(ft.getX()),Math.floor(ft.getY()),Math.floor(ft.getWidth()),Math.floor(ft.getHeight()))),ft.empty())},this.render=function(e,c){function h(e){var r,i,n,o;for(bt.setRGB(0,0,0),vt.setRGB(0,0,0),xt.setRGB(0,0,0),r=0,i=e.length;i>r;r++)n=e[r],o=n.color,n instanceof t.AmbientLight?(bt.r+=o.r,bt.g+=o.g,bt.b+=o.b):n instanceof t.DirectionalLight?(vt.r+=o.r,vt.g+=o.g,vt.b+=o.b):n instanceof t.PointLight&&(xt.r+=o.r,xt.g+=o.g,xt.b+=o.b)}function Y(e,r,i,n){var o,a,s,l,c,h;for(o=0,a=e.length;a>o;o++)s=e[o],l=s.color,s instanceof t.DirectionalLight?(c=s.matrixWorld.getPosition(),h=i.dot(c),0>=h||(h*=s.intensity,n.r+=l.r*h,n.g+=l.g*h,n.b+=l.b*h)):s instanceof t.PointLight&&(c=s.matrixWorld.getPosition(),h=i.dot(yt.sub(c,r).normalize()),0>=h||(h*=0==s.distance?1:1-Math.min(r.distanceTo(c)/s.distance,1),0!=h&&(h*=s.intensity,n.r+=l.r*h,n.g+=l.g*h,n.b+=l.b*h)))}function Z(e,a,s){r(s.opacity),i(s.blending);var l,c,h,u,f,m;s instanceof t.ParticleBasicMaterial?s.map&&(u=s.map.image,f=u.width>>1,m=u.height>>1,s=a.scale.x*p,h=a.scale.y*d,l=s*f,c=h*m,mt.set(e.x-l,e.y-c,e.x+l,e.y+c),ut.intersects(mt)&&(q.save(),q.translate(e.x,e.y),q.rotate(-a.rotation),q.scale(s,-h),q.translate(-f,-m),q.drawImage(u,0,0),q.restore())):s instanceof t.ParticleCanvasMaterial&&(l=a.scale.x*p,c=a.scale.y*d,mt.set(e.x-l,e.y-c,e.x+l,e.y+c),ut.intersects(mt)&&(n(s.color.getContextStyle()),o(s.color.getContextStyle()),q.save(),q.translate(e.x,e.y),q.rotate(-a.rotation),q.scale(l,c),s.program(q),q.restore()))}function K(e,o,a,s){r(s.opacity),i(s.blending),q.beginPath(),q.moveTo(e.positionScreen.x,e.positionScreen.y),q.lineTo(o.positionScreen.x,o.positionScreen.y),q.closePath(),s instanceof t.LineBasicMaterial&&(e=s.linewidth,tt!=e&&(q.lineWidth=tt=e),e=s.linecap,rt!=e&&(q.lineCap=rt=e),e=s.linejoin,it!=e&&(q.lineJoin=it=e),n(s.color.getContextStyle()),q.stroke(),mt.inflate(2*s.linewidth))}function $(e,n,o,a,s,h,p,d){G.info.render.vertices+=3,G.info.render.faces++,r(d.opacity),i(d.blending),b=e.positionScreen.x,v=e.positionScreen.y,x=n.positionScreen.x,y=n.positionScreen.y,w=o.positionScreen.x,_=o.positionScreen.y,J(b,v,x,y,w,_),d instanceof t.MeshBasicMaterial?d.map?d.map.mapping instanceof t.UVMapping&&(z=p.uvs[0],Mt(b,v,x,y,w,_,z[a].u,z[a].v,z[s].u,z[s].v,z[h].u,z[h].v,d.map)):d.envMap?d.envMap.mapping instanceof t.SphericalReflectionMapping&&(e=c.matrixWorldInverse,yt.copy(p.vertexNormalsWorld[a]),N=.5*(yt.x*e.n11+yt.y*e.n12+yt.z*e.n13)+.5,P=.5*-(yt.x*e.n21+yt.y*e.n22+yt.z*e.n23)+.5,yt.copy(p.vertexNormalsWorld[s]),D=.5*(yt.x*e.n11+yt.y*e.n12+yt.z*e.n13)+.5,F=.5*-(yt.x*e.n21+yt.y*e.n22+yt.z*e.n23)+.5,yt.copy(p.vertexNormalsWorld[h]),V=.5*(yt.x*e.n11+yt.y*e.n12+yt.z*e.n13)+.5,B=.5*-(yt.x*e.n21+yt.y*e.n22+yt.z*e.n23)+.5,Mt(b,v,x,y,w,_,N,P,D,F,V,B,d.envMap)):d.wireframe?wt(d.color,d.wireframeLinewidth,d.wireframeLinecap,d.wireframeLinejoin):_t(d.color):d instanceof t.MeshLambertMaterial?(d.map&&!d.wireframe&&(d.map.mapping instanceof t.UVMapping&&(z=p.uvs[0],Mt(b,v,x,y,w,_,z[a].u,z[a].v,z[s].u,z[s].v,z[h].u,z[h].v,d.map)),i(t.SubtractiveBlending)),gt?d.wireframe||d.shading!=t.SmoothShading||3!=p.vertexNormalsWorld.length?(at.r=bt.r,at.g=bt.g,at.b=bt.b,Y(l,p.centroidWorld,p.normalWorld,at),at.r=Math.max(0,Math.min(d.color.r*at.r,1)),at.g=Math.max(0,Math.min(d.color.g*at.g,1)),at.b=Math.max(0,Math.min(d.color.b*at.b,1)),d.wireframe?wt(at,d.wireframeLinewidth,d.wireframeLinecap,d.wireframeLinejoin):_t(at)):(st.r=lt.r=ct.r=bt.r,st.g=lt.g=ct.g=bt.g,st.b=lt.b=ct.b=bt.b,Y(l,p.v1.positionWorld,p.vertexNormalsWorld[0],st),Y(l,p.v2.positionWorld,p.vertexNormalsWorld[1],lt),Y(l,p.v3.positionWorld,p.vertexNormalsWorld[2],ct),st.r=Math.max(0,Math.min(d.color.r*st.r,1)),st.g=Math.max(0,Math.min(d.color.g*st.g,1)),st.b=Math.max(0,Math.min(d.color.b*st.b,1)),lt.r=Math.max(0,Math.min(d.color.r*lt.r,1)),lt.g=Math.max(0,Math.min(d.color.g*lt.g,1)),lt.b=Math.max(0,Math.min(d.color.b*lt.b,1)),ct.r=Math.max(0,Math.min(d.color.r*ct.r,1)),ct.g=Math.max(0,Math.min(d.color.g*ct.g,1)),ct.b=Math.max(0,Math.min(d.color.b*ct.b,1)),ht.r=.5*(lt.r+ct.r),ht.g=.5*(lt.g+ct.g),ht.b=.5*(lt.b+ct.b),R=kt(st,lt,ct,ht),St(b,v,x,y,w,_,0,0,1,0,0,1,R)):d.wireframe?wt(d.color,d.wireframeLinewidth,d.wireframeLinecap,d.wireframeLinejoin):_t(d.color)):d instanceof t.MeshDepthMaterial?(E=c.near,L=c.far,st.r=st.g=st.b=1-Tt(e.positionScreen.z,E,L),lt.r=lt.g=lt.b=1-Tt(n.positionScreen.z,E,L),ct.r=ct.g=ct.b=1-Tt(o.positionScreen.z,E,L),ht.r=.5*(lt.r+ct.r),ht.g=.5*(lt.g+ct.g),ht.b=.5*(lt.b+ct.b),R=kt(st,lt,ct,ht),St(b,v,x,y,w,_,0,0,1,0,0,1,R)):d instanceof t.MeshNormalMaterial&&(at.r=Ct(p.normalWorld.x),at.g=Ct(p.normalWorld.y),at.b=Ct(p.normalWorld.z),d.wireframe?wt(at,d.wireframeLinewidth,d.wireframeLinecap,d.wireframeLinejoin):_t(at))}function Q(e,n,o,a,s,h,p,d,u){G.info.render.vertices+=4,G.info.render.faces++,r(d.opacity),i(d.blending),d.map||d.envMap?($(e,n,a,0,1,3,p,d,u),$(s,o,h,1,2,3,p,d,u)):(b=e.positionScreen.x,v=e.positionScreen.y,x=n.positionScreen.x,y=n.positionScreen.y,w=o.positionScreen.x,_=o.positionScreen.y,M=a.positionScreen.x,S=a.positionScreen.y,k=s.positionScreen.x,T=s.positionScreen.y,C=h.positionScreen.x,A=h.positionScreen.y,d instanceof t.MeshBasicMaterial?(et(b,v,x,y,w,_,M,S),d.wireframe?wt(d.color,d.wireframeLinewidth,d.wireframeLinecap,d.wireframeLinejoin):_t(d.color)):d instanceof t.MeshLambertMaterial?gt?d.wireframe||d.shading!=t.SmoothShading||4!=p.vertexNormalsWorld.length?(at.r=bt.r,at.g=bt.g,at.b=bt.b,Y(l,p.centroidWorld,p.normalWorld,at),at.r=Math.max(0,Math.min(d.color.r*at.r,1)),at.g=Math.max(0,Math.min(d.color.g*at.g,1)),at.b=Math.max(0,Math.min(d.color.b*at.b,1)),et(b,v,x,y,w,_,M,S),d.wireframe?wt(at,d.wireframeLinewidth,d.wireframeLinecap,d.wireframeLinejoin):_t(at)):(st.r=lt.r=ct.r=ht.r=bt.r,st.g=lt.g=ct.g=ht.g=bt.g,st.b=lt.b=ct.b=ht.b=bt.b,Y(l,p.v1.positionWorld,p.vertexNormalsWorld[0],st),Y(l,p.v2.positionWorld,p.vertexNormalsWorld[1],lt),Y(l,p.v4.positionWorld,p.vertexNormalsWorld[3],ct),Y(l,p.v3.positionWorld,p.vertexNormalsWorld[2],ht),st.r=Math.max(0,Math.min(d.color.r*st.r,1)),st.g=Math.max(0,Math.min(d.color.g*st.g,1)),st.b=Math.max(0,Math.min(d.color.b*st.b,1)),lt.r=Math.max(0,Math.min(d.color.r*lt.r,1)),lt.g=Math.max(0,Math.min(d.color.g*lt.g,1)),lt.b=Math.max(0,Math.min(d.color.b*lt.b,1)),ct.r=Math.max(0,Math.min(d.color.r*ct.r,1)),ct.g=Math.max(0,Math.min(d.color.g*ct.g,1)),ct.b=Math.max(0,Math.min(d.color.b*ct.b,1)),ht.r=Math.max(0,Math.min(d.color.r*ht.r,1)),ht.g=Math.max(0,Math.min(d.color.g*ht.g,1)),ht.b=Math.max(0,Math.min(d.color.b*ht.b,1)),R=kt(st,lt,ct,ht),J(b,v,x,y,M,S),St(b,v,x,y,M,S,0,0,1,0,0,1,R),J(k,T,w,_,C,A),St(k,T,w,_,C,A,1,0,1,1,0,1,R)):(et(b,v,x,y,w,_,M,S),d.wireframe?wt(d.color,d.wireframeLinewidth,d.wireframeLinecap,d.wireframeLinejoin):_t(d.color)):d instanceof t.MeshNormalMaterial?(at.r=Ct(p.normalWorld.x),at.g=Ct(p.normalWorld.y),at.b=Ct(p.normalWorld.z),et(b,v,x,y,w,_,M,S),d.wireframe?wt(at,d.wireframeLinewidth,d.wireframeLinecap,d.wireframeLinejoin):_t(at)):d instanceof t.MeshDepthMaterial&&(E=c.near,L=c.far,st.r=st.g=st.b=1-Tt(e.positionScreen.z,E,L),lt.r=lt.g=lt.b=1-Tt(n.positionScreen.z,E,L),ct.r=ct.g=ct.b=1-Tt(a.positionScreen.z,E,L),ht.r=ht.g=ht.b=1-Tt(o.positionScreen.z,E,L),R=kt(st,lt,ct,ht),J(b,v,x,y,M,S),St(b,v,x,y,M,S,0,0,1,0,0,1,R),J(k,T,w,_,C,A),St(k,T,w,_,C,A,1,0,1,1,0,1,R)))}function J(e,t,r,i,n,o){q.beginPath(),q.moveTo(e,t),q.lineTo(r,i),q.lineTo(n,o),q.lineTo(e,t),q.closePath()}function et(e,t,r,i,n,o,a,s){q.beginPath(),q.moveTo(e,t),q.lineTo(r,i),q.lineTo(n,o),q.lineTo(a,s),q.lineTo(e,t),q.closePath()}function wt(e,t,r,i){tt!=t&&(q.lineWidth=tt=t),rt!=r&&(q.lineCap=rt=r),it!=i&&(q.lineJoin=it=i),n(e.getContextStyle()),q.stroke(),mt.inflate(2*t)}function _t(e){o(e.getContextStyle()),q.fill()}function Mt(e,r,i,n,a,s,l,c,h,p,d,u,f){if(0!=f.image.width){if(1==f.needsUpdate||void 0==pt[f.id]){var m=f.wrapS==t.RepeatWrapping,g=f.wrapT==t.RepeatWrapping;pt[f.id]=q.createPattern(f.image,m&&g?"repeat":m&&!g?"repeat-x":!m&&g?"repeat-y":"no-repeat"),f.needsUpdate=!1}o(pt[f.id]);var m=f.offset.x/f.repeat.x,g=f.offset.y/f.repeat.y,b=f.image.width*f.repeat.x,v=f.image.height*f.repeat.y,l=(l+m)*b,c=(c+g)*v,i=i-e,n=n-r,a=a-e,s=s-r,h=(h+m)*b-l,p=(p+g)*v-c,d=(d+m)*b-l,u=(u+g)*v-c,m=h*u-d*p;0==m?(void 0===dt[f.id]&&(r=document.createElement("canvas"),r.width=f.image.width,r.height=f.image.height,r=r.getContext("2d"),r.drawImage(f.image,0,0),dt[f.id]=r.getImageData(0,0,f.image.width,f.image.height).data),r=dt[f.id],l=4*(Math.floor(l)+Math.floor(c)*f.image.width),at.setRGB(r[l]/255,r[l+1]/255,r[l+2]/255),_t(at)):(m=1/m,f=(u*i-p*a)*m,p=(u*n-p*s)*m,i=(h*a-d*i)*m,n=(h*s-d*n)*m,e=e-f*l-i*c,l=r-p*l-n*c,q.save(),q.transform(f,p,i,n,e,l),q.fill(),q.restore())}}function St(e,t,r,i,n,o,a,s,l,c,h,p,d){var u,f;u=d.width-1,f=d.height-1,a*=u,s*=f,r-=e,i-=t,n-=e,o-=t,l=l*u-a,c=c*f-s,h=h*u-a,p=p*f-s,f=1/(l*p-h*c),u=(p*r-c*n)*f,c=(p*i-c*o)*f,r=(l*n-h*r)*f,i=(l*o-h*i)*f,e=e-u*a-r*s,t=t-c*a-i*s,q.save(),q.transform(u,c,r,i,e,t),q.clip(),q.drawImage(d,0,0),q.restore()}function kt(e,t,r,i){var n=~~(255*e.r),o=~~(255*e.g),e=~~(255*e.b),a=~~(255*t.r),s=~~(255*t.g),t=~~(255*t.b),l=~~(255*r.r),c=~~(255*r.g),r=~~(255*r.b),h=~~(255*i.r),p=~~(255*i.g),i=~~(255*i.b);return j[0]=0>n?0:n>255?255:n,j[1]=0>o?0:o>255?255:o,j[2]=0>e?0:e>255?255:e,j[4]=0>a?0:a>255?255:a,j[5]=0>s?0:s>255?255:s,j[6]=0>t?0:t>255?255:t,j[8]=0>l?0:l>255?255:l,j[9]=0>c?0:c>255?255:c,j[10]=0>r?0:r>255?255:r,j[12]=0>h?0:h>255?255:h,j[13]=0>p?0:p>255?255:p,j[14]=0>i?0:i>255?255:i,O.putImageData(I,0,0),H.drawImage(U,0,0),W}function Tt(e,t,r){return e=(e-t)/(r-t),e*e*(3-2*e)}function Ct(e){return e=.5*(e+1),0>e?0:e>1?1:e}function At(e,t){var r=t.x-e.x,i=t.y-e.y,n=r*r+i*i;0!=n&&(n=1/Math.sqrt(n),r*=n,i*=n,t.x+=r,t.y+=i,e.x-=r,e.y-=i)}var Et,Lt,Rt,zt;for(this.autoClear?this.clear():q.setTransform(1,0,0,-1,p,d),G.info.render.vertices=0,G.info.render.faces=0,a=X.projectScene(e,c,this.sortElements),s=a.elements,l=a.lights,(gt=0<l.length)&&h(l),Et=0,Lt=s.length;Lt>Et;Et++)Rt=s[Et],zt=Rt.material,zt=zt instanceof t.MeshFaceMaterial?Rt.faceMaterial:zt,null==zt||0==zt.opacity||(mt.empty(),Rt instanceof t.RenderableParticle?(u=Rt,u.x*=p,u.y*=d,Z(u,Rt,zt,e)):Rt instanceof t.RenderableLine?(u=Rt.v1,f=Rt.v2,u.positionScreen.x*=p,u.positionScreen.y*=d,f.positionScreen.x*=p,f.positionScreen.y*=d,mt.addPoint(u.positionScreen.x,u.positionScreen.y),mt.addPoint(f.positionScreen.x,f.positionScreen.y),ut.intersects(mt)&&K(u,f,Rt,zt,e)):Rt instanceof t.RenderableFace3?(u=Rt.v1,f=Rt.v2,m=Rt.v3,u.positionScreen.x*=p,u.positionScreen.y*=d,f.positionScreen.x*=p,f.positionScreen.y*=d,m.positionScreen.x*=p,m.positionScreen.y*=d,zt.overdraw&&(At(u.positionScreen,f.positionScreen),At(f.positionScreen,m.positionScreen),At(m.positionScreen,u.positionScreen)),mt.add3Points(u.positionScreen.x,u.positionScreen.y,f.positionScreen.x,f.positionScreen.y,m.positionScreen.x,m.positionScreen.y),ut.intersects(mt)&&$(u,f,m,0,1,2,Rt,zt,e)):Rt instanceof t.RenderableFace4&&(u=Rt.v1,f=Rt.v2,m=Rt.v3,g=Rt.v4,u.positionScreen.x*=p,u.positionScreen.y*=d,f.positionScreen.x*=p,f.positionScreen.y*=d,m.positionScreen.x*=p,m.positionScreen.y*=d,g.positionScreen.x*=p,g.positionScreen.y*=d,nt.positionScreen.copy(f.positionScreen),ot.positionScreen.copy(g.positionScreen),zt.overdraw&&(At(u.positionScreen,f.positionScreen),At(f.positionScreen,g.positionScreen),At(g.positionScreen,u.positionScreen),At(m.positionScreen,nt.positionScreen),At(m.positionScreen,ot.positionScreen)),mt.addPoint(u.positionScreen.x,u.positionScreen.y),mt.addPoint(f.positionScreen.x,f.positionScreen.y),mt.addPoint(m.positionScreen.x,m.positionScreen.y),mt.addPoint(g.positionScreen.x,g.positionScreen.y),ut.intersects(mt)&&Q(u,f,m,g,nt,ot,Rt,zt,e)),ft.addRectangle(mt));q.setTransform(1,0,0,1,0,0)}},t.SVGRenderer=function(){function e(e,r,i,n){var o,a,s,l,c,h;for(o=0,a=e.length;a>o;o++)s=e[o],l=s.color,s instanceof t.DirectionalLight?(c=s.matrixWorld.getPosition(),h=i.dot(c),0>=h||(h*=s.intensity,n.r+=l.r*h,n.g+=l.g*h,n.b+=l.b*h)):s instanceof t.PointLight&&(c=s.matrixWorld.getPosition(),h=i.dot(E.sub(c,r).normalize()),0>=h||(h*=0==s.distance?1:1-Math.min(r.distanceTo(c)/s.distance,1),0!=h&&(h*=s.intensity,n.r+=l.r*h,n.g+=l.g*h,n.b+=l.b*h)))}function r(e){return null==L[e]&&(L[e]=document.createElementNS("http://www.w3.org/2000/svg","path"),0==z&&L[e].setAttribute("shape-rendering","crispEdges")),L[e]}function i(e){return e=.5*(e+1),0>e?0:e>1?1:e}var n,o,a,s,l,c,h,p,d,u,f,m,g,b,v,x=this,y=new t.Projector,w=document.createElementNS("http://www.w3.org/2000/svg","svg"),_=new t.Rectangle,M=new t.Rectangle,S=!1,k=new t.Color,T=new t.Color,C=new t.Color,A=new t.Color,E=new t.Vector3,L=[],R=[],z=1;this.domElement=w,this.sortElements=this.sortObjects=this.autoClear=!0,this.info={render:{vertices:0,faces:0}},this.setQuality=function(e){switch(e){case"high":z=1;break;case"low":z=0}},this.setSize=function(e,t){s=e,l=t,c=s/2,h=l/2,w.setAttribute("viewBox",-c+" "+-h+" "+s+" "+l),w.setAttribute("width",s),w.setAttribute("height",l),_.set(-c,-h,c,h)},this.clear=function(){for(;0<w.childNodes.length;)w.removeChild(w.childNodes[0])},this.render=function(s,l){var E,L,N,P;if(this.autoClear&&this.clear(),x.info.render.vertices=0,x.info.render.faces=0,n=y.projectScene(s,l,this.sortElements),o=n.elements,a=n.lights,v=b=0,S=0<a.length)for(T.setRGB(0,0,0),C.setRGB(0,0,0),A.setRGB(0,0,0),E=0,L=a.length;L>E;E++)P=a[E],N=P.color,P instanceof t.AmbientLight?(T.r+=N.r,T.g+=N.g,T.b+=N.b):P instanceof t.DirectionalLight?(C.r+=N.r,C.g+=N.g,C.b+=N.b):P instanceof t.PointLight&&(A.r+=N.r,A.g+=N.g,A.b+=N.b);for(E=0,L=o.length;L>E;E++)if(N=o[E],P=N.material,P=P instanceof t.MeshFaceMaterial?N.faceMaterial:P,!(null==P||0==P.opacity))if(M.empty(),N instanceof t.RenderableParticle)p=N,p.x*=c,p.y*=-h;else if(N instanceof t.RenderableLine){if(p=N.v1,d=N.v2,p.positionScreen.x*=c,p.positionScreen.y*=-h,d.positionScreen.x*=c,d.positionScreen.y*=-h,M.addPoint(p.positionScreen.x,p.positionScreen.y),M.addPoint(d.positionScreen.x,d.positionScreen.y),_.intersects(M)){N=p;var D=d,F=v++;null==R[F]&&(R[F]=document.createElementNS("http://www.w3.org/2000/svg","line"),0==z&&R[F].setAttribute("shape-rendering","crispEdges")),g=R[F],g.setAttribute("x1",N.positionScreen.x),g.setAttribute("y1",N.positionScreen.y),g.setAttribute("x2",D.positionScreen.x),g.setAttribute("y2",D.positionScreen.y),P instanceof t.LineBasicMaterial&&(g.setAttribute("style","fill: none; stroke: "+P.color.getContextStyle()+"; stroke-width: "+P.linewidth+"; stroke-opacity: "+P.opacity+"; stroke-linecap: "+P.linecap+"; stroke-linejoin: "+P.linejoin),w.appendChild(g))}}else if(N instanceof t.RenderableFace3){if(p=N.v1,d=N.v2,u=N.v3,p.positionScreen.x*=c,p.positionScreen.y*=-h,d.positionScreen.x*=c,d.positionScreen.y*=-h,u.positionScreen.x*=c,u.positionScreen.y*=-h,M.addPoint(p.positionScreen.x,p.positionScreen.y),M.addPoint(d.positionScreen.x,d.positionScreen.y),M.addPoint(u.positionScreen.x,u.positionScreen.y),_.intersects(M)){var D=p,F=d,V=u;x.info.render.vertices+=3,x.info.render.faces++,g=r(b++),g.setAttribute("d","M "+D.positionScreen.x+" "+D.positionScreen.y+" L "+F.positionScreen.x+" "+F.positionScreen.y+" L "+V.positionScreen.x+","+V.positionScreen.y+"z"),P instanceof t.MeshBasicMaterial?k.copy(P.color):P instanceof t.MeshLambertMaterial?S?(k.r=T.r,k.g=T.g,k.b=T.b,e(a,N.centroidWorld,N.normalWorld,k),k.r=Math.max(0,Math.min(P.color.r*k.r,1)),k.g=Math.max(0,Math.min(P.color.g*k.g,1)),k.b=Math.max(0,Math.min(P.color.b*k.b,1))):k.copy(P.color):P instanceof t.MeshDepthMaterial?(m=1-P.__2near/(P.__farPlusNear-N.z*P.__farMinusNear),k.setRGB(m,m,m)):P instanceof t.MeshNormalMaterial&&k.setRGB(i(N.normalWorld.x),i(N.normalWorld.y),i(N.normalWorld.z)),P.wireframe?g.setAttribute("style","fill: none; stroke: "+k.getContextStyle()+"; stroke-width: "+P.wireframeLinewidth+"; stroke-opacity: "+P.opacity+"; stroke-linecap: "+P.wireframeLinecap+"; stroke-linejoin: "+P.wireframeLinejoin):g.setAttribute("style","fill: "+k.getContextStyle()+"; fill-opacity: "+P.opacity),w.appendChild(g)}}else if(N instanceof t.RenderableFace4&&(p=N.v1,d=N.v2,u=N.v3,f=N.v4,p.positionScreen.x*=c,p.positionScreen.y*=-h,d.positionScreen.x*=c,d.positionScreen.y*=-h,u.positionScreen.x*=c,u.positionScreen.y*=-h,f.positionScreen.x*=c,f.positionScreen.y*=-h,M.addPoint(p.positionScreen.x,p.positionScreen.y),M.addPoint(d.positionScreen.x,d.positionScreen.y),M.addPoint(u.positionScreen.x,u.positionScreen.y),M.addPoint(f.positionScreen.x,f.positionScreen.y),_.intersects(M))){var D=p,F=d,V=u,B=f;x.info.render.vertices+=4,x.info.render.faces++,g=r(b++),g.setAttribute("d","M "+D.positionScreen.x+" "+D.positionScreen.y+" L "+F.positionScreen.x+" "+F.positionScreen.y+" L "+V.positionScreen.x+","+V.positionScreen.y+" L "+B.positionScreen.x+","+B.positionScreen.y+"z"),P instanceof t.MeshBasicMaterial?k.copy(P.color):P instanceof t.MeshLambertMaterial?S?(k.r=T.r,k.g=T.g,k.b=T.b,e(a,N.centroidWorld,N.normalWorld,k),k.r=Math.max(0,Math.min(P.color.r*k.r,1)),k.g=Math.max(0,Math.min(P.color.g*k.g,1)),k.b=Math.max(0,Math.min(P.color.b*k.b,1))):k.copy(P.color):P instanceof t.MeshDepthMaterial?(m=1-P.__2near/(P.__farPlusNear-N.z*P.__farMinusNear),k.setRGB(m,m,m)):P instanceof t.MeshNormalMaterial&&k.setRGB(i(N.normalWorld.x),i(N.normalWorld.y),i(N.normalWorld.z)),P.wireframe?g.setAttribute("style","fill: none; stroke: "+k.getContextStyle()+"; stroke-width: "+P.wireframeLinewidth+"; stroke-opacity: "+P.opacity+"; stroke-linecap: "+P.wireframeLinecap+"; stroke-linejoin: "+P.wireframeLinejoin):g.setAttribute("style","fill: "+k.getContextStyle()+"; fill-opacity: "+P.opacity),w.appendChild(g)}}},t.ShaderChunk={fog_pars_fragment:"#ifdef USE_FOG\nuniform vec3 fogColor;\n#ifdef FOG_EXP2\nuniform float fogDensity;\n#else\nuniform float fogNear;\nuniform float fogFar;\n#endif\n#endif",fog_fragment:"#ifdef USE_FOG\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#ifdef FOG_EXP2\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\n#else\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\n#endif\ngl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\nvarying vec3 vReflect;\nuniform float reflectivity;\nuniform samplerCube envMap;\nuniform float flipEnvMap;\nuniform int combine;\n#endif",envmap_fragment:"#ifdef USE_ENVMAP\n#ifdef DOUBLE_SIDED\nfloat flipNormal = ( -1.0 + 2.0 * float( gl_FrontFacing ) );\nvec4 cubeColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * vReflect.x, vReflect.yz ) );\n#else\nvec4 cubeColor = textureCube( envMap, vec3( flipEnvMap * vReflect.x, vReflect.yz ) );\n#endif\n#ifdef GAMMA_INPUT\ncubeColor.xyz *= cubeColor.xyz;\n#endif\nif ( combine == 1 ) {\ngl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, reflectivity );\n} else {\ngl_FragColor.xyz = gl_FragColor.xyz * cubeColor.xyz;\n}\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\nvarying vec3 vReflect;\nuniform float refractionRatio;\nuniform bool useRefract;\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\nvec4 mPosition = objectMatrix * vec4( position, 1.0 );\nvec3 nWorld = mat3( objectMatrix[ 0 ].xyz, objectMatrix[ 1 ].xyz, objectMatrix[ 2 ].xyz ) * normal;\nif ( useRefract ) {\nvReflect = refract( normalize( mPosition.xyz - cameraPosition ), normalize( nWorld.xyz ), refractionRatio );\n} else {\nvReflect = reflect( normalize( mPosition.xyz - cameraPosition ), normalize( nWorld.xyz ) );\n}\n#endif",map_particle_pars_fragment:"#ifdef USE_MAP\nuniform sampler2D map;\n#endif",map_particle_fragment:"#ifdef USE_MAP\ngl_FragColor = gl_FragColor * texture2D( map, gl_PointCoord );\n#endif",map_pars_vertex:"#ifdef USE_MAP\nvarying vec2 vUv;\nuniform vec4 offsetRepeat;\n#endif",map_pars_fragment:"#ifdef USE_MAP\nvarying vec2 vUv;\nuniform sampler2D map;\n#endif",map_vertex:"#ifdef USE_MAP\nvUv = uv * offsetRepeat.zw + offsetRepeat.xy;\n#endif",map_fragment:"#ifdef USE_MAP\n#ifdef GAMMA_INPUT\nvec4 texelColor = texture2D( map, vUv );\ntexelColor.xyz *= texelColor.xyz;\ngl_FragColor = gl_FragColor * texelColor;\n#else\ngl_FragColor = gl_FragColor * texture2D( map, vUv );\n#endif\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\nvarying vec2 vUv2;\nuniform sampler2D lightMap;\n#endif",lightmap_pars_vertex:"#ifdef USE_LIGHTMAP\nvarying vec2 vUv2;\n#endif",lightmap_fragment:"#ifdef USE_LIGHTMAP\ngl_FragColor = gl_FragColor * texture2D( lightMap, vUv2 );\n#endif",lightmap_vertex:"#ifdef USE_LIGHTMAP\nvUv2 = uv2;\n#endif",lights_lambert_pars_vertex:"uniform vec3 ambient;\nuniform vec3 diffuse;\nuniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n#endif\n#ifdef WRAP_AROUND\nuniform vec3 wrapRGB;\n#endif",lights_lambert_vertex:"vLightFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\nvLightBack = vec3( 0.0 );\n#endif\ntransformedNormal = normalize( transformedNormal );\n#if MAX_DIR_LIGHTS > 0\nfor( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\nfloat dotProduct = dot( transformedNormal, dirVector );\nvec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );\n#ifdef DOUBLE_SIDED\nvec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );\n#ifdef WRAP_AROUND\nvec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );\n#endif\n#endif\n#ifdef WRAP_AROUND\nvec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );\ndirectionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );\n#ifdef DOUBLE_SIDED\ndirectionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );\n#endif\n#endif\nvLightFront += directionalLightColor[ i ] * directionalLightWeighting;\n#ifdef DOUBLE_SIDED\nvLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;\n#endif\n}\n#endif\n#if MAX_POINT_LIGHTS > 0\nfor( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\nfloat dotProduct = dot( transformedNormal, lVector );\nvec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );\n#ifdef DOUBLE_SIDED\nvec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );\n#ifdef WRAP_AROUND\nvec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );\n#endif\n#endif\n#ifdef WRAP_AROUND\nvec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );\npointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );\n#ifdef DOUBLE_SIDED\npointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );\n#endif\n#endif\nvLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;\n#ifdef DOUBLE_SIDED\nvLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;\n#endif\n}\n#endif\nvLightFront = vLightFront * diffuse + ambient * ambientLightColor;\n#ifdef DOUBLE_SIDED\nvLightBack = vLightBack * diffuse + ambient * ambientLightColor;\n#endif",lights_phong_pars_vertex:"#if MAX_POINT_LIGHTS > 0\n#ifndef PHONG_PER_PIXEL\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\nvarying vec4 vPointLight[ MAX_POINT_LIGHTS ];\n#endif\n#endif",lights_phong_vertex:"#if MAX_POINT_LIGHTS > 0\n#ifndef PHONG_PER_PIXEL\nfor( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nvPointLight[ i ] = vec4( lVector, lDistance );\n}\n#endif\n#endif",lights_phong_pars_fragment:"uniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\n#ifdef PHONG_PER_PIXEL\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n#else\nvarying vec4 vPointLight[ MAX_POINT_LIGHTS ];\n#endif\n#endif\n#ifdef WRAP_AROUND\nuniform vec3 wrapRGB;\n#endif\nvarying vec3 vViewPosition;\nvarying vec3 vNormal;",lights_phong_fragment:"vec3 normal = normalize( vNormal );\nvec3 viewPosition = normalize( vViewPosition );\n#ifdef DOUBLE_SIDED\nnormal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );\n#endif\n#if MAX_POINT_LIGHTS > 0\nvec3 pointDiffuse  = vec3( 0.0 );\nvec3 pointSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\n#ifdef PHONG_PER_PIXEL\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz + vViewPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\n#else\nvec3 lVector = normalize( vPointLight[ i ].xyz );\nfloat lDistance = vPointLight[ i ].w;\n#endif\nfloat dotProduct = dot( normal, lVector );\n#ifdef WRAP_AROUND\nfloat pointDiffuseWeightFull = max( dotProduct, 0.0 );\nfloat pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );\nvec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );\n#else\nfloat pointDiffuseWeight = max( dotProduct, 0.0 );\n#endif\npointDiffuse  += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;\nvec3 pointHalfVector = normalize( lVector + viewPosition );\nfloat pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );\nfloat pointSpecularWeight = max( pow( pointDotNormalHalf, shininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nvec3 schlick = specular + vec3( 1.0 - specular ) * pow( dot( lVector, pointHalfVector ), 5.0 );\npointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance;\n#else\npointSpecular += specular * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance;\n#endif\n}\n#endif\n#if MAX_DIR_LIGHTS > 0\nvec3 dirDiffuse  = vec3( 0.0 );\nvec3 dirSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\nfloat dotProduct = dot( normal, dirVector );\n#ifdef WRAP_AROUND\nfloat dirDiffuseWeightFull = max( dotProduct, 0.0 );\nfloat dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );\nvec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );\n#else\nfloat dirDiffuseWeight = max( dotProduct, 0.0 );\n#endif\ndirDiffuse  += diffuse * directionalLightColor[ i ] * dirDiffuseWeight;\nvec3 dirHalfVector = normalize( dirVector + viewPosition );\nfloat dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );\nfloat dirSpecularWeight = max( pow( dirDotNormalHalf, shininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nvec3 schlick = specular + vec3( 1.0 - specular ) * pow( dot( dirVector, dirHalfVector ), 5.0 );\ndirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight;\n#else\ndirSpecular += specular * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight;\n#endif\n}\n#endif\nvec3 totalDiffuse = vec3( 0.0 );\nvec3 totalSpecular = vec3( 0.0 );\n#if MAX_DIR_LIGHTS > 0\ntotalDiffuse += dirDiffuse;\ntotalSpecular += dirSpecular;\n#endif\n#if MAX_POINT_LIGHTS > 0\ntotalDiffuse += pointDiffuse;\ntotalSpecular += pointSpecular;\n#endif\n#ifdef METAL\ngl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * ambient + totalSpecular );\n#else\ngl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif",color_fragment:"#ifdef USE_COLOR\ngl_FragColor = gl_FragColor * vec4( vColor, opacity );\n#endif",color_pars_vertex:"#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\n#ifdef GAMMA_INPUT\nvColor = color * color;\n#else\nvColor = color;\n#endif\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\nuniform mat4 boneGlobalMatrices[ MAX_BONES ];\n#endif",skinning_vertex:"#ifdef USE_SKINNING\ngl_Position  = ( boneGlobalMatrices[ int( skinIndex.x ) ] * skinVertexA ) * skinWeight.x;\ngl_Position += ( boneGlobalMatrices[ int( skinIndex.y ) ] * skinVertexB ) * skinWeight.y;\ngl_Position  = projectionMatrix * modelViewMatrix * gl_Position;\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n#ifndef USE_MORPHNORMALS\nuniform float morphTargetInfluences[ 8 ];\n#else\nuniform float morphTargetInfluences[ 4 ];\n#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\nvec3 morphed = vec3( 0.0 );\nmorphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\nmorphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\nmorphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\nmorphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n#ifndef USE_MORPHNORMALS\nmorphed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\nmorphed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\nmorphed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\nmorphed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n#endif\nmorphed += position;\ngl_Position = projectionMatrix * modelViewMatrix * vec4( morphed, 1.0 );\n#endif",default_vertex:"#ifndef USE_MORPHTARGETS\n#ifndef USE_SKINNING\ngl_Position = projectionMatrix * mvPosition;\n#endif\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\nvec3 morphedNormal = vec3( 0.0 );\nmorphedNormal +=  ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\nmorphedNormal +=  ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\nmorphedNormal +=  ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\nmorphedNormal +=  ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\nmorphedNormal += normal;\nvec3 transformedNormal = normalMatrix * morphedNormal;\n#else\nvec3 transformedNormal = normalMatrix * normal;\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\nuniform sampler2D shadowMap[ MAX_SHADOWS ];\nuniform vec2 shadowMapSize[ MAX_SHADOWS ];\nuniform float shadowDarkness[ MAX_SHADOWS ];\nuniform float shadowBias[ MAX_SHADOWS ];\nvarying vec4 vShadowCoord[ MAX_SHADOWS ];\nfloat unpackDepth( const in vec4 rgba_depth ) {\nconst vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );\nfloat depth = dot( rgba_depth, bit_shift );\nreturn depth;\n}\n#endif",shadowmap_fragment:"#ifdef USE_SHADOWMAP\n#ifdef SHADOWMAP_DEBUG\nvec3 frustumColors[3];\nfrustumColors[0] = vec3( 1.0, 0.5, 0.0 );\nfrustumColors[1] = vec3( 0.0, 1.0, 0.8 );\nfrustumColors[2] = vec3( 0.0, 0.5, 1.0 );\n#endif\n#ifdef SHADOWMAP_CASCADE\nint inFrustumCount = 0;\n#endif\nfloat fDepth;\nvec3 shadowColor = vec3( 1.0 );\nfor( int i = 0; i < MAX_SHADOWS; i ++ ) {\nvec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;\nbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\nbool inFrustum = all( inFrustumVec );\n#ifdef SHADOWMAP_CASCADE\ninFrustumCount += int( inFrustum );\nbvec3 frustumTestVec = bvec3( inFrustum, inFrustumCount == 1, shadowCoord.z <= 1.0 );\n#else\nbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n#endif\nbool frustumTest = all( frustumTestVec );\nif ( frustumTest ) {\nshadowCoord.z += shadowBias[ i ];\n#ifdef SHADOWMAP_SOFT\nfloat shadow = 0.0;\nconst float shadowDelta = 1.0 / 9.0;\nfloat xPixelOffset = 1.0 / shadowMapSize[ i ].x;\nfloat yPixelOffset = 1.0 / shadowMapSize[ i ].y;\nfloat dx0 = -1.25 * xPixelOffset;\nfloat dy0 = -1.25 * yPixelOffset;\nfloat dx1 = 1.25 * xPixelOffset;\nfloat dy1 = 1.25 * yPixelOffset;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nshadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );\n#else\nvec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );\nfloat fDepth = unpackDepth( rgbaDepth );\nif ( fDepth < shadowCoord.z )\nshadowColor = shadowColor * vec3( 1.0 - shadowDarkness[ i ] );\n#endif\n}\n#ifdef SHADOWMAP_DEBUG\n#ifdef SHADOWMAP_CASCADE\nif ( inFrustum && inFrustumCount == 1 ) gl_FragColor.xyz *= frustumColors[ i ];\n#else\nif ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];\n#endif\n#endif\n}\n#ifdef GAMMA_OUTPUT\nshadowColor *= shadowColor;\n#endif\ngl_FragColor.xyz = gl_FragColor.xyz * shadowColor;\n#endif",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\nvarying vec4 vShadowCoord[ MAX_SHADOWS ];\nuniform mat4 shadowMatrix[ MAX_SHADOWS ];\n#endif",shadowmap_vertex:"#ifdef USE_SHADOWMAP\nfor( int i = 0; i < MAX_SHADOWS; i ++ ) {\n#ifdef USE_MORPHTARGETS\nvShadowCoord[ i ] = shadowMatrix[ i ] * objectMatrix * vec4( morphed, 1.0 );\n#else\nvShadowCoord[ i ] = shadowMatrix[ i ] * objectMatrix * vec4( position, 1.0 );\n#endif\n}\n#endif",alphatest_fragment:"#ifdef ALPHATEST\nif ( gl_FragColor.a < ALPHATEST ) discard;\n#endif",linear_to_gamma_fragment:"#ifdef GAMMA_OUTPUT\ngl_FragColor.xyz = sqrt( gl_FragColor.xyz );\n#endif"},t.UniformsUtils={merge:function(e){var t,r,i,n={};
for(t=0;t<e.length;t++)for(r in i=this.clone(e[t]))n[r]=i[r];return n},clone:function(e){var r,i,n,o={};for(r in e)for(i in o[r]={},e[r])n=e[r][i],o[r][i]=n instanceof t.Color||n instanceof t.Vector2||n instanceof t.Vector3||n instanceof t.Vector4||n instanceof t.Matrix4||n instanceof t.Texture?n.clone():n instanceof Array?n.slice():n;return o}},t.UniformsLib={common:{diffuse:{type:"c",value:new t.Color(15658734)},opacity:{type:"f",value:1},map:{type:"t",value:0,texture:null},offsetRepeat:{type:"v4",value:new t.Vector4(0,0,1,1)},lightMap:{type:"t",value:2,texture:null},envMap:{type:"t",value:1,texture:null},flipEnvMap:{type:"f",value:-1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98},combine:{type:"i",value:0},morphTargetInfluences:{type:"f",value:0}},fog:{fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new t.Color(16777215)}},lights:{ambientLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightDistance:{type:"fv1",value:[]}},particle:{psColor:{type:"c",value:new t.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:0,texture:null},fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new t.Color(16777215)}},shadowmap:{shadowMap:{type:"tv",value:6,texture:[]},shadowMapSize:{type:"v2v",value:[]},shadowBias:{type:"fv1",value:[]},shadowDarkness:{type:"fv1",value:[]},shadowMatrix:{type:"m4v",value:[]}}},t.ShaderLib={depth:{uniforms:{mNear:{type:"f",value:1},mFar:{type:"f",value:2e3},opacity:{type:"f",value:1}},vertexShader:"void main() {\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform float mNear;\nuniform float mFar;\nuniform float opacity;\nvoid main() {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat color = 1.0 - smoothstep( mNear, mFar, depth );\ngl_FragColor = vec4( vec3( color ), opacity );\n}"},normal:{uniforms:{opacity:{type:"f",value:1}},vertexShader:"varying vec3 vNormal;\nvoid main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvNormal = normalize( normalMatrix * normal );\ngl_Position = projectionMatrix * mvPosition;\n}",fragmentShader:"uniform float opacity;\nvarying vec3 vNormal;\nvoid main() {\ngl_FragColor = vec4( 0.5 * normalize( vNormal ) + 0.5, opacity );\n}"},basic:{uniforms:t.UniformsUtils.merge([t.UniformsLib.common,t.UniformsLib.fog,t.UniformsLib.shadowmap]),vertexShader:[t.ShaderChunk.map_pars_vertex,t.ShaderChunk.lightmap_pars_vertex,t.ShaderChunk.envmap_pars_vertex,t.ShaderChunk.color_pars_vertex,t.ShaderChunk.skinning_pars_vertex,t.ShaderChunk.morphtarget_pars_vertex,t.ShaderChunk.shadowmap_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",t.ShaderChunk.map_vertex,t.ShaderChunk.lightmap_vertex,t.ShaderChunk.envmap_vertex,t.ShaderChunk.color_vertex,t.ShaderChunk.skinning_vertex,t.ShaderChunk.morphtarget_vertex,t.ShaderChunk.default_vertex,t.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;\nuniform float opacity;",t.ShaderChunk.color_pars_fragment,t.ShaderChunk.map_pars_fragment,t.ShaderChunk.lightmap_pars_fragment,t.ShaderChunk.envmap_pars_fragment,t.ShaderChunk.fog_pars_fragment,t.ShaderChunk.shadowmap_pars_fragment,"void main() {\ngl_FragColor = vec4( diffuse, opacity );",t.ShaderChunk.map_fragment,t.ShaderChunk.alphatest_fragment,t.ShaderChunk.lightmap_fragment,t.ShaderChunk.color_fragment,t.ShaderChunk.envmap_fragment,t.ShaderChunk.shadowmap_fragment,t.ShaderChunk.linear_to_gamma_fragment,t.ShaderChunk.fog_fragment,"}"].join("\n")},lambert:{uniforms:t.UniformsUtils.merge([t.UniformsLib.common,t.UniformsLib.fog,t.UniformsLib.lights,t.UniformsLib.shadowmap,{ambient:{type:"c",value:new t.Color(328965)},wrapRGB:{type:"v3",value:new t.Vector3(1,1,1)}}]),vertexShader:["varying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\nvarying vec3 vLightBack;\n#endif",t.ShaderChunk.map_pars_vertex,t.ShaderChunk.lightmap_pars_vertex,t.ShaderChunk.envmap_pars_vertex,t.ShaderChunk.lights_lambert_pars_vertex,t.ShaderChunk.color_pars_vertex,t.ShaderChunk.skinning_pars_vertex,t.ShaderChunk.morphtarget_pars_vertex,t.ShaderChunk.shadowmap_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",t.ShaderChunk.map_vertex,t.ShaderChunk.lightmap_vertex,t.ShaderChunk.envmap_vertex,t.ShaderChunk.color_vertex,t.ShaderChunk.morphnormal_vertex,t.ShaderChunk.lights_lambert_vertex,t.ShaderChunk.skinning_vertex,t.ShaderChunk.morphtarget_vertex,t.ShaderChunk.default_vertex,t.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\nvarying vec3 vLightBack;\n#endif",t.ShaderChunk.color_pars_fragment,t.ShaderChunk.map_pars_fragment,t.ShaderChunk.lightmap_pars_fragment,t.ShaderChunk.envmap_pars_fragment,t.ShaderChunk.fog_pars_fragment,t.ShaderChunk.shadowmap_pars_fragment,"void main() {\ngl_FragColor = vec4( vec3 ( 1.0 ), opacity );",t.ShaderChunk.map_fragment,t.ShaderChunk.alphatest_fragment,"#ifdef DOUBLE_SIDED\nif ( gl_FrontFacing )\ngl_FragColor.xyz *= vLightFront;\nelse\ngl_FragColor.xyz *= vLightBack;\n#else\ngl_FragColor.xyz *= vLightFront;\n#endif",t.ShaderChunk.lightmap_fragment,t.ShaderChunk.color_fragment,t.ShaderChunk.envmap_fragment,t.ShaderChunk.shadowmap_fragment,t.ShaderChunk.linear_to_gamma_fragment,t.ShaderChunk.fog_fragment,"}"].join("\n")},phong:{uniforms:t.UniformsUtils.merge([t.UniformsLib.common,t.UniformsLib.fog,t.UniformsLib.lights,t.UniformsLib.shadowmap,{ambient:{type:"c",value:new t.Color(328965)},specular:{type:"c",value:new t.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new t.Vector3(1,1,1)}}]),vertexShader:["varying vec3 vViewPosition;\nvarying vec3 vNormal;",t.ShaderChunk.map_pars_vertex,t.ShaderChunk.lightmap_pars_vertex,t.ShaderChunk.envmap_pars_vertex,t.ShaderChunk.lights_phong_pars_vertex,t.ShaderChunk.color_pars_vertex,t.ShaderChunk.skinning_pars_vertex,t.ShaderChunk.morphtarget_pars_vertex,t.ShaderChunk.shadowmap_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",t.ShaderChunk.map_vertex,t.ShaderChunk.lightmap_vertex,t.ShaderChunk.envmap_vertex,t.ShaderChunk.color_vertex,"#ifndef USE_ENVMAP\nvec4 mPosition = objectMatrix * vec4( position, 1.0 );\n#endif\nvViewPosition = -mvPosition.xyz;",t.ShaderChunk.morphnormal_vertex,"vNormal = transformedNormal;",t.ShaderChunk.lights_phong_vertex,t.ShaderChunk.skinning_vertex,t.ShaderChunk.morphtarget_vertex,t.ShaderChunk.default_vertex,t.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;\nuniform float opacity;\nuniform vec3 ambient;\nuniform vec3 specular;\nuniform float shininess;",t.ShaderChunk.color_pars_fragment,t.ShaderChunk.map_pars_fragment,t.ShaderChunk.lightmap_pars_fragment,t.ShaderChunk.envmap_pars_fragment,t.ShaderChunk.fog_pars_fragment,t.ShaderChunk.lights_phong_pars_fragment,t.ShaderChunk.shadowmap_pars_fragment,"void main() {\ngl_FragColor = vec4( vec3 ( 1.0 ), opacity );",t.ShaderChunk.map_fragment,t.ShaderChunk.alphatest_fragment,t.ShaderChunk.lights_phong_fragment,t.ShaderChunk.lightmap_fragment,t.ShaderChunk.color_fragment,t.ShaderChunk.envmap_fragment,t.ShaderChunk.shadowmap_fragment,t.ShaderChunk.linear_to_gamma_fragment,t.ShaderChunk.fog_fragment,"}"].join("\n")},particle_basic:{uniforms:t.UniformsUtils.merge([t.UniformsLib.particle,t.UniformsLib.shadowmap]),vertexShader:["uniform float size;\nuniform float scale;",t.ShaderChunk.color_pars_vertex,t.ShaderChunk.shadowmap_pars_vertex,"void main() {",t.ShaderChunk.color_vertex,"vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n#ifdef USE_SIZEATTENUATION\ngl_PointSize = size * ( scale / length( mvPosition.xyz ) );\n#else\ngl_PointSize = size;\n#endif\ngl_Position = projectionMatrix * mvPosition;",t.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 psColor;\nuniform float opacity;",t.ShaderChunk.color_pars_fragment,t.ShaderChunk.map_particle_pars_fragment,t.ShaderChunk.fog_pars_fragment,t.ShaderChunk.shadowmap_pars_fragment,"void main() {\ngl_FragColor = vec4( psColor, opacity );",t.ShaderChunk.map_particle_fragment,t.ShaderChunk.alphatest_fragment,t.ShaderChunk.color_fragment,t.ShaderChunk.shadowmap_fragment,t.ShaderChunk.fog_fragment,"}"].join("\n")},depthRGBA:{uniforms:{},vertexShader:[t.ShaderChunk.morphtarget_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",t.ShaderChunk.morphtarget_vertex,t.ShaderChunk.default_vertex,"}"].join("\n"),fragmentShader:"vec4 pack_depth( const in float depth ) {\nconst vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );\nconst vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );\nvec4 res = fract( depth * bit_shift );\nres -= res.xxyz * bit_mask;\nreturn res;\n}\nvoid main() {\ngl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );\n}"}},t.WebGLRenderer=function(e){function r(e,t){var r=e.vertices.length,i=t.material;if(i.attributes){void 0===e.__webglCustomAttributesList&&(e.__webglCustomAttributesList=[]);for(var n in i.attributes){var o=i.attributes[n];if(!o.__webglInitialized||o.createUniqueBuffers){o.__webglInitialized=!0;var a=1;"v2"===o.type?a=2:"v3"===o.type?a=3:"v4"===o.type?a=4:"c"===o.type&&(a=3),o.size=a,o.array=new Float32Array(r*a),o.buffer=P.createBuffer(),o.buffer.belongsToAttribute=n,o.needsUpdate=!0}e.__webglCustomAttributesList.push(o)}}}function i(e,r){return!e.material||e.material instanceof t.MeshFaceMaterial?0<=r.materialIndex?e.geometry.materials[r.materialIndex]:void 0:e.material}function n(e){return e instanceof t.MeshBasicMaterial&&!e.envMap||e instanceof t.MeshDepthMaterial?!1:e&&void 0!==e.shading&&e.shading===t.SmoothShading?t.SmoothShading:t.FlatShading}function o(e){return e.map||e.lightMap||e instanceof t.ShaderMaterial?!0:!1}function a(e,t,r){var i,n,o,a,s=e.vertices;a=s.length;var l=e.colors,c=l.length,h=e.__vertexArray,p=e.__colorArray,d=e.__sortArray,u=e.__dirtyVertices,f=e.__dirtyColors,m=e.__webglCustomAttributesList;if(r.sortParticles){for(ot.multiplySelf(r.matrixWorld),i=0;a>i;i++)n=s[i].position,at.copy(n),ot.multiplyVector3(at),d[i]=[at.z,i];for(d.sort(function(e,t){return t[0]-e[0]}),i=0;a>i;i++)n=s[d[i][1]].position,o=3*i,h[o]=n.x,h[o+1]=n.y,h[o+2]=n.z;for(i=0;c>i;i++)o=3*i,n=l[d[i][1]],p[o]=n.r,p[o+1]=n.g,p[o+2]=n.b;if(m)for(l=0,c=m.length;c>l;l++)if(s=m[l],void 0===s.boundTo||"vertices"===s.boundTo)if(o=0,n=s.value.length,1===s.size)for(i=0;n>i;i++)a=d[i][1],s.array[i]=s.value[a];else if(2===s.size)for(i=0;n>i;i++)a=d[i][1],a=s.value[a],s.array[o]=a.x,s.array[o+1]=a.y,o+=2;else if(3===s.size)if("c"===s.type)for(i=0;n>i;i++)a=d[i][1],a=s.value[a],s.array[o]=a.r,s.array[o+1]=a.g,s.array[o+2]=a.b,o+=3;else for(i=0;n>i;i++)a=d[i][1],a=s.value[a],s.array[o]=a.x,s.array[o+1]=a.y,s.array[o+2]=a.z,o+=3;else if(4===s.size)for(i=0;n>i;i++)a=d[i][1],a=s.value[a],s.array[o]=a.x,s.array[o+1]=a.y,s.array[o+2]=a.z,s.array[o+3]=a.w,o+=4}else{if(u)for(i=0;a>i;i++)n=s[i].position,o=3*i,h[o]=n.x,h[o+1]=n.y,h[o+2]=n.z;if(f)for(i=0;c>i;i++)n=l[i],o=3*i,p[o]=n.r,p[o+1]=n.g,p[o+2]=n.b;if(m)for(l=0,c=m.length;c>l;l++)if(s=m[l],s.needsUpdate&&(void 0===s.boundTo||"vertices"===s.boundTo))if(n=s.value.length,o=0,1===s.size)for(i=0;n>i;i++)s.array[i]=s.value[i];else if(2===s.size)for(i=0;n>i;i++)a=s.value[i],s.array[o]=a.x,s.array[o+1]=a.y,o+=2;else if(3===s.size)if("c"===s.type)for(i=0;n>i;i++)a=s.value[i],s.array[o]=a.r,s.array[o+1]=a.g,s.array[o+2]=a.b,o+=3;else for(i=0;n>i;i++)a=s.value[i],s.array[o]=a.x,s.array[o+1]=a.y,s.array[o+2]=a.z,o+=3;else if(4===s.size)for(i=0;n>i;i++)a=s.value[i],s.array[o]=a.x,s.array[o+1]=a.y,s.array[o+2]=a.z,s.array[o+3]=a.w,o+=4}if((u||r.sortParticles)&&(P.bindBuffer(P.ARRAY_BUFFER,e.__webglVertexBuffer),P.bufferData(P.ARRAY_BUFFER,h,t)),(f||r.sortParticles)&&(P.bindBuffer(P.ARRAY_BUFFER,e.__webglColorBuffer),P.bufferData(P.ARRAY_BUFFER,p,t)),m)for(l=0,c=m.length;c>l;l++)s=m[l],(s.needsUpdate||r.sortParticles)&&(P.bindBuffer(P.ARRAY_BUFFER,s.buffer),P.bufferData(P.ARRAY_BUFFER,s.array,t))}function s(e,t){return t.z-e.z}function l(e,t,r){if(e.length)for(var i=0,n=e.length;n>i;i++)I=V=null,U=O=Y=X=G=-1,e[i].render(t,r,rt,it),I=V=null,U=O=Y=X=G=-1}function c(e,r,i,n,o,a,s,l){var c,h,p,d;r?(h=e.length-1,d=r=-1):(h=0,r=e.length,d=1);for(var u=h;u!==r;u+=d)if(c=e[u],c.render){if(h=c.object,p=c.buffer,l)c=l;else{if(c=c[i],!c)continue;s&&D.setBlending(c.blending),D.setDepthTest(c.depthTest),D.setDepthWrite(c.depthWrite),v(c.polygonOffset,c.polygonOffsetFactor,c.polygonOffsetUnits)}D.setObjectFaces(h),p instanceof t.BufferGeometry?D.renderBufferDirect(n,o,a,c,p,h):D.renderBuffer(n,o,a,c,p,h)}}function h(e,t,r,i,n,o,a){for(var s,l,c=0,h=e.length;h>c;c++)if(s=e[c],l=s.object,l.visible){if(a)s=a;else{if(s=s[t],!s)continue;o&&D.setBlending(s.blending),D.setDepthTest(s.depthTest),D.setDepthWrite(s.depthWrite),v(s.polygonOffset,s.polygonOffsetFactor,s.polygonOffsetUnits)}D.renderImmediateObject(r,i,n,s,l)}}function p(e,t,r){e.push({buffer:t,object:r,opaque:null,transparent:null})}function d(e){for(var t in e.attributes)if(e.attributes[t].needsUpdate)return!0;return!1}function u(e){for(var t in e.attributes)e.attributes[t].needsUpdate=!1}function f(e,t){for(var r=e.length-1;r>=0;r--)e[r].object===t&&e.splice(r,1)}function m(e,t){for(var r=e.length-1;r>=0;r--)e[r]===t&&e.splice(r,1)}function g(e,r,i,n,o){if(n.program||D.initMaterial(n,r,i,o),n.morphTargets&&!o.__webglMorphTargetInfluences){o.__webglMorphTargetInfluences=new Float32Array(D.maxMorphTargets);for(var a=0,s=D.maxMorphTargets;s>a;a++)o.__webglMorphTargetInfluences[a]=0}var l=!1,a=n.program,s=a.uniforms,c=n.uniforms;if(a!==V&&(P.useProgram(a),V=a,l=!0),n.id!==U&&(U=n.id,l=!0),(l||e!==I)&&(P.uniformMatrix4fv(s.projectionMatrix,!1,e._projectionMatrixArray),e!==I&&(I=e)),l){if(i&&n.fog&&(c.fogColor.value=i.color,i instanceof t.Fog?(c.fogNear.value=i.near,c.fogFar.value=i.far):i instanceof t.FogExp2&&(c.fogDensity.value=i.density)),n instanceof t.MeshPhongMaterial||n instanceof t.MeshLambertMaterial||n.lights){var h,p,d,u,f=0,m=0,g=0,b=lt,v=b.directional.colors,x=b.directional.positions,w=b.point.colors,_=b.point.positions,k=b.point.distances,T=0,C=0,A=u=0;for(i=0,l=r.length;l>i;i++)h=r[i],h.onlyShadow||(p=h.color,d=h.intensity,u=h.distance,h instanceof t.AmbientLight?D.gammaInput?(f+=p.r*p.r,m+=p.g*p.g,g+=p.b*p.b):(f+=p.r,m+=p.g,g+=p.b):h instanceof t.DirectionalLight?(u=3*T,D.gammaInput?(v[u]=p.r*p.r*d*d,v[u+1]=p.g*p.g*d*d,v[u+2]=p.b*p.b*d*d):(v[u]=p.r*d,v[u+1]=p.g*d,v[u+2]=p.b*d),st.copy(h.matrixWorld.getPosition()),st.subSelf(h.target.matrixWorld.getPosition()),st.normalize(),x[u]=st.x,x[u+1]=st.y,x[u+2]=st.z,T+=1):(h instanceof t.PointLight||h instanceof t.SpotLight)&&(A=3*C,D.gammaInput?(w[A]=p.r*p.r*d*d,w[A+1]=p.g*p.g*d*d,w[A+2]=p.b*p.b*d*d):(w[A]=p.r*d,w[A+1]=p.g*d,w[A+2]=p.b*d),h=h.matrixWorld.getPosition(),_[A]=h.x,_[A+1]=h.y,_[A+2]=h.z,k[C]=u,C+=1));for(i=3*T,l=v.length;l>i;i++)v[i]=0;for(i=3*C,l=w.length;l>i;i++)w[i]=0;b.point.length=C,b.directional.length=T,b.ambient[0]=f,b.ambient[1]=m,b.ambient[2]=g,i=lt,c.ambientLightColor.value=i.ambient,c.directionalLightColor.value=i.directional.colors,c.directionalLightDirection.value=i.directional.positions,c.pointLightColor.value=i.point.colors,c.pointLightPosition.value=i.point.positions,c.pointLightDistance.value=i.point.distances}if((n instanceof t.MeshBasicMaterial||n instanceof t.MeshLambertMaterial||n instanceof t.MeshPhongMaterial)&&(c.opacity.value=n.opacity,D.gammaInput?c.diffuse.value.copyGammaToLinear(n.color):c.diffuse.value=n.color,(c.map.texture=n.map)&&c.offsetRepeat.value.set(n.map.offset.x,n.map.offset.y,n.map.repeat.x,n.map.repeat.y),c.lightMap.texture=n.lightMap,c.envMap.texture=n.envMap,c.flipEnvMap.value=n.envMap instanceof t.WebGLRenderTargetCube?1:-1,c.reflectivity.value=n.reflectivity,c.refractionRatio.value=n.refractionRatio,c.combine.value=n.combine,c.useRefract.value=n.envMap&&n.envMap.mapping instanceof t.CubeRefractionMapping),n instanceof t.LineBasicMaterial?(c.diffuse.value=n.color,c.opacity.value=n.opacity):n instanceof t.ParticleBasicMaterial?(c.psColor.value=n.color,c.opacity.value=n.opacity,c.size.value=n.size,c.scale.value=S.height/2,c.map.texture=n.map):n instanceof t.MeshPhongMaterial?(c.shininess.value=n.shininess,D.gammaInput?(c.ambient.value.copyGammaToLinear(n.ambient),c.specular.value.copyGammaToLinear(n.specular)):(c.ambient.value=n.ambient,c.specular.value=n.specular),n.wrapAround&&c.wrapRGB.value.copy(n.wrapRGB)):n instanceof t.MeshLambertMaterial?(D.gammaInput?c.ambient.value.copyGammaToLinear(n.ambient):c.ambient.value=n.ambient,n.wrapAround&&c.wrapRGB.value.copy(n.wrapRGB)):n instanceof t.MeshDepthMaterial?(c.mNear.value=e.near,c.mFar.value=e.far,c.opacity.value=n.opacity):n instanceof t.MeshNormalMaterial&&(c.opacity.value=n.opacity),o.receiveShadow&&!n._shadowPass&&c.shadowMatrix)for(l=i=0,f=r.length;f>l;l++)m=r[l],m.castShadow&&(m instanceof t.SpotLight||m instanceof t.DirectionalLight&&!m.shadowCascade)&&(c.shadowMap.texture[i]=m.shadowMap,c.shadowMapSize.value[i]=m.shadowMapSize,c.shadowMatrix.value[i]=m.shadowMatrix,c.shadowDarkness.value[i]=m.shadowDarkness,c.shadowBias.value[i]=m.shadowBias,i++);for(r=n.uniformsList,c=0,i=r.length;i>c;c++)if(m=a.uniforms[r[c][1]])if(l=r[c][0],g=l.type,f=l.value,"i"===g)P.uniform1i(m,f);else if("f"===g)P.uniform1f(m,f);else if("v2"===g)P.uniform2f(m,f.x,f.y);else if("v3"===g)P.uniform3f(m,f.x,f.y,f.z);else if("v4"===g)P.uniform4f(m,f.x,f.y,f.z,f.w);else if("c"===g)P.uniform3f(m,f.r,f.g,f.b);else if("fv1"===g)P.uniform1fv(m,f);else if("fv"===g)P.uniform3fv(m,f);else if("v2v"===g){for(l._array||(l._array=new Float32Array(2*f.length)),g=0,b=f.length;b>g;g++)v=2*g,l._array[v]=f[g].x,l._array[v+1]=f[g].y;P.uniform2fv(m,l._array)}else if("v3v"===g){for(l._array||(l._array=new Float32Array(3*f.length)),g=0,b=f.length;b>g;g++)v=3*g,l._array[v]=f[g].x,l._array[v+1]=f[g].y,l._array[v+2]=f[g].z;P.uniform3fv(m,l._array)}else if("v4v"==g){for(l._array||(l._array=new Float32Array(4*f.length)),g=0,b=f.length;b>g;g++)v=4*g,l._array[v]=f[g].x,l._array[v+1]=f[g].y,l._array[v+2]=f[g].z,l._array[v+3]=f[g].w;P.uniform4fv(m,l._array)}else if("m4"===g)l._array||(l._array=new Float32Array(16)),f.flattenToArray(l._array),P.uniformMatrix4fv(m,!1,l._array);else if("m4v"===g){for(l._array||(l._array=new Float32Array(16*f.length)),g=0,b=f.length;b>g;g++)f[g].flattenToArrayOffset(l._array,16*g);P.uniformMatrix4fv(m,!1,l._array)}else if("t"===g){if(P.uniform1i(m,f),m=l.texture)if(m.image instanceof Array&&6===m.image.length){if(l=m,6===l.image.length)if(l.needsUpdate){for(l.image.__webglTextureCube||(l.image.__webglTextureCube=P.createTexture()),P.activeTexture(P.TEXTURE0+f),P.bindTexture(P.TEXTURE_CUBE_MAP,l.image.__webglTextureCube),f=[],m=0;6>m;m++)g=f,b=m,D.autoScaleCubemaps?(v=l.image[m],w=ht,v.width<=w&&v.height<=w||(_=Math.max(v.width,v.height),x=Math.floor(v.width*w/_),w=Math.floor(v.height*w/_),_=document.createElement("canvas"),_.width=x,_.height=w,_.getContext("2d").drawImage(v,0,0,v.width,v.height,0,0,x,w),v=_)):v=l.image[m],g[b]=v;for(m=f[0],g=0===(m.width&m.width-1)&&0===(m.height&m.height-1),b=M(l.format),v=M(l.type),y(P.TEXTURE_CUBE_MAP,l,g),m=0;6>m;m++)P.texImage2D(P.TEXTURE_CUBE_MAP_POSITIVE_X+m,0,b,b,v,f[m]);l.generateMipmaps&&g&&P.generateMipmap(P.TEXTURE_CUBE_MAP),l.needsUpdate=!1,l.onUpdate&&l.onUpdate()}else P.activeTexture(P.TEXTURE0+f),P.bindTexture(P.TEXTURE_CUBE_MAP,l.image.__webglTextureCube)}else m instanceof t.WebGLRenderTargetCube?(l=m,P.activeTexture(P.TEXTURE0+f),P.bindTexture(P.TEXTURE_CUBE_MAP,l.__webglTexture)):D.setTexture(m,f)}else if("tv"===g){if(!l._array)for(l._array=[],g=0,b=l.texture.length;b>g;g++)l._array[g]=f+g;for(P.uniform1iv(m,l._array),g=0,b=l.texture.length;b>g;g++)(m=l.texture[g])&&D.setTexture(m,l._array[g])}(n instanceof t.ShaderMaterial||n instanceof t.MeshPhongMaterial||n.envMap)&&null!==s.cameraPosition&&(r=e.matrixWorld.getPosition(),P.uniform3f(s.cameraPosition,r.x,r.y,r.z)),(n instanceof t.MeshPhongMaterial||n instanceof t.MeshLambertMaterial||n instanceof t.ShaderMaterial||n.skinning)&&null!==s.viewMatrix&&P.uniformMatrix4fv(s.viewMatrix,!1,e._viewMatrixArray),n.skinning&&P.uniformMatrix4fv(s.boneGlobalMatrices,!1,o.boneMatrices)}return P.uniformMatrix4fv(s.modelViewMatrix,!1,o._modelViewMatrixArray),s.normalMatrix&&P.uniformMatrix3fv(s.normalMatrix,!1,o._normalMatrixArray),(n instanceof t.ShaderMaterial||n.envMap||n.skinning||o.receiveShadow)&&null!==s.objectMatrix&&P.uniformMatrix4fv(s.objectMatrix,!1,o._objectMatrixArray),a}function b(e,r){e._modelViewMatrix.multiplyToArray(r.matrixWorldInverse,e.matrixWorld,e._modelViewMatrixArray);var i=t.Matrix4.makeInvert3x3(e._modelViewMatrix);i&&i.transposeIntoArray(e._normalMatrixArray)}function v(e,t,r){q!==e&&(e?P.enable(P.POLYGON_OFFSET_FILL):P.disable(P.POLYGON_OFFSET_FILL),q=e),!e||Z===t&&K===r||(P.polygonOffset(t,r),Z=t,K=r)}function x(e,t){var r;return"fragment"===e?r=P.createShader(P.FRAGMENT_SHADER):"vertex"===e&&(r=P.createShader(P.VERTEX_SHADER)),P.shaderSource(r,t),P.compileShader(r),P.getShaderParameter(r,P.COMPILE_STATUS)?r:(console.error(P.getShaderInfoLog(r)),console.error(t),null)}function y(e,t,r){r?(P.texParameteri(e,P.TEXTURE_WRAP_S,M(t.wrapS)),P.texParameteri(e,P.TEXTURE_WRAP_T,M(t.wrapT)),P.texParameteri(e,P.TEXTURE_MAG_FILTER,M(t.magFilter)),P.texParameteri(e,P.TEXTURE_MIN_FILTER,M(t.minFilter))):(P.texParameteri(e,P.TEXTURE_WRAP_S,P.CLAMP_TO_EDGE),P.texParameteri(e,P.TEXTURE_WRAP_T,P.CLAMP_TO_EDGE),P.texParameteri(e,P.TEXTURE_MAG_FILTER,_(t.magFilter)),P.texParameteri(e,P.TEXTURE_MIN_FILTER,_(t.minFilter)))}function w(e,t){P.bindRenderbuffer(P.RENDERBUFFER,e),t.depthBuffer&&!t.stencilBuffer?(P.renderbufferStorage(P.RENDERBUFFER,P.DEPTH_COMPONENT16,t.width,t.height),P.framebufferRenderbuffer(P.FRAMEBUFFER,P.DEPTH_ATTACHMENT,P.RENDERBUFFER,e)):t.depthBuffer&&t.stencilBuffer?(P.renderbufferStorage(P.RENDERBUFFER,P.DEPTH_STENCIL,t.width,t.height),P.framebufferRenderbuffer(P.FRAMEBUFFER,P.DEPTH_STENCIL_ATTACHMENT,P.RENDERBUFFER,e)):P.renderbufferStorage(P.RENDERBUFFER,P.RGBA4,t.width,t.height)}function _(e){switch(e){case t.NearestFilter:case t.NearestMipMapNearestFilter:case t.NearestMipMapLinearFilter:return P.NEAREST;default:return P.LINEAR}}function M(e){switch(e){case t.RepeatWrapping:return P.REPEAT;case t.ClampToEdgeWrapping:return P.CLAMP_TO_EDGE;case t.MirroredRepeatWrapping:return P.MIRRORED_REPEAT;case t.NearestFilter:return P.NEAREST;case t.NearestMipMapNearestFilter:return P.NEAREST_MIPMAP_NEAREST;case t.NearestMipMapLinearFilter:return P.NEAREST_MIPMAP_LINEAR;case t.LinearFilter:return P.LINEAR;case t.LinearMipMapNearestFilter:return P.LINEAR_MIPMAP_NEAREST;case t.LinearMipMapLinearFilter:return P.LINEAR_MIPMAP_LINEAR;case t.ByteType:return P.BYTE;case t.UnsignedByteType:return P.UNSIGNED_BYTE;case t.ShortType:return P.SHORT;case t.UnsignedShortType:return P.UNSIGNED_SHORT;case t.IntType:return P.INT;case t.UnsignedIntType:return P.UNSIGNED_INT;case t.FloatType:return P.FLOAT;case t.AlphaFormat:return P.ALPHA;case t.RGBFormat:return P.RGB;case t.RGBAFormat:return P.RGBA;case t.LuminanceFormat:return P.LUMINANCE;case t.LuminanceAlphaFormat:return P.LUMINANCE_ALPHA}return 0}var e=e||{},S=void 0!==e.canvas?e.canvas:document.createElement("canvas"),k=void 0!==e.precision?e.precision:"mediump",T=void 0!==e.alpha?e.alpha:!0,C=void 0!==e.premultipliedAlpha?e.premultipliedAlpha:!0,A=void 0!==e.antialias?e.antialias:!1,E=void 0!==e.stencil?e.stencil:!0,L=void 0!==e.preserveDrawingBuffer?e.preserveDrawingBuffer:!1,R=void 0!==e.clearColor?new t.Color(e.clearColor):new t.Color(0),z=void 0!==e.clearAlpha?e.clearAlpha:0,N=void 0!==e.maxLights?e.maxLights:4;this.domElement=S,this.context=null,this.autoUpdateScene=this.autoUpdateObjects=this.sortObjects=this.autoClearStencil=this.autoClearDepth=this.autoClearColor=this.autoClear=!0,this.shadowMapEnabled=this.physicallyBasedShading=this.gammaOutput=this.gammaInput=!1,this.shadowMapCullFrontFaces=this.shadowMapSoft=this.shadowMapAutoUpdate=!0,this.shadowMapCascade=this.shadowMapDebug=!1,this.maxMorphTargets=8,this.maxMorphNormals=4,this.autoScaleCubemaps=!0,this.renderPluginsPre=[],this.renderPluginsPost=[],this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}};var P,D=this,F=[],V=null,B=null,U=-1,O=null,I=null,j=0,W=null,H=null,G=null,X=null,Y=null,q=null,Z=null,K=null,$=null,Q=0,J=0,et=0,tt=0,rt=0,it=0,nt=new t.Frustum,ot=new t.Matrix4,at=new t.Vector4,st=new t.Vector3,lt={ambient:[0,0,0],directional:{length:0,colors:[],positions:[]},point:{length:0,colors:[],positions:[],distances:[]}};P=function(){var e;try{if(!(e=S.getContext("experimental-webgl",{alpha:T,premultipliedAlpha:C,antialias:A,stencil:E,preserveDrawingBuffer:L})))throw"Error creating WebGL context.";console.log(navigator.userAgent+" | "+e.getParameter(e.VERSION)+" | "+e.getParameter(e.VENDOR)+" | "+e.getParameter(e.RENDERER)+" | "+e.getParameter(e.SHADING_LANGUAGE_VERSION))}catch(t){console.error(t)}return e}(),P.clearColor(0,0,0,1),P.clearDepth(1),P.clearStencil(0),P.enable(P.DEPTH_TEST),P.depthFunc(P.LEQUAL),P.frontFace(P.CCW),P.cullFace(P.BACK),P.enable(P.CULL_FACE),P.enable(P.BLEND),P.blendEquation(P.FUNC_ADD),P.blendFunc(P.SRC_ALPHA,P.ONE_MINUS_SRC_ALPHA),P.clearColor(R.r,R.g,R.b,z),this.context=P;var ct=P.getParameter(P.MAX_VERTEX_TEXTURE_IMAGE_UNITS);P.getParameter(P.MAX_TEXTURE_SIZE);var ht=P.getParameter(P.MAX_CUBE_MAP_TEXTURE_SIZE);this.getContext=function(){return P},this.supportsVertexTextures=function(){return ct>0},this.setSize=function(e,t){S.width=e,S.height=t,this.setViewport(0,0,S.width,S.height)},this.setViewport=function(e,t,r,i){Q=e,J=t,et=r,tt=i,P.viewport(Q,J,et,tt)},this.setScissor=function(e,t,r,i){P.scissor(e,t,r,i)},this.enableScissorTest=function(e){e?P.enable(P.SCISSOR_TEST):P.disable(P.SCISSOR_TEST)},this.setClearColorHex=function(e,t){R.setHex(e),z=t,P.clearColor(R.r,R.g,R.b,z)},this.setClearColor=function(e,t){R.copy(e),z=t,P.clearColor(R.r,R.g,R.b,z)},this.getClearColor=function(){return R},this.getClearAlpha=function(){return z},this.clear=function(e,t,r){var i=0;(void 0===e||e)&&(i|=P.COLOR_BUFFER_BIT),(void 0===t||t)&&(i|=P.DEPTH_BUFFER_BIT),(void 0===r||r)&&(i|=P.STENCIL_BUFFER_BIT),P.clear(i)},this.clearTarget=function(e,t,r,i){this.setRenderTarget(e),this.clear(t,r,i)},this.addPostPlugin=function(e){e.init(this),this.renderPluginsPost.push(e)},this.addPrePlugin=function(e){e.init(this),this.renderPluginsPre.push(e)},this.deallocateObject=function(e){if(e.__webglInit)if(e.__webglInit=!1,delete e._modelViewMatrix,delete e._normalMatrixArray,delete e._modelViewMatrixArray,delete e._objectMatrixArray,e instanceof t.Mesh)for(var r in e.geometry.geometryGroups){var i=e.geometry.geometryGroups[r];P.deleteBuffer(i.__webglVertexBuffer),P.deleteBuffer(i.__webglNormalBuffer),P.deleteBuffer(i.__webglTangentBuffer),P.deleteBuffer(i.__webglColorBuffer),P.deleteBuffer(i.__webglUVBuffer),P.deleteBuffer(i.__webglUV2Buffer),P.deleteBuffer(i.__webglSkinVertexABuffer),P.deleteBuffer(i.__webglSkinVertexBBuffer),P.deleteBuffer(i.__webglSkinIndicesBuffer),P.deleteBuffer(i.__webglSkinWeightsBuffer),P.deleteBuffer(i.__webglFaceBuffer),P.deleteBuffer(i.__webglLineBuffer);var n=void 0,o=void 0;if(i.numMorphTargets)for(n=0,o=i.numMorphTargets;o>n;n++)P.deleteBuffer(i.__webglMorphTargetsBuffers[n]);if(i.numMorphNormals)for(n=0,o=i.numMorphNormals;o>n;n++)P.deleteBuffer(i.__webglMorphNormalsBuffers[n]);if(i.__webglCustomAttributesList)for(n in n=void 0,i.__webglCustomAttributesList)P.deleteBuffer(i.__webglCustomAttributesList[n].buffer);D.info.memory.geometries--}else e instanceof t.Ribbon?(e=e.geometry,P.deleteBuffer(e.__webglVertexBuffer),P.deleteBuffer(e.__webglColorBuffer),D.info.memory.geometries--):e instanceof t.Line?(e=e.geometry,P.deleteBuffer(e.__webglVertexBuffer),P.deleteBuffer(e.__webglColorBuffer),D.info.memory.geometries--):e instanceof t.ParticleSystem&&(e=e.geometry,P.deleteBuffer(e.__webglVertexBuffer),P.deleteBuffer(e.__webglColorBuffer),D.info.memory.geometries--)},this.deallocateTexture=function(e){e.__webglInit&&(e.__webglInit=!1,P.deleteTexture(e.__webglTexture),D.info.memory.textures--)},this.updateShadowMap=function(e,t){V=null,U=O=Y=X=G=-1,this.shadowMapPlugin.update(e,t)},this.renderBufferImmediate=function(e,r,i){if(e.__webglVertexBuffer||(e.__webglVertexBuffer=P.createBuffer()),e.__webglNormalBuffer||(e.__webglNormalBuffer=P.createBuffer()),e.hasPos&&(P.bindBuffer(P.ARRAY_BUFFER,e.__webglVertexBuffer),P.bufferData(P.ARRAY_BUFFER,e.positionArray,P.DYNAMIC_DRAW),P.enableVertexAttribArray(r.attributes.position),P.vertexAttribPointer(r.attributes.position,3,P.FLOAT,!1,0,0)),e.hasNormal){if(P.bindBuffer(P.ARRAY_BUFFER,e.__webglNormalBuffer),i===t.FlatShading){var n,o,a,s,l,c,h,p,d,u,f=3*e.count;for(u=0;f>u;u+=9)i=e.normalArray,n=i[u],o=i[u+1],a=i[u+2],s=i[u+3],c=i[u+4],p=i[u+5],l=i[u+6],h=i[u+7],d=i[u+8],n=(n+s+l)/3,o=(o+c+h)/3,a=(a+p+d)/3,i[u]=n,i[u+1]=o,i[u+2]=a,i[u+3]=n,i[u+4]=o,i[u+5]=a,i[u+6]=n,i[u+7]=o,i[u+8]=a}P.bufferData(P.ARRAY_BUFFER,e.normalArray,P.DYNAMIC_DRAW),P.enableVertexAttribArray(r.attributes.normal),P.vertexAttribPointer(r.attributes.normal,3,P.FLOAT,!1,0,0)}P.drawArrays(P.TRIANGLES,0,e.count),e.count=0},this.renderBufferDirect=function(e,r,i,n,o,a){if(0!==n.opacity&&(i=g(e,r,i,n,a),e=i.attributes,r=!1,n=16777215*o.id+2*i.id+(n.wireframe?1:0),n!==O&&(O=n,r=!0),a instanceof t.Mesh))for(a=o.offsets,n=0,i=a.length;i>n;++n)r&&(P.bindBuffer(P.ARRAY_BUFFER,o.vertexPositionBuffer),P.vertexAttribPointer(e.position,o.vertexPositionBuffer.itemSize,P.FLOAT,!1,0,12*a[n].index),0<=e.normal&&o.vertexNormalBuffer&&(P.bindBuffer(P.ARRAY_BUFFER,o.vertexNormalBuffer),P.vertexAttribPointer(e.normal,o.vertexNormalBuffer.itemSize,P.FLOAT,!1,0,12*a[n].index)),0<=e.uv&&o.vertexUvBuffer&&(o.vertexUvBuffer?(P.bindBuffer(P.ARRAY_BUFFER,o.vertexUvBuffer),P.vertexAttribPointer(e.uv,o.vertexUvBuffer.itemSize,P.FLOAT,!1,0,8*a[n].index),P.enableVertexAttribArray(e.uv)):P.disableVertexAttribArray(e.uv)),0<=e.color&&o.vertexColorBuffer&&(P.bindBuffer(P.ARRAY_BUFFER,o.vertexColorBuffer),P.vertexAttribPointer(e.color,o.vertexColorBuffer.itemSize,P.FLOAT,!1,0,16*a[n].index)),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,o.vertexIndexBuffer)),P.drawElements(P.TRIANGLES,a[n].count,P.UNSIGNED_SHORT,2*a[n].start),D.info.render.calls++,D.info.render.vertices+=a[n].count,D.info.render.faces+=a[n].count/3},this.renderBuffer=function(e,r,i,n,o,a){if(0!==n.opacity){var s,l,i=g(e,r,i,n,a),r=i.attributes,e=!1,i=16777215*o.id+2*i.id+(n.wireframe?1:0);if(i!==O&&(O=i,e=!0),!n.morphTargets&&0<=r.position)e&&(P.bindBuffer(P.ARRAY_BUFFER,o.__webglVertexBuffer),P.vertexAttribPointer(r.position,3,P.FLOAT,!1,0,0));else if(a.morphTargetBase){if(i=n.program.attributes,-1!==a.morphTargetBase?(P.bindBuffer(P.ARRAY_BUFFER,o.__webglMorphTargetsBuffers[a.morphTargetBase]),P.vertexAttribPointer(i.position,3,P.FLOAT,!1,0,0)):0<=i.position&&(P.bindBuffer(P.ARRAY_BUFFER,o.__webglVertexBuffer),P.vertexAttribPointer(i.position,3,P.FLOAT,!1,0,0)),a.morphTargetForcedOrder.length){s=0;var c=a.morphTargetForcedOrder;for(l=a.morphTargetInfluences;s<n.numSupportedMorphTargets&&s<c.length;)P.bindBuffer(P.ARRAY_BUFFER,o.__webglMorphTargetsBuffers[c[s]]),P.vertexAttribPointer(i["morphTarget"+s],3,P.FLOAT,!1,0,0),n.morphNormals&&(P.bindBuffer(P.ARRAY_BUFFER,o.__webglMorphNormalsBuffers[c[s]]),P.vertexAttribPointer(i["morphNormal"+s],3,P.FLOAT,!1,0,0)),a.__webglMorphTargetInfluences[s]=l[c[s]],s++}else{var c=[],h=-1,p=0;l=a.morphTargetInfluences;var d,u=l.length;for(s=0,-1!==a.morphTargetBase&&(c[a.morphTargetBase]=!0);s<n.numSupportedMorphTargets;){for(d=0;u>d;d++)!c[d]&&l[d]>h&&(p=d,h=l[p]);
P.bindBuffer(P.ARRAY_BUFFER,o.__webglMorphTargetsBuffers[p]),P.vertexAttribPointer(i["morphTarget"+s],3,P.FLOAT,!1,0,0),n.morphNormals&&(P.bindBuffer(P.ARRAY_BUFFER,o.__webglMorphNormalsBuffers[p]),P.vertexAttribPointer(i["morphNormal"+s],3,P.FLOAT,!1,0,0)),a.__webglMorphTargetInfluences[s]=h,c[p]=1,h=-1,s++}}null!==n.program.uniforms.morphTargetInfluences&&P.uniform1fv(n.program.uniforms.morphTargetInfluences,a.__webglMorphTargetInfluences)}if(e){if(o.__webglCustomAttributesList)for(s=0,l=o.__webglCustomAttributesList.length;l>s;s++)i=o.__webglCustomAttributesList[s],0<=r[i.buffer.belongsToAttribute]&&(P.bindBuffer(P.ARRAY_BUFFER,i.buffer),P.vertexAttribPointer(r[i.buffer.belongsToAttribute],i.size,P.FLOAT,!1,0,0));0<=r.color&&(P.bindBuffer(P.ARRAY_BUFFER,o.__webglColorBuffer),P.vertexAttribPointer(r.color,3,P.FLOAT,!1,0,0)),0<=r.normal&&(P.bindBuffer(P.ARRAY_BUFFER,o.__webglNormalBuffer),P.vertexAttribPointer(r.normal,3,P.FLOAT,!1,0,0)),0<=r.tangent&&(P.bindBuffer(P.ARRAY_BUFFER,o.__webglTangentBuffer),P.vertexAttribPointer(r.tangent,4,P.FLOAT,!1,0,0)),0<=r.uv&&(o.__webglUVBuffer?(P.bindBuffer(P.ARRAY_BUFFER,o.__webglUVBuffer),P.vertexAttribPointer(r.uv,2,P.FLOAT,!1,0,0),P.enableVertexAttribArray(r.uv)):P.disableVertexAttribArray(r.uv)),0<=r.uv2&&(o.__webglUV2Buffer?(P.bindBuffer(P.ARRAY_BUFFER,o.__webglUV2Buffer),P.vertexAttribPointer(r.uv2,2,P.FLOAT,!1,0,0),P.enableVertexAttribArray(r.uv2)):P.disableVertexAttribArray(r.uv2)),n.skinning&&0<=r.skinVertexA&&0<=r.skinVertexB&&0<=r.skinIndex&&0<=r.skinWeight&&(P.bindBuffer(P.ARRAY_BUFFER,o.__webglSkinVertexABuffer),P.vertexAttribPointer(r.skinVertexA,4,P.FLOAT,!1,0,0),P.bindBuffer(P.ARRAY_BUFFER,o.__webglSkinVertexBBuffer),P.vertexAttribPointer(r.skinVertexB,4,P.FLOAT,!1,0,0),P.bindBuffer(P.ARRAY_BUFFER,o.__webglSkinIndicesBuffer),P.vertexAttribPointer(r.skinIndex,4,P.FLOAT,!1,0,0),P.bindBuffer(P.ARRAY_BUFFER,o.__webglSkinWeightsBuffer),P.vertexAttribPointer(r.skinWeight,4,P.FLOAT,!1,0,0))}a instanceof t.Mesh?(n.wireframe?(n=n.wireframeLinewidth,n!==$&&(P.lineWidth(n),$=n),e&&P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,o.__webglLineBuffer),P.drawElements(P.LINES,o.__webglLineCount,P.UNSIGNED_SHORT,0)):(e&&P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,o.__webglFaceBuffer),P.drawElements(P.TRIANGLES,o.__webglFaceCount,P.UNSIGNED_SHORT,0)),D.info.render.calls++,D.info.render.vertices+=o.__webglFaceCount,D.info.render.faces+=o.__webglFaceCount/3):a instanceof t.Line?(a=a.type===t.LineStrip?P.LINE_STRIP:P.LINES,n=n.linewidth,n!==$&&(P.lineWidth(n),$=n),P.drawArrays(a,0,o.__webglLineCount),D.info.render.calls++):a instanceof t.ParticleSystem?(P.drawArrays(P.POINTS,0,o.__webglParticleCount),D.info.render.calls++,D.info.render.points+=o.__webglParticleCount):a instanceof t.Ribbon&&(P.drawArrays(P.TRIANGLE_STRIP,0,o.__webglVertexCount),D.info.render.calls++)}},this.render=function(e,r,i,n){var o,a,p,d,u=e.__lights,f=e.fog;for(U=-1,this.autoUpdateObjects&&this.initWebGLObjects(e),void 0===r.parent&&(console.warn("DEPRECATED: Camera hasn't been added to a Scene. Adding it..."),e.add(r)),this.autoUpdateScene&&e.updateMatrixWorld(),l(this.renderPluginsPre,e,r),D.info.render.calls=0,D.info.render.vertices=0,D.info.render.faces=0,D.info.render.points=0,r.matrixWorldInverse.getInverse(r.matrixWorld),r._viewMatrixArray||(r._viewMatrixArray=new Float32Array(16)),r.matrixWorldInverse.flattenToArray(r._viewMatrixArray),r._projectionMatrixArray||(r._projectionMatrixArray=new Float32Array(16)),r.projectionMatrix.flattenToArray(r._projectionMatrixArray),ot.multiply(r.projectionMatrix,r.matrixWorldInverse),nt.setFromMatrix(ot),this.setRenderTarget(i),(this.autoClear||n)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),d=e.__webglObjects,n=0,o=d.length;o>n;n++)if(a=d[n],p=a.object,a.render=!1,p.visible&&(!(p instanceof t.Mesh||p instanceof t.ParticleSystem)||!p.frustumCulled||nt.contains(p))){p.matrixWorld.flattenToArray(p._objectMatrixArray),b(p,r);var m=a,g=m.object,x=m.buffer,y=void 0,y=y=void 0,y=g.material;y instanceof t.MeshFaceMaterial?(y=x.materialIndex,y>=0&&(y=g.geometry.materials[y],y.transparent?(m.transparent=y,m.opaque=null):(m.opaque=y,m.transparent=null))):y&&(y.transparent?(m.transparent=y,m.opaque=null):(m.opaque=y,m.transparent=null)),a.render=!0,this.sortObjects&&(p.renderDepth?a.z=p.renderDepth:(at.copy(p.position),ot.multiplyVector3(at),a.z=at.z))}for(this.sortObjects&&d.sort(s),d=e.__webglObjectsImmediate,n=0,o=d.length;o>n;n++)a=d[n],p=a.object,p.visible&&(p.matrixAutoUpdate&&p.matrixWorld.flattenToArray(p._objectMatrixArray),b(p,r),p=a.object.material,p.transparent?(a.transparent=p,a.opaque=null):(a.opaque=p,a.transparent=null));e.overrideMaterial?(this.setBlending(e.overrideMaterial.blending),this.setDepthTest(e.overrideMaterial.depthTest),this.setDepthWrite(e.overrideMaterial.depthWrite),v(e.overrideMaterial.polygonOffset,e.overrideMaterial.polygonOffsetFactor,e.overrideMaterial.polygonOffsetUnits),c(e.__webglObjects,!1,"",r,u,f,!0,e.overrideMaterial),h(e.__webglObjectsImmediate,"",r,u,f,!1,e.overrideMaterial)):(this.setBlending(t.NormalBlending),c(e.__webglObjects,!0,"opaque",r,u,f,!1),h(e.__webglObjectsImmediate,"opaque",r,u,f,!1),c(e.__webglObjects,!1,"transparent",r,u,f,!0),h(e.__webglObjectsImmediate,"transparent",r,u,f,!0)),l(this.renderPluginsPost,e,r),i&&i.generateMipmaps&&i.minFilter!==t.NearestFilter&&i.minFilter!==t.LinearFilter&&(i instanceof t.WebGLRenderTargetCube?(P.bindTexture(P.TEXTURE_CUBE_MAP,i.__webglTexture),P.generateMipmap(P.TEXTURE_CUBE_MAP),P.bindTexture(P.TEXTURE_CUBE_MAP,null)):(P.bindTexture(P.TEXTURE_2D,i.__webglTexture),P.generateMipmap(P.TEXTURE_2D),P.bindTexture(P.TEXTURE_2D,null))),this.setDepthTest(!0),this.setDepthWrite(!0)},this.renderImmediateObject=function(e,t,r,i,n){var o=g(e,t,r,i,n);O=-1,D.setObjectFaces(n),n.immediateRenderCallback?n.immediateRenderCallback(o,P,nt):n.render(function(e){D.renderBufferImmediate(e,o,i.shading)})},this.initWebGLObjects=function(e){for(e.__webglObjects||(e.__webglObjects=[],e.__webglObjectsImmediate=[],e.__webglSprites=[],e.__webglFlares=[]);e.__objectsAdded.length;){var s=e.__objectsAdded[0],l=e,c=void 0,h=void 0,g=void 0;if(!s.__webglInit)if(s.__webglInit=!0,s._modelViewMatrix=new t.Matrix4,s._normalMatrixArray=new Float32Array(9),s._modelViewMatrixArray=new Float32Array(16),s._objectMatrixArray=new Float32Array(16),s.matrixWorld.flattenToArray(s._objectMatrixArray),s instanceof t.Mesh){if(h=s.geometry,h instanceof t.Geometry){if(void 0===h.geometryGroups){var b=h,v=void 0,x=void 0,y=void 0,w=void 0,_=void 0,M=void 0,S=void 0,k={},T=b.morphTargets.length,C=b.morphNormals.length;for(b.geometryGroups={},v=0,x=b.faces.length;x>v;v++)y=b.faces[v],w=y.materialIndex,M=void 0!==w?w:-1,void 0===k[M]&&(k[M]={hash:M,counter:0}),S=k[M].hash+"_"+k[M].counter,void 0===b.geometryGroups[S]&&(b.geometryGroups[S]={faces3:[],faces4:[],materialIndex:w,vertices:0,numMorphTargets:T,numMorphNormals:C}),_=y instanceof t.Face3?3:4,65535<b.geometryGroups[S].vertices+_&&(k[M].counter+=1,S=k[M].hash+"_"+k[M].counter,void 0===b.geometryGroups[S]&&(b.geometryGroups[S]={faces3:[],faces4:[],materialIndex:w,vertices:0,numMorphTargets:T,numMorphNormals:C})),y instanceof t.Face3?b.geometryGroups[S].faces3.push(v):b.geometryGroups[S].faces4.push(v),b.geometryGroups[S].vertices+=_;b.geometryGroupsList=[];var A=void 0;for(A in b.geometryGroups)b.geometryGroups[A].id=j++,b.geometryGroupsList.push(b.geometryGroups[A])}for(c in h.geometryGroups)if(g=h.geometryGroups[c],!g.__webglVertexBuffer){var E=g;E.__webglVertexBuffer=P.createBuffer(),E.__webglNormalBuffer=P.createBuffer(),E.__webglTangentBuffer=P.createBuffer(),E.__webglColorBuffer=P.createBuffer(),E.__webglUVBuffer=P.createBuffer(),E.__webglUV2Buffer=P.createBuffer(),E.__webglSkinVertexABuffer=P.createBuffer(),E.__webglSkinVertexBBuffer=P.createBuffer(),E.__webglSkinIndicesBuffer=P.createBuffer(),E.__webglSkinWeightsBuffer=P.createBuffer(),E.__webglFaceBuffer=P.createBuffer(),E.__webglLineBuffer=P.createBuffer();var L=void 0,R=void 0;if(E.numMorphTargets)for(E.__webglMorphTargetsBuffers=[],L=0,R=E.numMorphTargets;R>L;L++)E.__webglMorphTargetsBuffers.push(P.createBuffer());if(E.numMorphNormals)for(E.__webglMorphNormalsBuffers=[],L=0,R=E.numMorphNormals;R>L;L++)E.__webglMorphNormalsBuffers.push(P.createBuffer());D.info.memory.geometries++;var z=g,N=s,F=N.geometry,V=z.faces3,B=z.faces4,U=3*V.length+4*B.length,O=1*V.length+2*B.length,I=3*V.length+4*B.length,W=i(N,z),H=o(W),G=n(W),X=W.vertexColors?W.vertexColors:!1;z.__vertexArray=new Float32Array(3*U),G&&(z.__normalArray=new Float32Array(3*U)),F.hasTangents&&(z.__tangentArray=new Float32Array(4*U)),X&&(z.__colorArray=new Float32Array(3*U)),H&&((0<F.faceUvs.length||0<F.faceVertexUvs.length)&&(z.__uvArray=new Float32Array(2*U)),(1<F.faceUvs.length||1<F.faceVertexUvs.length)&&(z.__uv2Array=new Float32Array(2*U))),N.geometry.skinWeights.length&&N.geometry.skinIndices.length&&(z.__skinVertexAArray=new Float32Array(4*U),z.__skinVertexBArray=new Float32Array(4*U),z.__skinIndexArray=new Float32Array(4*U),z.__skinWeightArray=new Float32Array(4*U)),z.__faceArray=new Uint16Array(3*O),z.__lineArray=new Uint16Array(2*I);var Y=void 0,q=void 0;if(z.numMorphTargets)for(z.__morphTargetsArrays=[],Y=0,q=z.numMorphTargets;q>Y;Y++)z.__morphTargetsArrays.push(new Float32Array(3*U));if(z.numMorphNormals)for(z.__morphNormalsArrays=[],Y=0,q=z.numMorphNormals;q>Y;Y++)z.__morphNormalsArrays.push(new Float32Array(3*U));if(z.__webglFaceCount=3*O,z.__webglLineCount=2*I,W.attributes){void 0===z.__webglCustomAttributesList&&(z.__webglCustomAttributesList=[]);var Z=void 0;for(Z in W.attributes){var K,$=W.attributes[Z],Q={};for(K in $)Q[K]=$[K];if(!Q.__webglInitialized||Q.createUniqueBuffers){Q.__webglInitialized=!0;var J=1;"v2"===Q.type?J=2:"v3"===Q.type?J=3:"v4"===Q.type?J=4:"c"===Q.type&&(J=3),Q.size=J,Q.array=new Float32Array(U*J),Q.buffer=P.createBuffer(),Q.buffer.belongsToAttribute=Z,$.needsUpdate=!0,Q.__original=$}z.__webglCustomAttributesList.push(Q)}}z.__inittedArrays=!0,h.__dirtyVertices=!0,h.__dirtyMorphTargets=!0,h.__dirtyElements=!0,h.__dirtyUvs=!0,h.__dirtyNormals=!0,h.__dirtyTangents=!0,h.__dirtyColors=!0}}}else if(s instanceof t.Ribbon){if(h=s.geometry,!h.__webglVertexBuffer){var et=h;et.__webglVertexBuffer=P.createBuffer(),et.__webglColorBuffer=P.createBuffer(),D.info.memory.geometries++;var tt=h,rt=tt.vertices.length;tt.__vertexArray=new Float32Array(3*rt),tt.__colorArray=new Float32Array(3*rt),tt.__webglVertexCount=rt,h.__dirtyVertices=!0,h.__dirtyColors=!0}}else if(s instanceof t.Line){if(h=s.geometry,!h.__webglVertexBuffer){var it=h;it.__webglVertexBuffer=P.createBuffer(),it.__webglColorBuffer=P.createBuffer(),D.info.memory.geometries++;var nt=h,ot=s,at=nt.vertices.length;nt.__vertexArray=new Float32Array(3*at),nt.__colorArray=new Float32Array(3*at),nt.__webglLineCount=at,r(nt,ot),h.__dirtyVertices=!0,h.__dirtyColors=!0}}else if(s instanceof t.ParticleSystem&&(h=s.geometry,!h.__webglVertexBuffer)){var st=h;st.__webglVertexBuffer=P.createBuffer(),st.__webglColorBuffer=P.createBuffer(),D.info.geometries++;var lt=h,ct=s,ht=lt.vertices.length;lt.__vertexArray=new Float32Array(3*ht),lt.__colorArray=new Float32Array(3*ht),lt.__sortArray=[],lt.__webglParticleCount=ht,r(lt,ct),h.__dirtyVertices=!0,h.__dirtyColors=!0}if(!s.__webglActive){if(s instanceof t.Mesh)if(h=s.geometry,h instanceof t.BufferGeometry)p(l.__webglObjects,h,s);else for(c in h.geometryGroups)g=h.geometryGroups[c],p(l.__webglObjects,g,s);else s instanceof t.Ribbon||s instanceof t.Line||s instanceof t.ParticleSystem?(h=s.geometry,p(l.__webglObjects,h,s)):void 0!==t.MarchingCubes&&s instanceof t.MarchingCubes||s.immediateRenderCallback?l.__webglObjectsImmediate.push({object:s,opaque:null,transparent:null}):s instanceof t.Sprite?l.__webglSprites.push(s):s instanceof t.LensFlare&&l.__webglFlares.push(s);s.__webglActive=!0}e.__objectsAdded.splice(0,1)}for(;e.__objectsRemoved.length;){var pt=e.__objectsRemoved[0],dt=e;pt instanceof t.Mesh||pt instanceof t.ParticleSystem||pt instanceof t.Ribbon||pt instanceof t.Line?f(dt.__webglObjects,pt):pt instanceof t.Sprite?m(dt.__webglSprites,pt):pt instanceof t.LensFlare?m(dt.__webglFlares,pt):(pt instanceof t.MarchingCubes||pt.immediateRenderCallback)&&f(dt.__webglObjectsImmediate,pt),pt.__webglActive=!1,e.__objectsRemoved.splice(0,1)}for(var ut=0,ft=e.__webglObjects.length;ft>ut;ut++){var mt=e.__webglObjects[ut].object,gt=mt.geometry,bt=void 0,vt=void 0,xt=void 0;if(mt instanceof t.Mesh)if(gt instanceof t.BufferGeometry)gt.__dirtyVertices=!1,gt.__dirtyElements=!1,gt.__dirtyUvs=!1,gt.__dirtyNormals=!1,gt.__dirtyColors=!1;else{for(var yt=0,wt=gt.geometryGroupsList.length;wt>yt;yt++)if(bt=gt.geometryGroupsList[yt],xt=i(mt,bt),vt=xt.attributes&&d(xt),gt.__dirtyVertices||gt.__dirtyMorphTargets||gt.__dirtyElements||gt.__dirtyUvs||gt.__dirtyNormals||gt.__dirtyColors||gt.__dirtyTangents||vt){var _t=bt,Mt=mt,St=P.DYNAMIC_DRAW,kt=!gt.dynamic,Tt=xt;if(_t.__inittedArrays){var Ct=n(Tt),At=Tt.vertexColors?Tt.vertexColors:!1,Et=o(Tt),Lt=Ct===t.SmoothShading,Rt=void 0,zt=void 0,Nt=void 0,Pt=void 0,Dt=void 0,Ft=void 0,Vt=void 0,Bt=void 0,Ut=void 0,Ot=void 0,It=void 0,jt=void 0,Wt=void 0,Ht=void 0,Gt=void 0,Xt=void 0,Yt=void 0,qt=void 0,Zt=void 0,Kt=void 0,$t=void 0,Qt=void 0,Jt=void 0,er=void 0,tr=void 0,rr=void 0,ir=void 0,nr=void 0,or=void 0,ar=void 0,sr=void 0,lr=void 0,cr=void 0,hr=void 0,pr=void 0,dr=void 0,ur=void 0,fr=void 0,mr=void 0,gr=void 0,br=void 0,vr=void 0,xr=void 0,yr=void 0,wr=void 0,_r=void 0,Mr=void 0,Sr=void 0,kr=void 0,Tr=void 0,Cr=void 0,Ar=void 0,Er=void 0,Lr=void 0,Rr=0,zr=0,Nr=0,Pr=0,Dr=0,Fr=0,Vr=0,Br=0,Ur=0,Or=0,Ir=0,jr=0,Wr=void 0,Hr=_t.__vertexArray,Gr=_t.__uvArray,Xr=_t.__uv2Array,Yr=_t.__normalArray,qr=_t.__tangentArray,Zr=_t.__colorArray,Kr=_t.__skinVertexAArray,$r=_t.__skinVertexBArray,Qr=_t.__skinIndexArray,Jr=_t.__skinWeightArray,ei=_t.__morphTargetsArrays,ti=_t.__morphNormalsArrays,ri=_t.__webglCustomAttributesList,ii=void 0,ni=_t.__faceArray,oi=_t.__lineArray,ai=Mt.geometry,si=ai.__dirtyElements,li=ai.__dirtyUvs,ci=ai.__dirtyNormals,hi=ai.__dirtyTangents,pi=ai.__dirtyColors,di=ai.__dirtyMorphTargets,ui=ai.vertices,fi=_t.faces3,mi=_t.faces4,gi=ai.faces,bi=ai.faceVertexUvs[0],vi=ai.faceVertexUvs[1],xi=ai.skinVerticesA,yi=ai.skinVerticesB,wi=ai.skinIndices,_i=ai.skinWeights,Mi=ai.morphTargets,Si=ai.morphNormals;if(ai.__dirtyVertices){for(Rt=0,zt=fi.length;zt>Rt;Rt++)Pt=gi[fi[Rt]],jt=ui[Pt.a].position,Wt=ui[Pt.b].position,Ht=ui[Pt.c].position,Hr[zr]=jt.x,Hr[zr+1]=jt.y,Hr[zr+2]=jt.z,Hr[zr+3]=Wt.x,Hr[zr+4]=Wt.y,Hr[zr+5]=Wt.z,Hr[zr+6]=Ht.x,Hr[zr+7]=Ht.y,Hr[zr+8]=Ht.z,zr+=9;for(Rt=0,zt=mi.length;zt>Rt;Rt++)Pt=gi[mi[Rt]],jt=ui[Pt.a].position,Wt=ui[Pt.b].position,Ht=ui[Pt.c].position,Gt=ui[Pt.d].position,Hr[zr]=jt.x,Hr[zr+1]=jt.y,Hr[zr+2]=jt.z,Hr[zr+3]=Wt.x,Hr[zr+4]=Wt.y,Hr[zr+5]=Wt.z,Hr[zr+6]=Ht.x,Hr[zr+7]=Ht.y,Hr[zr+8]=Ht.z,Hr[zr+9]=Gt.x,Hr[zr+10]=Gt.y,Hr[zr+11]=Gt.z,zr+=12;P.bindBuffer(P.ARRAY_BUFFER,_t.__webglVertexBuffer),P.bufferData(P.ARRAY_BUFFER,Hr,St)}if(di)for(kr=0,Tr=Mi.length;Tr>kr;kr++){for(Ir=0,Rt=0,zt=fi.length;zt>Rt;Rt++)Er=fi[Rt],Pt=gi[Er],jt=Mi[kr].vertices[Pt.a].position,Wt=Mi[kr].vertices[Pt.b].position,Ht=Mi[kr].vertices[Pt.c].position,Cr=ei[kr],Cr[Ir]=jt.x,Cr[Ir+1]=jt.y,Cr[Ir+2]=jt.z,Cr[Ir+3]=Wt.x,Cr[Ir+4]=Wt.y,Cr[Ir+5]=Wt.z,Cr[Ir+6]=Ht.x,Cr[Ir+7]=Ht.y,Cr[Ir+8]=Ht.z,Tt.morphNormals&&(Lt?(Lr=Si[kr].vertexNormals[Er],Kt=Lr.a,$t=Lr.b,Qt=Lr.c):Qt=$t=Kt=Si[kr].faceNormals[Er],Ar=ti[kr],Ar[Ir]=Kt.x,Ar[Ir+1]=Kt.y,Ar[Ir+2]=Kt.z,Ar[Ir+3]=$t.x,Ar[Ir+4]=$t.y,Ar[Ir+5]=$t.z,Ar[Ir+6]=Qt.x,Ar[Ir+7]=Qt.y,Ar[Ir+8]=Qt.z),Ir+=9;for(Rt=0,zt=mi.length;zt>Rt;Rt++)Er=mi[Rt],Pt=gi[Er],jt=Mi[kr].vertices[Pt.a].position,Wt=Mi[kr].vertices[Pt.b].position,Ht=Mi[kr].vertices[Pt.c].position,Gt=Mi[kr].vertices[Pt.d].position,Cr=ei[kr],Cr[Ir]=jt.x,Cr[Ir+1]=jt.y,Cr[Ir+2]=jt.z,Cr[Ir+3]=Wt.x,Cr[Ir+4]=Wt.y,Cr[Ir+5]=Wt.z,Cr[Ir+6]=Ht.x,Cr[Ir+7]=Ht.y,Cr[Ir+8]=Ht.z,Cr[Ir+9]=Gt.x,Cr[Ir+10]=Gt.y,Cr[Ir+11]=Gt.z,Tt.morphNormals&&(Lt?(Lr=Si[kr].vertexNormals[Er],Kt=Lr.a,$t=Lr.b,Qt=Lr.c,Jt=Lr.d):Jt=Qt=$t=Kt=Si[kr].faceNormals[Er],Ar=ti[kr],Ar[Ir]=Kt.x,Ar[Ir+1]=Kt.y,Ar[Ir+2]=Kt.z,Ar[Ir+3]=$t.x,Ar[Ir+4]=$t.y,Ar[Ir+5]=$t.z,Ar[Ir+6]=Qt.x,Ar[Ir+7]=Qt.y,Ar[Ir+8]=Qt.z,Ar[Ir+9]=Jt.x,Ar[Ir+10]=Jt.y,Ar[Ir+11]=Jt.z),Ir+=12;P.bindBuffer(P.ARRAY_BUFFER,_t.__webglMorphTargetsBuffers[kr]),P.bufferData(P.ARRAY_BUFFER,ei[kr],St),Tt.morphNormals&&(P.bindBuffer(P.ARRAY_BUFFER,_t.__webglMorphNormalsBuffers[kr]),P.bufferData(P.ARRAY_BUFFER,ti[kr],St))}if(_i.length){for(Rt=0,zt=fi.length;zt>Rt;Rt++)Pt=gi[fi[Rt]],nr=_i[Pt.a],or=_i[Pt.b],ar=_i[Pt.c],Jr[Or]=nr.x,Jr[Or+1]=nr.y,Jr[Or+2]=nr.z,Jr[Or+3]=nr.w,Jr[Or+4]=or.x,Jr[Or+5]=or.y,Jr[Or+6]=or.z,Jr[Or+7]=or.w,Jr[Or+8]=ar.x,Jr[Or+9]=ar.y,Jr[Or+10]=ar.z,Jr[Or+11]=ar.w,lr=wi[Pt.a],cr=wi[Pt.b],hr=wi[Pt.c],Qr[Or]=lr.x,Qr[Or+1]=lr.y,Qr[Or+2]=lr.z,Qr[Or+3]=lr.w,Qr[Or+4]=cr.x,Qr[Or+5]=cr.y,Qr[Or+6]=cr.z,Qr[Or+7]=cr.w,Qr[Or+8]=hr.x,Qr[Or+9]=hr.y,Qr[Or+10]=hr.z,Qr[Or+11]=hr.w,dr=xi[Pt.a],ur=xi[Pt.b],fr=xi[Pt.c],Kr[Or]=dr.x,Kr[Or+1]=dr.y,Kr[Or+2]=dr.z,Kr[Or+3]=1,Kr[Or+4]=ur.x,Kr[Or+5]=ur.y,Kr[Or+6]=ur.z,Kr[Or+7]=1,Kr[Or+8]=fr.x,Kr[Or+9]=fr.y,Kr[Or+10]=fr.z,Kr[Or+11]=1,gr=yi[Pt.a],br=yi[Pt.b],vr=yi[Pt.c],$r[Or]=gr.x,$r[Or+1]=gr.y,$r[Or+2]=gr.z,$r[Or+3]=1,$r[Or+4]=br.x,$r[Or+5]=br.y,$r[Or+6]=br.z,$r[Or+7]=1,$r[Or+8]=vr.x,$r[Or+9]=vr.y,$r[Or+10]=vr.z,$r[Or+11]=1,Or+=12;for(Rt=0,zt=mi.length;zt>Rt;Rt++)Pt=gi[mi[Rt]],nr=_i[Pt.a],or=_i[Pt.b],ar=_i[Pt.c],sr=_i[Pt.d],Jr[Or]=nr.x,Jr[Or+1]=nr.y,Jr[Or+2]=nr.z,Jr[Or+3]=nr.w,Jr[Or+4]=or.x,Jr[Or+5]=or.y,Jr[Or+6]=or.z,Jr[Or+7]=or.w,Jr[Or+8]=ar.x,Jr[Or+9]=ar.y,Jr[Or+10]=ar.z,Jr[Or+11]=ar.w,Jr[Or+12]=sr.x,Jr[Or+13]=sr.y,Jr[Or+14]=sr.z,Jr[Or+15]=sr.w,lr=wi[Pt.a],cr=wi[Pt.b],hr=wi[Pt.c],pr=wi[Pt.d],Qr[Or]=lr.x,Qr[Or+1]=lr.y,Qr[Or+2]=lr.z,Qr[Or+3]=lr.w,Qr[Or+4]=cr.x,Qr[Or+5]=cr.y,Qr[Or+6]=cr.z,Qr[Or+7]=cr.w,Qr[Or+8]=hr.x,Qr[Or+9]=hr.y,Qr[Or+10]=hr.z,Qr[Or+11]=hr.w,Qr[Or+12]=pr.x,Qr[Or+13]=pr.y,Qr[Or+14]=pr.z,Qr[Or+15]=pr.w,dr=xi[Pt.a],ur=xi[Pt.b],fr=xi[Pt.c],mr=xi[Pt.d],Kr[Or]=dr.x,Kr[Or+1]=dr.y,Kr[Or+2]=dr.z,Kr[Or+3]=1,Kr[Or+4]=ur.x,Kr[Or+5]=ur.y,Kr[Or+6]=ur.z,Kr[Or+7]=1,Kr[Or+8]=fr.x,Kr[Or+9]=fr.y,Kr[Or+10]=fr.z,Kr[Or+11]=1,Kr[Or+12]=mr.x,Kr[Or+13]=mr.y,Kr[Or+14]=mr.z,Kr[Or+15]=1,gr=yi[Pt.a],br=yi[Pt.b],vr=yi[Pt.c],xr=yi[Pt.d],$r[Or]=gr.x,$r[Or+1]=gr.y,$r[Or+2]=gr.z,$r[Or+3]=1,$r[Or+4]=br.x,$r[Or+5]=br.y,$r[Or+6]=br.z,$r[Or+7]=1,$r[Or+8]=vr.x,$r[Or+9]=vr.y,$r[Or+10]=vr.z,$r[Or+11]=1,$r[Or+12]=xr.x,$r[Or+13]=xr.y,$r[Or+14]=xr.z,$r[Or+15]=1,Or+=16;Or>0&&(P.bindBuffer(P.ARRAY_BUFFER,_t.__webglSkinVertexABuffer),P.bufferData(P.ARRAY_BUFFER,Kr,St),P.bindBuffer(P.ARRAY_BUFFER,_t.__webglSkinVertexBBuffer),P.bufferData(P.ARRAY_BUFFER,$r,St),P.bindBuffer(P.ARRAY_BUFFER,_t.__webglSkinIndicesBuffer),P.bufferData(P.ARRAY_BUFFER,Qr,St),P.bindBuffer(P.ARRAY_BUFFER,_t.__webglSkinWeightsBuffer),P.bufferData(P.ARRAY_BUFFER,Jr,St))}if(pi&&At){for(Rt=0,zt=fi.length;zt>Rt;Rt++)Pt=gi[fi[Rt]],Vt=Pt.vertexColors,Bt=Pt.color,3===Vt.length&&At===t.VertexColors?(er=Vt[0],tr=Vt[1],rr=Vt[2]):rr=tr=er=Bt,Zr[Ur]=er.r,Zr[Ur+1]=er.g,Zr[Ur+2]=er.b,Zr[Ur+3]=tr.r,Zr[Ur+4]=tr.g,Zr[Ur+5]=tr.b,Zr[Ur+6]=rr.r,Zr[Ur+7]=rr.g,Zr[Ur+8]=rr.b,Ur+=9;for(Rt=0,zt=mi.length;zt>Rt;Rt++)Pt=gi[mi[Rt]],Vt=Pt.vertexColors,Bt=Pt.color,4===Vt.length&&At===t.VertexColors?(er=Vt[0],tr=Vt[1],rr=Vt[2],ir=Vt[3]):ir=rr=tr=er=Bt,Zr[Ur]=er.r,Zr[Ur+1]=er.g,Zr[Ur+2]=er.b,Zr[Ur+3]=tr.r,Zr[Ur+4]=tr.g,Zr[Ur+5]=tr.b,Zr[Ur+6]=rr.r,Zr[Ur+7]=rr.g,Zr[Ur+8]=rr.b,Zr[Ur+9]=ir.r,Zr[Ur+10]=ir.g,Zr[Ur+11]=ir.b,Ur+=12;Ur>0&&(P.bindBuffer(P.ARRAY_BUFFER,_t.__webglColorBuffer),P.bufferData(P.ARRAY_BUFFER,Zr,St))}if(hi&&ai.hasTangents){for(Rt=0,zt=fi.length;zt>Rt;Rt++)Pt=gi[fi[Rt]],Ut=Pt.vertexTangents,Xt=Ut[0],Yt=Ut[1],qt=Ut[2],qr[Vr]=Xt.x,qr[Vr+1]=Xt.y,qr[Vr+2]=Xt.z,qr[Vr+3]=Xt.w,qr[Vr+4]=Yt.x,qr[Vr+5]=Yt.y,qr[Vr+6]=Yt.z,qr[Vr+7]=Yt.w,qr[Vr+8]=qt.x,qr[Vr+9]=qt.y,qr[Vr+10]=qt.z,qr[Vr+11]=qt.w,Vr+=12;for(Rt=0,zt=mi.length;zt>Rt;Rt++)Pt=gi[mi[Rt]],Ut=Pt.vertexTangents,Xt=Ut[0],Yt=Ut[1],qt=Ut[2],Zt=Ut[3],qr[Vr]=Xt.x,qr[Vr+1]=Xt.y,qr[Vr+2]=Xt.z,qr[Vr+3]=Xt.w,qr[Vr+4]=Yt.x,qr[Vr+5]=Yt.y,qr[Vr+6]=Yt.z,qr[Vr+7]=Yt.w,qr[Vr+8]=qt.x,qr[Vr+9]=qt.y,qr[Vr+10]=qt.z,qr[Vr+11]=qt.w,qr[Vr+12]=Zt.x,qr[Vr+13]=Zt.y,qr[Vr+14]=Zt.z,qr[Vr+15]=Zt.w,Vr+=16;P.bindBuffer(P.ARRAY_BUFFER,_t.__webglTangentBuffer),P.bufferData(P.ARRAY_BUFFER,qr,St)}if(ci&&Ct){for(Rt=0,zt=fi.length;zt>Rt;Rt++)if(Pt=gi[fi[Rt]],Dt=Pt.vertexNormals,Ft=Pt.normal,3===Dt.length&&Lt)for(yr=0;3>yr;yr++)_r=Dt[yr],Yr[Fr]=_r.x,Yr[Fr+1]=_r.y,Yr[Fr+2]=_r.z,Fr+=3;else for(yr=0;3>yr;yr++)Yr[Fr]=Ft.x,Yr[Fr+1]=Ft.y,Yr[Fr+2]=Ft.z,Fr+=3;for(Rt=0,zt=mi.length;zt>Rt;Rt++)if(Pt=gi[mi[Rt]],Dt=Pt.vertexNormals,Ft=Pt.normal,4===Dt.length&&Lt)for(yr=0;4>yr;yr++)_r=Dt[yr],Yr[Fr]=_r.x,Yr[Fr+1]=_r.y,Yr[Fr+2]=_r.z,Fr+=3;else for(yr=0;4>yr;yr++)Yr[Fr]=Ft.x,Yr[Fr+1]=Ft.y,Yr[Fr+2]=Ft.z,Fr+=3;P.bindBuffer(P.ARRAY_BUFFER,_t.__webglNormalBuffer),P.bufferData(P.ARRAY_BUFFER,Yr,St)}if(li&&bi&&Et){for(Rt=0,zt=fi.length;zt>Rt;Rt++)if(Nt=fi[Rt],Pt=gi[Nt],Ot=bi[Nt],void 0!==Ot)for(yr=0;3>yr;yr++)Mr=Ot[yr],Gr[Nr]=Mr.u,Gr[Nr+1]=Mr.v,Nr+=2;for(Rt=0,zt=mi.length;zt>Rt;Rt++)if(Nt=mi[Rt],Pt=gi[Nt],Ot=bi[Nt],void 0!==Ot)for(yr=0;4>yr;yr++)Mr=Ot[yr],Gr[Nr]=Mr.u,Gr[Nr+1]=Mr.v,Nr+=2;Nr>0&&(P.bindBuffer(P.ARRAY_BUFFER,_t.__webglUVBuffer),P.bufferData(P.ARRAY_BUFFER,Gr,St))}if(li&&vi&&Et){for(Rt=0,zt=fi.length;zt>Rt;Rt++)if(Nt=fi[Rt],Pt=gi[Nt],It=vi[Nt],void 0!==It)for(yr=0;3>yr;yr++)Sr=It[yr],Xr[Pr]=Sr.u,Xr[Pr+1]=Sr.v,Pr+=2;for(Rt=0,zt=mi.length;zt>Rt;Rt++)if(Nt=mi[Rt],Pt=gi[Nt],It=vi[Nt],void 0!==It)for(yr=0;4>yr;yr++)Sr=It[yr],Xr[Pr]=Sr.u,Xr[Pr+1]=Sr.v,Pr+=2;Pr>0&&(P.bindBuffer(P.ARRAY_BUFFER,_t.__webglUV2Buffer),P.bufferData(P.ARRAY_BUFFER,Xr,St))}if(si){for(Rt=0,zt=fi.length;zt>Rt;Rt++)Pt=gi[fi[Rt]],ni[Dr]=Rr,ni[Dr+1]=Rr+1,ni[Dr+2]=Rr+2,Dr+=3,oi[Br]=Rr,oi[Br+1]=Rr+1,oi[Br+2]=Rr,oi[Br+3]=Rr+2,oi[Br+4]=Rr+1,oi[Br+5]=Rr+2,Br+=6,Rr+=3;for(Rt=0,zt=mi.length;zt>Rt;Rt++)Pt=gi[mi[Rt]],ni[Dr]=Rr,ni[Dr+1]=Rr+1,ni[Dr+2]=Rr+3,ni[Dr+3]=Rr+1,ni[Dr+4]=Rr+2,ni[Dr+5]=Rr+3,Dr+=6,oi[Br]=Rr,oi[Br+1]=Rr+1,oi[Br+2]=Rr,oi[Br+3]=Rr+3,oi[Br+4]=Rr+1,oi[Br+5]=Rr+2,oi[Br+6]=Rr+2,oi[Br+7]=Rr+3,Br+=8,Rr+=4;P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,_t.__webglFaceBuffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,ni,St),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,_t.__webglLineBuffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,oi,St)}if(ri)for(yr=0,wr=ri.length;wr>yr;yr++)if(ii=ri[yr],ii.__original.needsUpdate){if(jr=0,1===ii.size){if(void 0===ii.boundTo||"vertices"===ii.boundTo){for(Rt=0,zt=fi.length;zt>Rt;Rt++)Pt=gi[fi[Rt]],ii.array[jr]=ii.value[Pt.a],ii.array[jr+1]=ii.value[Pt.b],ii.array[jr+2]=ii.value[Pt.c],jr+=3;for(Rt=0,zt=mi.length;zt>Rt;Rt++)Pt=gi[mi[Rt]],ii.array[jr]=ii.value[Pt.a],ii.array[jr+1]=ii.value[Pt.b],ii.array[jr+2]=ii.value[Pt.c],ii.array[jr+3]=ii.value[Pt.d],jr+=4}else if("faces"===ii.boundTo){for(Rt=0,zt=fi.length;zt>Rt;Rt++)Wr=ii.value[fi[Rt]],ii.array[jr]=Wr,ii.array[jr+1]=Wr,ii.array[jr+2]=Wr,jr+=3;for(Rt=0,zt=mi.length;zt>Rt;Rt++)Wr=ii.value[mi[Rt]],ii.array[jr]=Wr,ii.array[jr+1]=Wr,ii.array[jr+2]=Wr,ii.array[jr+3]=Wr,jr+=4}}else if(2===ii.size){if(void 0===ii.boundTo||"vertices"===ii.boundTo){for(Rt=0,zt=fi.length;zt>Rt;Rt++)Pt=gi[fi[Rt]],jt=ii.value[Pt.a],Wt=ii.value[Pt.b],Ht=ii.value[Pt.c],ii.array[jr]=jt.x,ii.array[jr+1]=jt.y,ii.array[jr+2]=Wt.x,ii.array[jr+3]=Wt.y,ii.array[jr+4]=Ht.x,ii.array[jr+5]=Ht.y,jr+=6;for(Rt=0,zt=mi.length;zt>Rt;Rt++)Pt=gi[mi[Rt]],jt=ii.value[Pt.a],Wt=ii.value[Pt.b],Ht=ii.value[Pt.c],Gt=ii.value[Pt.d],ii.array[jr]=jt.x,ii.array[jr+1]=jt.y,ii.array[jr+2]=Wt.x,ii.array[jr+3]=Wt.y,ii.array[jr+4]=Ht.x,ii.array[jr+5]=Ht.y,ii.array[jr+6]=Gt.x,ii.array[jr+7]=Gt.y,jr+=8}else if("faces"===ii.boundTo){for(Rt=0,zt=fi.length;zt>Rt;Rt++)Ht=Wt=jt=Wr=ii.value[fi[Rt]],ii.array[jr]=jt.x,ii.array[jr+1]=jt.y,ii.array[jr+2]=Wt.x,ii.array[jr+3]=Wt.y,ii.array[jr+4]=Ht.x,ii.array[jr+5]=Ht.y,jr+=6;for(Rt=0,zt=mi.length;zt>Rt;Rt++)Gt=Ht=Wt=jt=Wr=ii.value[mi[Rt]],ii.array[jr]=jt.x,ii.array[jr+1]=jt.y,ii.array[jr+2]=Wt.x,ii.array[jr+3]=Wt.y,ii.array[jr+4]=Ht.x,ii.array[jr+5]=Ht.y,ii.array[jr+6]=Gt.x,ii.array[jr+7]=Gt.y,jr+=8}}else if(3===ii.size){var ki;if(ki="c"===ii.type?["r","g","b"]:["x","y","z"],void 0===ii.boundTo||"vertices"===ii.boundTo){for(Rt=0,zt=fi.length;zt>Rt;Rt++)Pt=gi[fi[Rt]],jt=ii.value[Pt.a],Wt=ii.value[Pt.b],Ht=ii.value[Pt.c],ii.array[jr]=jt[ki[0]],ii.array[jr+1]=jt[ki[1]],ii.array[jr+2]=jt[ki[2]],ii.array[jr+3]=Wt[ki[0]],ii.array[jr+4]=Wt[ki[1]],ii.array[jr+5]=Wt[ki[2]],ii.array[jr+6]=Ht[ki[0]],ii.array[jr+7]=Ht[ki[1]],ii.array[jr+8]=Ht[ki[2]],jr+=9;for(Rt=0,zt=mi.length;zt>Rt;Rt++)Pt=gi[mi[Rt]],jt=ii.value[Pt.a],Wt=ii.value[Pt.b],Ht=ii.value[Pt.c],Gt=ii.value[Pt.d],ii.array[jr]=jt[ki[0]],ii.array[jr+1]=jt[ki[1]],ii.array[jr+2]=jt[ki[2]],ii.array[jr+3]=Wt[ki[0]],ii.array[jr+4]=Wt[ki[1]],ii.array[jr+5]=Wt[ki[2]],ii.array[jr+6]=Ht[ki[0]],ii.array[jr+7]=Ht[ki[1]],ii.array[jr+8]=Ht[ki[2]],ii.array[jr+9]=Gt[ki[0]],ii.array[jr+10]=Gt[ki[1]],ii.array[jr+11]=Gt[ki[2]],jr+=12}else if("faces"===ii.boundTo){for(Rt=0,zt=fi.length;zt>Rt;Rt++)Ht=Wt=jt=Wr=ii.value[fi[Rt]],ii.array[jr]=jt[ki[0]],ii.array[jr+1]=jt[ki[1]],ii.array[jr+2]=jt[ki[2]],ii.array[jr+3]=Wt[ki[0]],ii.array[jr+4]=Wt[ki[1]],ii.array[jr+5]=Wt[ki[2]],ii.array[jr+6]=Ht[ki[0]],ii.array[jr+7]=Ht[ki[1]],ii.array[jr+8]=Ht[ki[2]],jr+=9;for(Rt=0,zt=mi.length;zt>Rt;Rt++)Gt=Ht=Wt=jt=Wr=ii.value[mi[Rt]],ii.array[jr]=jt[ki[0]],ii.array[jr+1]=jt[ki[1]],ii.array[jr+2]=jt[ki[2]],ii.array[jr+3]=Wt[ki[0]],ii.array[jr+4]=Wt[ki[1]],ii.array[jr+5]=Wt[ki[2]],ii.array[jr+6]=Ht[ki[0]],ii.array[jr+7]=Ht[ki[1]],ii.array[jr+8]=Ht[ki[2]],ii.array[jr+9]=Gt[ki[0]],ii.array[jr+10]=Gt[ki[1]],ii.array[jr+11]=Gt[ki[2]],jr+=12}}else if(4===ii.size)if(void 0===ii.boundTo||"vertices"===ii.boundTo){for(Rt=0,zt=fi.length;zt>Rt;Rt++)Pt=gi[fi[Rt]],jt=ii.value[Pt.a],Wt=ii.value[Pt.b],Ht=ii.value[Pt.c],ii.array[jr]=jt.x,ii.array[jr+1]=jt.y,ii.array[jr+2]=jt.z,ii.array[jr+3]=jt.w,ii.array[jr+4]=Wt.x,ii.array[jr+5]=Wt.y,ii.array[jr+6]=Wt.z,ii.array[jr+7]=Wt.w,ii.array[jr+8]=Ht.x,ii.array[jr+9]=Ht.y,ii.array[jr+10]=Ht.z,ii.array[jr+11]=Ht.w,jr+=12;for(Rt=0,zt=mi.length;zt>Rt;Rt++)Pt=gi[mi[Rt]],jt=ii.value[Pt.a],Wt=ii.value[Pt.b],Ht=ii.value[Pt.c],Gt=ii.value[Pt.d],ii.array[jr]=jt.x,ii.array[jr+1]=jt.y,ii.array[jr+2]=jt.z,ii.array[jr+3]=jt.w,ii.array[jr+4]=Wt.x,ii.array[jr+5]=Wt.y,ii.array[jr+6]=Wt.z,ii.array[jr+7]=Wt.w,ii.array[jr+8]=Ht.x,ii.array[jr+9]=Ht.y,ii.array[jr+10]=Ht.z,ii.array[jr+11]=Ht.w,ii.array[jr+12]=Gt.x,ii.array[jr+13]=Gt.y,ii.array[jr+14]=Gt.z,ii.array[jr+15]=Gt.w,jr+=16}else if("faces"===ii.boundTo){for(Rt=0,zt=fi.length;zt>Rt;Rt++)Ht=Wt=jt=Wr=ii.value[fi[Rt]],ii.array[jr]=jt.x,ii.array[jr+1]=jt.y,ii.array[jr+2]=jt.z,ii.array[jr+3]=jt.w,ii.array[jr+4]=Wt.x,ii.array[jr+5]=Wt.y,ii.array[jr+6]=Wt.z,ii.array[jr+7]=Wt.w,ii.array[jr+8]=Ht.x,ii.array[jr+9]=Ht.y,ii.array[jr+10]=Ht.z,ii.array[jr+11]=Ht.w,jr+=12;for(Rt=0,zt=mi.length;zt>Rt;Rt++)Gt=Ht=Wt=jt=Wr=ii.value[mi[Rt]],ii.array[jr]=jt.x,ii.array[jr+1]=jt.y,ii.array[jr+2]=jt.z,ii.array[jr+3]=jt.w,ii.array[jr+4]=Wt.x,ii.array[jr+5]=Wt.y,ii.array[jr+6]=Wt.z,ii.array[jr+7]=Wt.w,ii.array[jr+8]=Ht.x,ii.array[jr+9]=Ht.y,ii.array[jr+10]=Ht.z,ii.array[jr+11]=Ht.w,ii.array[jr+12]=Gt.x,ii.array[jr+13]=Gt.y,ii.array[jr+14]=Gt.z,ii.array[jr+15]=Gt.w,jr+=16}P.bindBuffer(P.ARRAY_BUFFER,ii.buffer),P.bufferData(P.ARRAY_BUFFER,ii.array,St)}kt&&(delete _t.__inittedArrays,delete _t.__colorArray,delete _t.__normalArray,delete _t.__tangentArray,delete _t.__uvArray,delete _t.__uv2Array,delete _t.__faceArray,delete _t.__vertexArray,delete _t.__lineArray,delete _t.__skinVertexAArray,delete _t.__skinVertexBArray,delete _t.__skinIndexArray,delete _t.__skinWeightArray)}}gt.__dirtyVertices=!1,gt.__dirtyMorphTargets=!1,gt.__dirtyElements=!1,gt.__dirtyUvs=!1,gt.__dirtyNormals=!1,gt.__dirtyColors=!1,gt.__dirtyTangents=!1,xt.attributes&&u(xt)}else if(mt instanceof t.Ribbon){if(gt.__dirtyVertices||gt.__dirtyColors){var Ti=gt,Ci=P.DYNAMIC_DRAW,Ai=void 0,Ei=void 0,Li=void 0,Ri=void 0,zi=void 0,Ni=Ti.vertices,Pi=Ti.colors,Di=Ni.length,Fi=Pi.length,Vi=Ti.__vertexArray,Bi=Ti.__colorArray,Ui=Ti.__dirtyColors;if(Ti.__dirtyVertices){for(Ai=0;Di>Ai;Ai++)Li=Ni[Ai].position,Ri=3*Ai,Vi[Ri]=Li.x,Vi[Ri+1]=Li.y,Vi[Ri+2]=Li.z;P.bindBuffer(P.ARRAY_BUFFER,Ti.__webglVertexBuffer),P.bufferData(P.ARRAY_BUFFER,Vi,Ci)}if(Ui){for(Ei=0;Fi>Ei;Ei++)zi=Pi[Ei],Ri=3*Ei,Bi[Ri]=zi.r,Bi[Ri+1]=zi.g,Bi[Ri+2]=zi.b;P.bindBuffer(P.ARRAY_BUFFER,Ti.__webglColorBuffer),P.bufferData(P.ARRAY_BUFFER,Bi,Ci)}}gt.__dirtyVertices=!1,gt.__dirtyColors=!1}else if(mt instanceof t.Line){if(xt=i(mt,bt),vt=xt.attributes&&d(xt),gt.__dirtyVertices||gt.__dirtyColors||vt){var Oi=gt,Ii=P.DYNAMIC_DRAW,ji=void 0,Wi=void 0,Hi=void 0,Gi=void 0,Xi=void 0,Yi=Oi.vertices,qi=Oi.colors,Zi=Yi.length,Ki=qi.length,$i=Oi.__vertexArray,Qi=Oi.__colorArray,Ji=Oi.__dirtyColors,en=Oi.__webglCustomAttributesList,tn=void 0,rn=void 0,nn=void 0,on=void 0,an=void 0,sn=void 0;if(Oi.__dirtyVertices){for(ji=0;Zi>ji;ji++)Hi=Yi[ji].position,Gi=3*ji,$i[Gi]=Hi.x,$i[Gi+1]=Hi.y,$i[Gi+2]=Hi.z;P.bindBuffer(P.ARRAY_BUFFER,Oi.__webglVertexBuffer),P.bufferData(P.ARRAY_BUFFER,$i,Ii)}if(Ji){for(Wi=0;Ki>Wi;Wi++)Xi=qi[Wi],Gi=3*Wi,Qi[Gi]=Xi.r,Qi[Gi+1]=Xi.g,Qi[Gi+2]=Xi.b;P.bindBuffer(P.ARRAY_BUFFER,Oi.__webglColorBuffer),P.bufferData(P.ARRAY_BUFFER,Qi,Ii)}if(en)for(tn=0,rn=en.length;rn>tn;tn++)if(sn=en[tn],sn.needsUpdate&&(void 0===sn.boundTo||"vertices"===sn.boundTo)){if(Gi=0,on=sn.value.length,1===sn.size)for(nn=0;on>nn;nn++)sn.array[nn]=sn.value[nn];else if(2===sn.size)for(nn=0;on>nn;nn++)an=sn.value[nn],sn.array[Gi]=an.x,sn.array[Gi+1]=an.y,Gi+=2;else if(3===sn.size)if("c"===sn.type)for(nn=0;on>nn;nn++)an=sn.value[nn],sn.array[Gi]=an.r,sn.array[Gi+1]=an.g,sn.array[Gi+2]=an.b,Gi+=3;else for(nn=0;on>nn;nn++)an=sn.value[nn],sn.array[Gi]=an.x,sn.array[Gi+1]=an.y,sn.array[Gi+2]=an.z,Gi+=3;else if(4===sn.size)for(nn=0;on>nn;nn++)an=sn.value[nn],sn.array[Gi]=an.x,sn.array[Gi+1]=an.y,sn.array[Gi+2]=an.z,sn.array[Gi+3]=an.w,Gi+=4;P.bindBuffer(P.ARRAY_BUFFER,sn.buffer),P.bufferData(P.ARRAY_BUFFER,sn.array,Ii)}}gt.__dirtyVertices=!1,gt.__dirtyColors=!1,xt.attributes&&u(xt)}else mt instanceof t.ParticleSystem&&(xt=i(mt,bt),vt=xt.attributes&&d(xt),(gt.__dirtyVertices||gt.__dirtyColors||mt.sortParticles||vt)&&a(gt,P.DYNAMIC_DRAW,mt),gt.__dirtyVertices=!1,gt.__dirtyColors=!1,xt.attributes&&u(xt))}},this.initMaterial=function(e,r,i,n){var o,a,s,l,c;if(e instanceof t.MeshDepthMaterial?c="depth":e instanceof t.MeshNormalMaterial?c="normal":e instanceof t.MeshBasicMaterial?c="basic":e instanceof t.MeshLambertMaterial?c="lambert":e instanceof t.MeshPhongMaterial?c="phong":e instanceof t.LineBasicMaterial?c="basic":e instanceof t.ParticleBasicMaterial&&(c="particle_basic"),c){var h=t.ShaderLib[c];e.uniforms=t.UniformsUtils.clone(h.uniforms),e.vertexShader=h.vertexShader,e.fragmentShader=h.fragmentShader}var p,d;for(a=h=0,p=0,d=r.length;d>p;p++)o=r[p],o.onlyShadow||(o instanceof t.DirectionalLight&&a++,o instanceof t.PointLight&&h++,o instanceof t.SpotLight&&h++);N>=h+a?p=a:(p=Math.ceil(N*a/(h+a)),h=N-p),o=p,a=h;var u=0;for(h=0,p=r.length;p>h;h++)d=r[h],d.castShadow&&(d instanceof t.SpotLight&&u++,d instanceof t.DirectionalLight&&!d.shadowCascade&&u++);var f=50;void 0!==n&&n instanceof t.SkinnedMesh&&(f=n.bones.length);var m;e:{p=e.fragmentShader,d=e.vertexShader;var g,h=e.uniforms,r=e.attributes,i={map:!!e.map,envMap:!!e.envMap,lightMap:!!e.lightMap,vertexColors:e.vertexColors,fog:i,useFog:e.fog,sizeAttenuation:e.sizeAttenuation,skinning:e.skinning,morphTargets:e.morphTargets,morphNormals:e.morphNormals,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,maxDirLights:o,maxPointLights:a,maxBones:f,shadowMapEnabled:this.shadowMapEnabled&&n.receiveShadow,shadowMapSoft:this.shadowMapSoft,shadowMapDebug:this.shadowMapDebug,shadowMapCascade:this.shadowMapCascade,maxShadows:u,alphaTest:e.alphaTest,metal:e.metal,perPixel:e.perPixel,wrapAround:e.wrapAround,doubleSided:n&&n.doubleSided},n=[];c?n.push(c):(n.push(p),n.push(d));
for(g in i)n.push(g),n.push(i[g]);for(c=n.join(),g=0,n=F.length;n>g;g++)if(F[g].code===c){m=F[g].program;break e}g=P.createProgram(),n=[ct>0?"#define VERTEX_TEXTURES":"",D.gammaInput?"#define GAMMA_INPUT":"",D.gammaOutput?"#define GAMMA_OUTPUT":"",D.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"","#define MAX_DIR_LIGHTS "+i.maxDirLights,"#define MAX_POINT_LIGHTS "+i.maxPointLights,"#define MAX_SHADOWS "+i.maxShadows,"#define MAX_BONES "+i.maxBones,i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.lightMap?"#define USE_LIGHTMAP":"",i.vertexColors?"#define USE_COLOR":"",i.skinning?"#define USE_SKINNING":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals?"#define USE_MORPHNORMALS":"",i.perPixel?"#define PHONG_PER_PIXEL":"",i.wrapAround?"#define WRAP_AROUND":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapSoft?"#define SHADOWMAP_SOFT":"",i.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",i.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"","uniform mat4 objectMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 cameraPosition;\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\nattribute vec2 uv2;\n#ifdef USE_COLOR\nattribute vec3 color;\n#endif\n#ifdef USE_MORPHTARGETS\nattribute vec3 morphTarget0;\nattribute vec3 morphTarget1;\nattribute vec3 morphTarget2;\nattribute vec3 morphTarget3;\n#ifdef USE_MORPHNORMALS\nattribute vec3 morphNormal0;\nattribute vec3 morphNormal1;\nattribute vec3 morphNormal2;\nattribute vec3 morphNormal3;\n#else\nattribute vec3 morphTarget4;\nattribute vec3 morphTarget5;\nattribute vec3 morphTarget6;\nattribute vec3 morphTarget7;\n#endif\n#endif\n#ifdef USE_SKINNING\nattribute vec4 skinVertexA;\nattribute vec4 skinVertexB;\nattribute vec4 skinIndex;\nattribute vec4 skinWeight;\n#endif\n"].join("\n"),o=["precision "+k+" float;","#define MAX_DIR_LIGHTS "+i.maxDirLights,"#define MAX_POINT_LIGHTS "+i.maxPointLights,"#define MAX_SHADOWS "+i.maxShadows,i.alphaTest?"#define ALPHATEST "+i.alphaTest:"",D.gammaInput?"#define GAMMA_INPUT":"",D.gammaOutput?"#define GAMMA_OUTPUT":"",D.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"",i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fog instanceof t.FogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.lightMap?"#define USE_LIGHTMAP":"",i.vertexColors?"#define USE_COLOR":"",i.metal?"#define METAL":"",i.perPixel?"#define PHONG_PER_PIXEL":"",i.wrapAround?"#define WRAP_AROUND":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapSoft?"#define SHADOWMAP_SOFT":"",i.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",i.shadowMapCascade?"#define SHADOWMAP_CASCADE":"","uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\n"].join("\n"),P.attachShader(g,x("fragment",o+p)),P.attachShader(g,x("vertex",n+d)),P.linkProgram(g),P.getProgramParameter(g,P.LINK_STATUS)||console.error("Could not initialise shader\nVALIDATE_STATUS: "+P.getProgramParameter(g,P.VALIDATE_STATUS)+", gl error ["+P.getError()+"]"),g.uniforms={},g.attributes={};var b,n="viewMatrix,modelViewMatrix,projectionMatrix,normalMatrix,objectMatrix,cameraPosition,boneGlobalMatrices,morphTargetInfluences".split(",");for(b in h)n.push(b);for(b=n,n=0,h=b.length;h>n;n++)p=b[n],g.uniforms[p]=P.getUniformLocation(g,p);for(n="position,normal,uv,uv2,tangent,color,skinVertexA,skinVertexB,skinIndex,skinWeight".split(","),b=0;b<i.maxMorphTargets;b++)n.push("morphTarget"+b);for(b=0;b<i.maxMorphNormals;b++)n.push("morphNormal"+b);for(m in r)n.push(m);for(m=n,b=0,r=m.length;r>b;b++)i=m[b],g.attributes[i]=P.getAttribLocation(g,i);g.id=F.length,F.push({program:g,code:c}),D.info.memory.programs=F.length,m=g}if(e.program=m,m=e.program.attributes,0<=m.position&&P.enableVertexAttribArray(m.position),0<=m.color&&P.enableVertexAttribArray(m.color),0<=m.normal&&P.enableVertexAttribArray(m.normal),0<=m.tangent&&P.enableVertexAttribArray(m.tangent),e.skinning&&0<=m.skinVertexA&&0<=m.skinVertexB&&0<=m.skinIndex&&0<=m.skinWeight&&(P.enableVertexAttribArray(m.skinVertexA),P.enableVertexAttribArray(m.skinVertexB),P.enableVertexAttribArray(m.skinIndex),P.enableVertexAttribArray(m.skinWeight)),e.attributes)for(l in e.attributes)void 0!==m[l]&&0<=m[l]&&P.enableVertexAttribArray(m[l]);if(e.morphTargets)for(e.numSupportedMorphTargets=0,g="morphTarget",l=0;l<this.maxMorphTargets;l++)b=g+l,0<=m[b]&&(P.enableVertexAttribArray(m[b]),e.numSupportedMorphTargets++);if(e.morphNormals)for(e.numSupportedMorphNormals=0,g="morphNormal",l=0;l<this.maxMorphNormals;l++)b=g+l,0<=m[b]&&(P.enableVertexAttribArray(m[b]),e.numSupportedMorphNormals++);e.uniformsList=[];for(s in e.uniforms)e.uniformsList.push([e.uniforms[s],s])},this.setFaceCulling=function(e,t){e?(t&&"ccw"!==t?P.frontFace(P.CW):P.frontFace(P.CCW),"back"===e?P.cullFace(P.BACK):"front"===e?P.cullFace(P.FRONT):P.cullFace(P.FRONT_AND_BACK),P.enable(P.CULL_FACE)):P.disable(P.CULL_FACE)},this.setObjectFaces=function(e){W!==e.doubleSided&&(e.doubleSided?P.disable(P.CULL_FACE):P.enable(P.CULL_FACE),W=e.doubleSided),H!==e.flipSided&&(e.flipSided?P.frontFace(P.CW):P.frontFace(P.CCW),H=e.flipSided)},this.setDepthTest=function(e){X!==e&&(e?P.enable(P.DEPTH_TEST):P.disable(P.DEPTH_TEST),X=e)},this.setDepthWrite=function(e){Y!==e&&(P.depthMask(e),Y=e)},this.setBlending=function(e){if(e!==G){switch(e){case t.NoBlending:P.disable(P.BLEND);break;case t.AdditiveBlending:P.enable(P.BLEND),P.blendEquation(P.FUNC_ADD),P.blendFunc(P.SRC_ALPHA,P.ONE);break;case t.SubtractiveBlending:P.enable(P.BLEND),P.blendEquation(P.FUNC_ADD),P.blendFunc(P.ZERO,P.ONE_MINUS_SRC_COLOR);break;case t.MultiplyBlending:P.enable(P.BLEND),P.blendEquation(P.FUNC_ADD),P.blendFunc(P.ZERO,P.SRC_COLOR);break;default:P.enable(P.BLEND),P.blendEquationSeparate(P.FUNC_ADD,P.FUNC_ADD),P.blendFuncSeparate(P.SRC_ALPHA,P.ONE_MINUS_SRC_ALPHA,P.ONE,P.ONE_MINUS_SRC_ALPHA)}G=e}},this.setTexture=function(e,r){if(e.needsUpdate){e.__webglInit||(e.__webglInit=!0,e.__webglTexture=P.createTexture(),D.info.memory.textures++),P.activeTexture(P.TEXTURE0+r),P.bindTexture(P.TEXTURE_2D,e.__webglTexture);var i=e.image,n=0===(i.width&i.width-1)&&0===(i.height&i.height-1),o=M(e.format),a=M(e.type);y(P.TEXTURE_2D,e,n),e instanceof t.DataTexture?P.texImage2D(P.TEXTURE_2D,0,o,i.width,i.height,0,o,a,i.data):P.texImage2D(P.TEXTURE_2D,0,o,o,a,e.image),e.generateMipmaps&&n&&P.generateMipmap(P.TEXTURE_2D),e.needsUpdate=!1,e.onUpdate&&e.onUpdate()}else P.activeTexture(P.TEXTURE0+r),P.bindTexture(P.TEXTURE_2D,e.__webglTexture)},this.setRenderTarget=function(e){var r=e instanceof t.WebGLRenderTargetCube;if(e&&!e.__webglFramebuffer){void 0===e.depthBuffer&&(e.depthBuffer=!0),void 0===e.stencilBuffer&&(e.stencilBuffer=!0),e.__webglTexture=P.createTexture();var i=0===(e.width&e.width-1)&&0===(e.height&e.height-1),n=M(e.format),o=M(e.type);if(r)for(e.__webglFramebuffer=[],e.__webglRenderbuffer=[],P.bindTexture(P.TEXTURE_CUBE_MAP,e.__webglTexture),y(P.TEXTURE_CUBE_MAP,e,i),i=0;6>i;i++){e.__webglFramebuffer[i]=P.createFramebuffer(),e.__webglRenderbuffer[i]=P.createRenderbuffer(),P.texImage2D(P.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,n,e.width,e.height,0,n,o,null);var a=e,s=P.TEXTURE_CUBE_MAP_POSITIVE_X+i;P.bindFramebuffer(P.FRAMEBUFFER,e.__webglFramebuffer[i]),P.framebufferTexture2D(P.FRAMEBUFFER,P.COLOR_ATTACHMENT0,s,a.__webglTexture,0),w(e.__webglRenderbuffer[i],e)}else e.__webglFramebuffer=P.createFramebuffer(),e.__webglRenderbuffer=P.createRenderbuffer(),P.bindTexture(P.TEXTURE_2D,e.__webglTexture),y(P.TEXTURE_2D,e,i),P.texImage2D(P.TEXTURE_2D,0,n,e.width,e.height,0,n,o,null),n=P.TEXTURE_2D,P.bindFramebuffer(P.FRAMEBUFFER,e.__webglFramebuffer),P.framebufferTexture2D(P.FRAMEBUFFER,P.COLOR_ATTACHMENT0,n,e.__webglTexture,0),w(e.__webglRenderbuffer,e);r?P.bindTexture(P.TEXTURE_CUBE_MAP,null):P.bindTexture(P.TEXTURE_2D,null),P.bindRenderbuffer(P.RENDERBUFFER,null),P.bindFramebuffer(P.FRAMEBUFFER,null)}e?(r=r?e.__webglFramebuffer[e.activeCubeFace]:e.__webglFramebuffer,n=e.width,e=e.height,i=o=0):(r=null,n=et,e=tt,o=Q,i=J),r!==B&&(P.bindFramebuffer(P.FRAMEBUFFER,r),P.viewport(o,i,n,e),B=r),rt=n,it=e},this.shadowMapPlugin=new t.ShadowMapPlugin,this.addPrePlugin(this.shadowMapPlugin),this.addPostPlugin(new t.SpritePlugin),this.addPostPlugin(new t.LensFlarePlugin)},t.WebGLRenderTarget=function(e,r,i){this.width=e,this.height=r,i=i||{},this.wrapS=void 0!==i.wrapS?i.wrapS:t.ClampToEdgeWrapping,this.wrapT=void 0!==i.wrapT?i.wrapT:t.ClampToEdgeWrapping,this.magFilter=void 0!==i.magFilter?i.magFilter:t.LinearFilter,this.minFilter=void 0!==i.minFilter?i.minFilter:t.LinearMipMapLinearFilter,this.offset=new t.Vector2(0,0),this.repeat=new t.Vector2(1,1),this.format=void 0!==i.format?i.format:t.RGBAFormat,this.type=void 0!==i.type?i.type:t.UnsignedByteType,this.depthBuffer=void 0!==i.depthBuffer?i.depthBuffer:!0,this.stencilBuffer=void 0!==i.stencilBuffer?i.stencilBuffer:!0,this.generateMipmaps=!0},t.WebGLRenderTarget.prototype.clone=function(){var e=new t.WebGLRenderTarget(this.width,this.height);return e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.format=this.format,e.type=this.type,e.depthBuffer=this.depthBuffer,e.stencilBuffer=this.stencilBuffer,e},t.WebGLRenderTargetCube=function(e,r,i){t.WebGLRenderTarget.call(this,e,r,i),this.activeCubeFace=0},t.WebGLRenderTargetCube.prototype=new t.WebGLRenderTarget,t.WebGLRenderTargetCube.prototype.constructor=t.WebGLRenderTargetCube,t.RenderableVertex=function(){this.positionWorld=new t.Vector3,this.positionScreen=new t.Vector4,this.visible=!0},t.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},t.RenderableFace3=function(){this.v1=new t.RenderableVertex,this.v2=new t.RenderableVertex,this.v3=new t.RenderableVertex,this.centroidWorld=new t.Vector3,this.centroidScreen=new t.Vector3,this.normalWorld=new t.Vector3,this.vertexNormalsWorld=[new t.Vector3,new t.Vector3,new t.Vector3],this.faceMaterial=this.material=null,this.uvs=[[]],this.z=null},t.RenderableFace4=function(){this.v1=new t.RenderableVertex,this.v2=new t.RenderableVertex,this.v3=new t.RenderableVertex,this.v4=new t.RenderableVertex,this.centroidWorld=new t.Vector3,this.centroidScreen=new t.Vector3,this.normalWorld=new t.Vector3,this.vertexNormalsWorld=[new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3],this.faceMaterial=this.material=null,this.uvs=[[]],this.z=null},t.RenderableObject=function(){this.z=this.object=null},t.RenderableParticle=function(){this.rotation=this.z=this.y=this.x=null,this.scale=new t.Vector2,this.material=null},t.RenderableLine=function(){this.z=null,this.v1=new t.RenderableVertex,this.v2=new t.RenderableVertex,this.material=null},t.ColorUtils={adjustHSV:function(e,r,i,n){var o=t.ColorUtils.__hsv;t.ColorUtils.rgbToHsv(e,o),o.h=t.Math.clamp(o.h+r,0,1),o.s=t.Math.clamp(o.s+i,0,1),o.v=t.Math.clamp(o.v+n,0,1),e.setHSV(o.h,o.s,o.v)},rgbToHsv:function(e,t){var r=e.r,i=e.g,n=e.b,o=Math.max(Math.max(r,i),n),a=Math.min(Math.min(r,i),n);if(a===o)a=r=0;else{var s=o-a,a=s/o,r=(r===o?(i-n)/s:i===o?2+(n-r)/s:4+(r-i)/s)/6;0>r&&(r+=1),r>1&&(r-=1)}return void 0===t&&(t={h:0,s:0,v:0}),t.h=r,t.s=a,t.v=o,t}},t.ColorUtils.__hsv={h:0,s:0,v:0},t.GeometryUtils={merge:function(e,r){for(var i,n,o=e.vertices.length,a=r instanceof t.Mesh?r.geometry:r,s=e.vertices,l=a.vertices,c=e.faces,h=a.faces,p=e.faceVertexUvs[0],d=a.faceVertexUvs[0],u={},f=0;f<e.materials.length;f++)u[e.materials[f].id]=f;r instanceof t.Mesh&&(r.matrixAutoUpdate&&r.updateMatrix(),i=r.matrix,n=new t.Matrix4,n.extractRotation(i,r.scale));for(var f=0,m=l.length;m>f;f++){var g=l[f].clone();i&&i.multiplyVector3(g.position),s.push(g)}for(f=0,m=h.length;m>f;f++){var b,v,s=h[f],x=s.vertexNormals,y=s.vertexColors;for(s instanceof t.Face3?b=new t.Face3(s.a+o,s.b+o,s.c+o):s instanceof t.Face4&&(b=new t.Face4(s.a+o,s.b+o,s.c+o,s.d+o)),b.normal.copy(s.normal),n&&n.multiplyVector3(b.normal),l=0,g=x.length;g>l;l++)v=x[l].clone(),n&&n.multiplyVector3(v),b.vertexNormals.push(v);for(b.color.copy(s.color),l=0,g=y.length;g>l;l++)v=y[l],b.vertexColors.push(v.clone());void 0!==s.materialIndex&&(l=a.materials[s.materialIndex],g=l.id,y=u[g],void 0===y&&(y=e.materials.length,u[g]=y,e.materials.push(l)),b.materialIndex=y),b.centroid.copy(s.centroid),i&&i.multiplyVector3(b.centroid),c.push(b)}for(f=0,m=d.length;m>f;f++){for(i=d[f],n=[],l=0,g=i.length;g>l;l++)n.push(new t.UV(i[l].u,i[l].v));p.push(n)}},clone:function(e){var r,i=new t.Geometry,n=e.vertices,o=e.faces,a=e.faceVertexUvs[0];for(e.materials&&(i.materials=e.materials.slice()),e=0,r=n.length;r>e;e++)i.vertices.push(n[e].clone());for(e=0,r=o.length;r>e;e++)i.faces.push(o[e].clone());for(e=0,r=a.length;r>e;e++){for(var n=a[e],o=[],s=0,l=n.length;l>s;s++)o.push(new t.UV(n[s].u,n[s].v));i.faceVertexUvs[0].push(o)}return i},randomPointInTriangle:function(e,r,i){var n,o,a,s=new t.Vector3,l=t.GeometryUtils.__v1;return n=t.GeometryUtils.random(),o=t.GeometryUtils.random(),n+o>1&&(n=1-n,o=1-o),a=1-n-o,s.copy(e),s.multiplyScalar(n),l.copy(r),l.multiplyScalar(o),s.addSelf(l),l.copy(i),l.multiplyScalar(a),s.addSelf(l),s},randomPointInFace:function(e,r,i){var n,o,a;if(e instanceof t.Face3)return n=r.vertices[e.a].position,o=r.vertices[e.b].position,a=r.vertices[e.c].position,t.GeometryUtils.randomPointInTriangle(n,o,a);if(e instanceof t.Face4){n=r.vertices[e.a].position,o=r.vertices[e.b].position,a=r.vertices[e.c].position;var s,r=r.vertices[e.d].position;return i?e._area1&&e._area2?(i=e._area1,s=e._area2):(i=t.GeometryUtils.triangleArea(n,o,r),s=t.GeometryUtils.triangleArea(o,a,r),e._area1=i,e._area2=s):(i=t.GeometryUtils.triangleArea(n,o,r),s=t.GeometryUtils.triangleArea(o,a,r)),t.GeometryUtils.random()*(i+s)<i?t.GeometryUtils.randomPointInTriangle(n,o,r):t.GeometryUtils.randomPointInTriangle(o,a,r)}},randomPointsInGeometry:function(e,r){function i(e){function t(r,i){if(r>i)return r;var n=r+Math.floor((i-r)/2);return f[n]>e?t(r,n-1):f[n]<e?t(n+1,i):n}return t(0,f.length-1)}var n,o,a,s,l,c,h=e.faces,p=e.vertices,d=h.length,u=0,f=[];for(o=0;d>o;o++)n=h[o],n instanceof t.Face3?(a=p[n.a].position,s=p[n.b].position,l=p[n.c].position,n._area=t.GeometryUtils.triangleArea(a,s,l)):n instanceof t.Face4&&(a=p[n.a].position,s=p[n.b].position,l=p[n.c].position,c=p[n.d].position,n._area1=t.GeometryUtils.triangleArea(a,s,c),n._area2=t.GeometryUtils.triangleArea(s,l,c),n._area=n._area1+n._area2),u+=n._area,f[o]=u;for(n=[],o=0;r>o;o++)p=t.GeometryUtils.random()*u,p=i(p),n[o]=t.GeometryUtils.randomPointInFace(h[p],e,!0);return n},triangleArea:function(e,r,i){var n,o=t.GeometryUtils.__v1;return o.sub(e,r),n=o.length(),o.sub(e,i),e=o.length(),o.sub(r,i),i=o.length(),r=.5*(n+e+i),Math.sqrt(r*(r-n)*(r-e)*(r-i))},center:function(e){e.computeBoundingBox();var r=e.boundingBox,i=new t.Vector3;return i.add(r.min,r.max),i.multiplyScalar(-.5),e.applyMatrix((new t.Matrix4).setTranslation(i.x,i.y,i.z)),e.computeBoundingBox(),i},normalizeUVs:function(e){for(var e=e.faceVertexUvs[0],t=0,r=e.length;r>t;t++)for(var i=e[t],n=0,o=i.length;o>n;n++)1!==i[n].u&&(i[n].u-=Math.floor(i[n].u)),1!==i[n].v&&(i[n].v-=Math.floor(i[n].v))},triangulateQuads:function(e){for(var r=e.faces.length-1;r>=0;r--){var i=e.faces[r];if(i instanceof t.Face4){var n=i.a,o=i.b,a=i.c,s=i.d,l=i.clone(),i=i.clone();for(l.a=n,l.b=o,l.c=s,i.a=o,i.b=a,i.c=s,e.faces.splice(r,1,l,i),n=0;n<e.faceVertexUvs.length;n++)e.faceVertexUvs[n].length&&(l=e.faceVertexUvs[n][r],o=l[1],a=l[2],s=l[3],l=[l[0].clone(),o.clone(),s.clone()],o=[o.clone(),a.clone(),s.clone()],e.faceVertexUvs[n].splice(r,1,l,o));for(n=0;n<e.faceUvs.length;n++)e.faceUvs[n].length&&(o=e.faceUvs[n][r],e.faceUvs[n].splice(r,1,o,o))}}e.computeCentroids(),e.computeFaceNormals(),e.computeVertexNormals(),e.hasTangents&&e.computeTangents()},explode:function(e){for(var r=[],i=0,n=e.faces.length;n>i;i++){var o=r.length,a=e.faces[i];if(a instanceof t.Face4){var s=a.a,l=a.b,c=a.c,s=e.vertices[s],l=e.vertices[l],c=e.vertices[c],h=e.vertices[a.d];r.push(s.clone()),r.push(l.clone()),r.push(c.clone()),r.push(h.clone()),a.a=o,a.b=o+1,a.c=o+2,a.d=o+3}else s=a.a,l=a.b,c=a.c,s=e.vertices[s],l=e.vertices[l],c=e.vertices[c],r.push(s.clone()),r.push(l.clone()),r.push(c.clone()),a.a=o,a.b=o+1,a.c=o+2}e.vertices=r},tessellate:function(e,r){var i,n,o,a,s,l,c,h,p,d,u,f,m,g,b,v,x;for(i=e.faces.length-1;i>=0;i--)if(n=e.faces[i],n instanceof t.Face3){if(o=n.a,a=n.b,s=n.c,c=e.vertices[o],h=e.vertices[a],p=e.vertices[s],u=c.position.distanceTo(h.position),f=h.position.distanceTo(p.position),d=c.position.distanceTo(p.position),u>r||f>r||d>r)for(l=e.vertices.length,x=n.clone(),n=n.clone(),u>=f&&u>=d?(c=c.clone(),c.position.lerpSelf(h.position,.5),x.a=o,x.b=l,x.c=s,n.a=l,n.b=a,n.c=s,o=0):f>=u&&f>=d?(c=h.clone(),c.position.lerpSelf(p.position,.5),x.a=o,x.b=a,x.c=l,n.a=l,n.b=s,n.c=o,o=1):(c=c.clone(),c.position.lerpSelf(p.position,.5),x.a=o,x.b=a,x.c=l,n.a=l,n.b=a,n.c=s,o=2),e.faces.splice(i,1,x,n),e.vertices.push(c),a=0;a<e.faceVertexUvs.length;a++)e.faceVertexUvs[a].length&&(p=e.faceVertexUvs[a][i],h=p[0],s=p[1],c=p[2],0===o?(u=h.clone(),u.lerpSelf(s,.5),p=[h.clone(),u.clone(),c.clone()],s=[u.clone(),s.clone(),c.clone()]):1===o?(u=s.clone(),u.lerpSelf(c,.5),p=[h.clone(),s.clone(),u.clone()],s=[u.clone(),c.clone(),h.clone()]):(u=h.clone(),u.lerpSelf(c,.5),p=[h.clone(),s.clone(),u.clone()],s=[u.clone(),s.clone(),c.clone()]),e.faceVertexUvs[a].splice(i,1,p,s))}else if(o=n.a,a=n.b,s=n.c,l=n.d,c=e.vertices[o],h=e.vertices[a],p=e.vertices[s],d=e.vertices[l],u=c.position.distanceTo(h.position),f=h.position.distanceTo(p.position),m=p.position.distanceTo(d.position),g=c.position.distanceTo(d.position),u>r||f>r||m>r||g>r)for(b=e.vertices.length,v=e.vertices.length+1,x=n.clone(),n=n.clone(),u>=f&&u>=m&&u>=g||m>=f&&m>=u&&m>=g?(u=c.clone(),u.position.lerpSelf(h.position,.5),h=p.clone(),h.position.lerpSelf(d.position,.5),x.a=o,x.b=b,x.c=v,x.d=l,n.a=b,n.b=a,n.c=s,n.d=v,o=0):(u=h.clone(),u.position.lerpSelf(p.position,.5),h=d.clone(),h.position.lerpSelf(c.position,.5),x.a=o,x.b=a,x.c=b,x.d=v,n.a=v,n.b=b,n.c=s,n.d=l,o=1),e.faces.splice(i,1,x,n),e.vertices.push(u),e.vertices.push(h),a=0;a<e.faceVertexUvs.length;a++)e.faceVertexUvs[a].length&&(p=e.faceVertexUvs[a][i],h=p[0],s=p[1],c=p[2],p=p[3],0===o?(u=h.clone(),u.lerpSelf(s,.5),f=c.clone(),f.lerpSelf(p,.5),h=[h.clone(),u.clone(),f.clone(),p.clone()],s=[u.clone(),s.clone(),c.clone(),f.clone()]):(u=s.clone(),u.lerpSelf(c,.5),f=p.clone(),f.lerpSelf(h,.5),h=[h.clone(),s.clone(),u.clone(),f.clone()],s=[f.clone(),u.clone(),c.clone(),p.clone()]),e.faceVertexUvs[a].splice(i,1,h,s))}},t.GeometryUtils.random=t.Math.random16,t.GeometryUtils.__v1=new t.Vector3,t.ImageUtils={crossOrigin:"anonymous",loadTexture:function(e,r,i){var n=new Image,o=new t.Texture(n,r);return n.onload=function(){o.needsUpdate=!0,i&&i(this)},n.crossOrigin=this.crossOrigin,n.src=e,o},loadTextureCube:function(e,r,i){var n,o=[],a=new t.Texture(o,r);for(o.loadCount=0,r=0,n=e.length;n>r;++r)o[r]=new Image,o[r].onload=function(){o.loadCount+=1,6===o.loadCount&&(a.needsUpdate=!0),i&&i(this)},o[r].crossOrigin=this.crossOrigin,o[r].src=e[r];return a},getNormalMap:function(e,t){var r=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return[e[0]/t,e[1]/t,e[2]/t]},t=1|t,i=e.width,n=e.height,o=document.createElement("canvas");o.width=i,o.height=n;var a=o.getContext("2d");a.drawImage(e,0,0);for(var s=a.getImageData(0,0,i,n).data,l=a.createImageData(i,n),c=l.data,h=0;i>h;h++)for(var p=1;n>p;p++){var d=0>p-1?n-1:p-1,u=(p+1)%n,f=0>h-1?i-1:h-1,m=(h+1)%i,g=[],b=[0,0,s[4*(p*i+h)]/255*t];for(g.push([-1,0,s[4*(p*i+f)]/255*t]),g.push([-1,-1,s[4*(d*i+f)]/255*t]),g.push([0,-1,s[4*(d*i+h)]/255*t]),g.push([1,-1,s[4*(d*i+m)]/255*t]),g.push([1,0,s[4*(p*i+m)]/255*t]),g.push([1,1,s[4*(u*i+m)]/255*t]),g.push([0,1,s[4*(u*i+h)]/255*t]),g.push([-1,1,s[4*(u*i+f)]/255*t]),d=[],f=g.length,u=0;f>u;u++){var m=g[u],v=g[(u+1)%f],m=[m[0]-b[0],m[1]-b[1],m[2]-b[2]],v=[v[0]-b[0],v[1]-b[1],v[2]-b[2]];d.push(r([m[1]*v[2]-m[2]*v[1],m[2]*v[0]-m[0]*v[2],m[0]*v[1]-m[1]*v[0]]))}for(g=[0,0,0],u=0;u<d.length;u++)g[0]+=d[u][0],g[1]+=d[u][1],g[2]+=d[u][2];g[0]/=d.length,g[1]/=d.length,g[2]/=d.length,b=4*(p*i+h),c[b]=0|255*((g[0]+1)/2),c[b+1]=0|255*(g[1]+.5),c[b+2]=0|255*g[2],c[b+3]=255}return a.putImageData(l,0,0),o},generateDataTexture:function(e,r,i){for(var n=e*r,o=new Uint8Array(3*n),a=Math.floor(255*i.r),s=Math.floor(255*i.g),i=Math.floor(255*i.b),l=0;n>l;l++)o[3*l]=a,o[3*l+1]=s,o[3*l+2]=i;return e=new t.DataTexture(o,e,r,t.RGBFormat),e.needsUpdate=!0,e}},t.SceneUtils={showHierarchy:function(e,r){t.SceneUtils.traverseHierarchy(e,function(e){e.visible=r})},traverseHierarchy:function(e,r){var i,n,o=e.children.length;for(n=0;o>n;n++)i=e.children[n],r(i),t.SceneUtils.traverseHierarchy(i,r)},createMultiMaterialObject:function(e,r){var i,n=r.length,o=new t.Object3D;for(i=0;n>i;i++){var a=new t.Mesh(e,r[i]);o.add(a)}return o},cloneObject:function(e){var r;e instanceof t.MorphAnimMesh?(r=new t.MorphAnimMesh(e.geometry,e.material),r.duration=e.duration,r.mirroredLoop=e.mirroredLoop,r.time=e.time,r.lastKeyframe=e.lastKeyframe,r.currentKeyframe=e.currentKeyframe,r.direction=e.direction,r.directionBackwards=e.directionBackwards):e instanceof t.SkinnedMesh?r=new t.SkinnedMesh(e.geometry,e.material):e instanceof t.Mesh?r=new t.Mesh(e.geometry,e.material):e instanceof t.Line?r=new t.Line(e.geometry,e.material,e.type):e instanceof t.Ribbon?r=new t.Ribbon(e.geometry,e.material):e instanceof t.ParticleSystem?(r=new t.ParticleSystem(e.geometry,e.material),r.sortParticles=e.sortParticles):e instanceof t.Particle?r=new t.Particle(e.material):e instanceof t.Sprite?(r=new t.Sprite({}),r.color.copy(e.color),r.map=e.map,r.blending=e.blending,r.useScreenCoordinates=e.useScreenCoordinates,r.mergeWith3D=e.mergeWith3D,r.affectedByDistance=e.affectedByDistance,r.scaleByViewport=e.scaleByViewport,r.alignment=e.alignment,r.rotation3d.copy(e.rotation3d),r.rotation=e.rotation,r.opacity=e.opacity,r.uvOffset.copy(e.uvOffset),r.uvScale.copy(e.uvScale)):e instanceof t.LOD?r=new t.LOD:e instanceof t.MarchingCubes?(r=new t.MarchingCubes(e.resolution,e.material),r.field.set(e.field),r.isolation=e.isolation):e instanceof t.Object3D&&(r=new t.Object3D),r.name=e.name,r.parent=e.parent,r.up.copy(e.up),r.position.copy(e.position),r.rotation instanceof t.Vector3&&r.rotation.copy(e.rotation),r.eulerOrder=e.eulerOrder,r.scale.copy(e.scale),r.dynamic=e.dynamic,r.doubleSided=e.doubleSided,r.flipSided=e.flipSided,r.renderDepth=e.renderDepth,r.rotationAutoUpdate=e.rotationAutoUpdate,r.matrix.copy(e.matrix),r.matrixWorld.copy(e.matrixWorld),r.matrixRotationWorld.copy(e.matrixRotationWorld),r.matrixAutoUpdate=e.matrixAutoUpdate,r.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,r.quaternion.copy(e.quaternion),r.useQuaternion=e.useQuaternion,r.boundRadius=e.boundRadius,r.boundRadiusScale=e.boundRadiusScale,r.visible=e.visible,r.castShadow=e.castShadow,r.receiveShadow=e.receiveShadow,r.frustumCulled=e.frustumCulled;for(var i=0;i<e.children.length;i++){var n=t.SceneUtils.cloneObject(e.children[i]);r.children[i]=n,n.parent=r}if(e instanceof t.LOD)for(i=0;i<e.LODs.length;i++)r.LODs[i]={visibleAtDistance:e.LODs[i].visibleAtDistance,object3D:r.children[i]};return r},detach:function(e,t,r){e.applyMatrix(t.matrixWorld),t.remove(e),r.add(e)},attach:function(e,r,i){var n=new t.Matrix4;n.getInverse(i.matrixWorld),e.applyMatrix(n),r.remove(e),i.add(e)}},t.WebGLRenderer&&(t.ShaderUtils={lib:{fresnel:{uniforms:{mRefractionRatio:{type:"f",value:1.02},mFresnelBias:{type:"f",value:.1},mFresnelPower:{type:"f",value:2},mFresnelScale:{type:"f",value:1},tCube:{type:"t",value:1,texture:null}},fragmentShader:"uniform samplerCube tCube;\nvarying vec3 vReflect;\nvarying vec3 vRefract[3];\nvarying float vReflectionFactor;\nvoid main() {\nvec4 reflectedColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );\nvec4 refractedColor = vec4( 1.0, 1.0, 1.0, 1.0 );\nrefractedColor.r = textureCube( tCube, vec3( -vRefract[0].x, vRefract[0].yz ) ).r;\nrefractedColor.g = textureCube( tCube, vec3( -vRefract[1].x, vRefract[1].yz ) ).g;\nrefractedColor.b = textureCube( tCube, vec3( -vRefract[2].x, vRefract[2].yz ) ).b;\nrefractedColor.a = 1.0;\ngl_FragColor = mix( refractedColor, reflectedColor, clamp( vReflectionFactor, 0.0, 1.0 ) );\n}",vertexShader:"uniform float mRefractionRatio;\nuniform float mFresnelBias;\nuniform float mFresnelScale;\nuniform float mFresnelPower;\nvarying vec3 vReflect;\nvarying vec3 vRefract[3];\nvarying float vReflectionFactor;\nvoid main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvec4 mPosition = objectMatrix * vec4( position, 1.0 );\nvec3 nWorld = normalize ( mat3( objectMatrix[0].xyz, objectMatrix[1].xyz, objectMatrix[2].xyz ) * normal );\nvec3 I = mPosition.xyz - cameraPosition;\nvReflect = reflect( I, nWorld );\nvRefract[0] = refract( normalize( I ), nWorld, mRefractionRatio );\nvRefract[1] = refract( normalize( I ), nWorld, mRefractionRatio * 0.99 );\nvRefract[2] = refract( normalize( I ), nWorld, mRefractionRatio * 0.98 );\nvReflectionFactor = mFresnelBias + mFresnelScale * pow( 1.0 + dot( normalize( I ), nWorld ), mFresnelPower );\ngl_Position = projectionMatrix * mvPosition;\n}"},normal:{uniforms:t.UniformsUtils.merge([t.UniformsLib.fog,t.UniformsLib.lights,t.UniformsLib.shadowmap,{enableAO:{type:"i",value:0},enableDiffuse:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},tDiffuse:{type:"t",value:0,texture:null},tCube:{type:"t",value:1,texture:null},tNormal:{type:"t",value:2,texture:null},tSpecular:{type:"t",value:3,texture:null},tAO:{type:"t",value:4,texture:null},tDisplacement:{type:"t",value:5,texture:null},uNormalScale:{type:"f",value:1},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},uDiffuseColor:{type:"c",value:new t.Color(16777215)},uSpecularColor:{type:"c",value:new t.Color(1118481)},uAmbientColor:{type:"c",value:new t.Color(16777215)},uShininess:{type:"f",value:30},uOpacity:{type:"f",value:1},uReflectivity:{type:"f",value:.5},uOffset:{type:"v2",value:new t.Vector2(0,0)},uRepeat:{type:"v2",value:new t.Vector2(1,1)},wrapRGB:{type:"v3",value:new t.Vector3(1,1,1)}}]),fragmentShader:["uniform vec3 uAmbientColor;\nuniform vec3 uDiffuseColor;\nuniform vec3 uSpecularColor;\nuniform float uShininess;\nuniform float uOpacity;\nuniform bool enableDiffuse;\nuniform bool enableSpecular;\nuniform bool enableAO;\nuniform bool enableReflection;\nuniform sampler2D tDiffuse;\nuniform sampler2D tNormal;\nuniform sampler2D tSpecular;\nuniform sampler2D tAO;\nuniform samplerCube tCube;\nuniform float uNormalScale;\nuniform float uReflectivity;\nvarying vec3 vTangent;\nvarying vec3 vBinormal;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nuniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nvarying vec4 vPointLight[ MAX_POINT_LIGHTS ];\n#endif\n#ifdef WRAP_AROUND\nuniform vec3 wrapRGB;\n#endif\nvarying vec3 vViewPosition;",t.ShaderChunk.shadowmap_pars_fragment,t.ShaderChunk.fog_pars_fragment,"void main() {\ngl_FragColor = vec4( vec3( 1.0 ), uOpacity );\nvec3 specularTex = vec3( 1.0 );\nvec3 normalTex = texture2D( tNormal, vUv ).xyz * 2.0 - 1.0;\nnormalTex.xy *= uNormalScale;\nnormalTex = normalize( normalTex );\nif( enableDiffuse ) {\n#ifdef GAMMA_INPUT\nvec4 texelColor = texture2D( tDiffuse, vUv );\ntexelColor.xyz *= texelColor.xyz;\ngl_FragColor = gl_FragColor * texelColor;\n#else\ngl_FragColor = gl_FragColor * texture2D( tDiffuse, vUv );\n#endif\n}\nif( enableAO ) {\n#ifdef GAMMA_INPUT\nvec4 aoColor = texture2D( tAO, vUv );\naoColor.xyz *= aoColor.xyz;\ngl_FragColor.xyz = gl_FragColor.xyz * aoColor.xyz;\n#else\ngl_FragColor.xyz = gl_FragColor.xyz * texture2D( tAO, vUv ).xyz;\n#endif\n}\nif( enableSpecular )\nspecularTex = texture2D( tSpecular, vUv ).xyz;\nmat3 tsb = mat3( normalize( vTangent ), normalize( vBinormal ), normalize( vNormal ) );\nvec3 finalNormal = tsb * normalTex;\nvec3 normal = normalize( finalNormal );\nvec3 viewPosition = normalize( vViewPosition );\n#if MAX_POINT_LIGHTS > 0\nvec3 pointDiffuse = vec3( 0.0 );\nvec3 pointSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec3 pointVector = normalize( vPointLight[ i ].xyz );\nfloat pointDistance = vPointLight[ i ].w;\n#ifdef WRAP_AROUND\nfloat pointDiffuseWeightFull = max( dot( normal, pointVector ), 0.0 );\nfloat pointDiffuseWeightHalf = max( 0.5 * dot( normal, pointVector ) + 0.5, 0.0 );\nvec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );\n#else\nfloat pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );\n#endif\npointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight;\nvec3 pointHalfVector = normalize( pointVector + viewPosition );\nfloat pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );\nfloat pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, uShininess ), 0.0 );\npointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight * pointDiffuseWeight;\n}\n#endif\n#if MAX_DIR_LIGHTS > 0\nvec3 dirDiffuse = vec3( 0.0 );\nvec3 dirSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\n#ifdef WRAP_AROUND\nfloat directionalLightWeightingFull = max( dot( normal, dirVector ), 0.0 );\nfloat directionalLightWeightingHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );\nvec3 dirDiffuseWeight = mix( vec3( directionalLightWeightingFull ), vec3( directionalLightWeightingHalf ), wrapRGB );\n#else\nfloat dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );\n#endif\ndirDiffuse += directionalLightColor[ i ] * uDiffuseColor * dirDiffuseWeight;\nvec3 dirHalfVector = normalize( dirVector + viewPosition );\nfloat dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );\nfloat dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );\ndirSpecular += directionalLightColor[ i ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight;\n}\n#endif\nvec3 totalDiffuse = vec3( 0.0 );\nvec3 totalSpecular = vec3( 0.0 );\n#if MAX_DIR_LIGHTS > 0\ntotalDiffuse += dirDiffuse;\ntotalSpecular += dirSpecular;\n#endif\n#if MAX_POINT_LIGHTS > 0\ntotalDiffuse += pointDiffuse;\ntotalSpecular += pointSpecular;\n#endif\ngl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor) + totalSpecular;\nif ( enableReflection ) {\nvec3 wPos = cameraPosition - vViewPosition;\nvec3 vReflect = reflect( normalize( wPos ), normal );\nvec4 cubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );\n#ifdef GAMMA_INPUT\ncubeColor.xyz *= cubeColor.xyz;\n#endif\ngl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularTex.r * uReflectivity );\n}",t.ShaderChunk.shadowmap_fragment,t.ShaderChunk.linear_to_gamma_fragment,t.ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["attribute vec4 tangent;\nuniform vec2 uOffset;\nuniform vec2 uRepeat;\n#ifdef VERTEX_TEXTURES\nuniform sampler2D tDisplacement;\nuniform float uDisplacementScale;\nuniform float uDisplacementBias;\n#endif\nvarying vec3 vTangent;\nvarying vec3 vBinormal;\nvarying vec3 vNormal;\nvarying vec2 vUv;\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\nvarying vec4 vPointLight[ MAX_POINT_LIGHTS ];\n#endif\nvarying vec3 vViewPosition;",t.ShaderChunk.shadowmap_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvViewPosition = -mvPosition.xyz;\nvNormal = normalMatrix * normal;\nvTangent = normalMatrix * tangent.xyz;\nvBinormal = cross( vNormal, vTangent ) * tangent.w;\nvUv = uv * uRepeat + uOffset;\n#if MAX_POINT_LIGHTS > 0\nfor( int i = 0; i < MAX_POINT_LIGHTS; i++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\nvPointLight[ i ] = vec4( lVector, lDistance );\n}\n#endif\n#ifdef VERTEX_TEXTURES\nvec3 dv = texture2D( tDisplacement, uv ).xyz;\nfloat df = uDisplacementScale * dv.x + uDisplacementBias;\nvec4 displacedPosition = vec4( normalize( vNormal.xyz ) * df, 0.0 ) + mvPosition;\ngl_Position = projectionMatrix * displacedPosition;\n#else\ngl_Position = projectionMatrix * mvPosition;\n#endif",t.ShaderChunk.shadowmap_vertex,"}"].join("\n")},cube:{uniforms:{tCube:{type:"t",value:1,texture:null},tFlip:{type:"f",value:-1}},vertexShader:"varying vec3 vViewPosition;\nvoid main() {\nvec4 mPosition = objectMatrix * vec4( position, 1.0 );\nvViewPosition = cameraPosition - mPosition.xyz;\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform samplerCube tCube;\nuniform float tFlip;\nvarying vec3 vViewPosition;\nvoid main() {\nvec3 wPos = cameraPosition - vViewPosition;\ngl_FragColor = textureCube( tCube, vec3( tFlip * wPos.x, wPos.yz ) );\n}"}}}),t.BufferGeometry=function(){this.id=t.GeometryCount++,this.vertexColorArray=this.vertexUvArray=this.vertexNormalArray=this.vertexPositionArray=this.vertexIndexArray=this.vertexColorBuffer=this.vertexUvBuffer=this.vertexNormalBuffer=this.vertexPositionBuffer=this.vertexIndexBuffer=null,this.dynamic=!1,this.boundingSphere=this.boundingBox=null,this.morphTargets=[]
},t.BufferGeometry.prototype={constructor:t.BufferGeometry,computeBoundingBox:function(){},computeBoundingSphere:function(){}},t.Curve=function(){},t.Curve.prototype.getPoint=function(){return console.log("Warning, getPoint() not implemented!"),null},t.Curve.prototype.getPointAt=function(e){return this.getPoint(this.getUtoTmapping(e))},t.Curve.prototype.getPoints=function(e){e||(e=5);var t,r=[];for(t=0;e>=t;t++)r.push(this.getPoint(t/e));return r},t.Curve.prototype.getSpacedPoints=function(e){e||(e=5);var t,r=[];for(t=0;e>=t;t++)r.push(this.getPointAt(t/e));return r},t.Curve.prototype.getLength=function(){var e=this.getLengths();return e[e.length-1]},t.Curve.prototype.getLengths=function(e){if(e||(e=200),this.cacheArcLengths&&this.cacheArcLengths.length==e+1)return this.cacheArcLengths;var t,r,i=[],n=this.getPoint(0),o=0;for(i.push(0),r=1;e>=r;r++)t=this.getPoint(r/e),o+=t.distanceTo(n),i.push(o),n=t;return this.cacheArcLengths=i},t.Curve.prototype.getUtoTmapping=function(e,t){var r,i=this.getLengths(),n=0,o=i.length;r=t?t:e*i[o-1];for(var a,s=0,l=o-1;l>=s;)if(n=Math.floor(s+(l-s)/2),a=i[n]-r,0>a)s=n+1;else{if(!(a>0)){l=n;break}l=n-1}return n=l,i[n]==r?n/(o-1):(s=i[n],i=(n+(r-s)/(i[n+1]-s))/(o-1))},t.Curve.prototype.getNormalVector=function(e){return e=this.getTangent(e),new t.Vector2(-e.y,e.x)},t.Curve.prototype.getTangent=function(e){var t=e-1e-4,e=e+1e-4;return 0>t&&(t=0),e>1&&(e=1),t=this.getPoint(t),e=this.getPoint(e),t.clone().subSelf(e).normalize()},t.Curve.prototype.getTangentAt=function(e){return this.getTangent(this.getUtoTmapping(e))},t.LineCurve=function(e,r){e instanceof t.Vector2?(this.v1=e,this.v2=r):t.LineCurve.oldConstructor.apply(this,arguments)},t.LineCurve.oldConstructor=function(e,r,i,n){this.constructor(new t.Vector2(e,r),new t.Vector2(i,n))},t.LineCurve.prototype=new t.Curve,t.LineCurve.prototype.constructor=t.LineCurve,t.LineCurve.prototype.getPoint=function(e){var r=new t.Vector2;return r.sub(this.v2,this.v1),r.multiplyScalar(e).addSelf(this.v1),r},t.LineCurve.prototype.getPointAt=function(e){return this.getPoint(e)},t.LineCurve.prototype.getTangent=function(){var e=new t.Vector2;return e.sub(this.v2,this.v1),e.normalize(),e},t.QuadraticBezierCurve=function(e,r,i){if(!(r instanceof t.Vector2))var n=Array.prototype.slice.call(arguments),e=new t.Vector2(n[0],n[1]),r=new t.Vector2(n[2],n[3]),i=new t.Vector2(n[4],n[5]);this.v0=e,this.v1=r,this.v2=i},t.QuadraticBezierCurve.prototype=new t.Curve,t.QuadraticBezierCurve.prototype.constructor=t.QuadraticBezierCurve,t.QuadraticBezierCurve.prototype.getPoint=function(e){var r;return r=t.Shape.Utils.b2(e,this.v0.x,this.v1.x,this.v2.x),e=t.Shape.Utils.b2(e,this.v0.y,this.v1.y,this.v2.y),new t.Vector2(r,e)},t.QuadraticBezierCurve.prototype.getTangent=function(e){var r;return r=t.Curve.Utils.tangentQuadraticBezier(e,this.v0.x,this.v1.x,this.v2.x),e=t.Curve.Utils.tangentQuadraticBezier(e,this.v0.y,this.v1.y,this.v2.y),r=new t.Vector2(r,e),r.normalize(),r},t.CubicBezierCurve=function(e,r,i,n){if(!(r instanceof t.Vector2))var o=Array.prototype.slice.call(arguments),e=new t.Vector2(o[0],o[1]),r=new t.Vector2(o[2],o[3]),i=new t.Vector2(o[4],o[5]),n=new t.Vector2(o[6],o[7]);this.v0=e,this.v1=r,this.v2=i,this.v3=n},t.CubicBezierCurve.prototype=new t.Curve,t.CubicBezierCurve.prototype.constructor=t.CubicBezierCurve,t.CubicBezierCurve.prototype.getPoint=function(e){var r;return r=t.Shape.Utils.b3(e,this.v0.x,this.v1.x,this.v2.x,this.v3.x),e=t.Shape.Utils.b3(e,this.v0.y,this.v1.y,this.v2.y,this.v3.y),new t.Vector2(r,e)},t.CubicBezierCurve.prototype.getTangent=function(e){var r;return r=t.Curve.Utils.tangentCubicBezier(e,this.v0.x,this.v1.x,this.v2.x,this.v3.x),e=t.Curve.Utils.tangentCubicBezier(e,this.v0.y,this.v1.y,this.v2.y,this.v3.y),r=new t.Vector2(r,e),r.normalize(),r},t.SplineCurve=function(e){this.points=void 0==e?[]:e},t.SplineCurve.prototype=new t.Curve,t.SplineCurve.prototype.constructor=t.SplineCurve,t.SplineCurve.prototype.getPoint=function(e){var r,i=new t.Vector2,n=[],o=this.points;return r=(o.length-1)*e,e=Math.floor(r),r-=e,n[0]=0==e?e:e-1,n[1]=e,n[2]=e>o.length-2?e:e+1,n[3]=e>o.length-3?e:e+2,i.x=t.Curve.Utils.interpolate(o[n[0]].x,o[n[1]].x,o[n[2]].x,o[n[3]].x,r),i.y=t.Curve.Utils.interpolate(o[n[0]].y,o[n[1]].y,o[n[2]].y,o[n[3]].y,r),i},t.ArcCurve=function(e,t,r,i,n,o){this.aX=e,this.aY=t,this.aRadius=r,this.aStartAngle=i,this.aEndAngle=n,this.aClockwise=o},t.ArcCurve.prototype=new t.Curve,t.ArcCurve.prototype.constructor=t.ArcCurve,t.ArcCurve.prototype.getPoint=function(e){var r=this.aEndAngle-this.aStartAngle;return this.aClockwise||(e=1-e),r=this.aStartAngle+e*r,e=this.aX+this.aRadius*Math.cos(r),r=this.aY+this.aRadius*Math.sin(r),new t.Vector2(e,r)},t.Curve.Utils={tangentQuadraticBezier:function(e,t,r,i){return 2*(1-e)*(r-t)+2*e*(i-r)},tangentCubicBezier:function(e,t,r,i,n){return-3*t*(1-e)*(1-e)+3*r*(1-e)*(1-e)-6*e*r*(1-e)+6*e*i*(1-e)-3*e*e*i+3*e*e*n},tangentSpline:function(e){return 6*e*e-6*e+(3*e*e-4*e+1)+(-6*e*e+6*e)+(3*e*e-2*e)},interpolate:function(e,t,r,i,n){var e=.5*(r-e),i=.5*(i-t),o=n*n;return(2*t-2*r+e+i)*n*o+(-3*t+3*r-2*e-i)*o+e*n+t}},t.Curve.create=function(e,r){return e.prototype=new t.Curve,e.prototype.constructor=e,e.prototype.getPoint=r,e},t.LineCurve3=t.Curve.create(function(e,t){this.v1=e,this.v2=t},function(e){var r=new t.Vector3;return r.sub(this.v2,this.v1),r.multiplyScalar(e),r.addSelf(this.v1),r}),t.QuadraticBezierCurve3=t.Curve.create(function(e,t,r){this.v0=e,this.v1=t,this.v2=r},function(e){var r,i;return r=t.Shape.Utils.b2(e,this.v0.x,this.v1.x,this.v2.x),i=t.Shape.Utils.b2(e,this.v0.y,this.v1.y,this.v2.y),e=t.Shape.Utils.b2(e,this.v0.z,this.v1.z,this.v2.z),new t.Vector3(r,i,e)}),t.CubicBezierCurve3=t.Curve.create(function(e,t,r,i){this.v0=e,this.v1=t,this.v2=r,this.v3=i},function(e){var r,i;return r=t.Shape.Utils.b3(e,this.v0.x,this.v1.x,this.v2.x,this.v3.x),i=t.Shape.Utils.b3(e,this.v0.y,this.v1.y,this.v2.y,this.v3.y),e=t.Shape.Utils.b3(e,this.v0.z,this.v1.z,this.v2.z,this.v3.z),new t.Vector3(r,i,e)}),t.SplineCurve3=t.Curve.create(function(e){this.points=void 0==e?[]:e},function(e){var r,i=new t.Vector3,n=[],o=this.points;return r=(o.length-1)*e,e=Math.floor(r),r-=e,n[0]=0==e?e:e-1,n[1]=e,n[2]=e>o.length-2?e:e+1,n[3]=e>o.length-3?e:e+2,i.x=t.Curve.Utils.interpolate(o[n[0]].x,o[n[1]].x,o[n[2]].x,o[n[3]].x,r),i.y=t.Curve.Utils.interpolate(o[n[0]].y,o[n[1]].y,o[n[2]].y,o[n[3]].y,r),i.z=t.Curve.Utils.interpolate(o[n[0]].z,o[n[1]].z,o[n[2]].z,o[n[3]].z,r),i}),t.CurvePath=function(){this.curves=[],this.bends=[],this.autoClose=!1},t.CurvePath.prototype=new t.Curve,t.CurvePath.prototype.constructor=t.CurvePath,t.CurvePath.prototype.add=function(e){this.curves.push(e)},t.CurvePath.prototype.checkConnection=function(){},t.CurvePath.prototype.closePath=function(){var e=this.curves[0].getPoint(0),r=this.curves[this.curves.length-1].getPoint(1);e.equals(r)||this.curves.push(new t.LineCurve(r,e))},t.CurvePath.prototype.getPoint=function(e){for(var t=e*this.getLength(),r=this.getCurveLengths(),e=0;e<r.length;){if(r[e]>=t)return t=r[e]-t,e=this.curves[e],t=1-t/e.getLength(),e.getPointAt(t);e++}return null},t.CurvePath.prototype.getLength=function(){var e=this.getCurveLengths();return e[e.length-1]},t.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length)return this.cacheLengths;var e,t=[],r=0,i=this.curves.length;for(e=0;i>e;e++)r+=this.curves[e].getLength(),t.push(r);return this.cacheLengths=t},t.CurvePath.prototype.getBoundingBox=function(){var e,r,i,n,o=this.getPoints();e=r=Number.NEGATIVE_INFINITY,i=n=Number.POSITIVE_INFINITY;var a,s,l,c;for(c=new t.Vector2,s=0,l=o.length;l>s;s++)a=o[s],a.x>e?e=a.x:a.x<i&&(i=a.x),a.y>r?r=a.y:a.y<r&&(n=a.y),c.addSelf(a.x,a.y);return{minX:i,minY:n,maxX:e,maxY:r,centroid:c.divideScalar(l)}},t.CurvePath.prototype.createPointsGeometry=function(e){return this.createGeometry(this.getPoints(e,!0))},t.CurvePath.prototype.createSpacedPointsGeometry=function(e){return this.createGeometry(this.getSpacedPoints(e,!0))},t.CurvePath.prototype.createGeometry=function(e){for(var r=new t.Geometry,i=0;i<e.length;i++)r.vertices.push(new t.Vertex(new t.Vector3(e[i].x,e[i].y,0)));return r},t.CurvePath.prototype.addWrapPath=function(e){this.bends.push(e)},t.CurvePath.prototype.getTransformedPoints=function(e,t){var r,i,n=this.getPoints(e);for(t||(t=this.bends),r=0,i=t.length;i>r;r++)n=this.getWrapPoints(n,t[r]);return n},t.CurvePath.prototype.getTransformedSpacedPoints=function(e,t){var r,i,n=this.getSpacedPoints(e);for(t||(t=this.bends),r=0,i=t.length;i>r;r++)n=this.getWrapPoints(n,t[r]);return n},t.CurvePath.prototype.getWrapPoints=function(e,t){var r,i,n,o,a,s,l=this.getBoundingBox();for(r=0,i=e.length;i>r;r++)n=e[r],o=n.x,a=n.y,s=o/l.maxX,s=t.getUtoTmapping(s,o),o=t.getPoint(s),a=t.getNormalVector(s).multiplyScalar(a),n.x=o.x+a.x,n.y=o.y+a.y;return e},t.EventTarget=function(){var e={};this.addEventListener=function(t,r){void 0==e[t]&&(e[t]=[]),-1===e[t].indexOf(r)&&e[t].push(r)},this.dispatchEvent=function(t){for(var r in e[t.type])e[t.type][r](t)},this.removeEventListener=function(t,r){var i=e[t].indexOf(r);-1!==i&&e[t].splice(i,1)}},t.Gyroscope=function(){t.Object3D.call(this)},t.Gyroscope.prototype=new t.Object3D,t.Gyroscope.prototype.constructor=t.Gyroscope,t.Gyroscope.prototype.updateMatrixWorld=function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(this.parent?(this.matrixWorld.multiply(this.parent.matrixWorld,this.matrix),this.matrixWorld.decompose(this.translationWorld,this.rotationWorld,this.scaleWorld),this.matrix.decompose(this.translationObject,this.rotationObject,this.scaleObject),this.matrixWorld.compose(this.translationWorld,this.rotationObject,this.scaleWorld)):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=0,r=this.children.length;r>t;t++)this.children[t].updateMatrixWorld(e)},t.Gyroscope.prototype.translationWorld=new t.Vector3,t.Gyroscope.prototype.translationObject=new t.Vector3,t.Gyroscope.prototype.rotationWorld=new t.Quaternion,t.Gyroscope.prototype.rotationObject=new t.Quaternion,t.Gyroscope.prototype.scaleWorld=new t.Vector3,t.Gyroscope.prototype.scaleObject=new t.Vector3,t.Path=function(e){t.CurvePath.call(this),this.actions=[],e&&this.fromPoints(e)},t.Path.prototype=new t.CurvePath,t.Path.prototype.constructor=t.Path,t.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc"},t.Path.prototype.fromPoints=function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,r=e.length;r>t;t++)this.lineTo(e[t].x,e[t].y)},t.Path.prototype.moveTo=function(){var e=Array.prototype.slice.call(arguments);this.actions.push({action:t.PathActions.MOVE_TO,args:e})},t.Path.prototype.lineTo=function(e,r){var i=Array.prototype.slice.call(arguments),n=this.actions[this.actions.length-1].args;this.curves.push(new t.LineCurve(new t.Vector2(n[n.length-2],n[n.length-1]),new t.Vector2(e,r))),this.actions.push({action:t.PathActions.LINE_TO,args:i})},t.Path.prototype.quadraticCurveTo=function(e,r,i,n){var o=Array.prototype.slice.call(arguments),a=this.actions[this.actions.length-1].args;this.curves.push(new t.QuadraticBezierCurve(new t.Vector2(a[a.length-2],a[a.length-1]),new t.Vector2(e,r),new t.Vector2(i,n))),this.actions.push({action:t.PathActions.QUADRATIC_CURVE_TO,args:o})},t.Path.prototype.bezierCurveTo=function(e,r,i,n,o,a){var s=Array.prototype.slice.call(arguments),l=this.actions[this.actions.length-1].args;this.curves.push(new t.CubicBezierCurve(new t.Vector2(l[l.length-2],l[l.length-1]),new t.Vector2(e,r),new t.Vector2(i,n),new t.Vector2(o,a))),this.actions.push({action:t.PathActions.BEZIER_CURVE_TO,args:s})},t.Path.prototype.splineThru=function(e){var r=Array.prototype.slice.call(arguments),i=this.actions[this.actions.length-1].args,i=[new t.Vector2(i[i.length-2],i[i.length-1])];Array.prototype.push.apply(i,e),this.curves.push(new t.SplineCurve(i)),this.actions.push({action:t.PathActions.CSPLINE_THRU,args:r})},t.Path.prototype.arc=function(e,r,i,n,o,a){var s=Array.prototype.slice.call(arguments);this.curves.push(new t.ArcCurve(e,r,i,n,o,a)),this.actions.push({action:t.PathActions.ARC,args:s})},t.Path.prototype.getSpacedPoints=function(e){e||(e=40);for(var t=[],r=0;e>r;r++)t.push(this.getPoint(r/e));return t},t.Path.prototype.getPoints=function(e,r){var i,n,o,a,s,l,c,h,p,d,u,f,m,e=e||12,g=[];for(i=0,n=this.actions.length;n>i;i++)switch(o=this.actions[i],a=o.action,o=o.args,a){case t.PathActions.LINE_TO:g.push(new t.Vector2(o[0],o[1]));break;case t.PathActions.QUADRATIC_CURVE_TO:for(s=o[2],l=o[3],p=o[0],d=o[1],0<g.length?(a=g[g.length-1],u=a.x,f=a.y):(a=this.actions[i-1].args,u=a[a.length-2],f=a[a.length-1]),a=1;e>=a;a++)m=a/e,o=t.Shape.Utils.b2(m,u,p,s),m=t.Shape.Utils.b2(m,f,d,l),g.push(new t.Vector2(o,m));break;case t.PathActions.BEZIER_CURVE_TO:for(s=o[4],l=o[5],p=o[0],d=o[1],c=o[2],h=o[3],0<g.length?(a=g[g.length-1],u=a.x,f=a.y):(a=this.actions[i-1].args,u=a[a.length-2],f=a[a.length-1]),a=1;e>=a;a++)m=a/e,o=t.Shape.Utils.b3(m,u,p,c,s),m=t.Shape.Utils.b3(m,f,d,h,l),g.push(new t.Vector2(o,m));break;case t.PathActions.CSPLINE_THRU:for(a=this.actions[i-1].args,a=[new t.Vector2(a[a.length-2],a[a.length-1])],m=e*o[0].length,a=a.concat(o[0]),o=new t.SplineCurve(a),a=1;m>=a;a++)g.push(o.getPointAt(a/m));break;case t.PathActions.ARC:a=this.actions[i-1].args,s=o[0],l=o[1],c=o[2],p=o[3],m=o[4],d=!!o[5],h=a[a.length-2],u=a[a.length-1],0==a.length&&(h=u=0),f=m-p;var b=2*e;for(a=1;b>=a;a++)m=a/b,d||(m=1-m),m=p+m*f,o=h+s+c*Math.cos(m),m=u+l+c*Math.sin(m),g.push(new t.Vector2(o,m))}return r&&g.push(g[0]),g},t.Path.prototype.transform=function(e,t){return this.getBoundingBox(),this.getWrapPoints(this.getPoints(t),e)},t.Path.prototype.nltransform=function(e,t,r,i,n,o){var a,s,l,c,h,p=this.getPoints();for(a=0,s=p.length;s>a;a++)l=p[a],c=l.x,h=l.y,l.x=e*c+t*h+r,l.y=i*h+n*c+o;return p},t.Path.prototype.debug=function(e){var r=this.getBoundingBox();e||(e=document.createElement("canvas"),e.setAttribute("width",r.maxX+100),e.setAttribute("height",r.maxY+100),document.body.appendChild(e)),r=e.getContext("2d"),r.fillStyle="white",r.fillRect(0,0,e.width,e.height),r.strokeStyle="black",r.beginPath();var i,n,o;for(e=0,i=this.actions.length;i>e;e++)n=this.actions[e],o=n.args,n=n.action,n!=t.PathActions.CSPLINE_THRU&&r[n].apply(r,o);for(r.stroke(),r.closePath(),r.strokeStyle="red",n=this.getPoints(),e=0,i=n.length;i>e;e++)o=n[e],r.beginPath(),r.arc(o.x,o.y,1.5,0,2*Math.PI,!1),r.stroke(),r.closePath()},t.Path.prototype.toShapes=function(){var e,r,i,n,o=[],a=new t.Path;for(e=0,r=this.actions.length;r>e;e++)i=this.actions[e],n=i.args,i=i.action,i==t.PathActions.MOVE_TO&&0!=a.actions.length&&(o.push(a),a=new t.Path),a[i].apply(a,n);if(0!=a.actions.length&&o.push(a),0==o.length)return[];var s;if(n=[],e=!t.Shape.Utils.isClockWise(o[0].getPoints()),1==o.length)return a=o[0],s=new t.Shape,s.actions=a.actions,s.curves=a.curves,n.push(s),n;if(e)for(s=new t.Shape,e=0,r=o.length;r>e;e++)a=o[e],t.Shape.Utils.isClockWise(a.getPoints())?(s.actions=a.actions,s.curves=a.curves,n.push(s),s=new t.Shape):s.holes.push(a);else{for(e=0,r=o.length;r>e;e++)a=o[e],t.Shape.Utils.isClockWise(a.getPoints())?(s&&n.push(s),s=new t.Shape,s.actions=a.actions,s.curves=a.curves):s.holes.push(a);n.push(s)}return n},t.Shape=function(){t.Path.apply(this,arguments),this.holes=[]},t.Shape.prototype=new t.Path,t.Shape.prototype.constructor=t.Path,t.Shape.prototype.extrude=function(e){return new t.ExtrudeGeometry(this,e)},t.Shape.prototype.getPointsHoles=function(e){var t,r=this.holes.length,i=[];for(t=0;r>t;t++)i[t]=this.holes[t].getTransformedPoints(e,this.bends);return i},t.Shape.prototype.getSpacedPointsHoles=function(e){var t,r=this.holes.length,i=[];for(t=0;r>t;t++)i[t]=this.holes[t].getTransformedSpacedPoints(e,this.bends);return i},t.Shape.prototype.extractAllPoints=function(e){return{shape:this.getTransformedPoints(e),holes:this.getPointsHoles(e)}},t.Shape.prototype.extractAllSpacedPoints=function(e){return{shape:this.getTransformedSpacedPoints(e),holes:this.getSpacedPointsHoles(e)}},t.Shape.Utils={removeHoles:function(e,r){var i,n,o,a,s,l,c,h,p,d,u=e.concat(),f=u.concat(),m=[];for(s=0;s<r.length;s++){for(l=r[s],Array.prototype.push.apply(f,l),n=Number.POSITIVE_INFINITY,i=0;i<l.length;i++)for(p=l[i],d=[],h=0;h<u.length;h++)c=u[h],c=p.distanceToSquared(c),d.push(c),n>c&&(n=c,o=i,a=h);i=a-1>=0?a-1:u.length-1,n=o-1>=0?o-1:l.length-1;var g=[l[o],u[a],u[i]];h=t.FontUtils.Triangulate.area(g);var b=[l[o],l[n],u[a]];p=t.FontUtils.Triangulate.area(b),d=a,c=o,a+=1,o+=-1,0>a&&(a+=u.length),a%=u.length,0>o&&(o+=l.length),o%=l.length,i=a-1>=0?a-1:u.length-1,n=o-1>=0?o-1:l.length-1,g=[l[o],u[a],u[i]],g=t.FontUtils.Triangulate.area(g),b=[l[o],l[n],u[a]],b=t.FontUtils.Triangulate.area(b),h+p>g+b&&(a=d,o=c,0>a&&(a+=u.length),a%=u.length,0>o&&(o+=l.length),o%=l.length,i=a-1>=0?a-1:u.length-1,n=o-1>=0?o-1:l.length-1),h=u.slice(0,a),p=u.slice(a),d=l.slice(o),c=l.slice(0,o),n=[l[o],l[n],u[a]],m.push([l[o],u[a],u[i]]),m.push(n),u=h.concat(d).concat(c).concat(p)}return{shape:u,isolatedPts:m,allpoints:f}},triangulateShape:function(e,r){var i,n,o,a,s=t.Shape.Utils.removeHoles(e,r),l=s.allpoints,c=s.isolatedPts,s=t.FontUtils.Triangulate(s.shape,!1),h={};for(i=0,n=l.length;n>i;i++)a=l[i].x+":"+l[i].y,void 0!==h[a]&&console.log("Duplicate point",a),h[a]=i;for(i=0,n=s.length;n>i;i++)for(o=s[i],l=0;3>l;l++)a=o[l].x+":"+o[l].y,a=h[a],void 0!==a&&(o[l]=a);for(i=0,n=c.length;n>i;i++)for(o=c[i],l=0;3>l;l++)a=o[l].x+":"+o[l].y,a=h[a],void 0!==a&&(o[l]=a);return s.concat(c)},isClockWise:function(e){return 0>t.FontUtils.Triangulate.area(e)},b2p0:function(e,t){var r=1-e;return r*r*t},b2p1:function(e,t){return 2*(1-e)*e*t},b2p2:function(e,t){return e*e*t},b2:function(e,t,r,i){return this.b2p0(e,t)+this.b2p1(e,r)+this.b2p2(e,i)},b3p0:function(e,t){var r=1-e;return r*r*r*t},b3p1:function(e,t){var r=1-e;return 3*r*r*e*t},b3p2:function(e,t){return 3*(1-e)*e*e*t},b3p3:function(e,t){return e*e*e*t},b3:function(e,t,r,i,n){return this.b3p0(e,t)+this.b3p1(e,r)+this.b3p2(e,i)+this.b3p3(e,n)}},t.TextPath=function(e,r){t.Path.call(this),this.parameters=r||{},this.set(e)},t.TextPath.prototype.set=function(e,r){r=r||this.parameters,this.text=e;var i=void 0!==r.curveSegments?r.curveSegments:4,n=void 0!==r.font?r.font:"helvetiker",o=void 0!==r.weight?r.weight:"normal",a=void 0!==r.style?r.style:"normal";t.FontUtils.size=void 0!==r.size?r.size:100,t.FontUtils.divisions=i,t.FontUtils.face=n,t.FontUtils.weight=o,t.FontUtils.style=a},t.TextPath.prototype.toShapes=function(){for(var e=t.FontUtils.drawText(this.text).paths,r=[],i=0,n=e.length;n>i;i++)Array.prototype.push.apply(r,e[i].toShapes());return r},t.AnimationHandler=function(){var e=[],r={},i={update:function(t){for(var r=0;r<e.length;r++)e[r].update(t)},addToUpdate:function(t){-1===e.indexOf(t)&&e.push(t)},removeFromUpdate:function(t){t=e.indexOf(t),-1!==t&&e.splice(t,1)},add:function(e){if(void 0!==r[e.name]&&console.log("THREE.AnimationHandler.add: Warning! "+e.name+" already exists in library. Overwriting."),r[e.name]=e,!0!==e.initialized){for(var i=0;i<e.hierarchy.length;i++){for(var n=0;n<e.hierarchy[i].keys.length;n++)if(0>e.hierarchy[i].keys[n].time&&(e.hierarchy[i].keys[n].time=0),void 0!==e.hierarchy[i].keys[n].rot&&!(e.hierarchy[i].keys[n].rot instanceof t.Quaternion)){var o=e.hierarchy[i].keys[n].rot;e.hierarchy[i].keys[n].rot=new t.Quaternion(o[0],o[1],o[2],o[3])}if(e.hierarchy[i].keys.length&&void 0!==e.hierarchy[i].keys[0].morphTargets){for(o={},n=0;n<e.hierarchy[i].keys.length;n++)for(var a=0;a<e.hierarchy[i].keys[n].morphTargets.length;a++){var s=e.hierarchy[i].keys[n].morphTargets[a];o[s]=-1}for(e.hierarchy[i].usedMorphTargets=o,n=0;n<e.hierarchy[i].keys.length;n++){var l={};for(s in o){for(a=0;a<e.hierarchy[i].keys[n].morphTargets.length;a++)if(e.hierarchy[i].keys[n].morphTargets[a]===s){l[s]=e.hierarchy[i].keys[n].morphTargetsInfluences[a];break}a===e.hierarchy[i].keys[n].morphTargets.length&&(l[s]=0)}e.hierarchy[i].keys[n].morphTargetsInfluences=l}}for(n=1;n<e.hierarchy[i].keys.length;n++)e.hierarchy[i].keys[n].time===e.hierarchy[i].keys[n-1].time&&(e.hierarchy[i].keys.splice(n,1),n--);for(n=0;n<e.hierarchy[i].keys.length;n++)e.hierarchy[i].keys[n].index=n}for(n=parseInt(e.length*e.fps,10),e.JIT={},e.JIT.hierarchy=[],i=0;i<e.hierarchy.length;i++)e.JIT.hierarchy.push(Array(n));e.initialized=!0}},get:function(e){return"string"==typeof e?r[e]?r[e]:(console.log("THREE.AnimationHandler.get: Couldn't find animation "+e),null):void 0},parse:function(e){var r=[];if(e instanceof t.SkinnedMesh)for(var i=0;i<e.bones.length;i++)r.push(e.bones[i]);else n(e,r);return r}},n=function(e,t){t.push(e);for(var r=0;r<e.children.length;r++)n(e.children[r],t)};return i.LINEAR=0,i.CATMULLROM=1,i.CATMULLROM_FORWARD=2,i}(),t.Animation=function(e,r,i,n){this.root=e,this.data=t.AnimationHandler.get(r),this.hierarchy=t.AnimationHandler.parse(e),this.currentTime=0,this.timeScale=1,this.isPlaying=!1,this.loop=this.isPaused=!0,this.interpolationType=void 0!==i?i:t.AnimationHandler.LINEAR,this.JITCompile=void 0!==n?n:!0,this.points=[],this.target=new t.Vector3},t.Animation.prototype.play=function(e,r){if(!this.isPlaying){this.isPlaying=!0,this.loop=void 0!==e?e:!0,this.currentTime=void 0!==r?r:0;var i,n,o=this.hierarchy.length;for(i=0;o>i;i++){n=this.hierarchy[i],this.interpolationType!==t.AnimationHandler.CATMULLROM_FORWARD&&(n.useQuaternion=!0),n.matrixAutoUpdate=!0,void 0===n.animationCache&&(n.animationCache={},n.animationCache.prevKey={pos:0,rot:0,scl:0},n.animationCache.nextKey={pos:0,rot:0,scl:0},n.animationCache.originalMatrix=n instanceof t.Bone?n.skinMatrix:n.matrix);var a=n.animationCache.prevKey;n=n.animationCache.nextKey,a.pos=this.data.hierarchy[i].keys[0],a.rot=this.data.hierarchy[i].keys[0],a.scl=this.data.hierarchy[i].keys[0],n.pos=this.getNextKeyWith("pos",i,1),n.rot=this.getNextKeyWith("rot",i,1),n.scl=this.getNextKeyWith("scl",i,1)}this.update(0)}this.isPaused=!1,t.AnimationHandler.addToUpdate(this)},t.Animation.prototype.pause=function(){this.isPaused?t.AnimationHandler.addToUpdate(this):t.AnimationHandler.removeFromUpdate(this),this.isPaused=!this.isPaused},t.Animation.prototype.stop=function(){this.isPaused=this.isPlaying=!1,t.AnimationHandler.removeFromUpdate(this);for(var e=0;e<this.hierarchy.length;e++)void 0!==this.hierarchy[e].animationCache&&(this.hierarchy[e]instanceof t.Bone?this.hierarchy[e].skinMatrix=this.hierarchy[e].animationCache.originalMatrix:this.hierarchy[e].matrix=this.hierarchy[e].animationCache.originalMatrix,delete this.hierarchy[e].animationCache)},t.Animation.prototype.update=function(e){if(this.isPlaying){var r,i,n,o,a,s,l,c,h,p,d=["pos","rot","scl"],u=this.data.JIT.hierarchy;p=this.currentTime+=e*this.timeScale,h=this.currentTime%=this.data.length,c=parseInt(Math.min(h*this.data.fps,this.data.length*this.data.fps),10);for(var f=0,m=this.hierarchy.length;m>f;f++)if(e=this.hierarchy[f],l=e.animationCache,this.JITCompile&&void 0!==u[f][c])e instanceof t.Bone?(e.skinMatrix=u[f][c],e.matrixAutoUpdate=!1,e.matrixWorldNeedsUpdate=!1):(e.matrix=u[f][c],e.matrixAutoUpdate=!1,e.matrixWorldNeedsUpdate=!0);else{this.JITCompile&&(e instanceof t.Bone?e.skinMatrix=e.animationCache.originalMatrix:e.matrix=e.animationCache.originalMatrix);for(var g=0;3>g;g++){if(r=d[g],a=l.prevKey[r],s=l.nextKey[r],s.time<=p){if(p>h){if(!this.loop)return this.stop(),void 0;for(a=this.data.hierarchy[f].keys[0],s=this.getNextKeyWith(r,f,1);s.time<h;)a=s,s=this.getNextKeyWith(r,f,s.index+1)}else do a=s,s=this.getNextKeyWith(r,f,s.index+1);while(s.time<h);l.prevKey[r]=a,l.nextKey[r]=s}e.matrixAutoUpdate=!0,e.matrixWorldNeedsUpdate=!0,i=(h-a.time)/(s.time-a.time),n=a[r],o=s[r],(0>i||i>1)&&(console.log("THREE.Animation.update: Warning! Scale out of bounds:"+i+" on bone "+f),i=0>i?0:1),"pos"===r?(r=e.position,this.interpolationType===t.AnimationHandler.LINEAR?(r.x=n[0]+(o[0]-n[0])*i,r.y=n[1]+(o[1]-n[1])*i,r.z=n[2]+(o[2]-n[2])*i):(this.interpolationType===t.AnimationHandler.CATMULLROM||this.interpolationType===t.AnimationHandler.CATMULLROM_FORWARD)&&(this.points[0]=this.getPrevKeyWith("pos",f,a.index-1).pos,this.points[1]=n,this.points[2]=o,this.points[3]=this.getNextKeyWith("pos",f,s.index+1).pos,i=.33*i+.33,n=this.interpolateCatmullRom(this.points,i),r.x=n[0],r.y=n[1],r.z=n[2],this.interpolationType===t.AnimationHandler.CATMULLROM_FORWARD&&(i=this.interpolateCatmullRom(this.points,1.01*i),this.target.set(i[0],i[1],i[2]),this.target.subSelf(r),this.target.y=0,this.target.normalize(),i=Math.atan2(this.target.x,this.target.z),e.rotation.set(0,i,0)))):"rot"===r?t.Quaternion.slerp(n,o,e.quaternion,i):"scl"===r&&(r=e.scale,r.x=n[0]+(o[0]-n[0])*i,r.y=n[1]+(o[1]-n[1])*i,r.z=n[2]+(o[2]-n[2])*i)}}if(this.JITCompile&&void 0===u[0][c])for(this.hierarchy[0].updateMatrixWorld(!0),f=0;f<this.hierarchy.length;f++)u[f][c]=this.hierarchy[f]instanceof t.Bone?this.hierarchy[f].skinMatrix.clone():this.hierarchy[f].matrix.clone()}},t.Animation.prototype.interpolateCatmullRom=function(e,t){var r,i,n,o,a,s,l=[],c=[];return r=(e.length-1)*t,i=Math.floor(r),r-=i,l[0]=0===i?i:i-1,l[1]=i,l[2]=i>e.length-2?i:i+1,l[3]=i>e.length-3?i:i+2,i=e[l[0]],o=e[l[1]],a=e[l[2]],s=e[l[3]],l=r*r,n=r*l,c[0]=this.interpolate(i[0],o[0],a[0],s[0],r,l,n),c[1]=this.interpolate(i[1],o[1],a[1],s[1],r,l,n),c[2]=this.interpolate(i[2],o[2],a[2],s[2],r,l,n),c},t.Animation.prototype.interpolate=function(e,t,r,i,n,o,a){return e=.5*(r-e),i=.5*(i-t),(2*(t-r)+e+i)*a+(-3*(t-r)-2*e-i)*o+e*n+t},t.Animation.prototype.getNextKeyWith=function(e,r,i){for(var n=this.data.hierarchy[r].keys,i=this.interpolationType===t.AnimationHandler.CATMULLROM||this.interpolationType===t.AnimationHandler.CATMULLROM_FORWARD?i<n.length-1?i:n.length-1:i%n.length;i<n.length;i++)if(void 0!==n[i][e])return n[i];return this.data.hierarchy[r].keys[0]},t.Animation.prototype.getPrevKeyWith=function(e,r,i){for(var n=this.data.hierarchy[r].keys,i=this.interpolationType===t.AnimationHandler.CATMULLROM||this.interpolationType===t.AnimationHandler.CATMULLROM_FORWARD?i>0?i:0:i>=0?i:i+n.length;i>=0;i--)if(void 0!==n[i][e])return n[i];return this.data.hierarchy[r].keys[n.length-1]},t.KeyFrameAnimation=function(e,r,i){for(this.root=e,this.data=t.AnimationHandler.get(r),this.hierarchy=t.AnimationHandler.parse(e),this.currentTime=0,this.timeScale=.001,this.isPlaying=!1,this.loop=this.isPaused=!0,this.JITCompile=void 0!==i?i:!0,e=0,r=this.hierarchy.length;r>e;e++){var i=this.data.hierarchy[e].sids,n=this.hierarchy[e];if(this.data.hierarchy[e].keys.length&&i){for(var o=0;o<i.length;o++){var a=i[o],s=this.getNextKeyWith(a,e,0);s&&s.apply(a)}n.matrixAutoUpdate=!1,this.data.hierarchy[e].node.updateMatrix(),n.matrixWorldNeedsUpdate=!0}}},t.KeyFrameAnimation.prototype.play=function(e,r){if(!this.isPlaying){this.isPlaying=!0,this.loop=void 0!==e?e:!0,this.currentTime=void 0!==r?r:0,this.startTimeMs=r,this.startTime=1e7,this.endTime=-this.startTime;var i,n,o,a=this.hierarchy.length;for(i=0;a>i;i++)n=this.hierarchy[i],o=this.data.hierarchy[i],n.useQuaternion=!0,void 0===o.animationCache&&(o.animationCache={},o.animationCache.prevKey=null,o.animationCache.nextKey=null,o.animationCache.originalMatrix=n instanceof t.Bone?n.skinMatrix:n.matrix),n=this.data.hierarchy[i].keys,n.length&&(o.animationCache.prevKey=n[0],o.animationCache.nextKey=n[1],this.startTime=Math.min(n[0].time,this.startTime),this.endTime=Math.max(n[n.length-1].time,this.endTime));this.update(0)}this.isPaused=!1,t.AnimationHandler.addToUpdate(this)},t.KeyFrameAnimation.prototype.pause=function(){this.isPaused?t.AnimationHandler.addToUpdate(this):t.AnimationHandler.removeFromUpdate(this),this.isPaused=!this.isPaused},t.KeyFrameAnimation.prototype.stop=function(){this.isPaused=this.isPlaying=!1,t.AnimationHandler.removeFromUpdate(this);for(var e=0;e<this.data.hierarchy.length;e++){var r=this.hierarchy[e],i=this.data.hierarchy[e];if(void 0!==i.animationCache){var n=i.animationCache.originalMatrix;r instanceof t.Bone?(n.copy(r.skinMatrix),r.skinMatrix=n):(n.copy(r.matrix),r.matrix=n),delete i.animationCache}}},t.KeyFrameAnimation.prototype.update=function(e){if(this.isPlaying){var r,i,n,o,a,s,l,c=this.data.JIT.hierarchy;if(s=this.currentTime+=e*this.timeScale,a=this.currentTime%=this.data.length,a<this.startTimeMs&&(a=this.currentTime=this.startTimeMs+a),o=parseInt(Math.min(a*this.data.fps,this.data.length*this.data.fps),10),(l=s>a)&&!this.loop){for(var e=0,h=this.hierarchy.length;h>e;e++){var p=this.data.hierarchy[e].keys,c=this.data.hierarchy[e].sids;if(n=p.length-1,o=this.hierarchy[e],p.length){for(p=0;p<c.length;p++)a=c[p],(s=this.getPrevKeyWith(a,e,n))&&s.apply(a);this.data.hierarchy[e].node.updateMatrix(),o.matrixWorldNeedsUpdate=!0}}this.stop()}else if(!(a<this.startTime)){for(e=0,h=this.hierarchy.length;h>e;e++){n=this.hierarchy[e],r=this.data.hierarchy[e];var p=r.keys,d=r.animationCache;if(this.JITCompile&&void 0!==c[e][o])n instanceof t.Bone?(n.skinMatrix=c[e][o],n.matrixWorldNeedsUpdate=!1):(n.matrix=c[e][o],n.matrixWorldNeedsUpdate=!0);else if(p.length){if(this.JITCompile&&d&&(n instanceof t.Bone?n.skinMatrix=d.originalMatrix:n.matrix=d.originalMatrix),r=d.prevKey,i=d.nextKey,r&&i){if(i.time<=s){if(l&&this.loop)for(r=p[0],i=p[1];i.time<a;)r=i,i=p[r.index+1];else if(!l)for(var u=p.length-1;i.time<a&&i.index!==u;)r=i,i=p[r.index+1];d.prevKey=r,d.nextKey=i}i.time>=a?r.interpolate(i,a):r.interpolate(i,i.time)}this.data.hierarchy[e].node.updateMatrix(),n.matrixWorldNeedsUpdate=!0}}if(this.JITCompile&&void 0===c[0][o])for(this.hierarchy[0].updateMatrixWorld(!0),e=0;e<this.hierarchy.length;e++)c[e][o]=this.hierarchy[e]instanceof t.Bone?this.hierarchy[e].skinMatrix.clone():this.hierarchy[e].matrix.clone()}}},t.KeyFrameAnimation.prototype.getNextKeyWith=function(e,t,r){for(t=this.data.hierarchy[t].keys,r%=t.length;r<t.length;r++)if(t[r].hasTarget(e))return t[r];return t[0]},t.KeyFrameAnimation.prototype.getPrevKeyWith=function(e,t,r){for(t=this.data.hierarchy[t].keys,r=r>=0?r:r+t.length;r>=0;r--)if(t[r].hasTarget(e))return t[r];return t[t.length-1]},t.CubeCamera=function(e,r,i,n){this.heightOffset=i,this.position=new t.Vector3(0,i,0),this.cameraPX=new t.PerspectiveCamera(90,1,e,r),this.cameraNX=new t.PerspectiveCamera(90,1,e,r),this.cameraPY=new t.PerspectiveCamera(90,1,e,r),this.cameraNY=new t.PerspectiveCamera(90,1,e,r),this.cameraPZ=new t.PerspectiveCamera(90,1,e,r),this.cameraNZ=new t.PerspectiveCamera(90,1,e,r),this.cameraPX.position=this.position,this.cameraNX.position=this.position,this.cameraPY.position=this.position,this.cameraNY.position=this.position,this.cameraPZ.position=this.position,this.cameraNZ.position=this.position,this.cameraPX.up.set(0,-1,0),this.cameraNX.up.set(0,-1,0),this.cameraPY.up.set(0,0,1),this.cameraNY.up.set(0,0,-1),this.cameraPZ.up.set(0,-1,0),this.cameraNZ.up.set(0,-1,0),this.targetPX=new t.Vector3(0,0,0),this.targetNX=new t.Vector3(0,0,0),this.targetPY=new t.Vector3(0,0,0),this.targetNY=new t.Vector3(0,0,0),this.targetPZ=new t.Vector3(0,0,0),this.targetNZ=new t.Vector3(0,0,0),this.renderTarget=new t.WebGLRenderTargetCube(n,n,{format:t.RGBFormat,magFilter:t.LinearFilter,minFilter:t.LinearFilter}),this.updatePosition=function(e){this.position.copy(e),this.position.y+=this.heightOffset,this.targetPX.copy(this.position),this.targetNX.copy(this.position),this.targetPY.copy(this.position),this.targetNY.copy(this.position),this.targetPZ.copy(this.position),this.targetNZ.copy(this.position),this.targetPX.x+=1,this.targetNX.x-=1,this.targetPY.y+=1,this.targetNY.y-=1,this.targetPZ.z+=1,this.targetNZ.z-=1,this.cameraPX.lookAt(this.targetPX),this.cameraNX.lookAt(this.targetNX),this.cameraPY.lookAt(this.targetPY),this.cameraNY.lookAt(this.targetNY),this.cameraPZ.lookAt(this.targetPZ),this.cameraNZ.lookAt(this.targetNZ)},this.updateCubeMap=function(e,t){var r=this.renderTarget;r.activeCubeFace=0,e.render(t,this.cameraPX,r),r.activeCubeFace=1,e.render(t,this.cameraNX,r),r.activeCubeFace=2,e.render(t,this.cameraPY,r),r.activeCubeFace=3,e.render(t,this.cameraNY,r),r.activeCubeFace=4,e.render(t,this.cameraPZ,r),r.activeCubeFace=5,e.render(t,this.cameraNZ,r)
}},t.CombinedCamera=function(e,r,i,n,o,a,s){t.Camera.call(this),this.fov=i,this.left=-e/2,this.right=e/2,this.top=r/2,this.bottom=-r/2,this.cameraO=new t.OrthographicCamera(e/-2,e/2,r/2,r/-2,a,s),this.cameraP=new t.PerspectiveCamera(i,e/r,n,o),this.zoom=1,this.toPerspective()},t.CombinedCamera.prototype=new t.Camera,t.CombinedCamera.prototype.constructor=t.CoolCamera,t.CombinedCamera.prototype.toPerspective=function(){this.near=this.cameraP.near,this.far=this.cameraP.far,this.cameraP.fov=this.fov/this.zoom,this.cameraP.updateProjectionMatrix(),this.projectionMatrix=this.cameraP.projectionMatrix,this.inPersepectiveMode=!0,this.inOrthographicMode=!1},t.CombinedCamera.prototype.toOrthographic=function(){var e=this.cameraP.aspect,t=(this.cameraP.near+this.cameraP.far)/2,t=Math.tan(this.fov/2)*t,e=2*t*e/2,t=t/this.zoom,e=e/this.zoom;this.cameraO.left=-e,this.cameraO.right=e,this.cameraO.top=t,this.cameraO.bottom=-t,this.cameraO.updateProjectionMatrix(),this.near=this.cameraO.near,this.far=this.cameraO.far,this.projectionMatrix=this.cameraO.projectionMatrix,this.inPersepectiveMode=!1,this.inOrthographicMode=!0},t.CombinedCamera.prototype.setFov=function(e){this.fov=e,this.inPersepectiveMode?this.toPerspective():this.toOrthographic()},t.CombinedCamera.prototype.setLens=function(e,t){var r=2*Math.atan((void 0!==t?t:24)/(2*e))*(180/Math.PI);return this.setFov(r),r},t.CombinedCamera.prototype.setZoom=function(e){this.zoom=e,this.inPersepectiveMode?this.toPerspective():this.toOrthographic()},t.CombinedCamera.prototype.toFrontView=function(){this.rotation.x=0,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},t.CombinedCamera.prototype.toBackView=function(){this.rotation.x=0,this.rotation.y=Math.PI,this.rotation.z=0,this.rotationAutoUpdate=!1},t.CombinedCamera.prototype.toLeftView=function(){this.rotation.x=0,this.rotation.y=-Math.PI/2,this.rotation.z=0,this.rotationAutoUpdate=!1},t.CombinedCamera.prototype.toRightView=function(){this.rotation.x=0,this.rotation.y=Math.PI/2,this.rotation.z=0,this.rotationAutoUpdate=!1},t.CombinedCamera.prototype.toTopView=function(){this.rotation.x=-Math.PI/2,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},t.CombinedCamera.prototype.toBottomView=function(){this.rotation.x=Math.PI/2,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},t.FirstPersonControls=function(e,r){function i(e,t){return function(){t.apply(e,arguments)}}this.object=e,this.target=new t.Vector3(0,0,0),this.domElement=void 0!==r?r:document,this.movementSpeed=1,this.lookSpeed=.005,this.noFly=!1,this.lookVertical=!0,this.autoForward=!1,this.activeLook=!0,this.heightSpeed=!1,this.heightCoef=1,this.heightMin=0,this.constrainVertical=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.theta=this.phi=this.lon=this.lat=this.mouseY=this.mouseX=this.autoSpeedFactor=0,this.mouseDragOn=this.freeze=this.moveRight=this.moveLeft=this.moveBackward=this.moveForward=!1,this.domElement===document?(this.viewHalfX=window.innerWidth/2,this.viewHalfY=window.innerHeight/2):(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2,this.domElement.setAttribute("tabindex",-1)),this.onMouseDown=function(e){if(this.domElement!==document&&this.domElement.focus(),e.preventDefault(),e.stopPropagation(),this.activeLook)switch(e.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0}this.mouseDragOn=!0},this.onMouseUp=function(e){if(e.preventDefault(),e.stopPropagation(),this.activeLook)switch(e.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1}this.mouseDragOn=!1},this.onMouseMove=function(e){this.domElement===document?(this.mouseX=e.pageX-this.viewHalfX,this.mouseY=e.pageY-this.viewHalfY):(this.mouseX=e.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=e.pageY-this.domElement.offsetTop-this.viewHalfY)},this.onKeyDown=function(e){switch(e.keyCode){case 38:case 87:this.moveForward=!0;break;case 37:case 65:this.moveLeft=!0;break;case 40:case 83:this.moveBackward=!0;break;case 39:case 68:this.moveRight=!0;break;case 82:this.moveUp=!0;break;case 70:this.moveDown=!0;break;case 81:this.freeze=!this.freeze}},this.onKeyUp=function(e){switch(e.keyCode){case 38:case 87:this.moveForward=!1;break;case 37:case 65:this.moveLeft=!1;break;case 40:case 83:this.moveBackward=!1;break;case 39:case 68:this.moveRight=!1;break;case 82:this.moveUp=!1;break;case 70:this.moveDown=!1}},this.update=function(e){var r=0;if(!this.freeze){this.heightSpeed?(r=t.Math.clamp(this.object.position.y,this.heightMin,this.heightMax)-this.heightMin,this.autoSpeedFactor=e*r*this.heightCoef):this.autoSpeedFactor=0,r=e*this.movementSpeed,(this.moveForward||this.autoForward&&!this.moveBackward)&&this.object.translateZ(-(r+this.autoSpeedFactor)),this.moveBackward&&this.object.translateZ(r),this.moveLeft&&this.object.translateX(-r),this.moveRight&&this.object.translateX(r),this.moveUp&&this.object.translateY(r),this.moveDown&&this.object.translateY(-r),e*=this.lookSpeed,this.activeLook||(e=0),this.lon+=this.mouseX*e,this.lookVertical&&(this.lat-=this.mouseY*e),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=(90-this.lat)*Math.PI/180,this.theta=this.lon*Math.PI/180;var r=this.target,i=this.object.position;r.x=i.x+100*Math.sin(this.phi)*Math.cos(this.theta),r.y=i.y+100*Math.cos(this.phi),r.z=i.z+100*Math.sin(this.phi)*Math.sin(this.theta),r=1,this.constrainVertical&&(r=Math.PI/(this.verticalMax-this.verticalMin)),this.lon+=this.mouseX*e,this.lookVertical&&(this.lat-=this.mouseY*e*r),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=(90-this.lat)*Math.PI/180,this.theta=this.lon*Math.PI/180,this.constrainVertical&&(this.phi=t.Math.mapLinear(this.phi,0,Math.PI,this.verticalMin,this.verticalMax)),r=this.target,i=this.object.position,r.x=i.x+100*Math.sin(this.phi)*Math.cos(this.theta),r.y=i.y+100*Math.cos(this.phi),r.z=i.z+100*Math.sin(this.phi)*Math.sin(this.theta),this.object.lookAt(r)}},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousemove",i(this,this.onMouseMove),!1),this.domElement.addEventListener("mousedown",i(this,this.onMouseDown),!1),this.domElement.addEventListener("mouseup",i(this,this.onMouseUp),!1),this.domElement.addEventListener("keydown",i(this,this.onKeyDown),!1),this.domElement.addEventListener("keyup",i(this,this.onKeyUp),!1)},t.PathControls=function(e,r){function i(e){return 1>(e*=2)?.5*e*e:-.5*(--e*(e-2)-1)}function n(e,t){return function(){t.apply(e,arguments)}}function o(e,r,i,n){var o,a={name:i,fps:.6,length:n,hierarchy:[]},s=r.getControlPointsArray(),l=r.getLength(),c=s.length,h=0;for(o=c-1,r={parent:-1,keys:[]},r.keys[0]={time:0,pos:s[0],rot:[0,0,0,1],scl:[1,1,1]},r.keys[o]={time:n,pos:s[o],rot:[0,0,0,1],scl:[1,1,1]},o=1;c-1>o;o++)h=n*l.chunks[o]/l.total,r.keys[o]={time:h,pos:s[o]};return a.hierarchy[0]=r,t.AnimationHandler.add(a),new t.Animation(e,i,t.AnimationHandler.CATMULLROM_FORWARD,!1)}function a(e,r){var i,n,o=new t.Geometry;for(i=0;i<e.points.length*r;i++)n=i/(e.points.length*r),n=e.getPoint(n),o.vertices[i]=new t.Vertex(new t.Vector3(n.x,n.y,n.z));return o}this.object=e,this.domElement=void 0!==r?r:document,this.id="PathControls"+t.PathControlsIdCounter++,this.duration=1e4,this.waypoints=[],this.useConstantSpeed=!0,this.resamplingCoef=50,this.debugPath=new t.Object3D,this.debugDummy=new t.Object3D,this.animationParent=new t.Object3D,this.lookSpeed=.005,this.lookHorizontal=this.lookVertical=!0,this.verticalAngleMap={srcRange:[0,2*Math.PI],dstRange:[0,2*Math.PI]},this.horizontalAngleMap={srcRange:[0,2*Math.PI],dstRange:[0,2*Math.PI]},this.target=new t.Object3D,this.theta=this.phi=this.lon=this.lat=this.mouseY=this.mouseX=0,this.domElement===document?(this.viewHalfX=window.innerWidth/2,this.viewHalfY=window.innerHeight/2):(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2,this.domElement.setAttribute("tabindex",-1));var s=2*Math.PI,l=Math.PI/180;this.update=function(e){var r;this.lookHorizontal&&(this.lon+=this.mouseX*this.lookSpeed*e),this.lookVertical&&(this.lat-=this.mouseY*this.lookSpeed*e),this.lon=Math.max(0,Math.min(360,this.lon)),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=(90-this.lat)*l,this.theta=this.lon*l,e=this.phi%s,this.phi=e>=0?e:e+s,r=this.verticalAngleMap.srcRange,e=this.verticalAngleMap.dstRange,r=t.Math.mapLinear(this.phi,r[0],r[1],e[0],e[1]);var n=e[1]-e[0];this.phi=i((r-e[0])/n)*n+e[0],r=this.horizontalAngleMap.srcRange,e=this.horizontalAngleMap.dstRange,r=t.Math.mapLinear(this.theta,r[0],r[1],e[0],e[1]),n=e[1]-e[0],this.theta=i((r-e[0])/n)*n+e[0],e=this.target.position,e.x=100*Math.sin(this.phi)*Math.cos(this.theta),e.y=100*Math.cos(this.phi),e.z=100*Math.sin(this.phi)*Math.sin(this.theta),this.object.lookAt(this.target.position)},this.onMouseMove=function(e){this.domElement===document?(this.mouseX=e.pageX-this.viewHalfX,this.mouseY=e.pageY-this.viewHalfY):(this.mouseX=e.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=e.pageY-this.domElement.offsetTop-this.viewHalfY)},this.init=function(){if(this.spline=new t.Spline,this.spline.initFromArray(this.waypoints),this.useConstantSpeed&&this.spline.reparametrizeByArcLength(this.resamplingCoef),this.createDebugDummy){var e=new t.MeshLambertMaterial({color:30719}),r=new t.MeshLambertMaterial({color:65280}),i=new t.CubeGeometry(10,10,20),s=new t.CubeGeometry(2,2,10);this.animationParent=new t.Mesh(i,e),e=new t.Mesh(s,r),e.position.set(0,10,0),this.animation=o(this.animationParent,this.spline,this.id,this.duration),this.animationParent.add(this.object),this.animationParent.add(this.target),this.animationParent.add(e)}else this.animation=o(this.animationParent,this.spline,this.id,this.duration),this.animationParent.add(this.target),this.animationParent.add(this.object);if(this.createDebugPath){var e=this.debugPath,r=this.spline,s=a(r,10),i=a(r,10),l=new t.LineBasicMaterial({color:16711680,linewidth:3}),s=new t.Line(s,l),i=new t.ParticleSystem(i,new t.ParticleBasicMaterial({color:16755200,size:3}));s.scale.set(1,1,1),e.add(s),i.scale.set(1,1,1),e.add(i);for(var s=new t.SphereGeometry(1,16,8),l=new t.MeshBasicMaterial({color:65280}),c=0;c<r.points.length;c++)i=new t.Mesh(s,l),i.position.copy(r.points[c]),e.add(i)}this.domElement.addEventListener("mousemove",n(this,this.onMouseMove),!1)}},t.PathControlsIdCounter=0,t.FlyControls=function(e,r){function i(e,t){return function(){t.apply(e,arguments)}}this.object=e,this.domElement=void 0!==r?r:document,r&&this.domElement.setAttribute("tabindex",-1),this.movementSpeed=1,this.rollSpeed=.005,this.autoForward=this.dragToLook=!1,this.object.useQuaternion=!0,this.tmpQuaternion=new t.Quaternion,this.mouseStatus=0,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.moveVector=new t.Vector3(0,0,0),this.rotationVector=new t.Vector3(0,0,0),this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)},this.keydown=function(e){if(!e.altKey){switch(e.keyCode){case 16:this.movementSpeedMultiplier=.1;break;case 87:this.moveState.forward=1;break;case 83:this.moveState.back=1;break;case 65:this.moveState.left=1;break;case 68:this.moveState.right=1;break;case 82:this.moveState.up=1;break;case 70:this.moveState.down=1;break;case 38:this.moveState.pitchUp=1;break;case 40:this.moveState.pitchDown=1;break;case 37:this.moveState.yawLeft=1;break;case 39:this.moveState.yawRight=1;break;case 81:this.moveState.rollLeft=1;break;case 69:this.moveState.rollRight=1}this.updateMovementVector(),this.updateRotationVector()}},this.keyup=function(e){switch(e.keyCode){case 16:this.movementSpeedMultiplier=1;break;case 87:this.moveState.forward=0;break;case 83:this.moveState.back=0;break;case 65:this.moveState.left=0;break;case 68:this.moveState.right=0;break;case 82:this.moveState.up=0;break;case 70:this.moveState.down=0;break;case 38:this.moveState.pitchUp=0;break;case 40:this.moveState.pitchDown=0;break;case 37:this.moveState.yawLeft=0;break;case 39:this.moveState.yawRight=0;break;case 81:this.moveState.rollLeft=0;break;case 69:this.moveState.rollRight=0}this.updateMovementVector(),this.updateRotationVector()},this.mousedown=function(e){if(this.domElement!==document&&this.domElement.focus(),e.preventDefault(),e.stopPropagation(),this.dragToLook)this.mouseStatus++;else switch(e.button){case 0:this.object.moveForward=!0;break;case 2:this.object.moveBackward=!0}},this.mousemove=function(e){if(!this.dragToLook||0<this.mouseStatus){var t=this.getContainerDimensions(),r=t.size[0]/2,i=t.size[1]/2;this.moveState.yawLeft=-(e.pageX-t.offset[0]-r)/r,this.moveState.pitchDown=(e.pageY-t.offset[1]-i)/i,this.updateRotationVector()}},this.mouseup=function(e){if(e.preventDefault(),e.stopPropagation(),this.dragToLook)this.mouseStatus--,this.moveState.yawLeft=this.moveState.pitchDown=0;else switch(e.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1}this.updateRotationVector()},this.update=function(e){var t=e*this.movementSpeed,e=e*this.rollSpeed;this.object.translateX(this.moveVector.x*t),this.object.translateY(this.moveVector.y*t),this.object.translateZ(this.moveVector.z*t),this.tmpQuaternion.set(this.rotationVector.x*e,this.rotationVector.y*e,this.rotationVector.z*e,1).normalize(),this.object.quaternion.multiplySelf(this.tmpQuaternion),this.object.matrix.setPosition(this.object.position),this.object.matrix.setRotationFromQuaternion(this.object.quaternion),this.object.matrixWorldNeedsUpdate=!0},this.updateMovementVector=function(){var e=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-e+this.moveState.back},this.updateRotationVector=function(){this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft},this.getContainerDimensions=function(){return this.domElement!=document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}},this.domElement.addEventListener("mousemove",i(this,this.mousemove),!1),this.domElement.addEventListener("mousedown",i(this,this.mousedown),!1),this.domElement.addEventListener("mouseup",i(this,this.mouseup),!1),this.domElement.addEventListener("keydown",i(this,this.keydown),!1),this.domElement.addEventListener("keyup",i(this,this.keyup),!1),this.updateMovementVector(),this.updateRotationVector()},t.RollControls=function(e,r){this.object=e,this.domElement=void 0!==r?r:document,this.mouseLook=!0,this.autoForward=!1,this.rollSpeed=this.movementSpeed=this.lookSpeed=1,this.constrainVertical=[-.9,.9],this.object.matrixAutoUpdate=!1,this.forward=new t.Vector3(0,0,1),this.roll=0;var i=new t.Vector3,n=new t.Vector3,o=new t.Vector3,a=new t.Matrix4,s=!1,l=1,c=0,h=0,p=0,d=0,u=0,f=window.innerWidth/2,m=window.innerHeight/2;this.update=function(e){if(this.mouseLook){var t=e*this.lookSpeed;this.rotateHorizontally(t*d),this.rotateVertically(t*u)}t=e*this.movementSpeed,this.object.translateZ(-t*(c>0||this.autoForward&&!(0>c)?1:c)),this.object.translateX(t*h),this.object.translateY(t*p),s&&(this.roll+=this.rollSpeed*e*l),this.forward.y>this.constrainVertical[1]?(this.forward.y=this.constrainVertical[1],this.forward.normalize()):this.forward.y<this.constrainVertical[0]&&(this.forward.y=this.constrainVertical[0],this.forward.normalize()),o.copy(this.forward),n.set(0,1,0),i.cross(n,o).normalize(),n.cross(o,i).normalize(),this.object.matrix.n11=i.x,this.object.matrix.n12=n.x,this.object.matrix.n13=o.x,this.object.matrix.n21=i.y,this.object.matrix.n22=n.y,this.object.matrix.n23=o.y,this.object.matrix.n31=i.z,this.object.matrix.n32=n.z,this.object.matrix.n33=o.z,a.identity(),a.n11=Math.cos(this.roll),a.n12=-Math.sin(this.roll),a.n21=Math.sin(this.roll),a.n22=Math.cos(this.roll),this.object.matrix.multiplySelf(a),this.object.matrixWorldNeedsUpdate=!0,this.object.matrix.n14=this.object.position.x,this.object.matrix.n24=this.object.position.y,this.object.matrix.n34=this.object.position.z},this.translateX=function(e){this.object.position.x+=this.object.matrix.n11*e,this.object.position.y+=this.object.matrix.n21*e,this.object.position.z+=this.object.matrix.n31*e},this.translateY=function(e){this.object.position.x+=this.object.matrix.n12*e,this.object.position.y+=this.object.matrix.n22*e,this.object.position.z+=this.object.matrix.n32*e},this.translateZ=function(e){this.object.position.x-=this.object.matrix.n13*e,this.object.position.y-=this.object.matrix.n23*e,this.object.position.z-=this.object.matrix.n33*e},this.rotateHorizontally=function(e){i.set(this.object.matrix.n11,this.object.matrix.n21,this.object.matrix.n31),i.multiplyScalar(e),this.forward.subSelf(i),this.forward.normalize()},this.rotateVertically=function(e){n.set(this.object.matrix.n12,this.object.matrix.n22,this.object.matrix.n32),n.multiplyScalar(e),this.forward.addSelf(n),this.forward.normalize()},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousemove",function(e){d=(e.clientX-f)/window.innerWidth,u=(e.clientY-m)/window.innerHeight},!1),this.domElement.addEventListener("mousedown",function(e){switch(e.preventDefault(),e.stopPropagation(),e.button){case 0:c=1;break;case 2:c=-1}},!1),this.domElement.addEventListener("mouseup",function(e){switch(e.preventDefault(),e.stopPropagation(),e.button){case 0:c=0;break;case 2:c=0}},!1),this.domElement.addEventListener("keydown",function(e){switch(e.keyCode){case 38:case 87:c=1;break;case 37:case 65:h=-1;break;case 40:case 83:c=-1;break;case 39:case 68:h=1;break;case 81:s=!0,l=1;break;case 69:s=!0,l=-1;break;case 82:p=1;break;case 70:p=-1}},!1),this.domElement.addEventListener("keyup",function(e){switch(e.keyCode){case 38:case 87:c=0;break;case 37:case 65:h=0;break;case 40:case 83:c=0;break;case 39:case 68:h=0;break;case 81:s=!1;break;case 69:s=!1;break;case 82:p=0;break;case 70:p=0}},!1)},t.TrackballControls=function(e,r){t.EventTarget.call(this);var i=this;this.object=e,this.domElement=void 0!==r?r:document,this.enabled=!0,this.screen={width:window.innerWidth,height:window.innerHeight,offsetLeft:0,offsetTop:0},this.radius=(this.screen.width+this.screen.height)/4,this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.staticMoving=this.noPan=this.noZoom=this.noRotate=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.target=new t.Vector3;var n=new t.Vector3,o=!1,a=-1,s=new t.Vector3,l=new t.Vector3,c=new t.Vector3,h=new t.Vector2,p=new t.Vector2,d=new t.Vector2,u=new t.Vector2,f={type:"change"};this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)},this.getMouseOnScreen=function(e,r){return new t.Vector2(.5*((e-i.screen.offsetLeft)/i.radius),.5*((r-i.screen.offsetTop)/i.radius))},this.getMouseProjectionOnBall=function(e,r){var n=new t.Vector3((e-.5*i.screen.width-i.screen.offsetLeft)/i.radius,(.5*i.screen.height+i.screen.offsetTop-r)/i.radius,0),o=n.length();return o>1?n.normalize():n.z=Math.sqrt(1-o*o),s.copy(i.object.position).subSelf(i.target),o=i.object.up.clone().setLength(n.y),o.addSelf(i.object.up.clone().crossSelf(s).setLength(n.x)),o.addSelf(s.setLength(n.z)),o},this.rotateCamera=function(){var e=Math.acos(l.dot(c)/l.length()/c.length());if(e){var r=(new t.Vector3).cross(l,c).normalize(),n=new t.Quaternion,e=e*i.rotateSpeed;n.setFromAxisAngle(r,-e),n.multiplyVector3(s),n.multiplyVector3(i.object.up),n.multiplyVector3(c),i.staticMoving?l=c:(n.setFromAxisAngle(r,e*(i.dynamicDampingFactor-1)),n.multiplyVector3(l))}},this.zoomCamera=function(){var e=1+(p.y-h.y)*i.zoomSpeed;1!==e&&e>0&&(s.multiplyScalar(e),i.staticMoving?h=p:h.y+=(p.y-h.y)*this.dynamicDampingFactor)},this.panCamera=function(){var e=u.clone().subSelf(d);if(e.lengthSq()){e.multiplyScalar(s.length()*i.panSpeed);var t=s.clone().crossSelf(i.object.up).setLength(e.x);t.addSelf(i.object.up.clone().setLength(e.y)),i.object.position.addSelf(t),i.target.addSelf(t),i.staticMoving?d=u:d.addSelf(e.sub(u,d).multiplyScalar(i.dynamicDampingFactor))}},this.checkDistances=function(){i.noZoom&&i.noPan||(i.object.position.lengthSq()>i.maxDistance*i.maxDistance&&i.object.position.setLength(i.maxDistance),s.lengthSq()<i.minDistance*i.minDistance&&i.object.position.add(i.target,s.setLength(i.minDistance)))},this.update=function(){s.copy(i.object.position).subSelf(i.target),i.noRotate||i.rotateCamera(),i.noZoom||i.zoomCamera(),i.noPan||i.panCamera(),i.object.position.add(i.target,s),i.checkDistances(),i.object.lookAt(i.target),0<n.distanceTo(i.object.position)&&(i.dispatchEvent(f),n.copy(i.object.position))},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousemove",function(e){i.enabled&&(o&&(l=c=i.getMouseProjectionOnBall(e.clientX,e.clientY),h=p=i.getMouseOnScreen(e.clientX,e.clientY),d=u=i.getMouseOnScreen(e.clientX,e.clientY),o=!1),-1!==a&&(0!==a||i.noRotate?1!==a||i.noZoom?2===a&&!i.noPan&&(u=i.getMouseOnScreen(e.clientX,e.clientY)):p=i.getMouseOnScreen(e.clientX,e.clientY):c=i.getMouseProjectionOnBall(e.clientX,e.clientY)))},!1),this.domElement.addEventListener("mousedown",function(e){i.enabled&&(e.preventDefault(),e.stopPropagation(),-1===a)&&(a=e.button,0!==a||i.noRotate?1!==a||i.noZoom?this.noPan||(d=u=i.getMouseOnScreen(e.clientX,e.clientY)):h=p=i.getMouseOnScreen(e.clientX,e.clientY):l=c=i.getMouseProjectionOnBall(e.clientX,e.clientY))},!1),this.domElement.addEventListener("mouseup",function(e){i.enabled&&(e.preventDefault(),e.stopPropagation(),a=-1)},!1),window.addEventListener("keydown",function(e){i.enabled&&-1===a&&(e.keyCode!==i.keys[0]||i.noRotate?e.keyCode!==i.keys[1]||i.noZoom?e.keyCode===i.keys[2]&&!i.noPan&&(a=2):a=1:a=0,-1!==a&&(o=!0))},!1),window.addEventListener("keyup",function(){i.enabled&&-1!==a&&(a=-1)},!1)},t.CubeGeometry=function(e,r,i,n,o,a,s,l){function c(e,r,i,s,l,c,h,p){var d,u=n||1,f=o||1,m=l/2,b=c/2,v=g.vertices.length;"x"===e&&"y"===r||"y"===e&&"x"===r?d="z":"x"===e&&"z"===r||"z"===e&&"x"===r?(d="y",f=a||1):("z"===e&&"y"===r||"y"===e&&"z"===r)&&(d="x",u=a||1);var x=u+1,y=f+1,w=l/u,_=c/f,M=new t.Vector3;for(M[d]=h>0?1:-1,l=0;y>l;l++)for(c=0;x>c;c++){var S=new t.Vector3;S[e]=(c*w-m)*i,S[r]=(l*_-b)*s,S[d]=h,g.vertices.push(new t.Vertex(S))}for(l=0;f>l;l++)for(c=0;u>c;c++)e=new t.Face4(c+x*l+v,c+x*(l+1)+v,c+1+x*(l+1)+v,c+1+x*l+v),e.normal.copy(M),e.vertexNormals.push(M.clone(),M.clone(),M.clone(),M.clone()),e.materialIndex=p,g.faces.push(e),g.faceVertexUvs[0].push([new t.UV(c/u,l/f),new t.UV(c/u,(l+1)/f),new t.UV((c+1)/u,(l+1)/f),new t.UV((c+1)/u,l/f)])}t.Geometry.call(this);var h,p,d,u,f,m,g=this,b=e/2,v=r/2,x=i/2;if(void 0!==s){if(s instanceof Array)this.materials=s;else for(this.materials=[],h=0;6>h;h++)this.materials.push(s);h=0,u=1,p=2,f=3,d=4,m=5}else this.materials=[];if(this.sides={px:!0,nx:!0,py:!0,ny:!0,pz:!0,nz:!0},void 0!=l)for(var y in l)void 0!==this.sides[y]&&(this.sides[y]=l[y]);this.sides.px&&c("z","y",-1,-1,i,r,b,h),this.sides.nx&&c("z","y",1,-1,i,r,-b,u),this.sides.py&&c("x","z",1,1,e,i,v,p),this.sides.ny&&c("x","z",1,-1,e,i,-v,f),this.sides.pz&&c("x","y",1,-1,e,r,x,d),this.sides.nz&&c("x","y",-1,-1,e,r,-x,m),this.computeCentroids(),this.mergeVertices()},t.CubeGeometry.prototype=new t.Geometry,t.CubeGeometry.prototype.constructor=t.CubeGeometry,t.CylinderGeometry=function(e,r,i,n,o,a){t.Geometry.call(this);var s,l,e=void 0!==e?e:20,r=void 0!==r?r:20,i=void 0!==i?i:100,c=i/2,n=n||8,o=o||1,h=[],p=[];for(l=0;o>=l;l++){var d=[],u=[],f=l/o,m=f*(r-e)+e;for(s=0;n>=s;s++){var g=s/n,b=m*Math.sin(2*g*Math.PI),v=-f*i+c,x=m*Math.cos(2*g*Math.PI);this.vertices.push(new t.Vertex(new t.Vector3(b,v,x))),d.push(this.vertices.length-1),u.push(new t.UV(g,f))}h.push(d),p.push(u)}for(l=0;o>l;l++)for(s=0;n>s;s++){var i=h[l][s],d=h[l+1][s],u=h[l+1][s+1],f=h[l][s+1],m=this.vertices[i].position.clone().setY(0).normalize(),g=this.vertices[d].position.clone().setY(0).normalize(),b=this.vertices[u].position.clone().setY(0).normalize(),v=this.vertices[f].position.clone().setY(0).normalize(),x=p[l][s].clone(),y=p[l+1][s].clone(),w=p[l+1][s+1].clone(),_=p[l][s+1].clone();this.faces.push(new t.Face4(i,d,u,f,[m,g,b,v])),this.faceVertexUvs[0].push([x,y,w,_])}if(!a&&e>0)for(this.vertices.push(new t.Vertex(new t.Vector3(0,c,0))),s=0;n>s;s++)i=h[0][s],d=h[0][s+1],u=this.vertices.length-1,m=new t.Vector3(0,1,0),g=new t.Vector3(0,1,0),b=new t.Vector3(0,1,0),x=p[0][s].clone(),y=p[0][s+1].clone(),w=new t.UV(y.u,0),this.faces.push(new t.Face3(i,d,u,[m,g,b])),this.faceVertexUvs[0].push([x,y,w]);if(!a&&r>0)for(this.vertices.push(new t.Vertex(new t.Vector3(0,-c,0))),s=0;n>s;s++)i=h[l][s+1],d=h[l][s],u=this.vertices.length-1,m=new t.Vector3(0,-1,0),g=new t.Vector3(0,-1,0),b=new t.Vector3(0,-1,0),x=p[l][s+1].clone(),y=p[l][s].clone(),w=new t.UV(y.u,1),this.faces.push(new t.Face3(i,d,u,[m,g,b])),this.faceVertexUvs[0].push([x,y,w]);this.computeCentroids(),this.computeFaceNormals()},t.CylinderGeometry.prototype=new t.Geometry,t.CylinderGeometry.prototype.constructor=t.CylinderGeometry,t.ExtrudeGeometry=function(e,r){if("undefined"!=typeof e){t.Geometry.call(this);var i,n,e=e instanceof Array?e:[e],o=e.length;for(this.shapebb=e[o-1].getBoundingBox(),n=0;o>n;n++)i=e[n],this.addShape(i,r);this.computeCentroids(),this.computeFaceNormals()}},t.ExtrudeGeometry.prototype=new t.Geometry,t.ExtrudeGeometry.prototype.constructor=t.ExtrudeGeometry,t.ExtrudeGeometry.prototype.addShape=function(e,r){function i(e,t,r){return t||console.log("die"),t.clone().multiplyScalar(r).addSelf(e)}function n(e,r,i){var n=t.ExtrudeGeometry.__v1,o=t.ExtrudeGeometry.__v2,a=t.ExtrudeGeometry.__v3,s=t.ExtrudeGeometry.__v4,l=t.ExtrudeGeometry.__v5,c=t.ExtrudeGeometry.__v6;return n.set(e.x-r.x,e.y-r.y),o.set(e.x-i.x,e.y-i.y),n=n.normalize(),o=o.normalize(),a.set(-n.y,n.x),s.set(o.y,-o.x),l.copy(e).addSelf(a),c.copy(e).addSelf(s),l.equals(c)?s.clone():(l.copy(r).addSelf(a),c.copy(i).addSelf(s),a=n.dot(s),s=c.subSelf(l).dot(s),0===a&&(console.log("Either infinite or no solutions!"),0===s?console.log("Its finite solutions."):console.log("Too bad, no solutions.")),s/=a,0>s?(r=Math.atan2(r.y-e.y,r.x-e.x),e=Math.atan2(i.y-e.y,i.x-e.x),r>e&&(e+=2*Math.PI),i=(r+e)/2,e=-Math.cos(i),i=-Math.sin(i),new t.Vector2(e,i)):n.multiplyScalar(s).addSelf(l).subSelf(e).clone())}function o(e){for(P=e.length;0<=--P;){F=P,V=P-1,0>V&&(V=e.length-1);for(var r=0,i=m+2*d,r=0;i>r;r++){var n=R*r,o=R*(r+1),a=I+F+n,s=I+V+n,l=I+V+o,c=I+F+o,a=a+T,s=s+T,l=l+T,c=c+T;k.faces.push(new t.Face4(a,s,l,c,null,null,w));var o=k.vertices[a].position.x,n=k.vertices[a].position.y,a=k.vertices[a].position.z,h=k.vertices[s].position.x,p=k.vertices[s].position.y,s=k.vertices[s].position.z,u=k.vertices[l].position.x,f=k.vertices[l].position.y,l=k.vertices[l].position.z,g=k.vertices[c].position.x,b=k.vertices[c].position.y,c=k.vertices[c].position.z;.01>Math.abs(n-p)?k.faceVertexUvs[0].push([new t.UV(o,a),new t.UV(h,s),new t.UV(u,l),new t.UV(g,c)]):k.faceVertexUvs[0].push([new t.UV(n,a),new t.UV(p,s),new t.UV(f,l),new t.UV(b,c)])}}}function a(e,r,i){k.vertices.push(new t.Vertex(new t.Vector3(e,r,i)))}function s(e,r,i){e+=T,r+=T,i+=T,k.faces.push(new t.Face3(e,r,i,null,null,y));var n=k.vertices[r].position.x,r=k.vertices[r].position.y,o=k.vertices[i].position.x,i=k.vertices[i].position.y;k.faceVertexUvs[0].push([new t.UV(k.vertices[e].position.x,1-k.vertices[e].position.y),new t.UV(n,1-r),new t.UV(o,1-i)])}var l,c=void 0!==r.amount?r.amount:100,h=void 0!==r.bevelThickness?r.bevelThickness:6,p=void 0!==r.bevelSize?r.bevelSize:h-2,d=void 0!==r.bevelSegments?r.bevelSegments:3,u=void 0!==r.bevelEnabled?r.bevelEnabled:!0,f=void 0!==r.curveSegments?r.curveSegments:12,m=void 0!==r.steps?r.steps:1,g=r.bendPath,b=r.extrudePath,v=!1,x=void 0!==r.useSpacedPoints?r.useSpacedPoints:!1,y=r.material,w=r.extrudeMaterial;b&&(l=b.getPoints(f),m=l.length,v=!0,u=!1),u||(p=h=d=0);var _,M,S,k=this,T=this.vertices.length;if(g&&e.addWrapPath(g),f=x?e.extractAllSpacedPoints(f):e.extractAllPoints(f),g=f.shape,f=f.holes,b=!t.Shape.Utils.isClockWise(g)){for(g=g.reverse(),M=0,S=f.length;S>M;M++)_=f[M],t.Shape.Utils.isClockWise(_)&&(f[M]=_.reverse());b=!1}for(b=t.Shape.Utils.triangulateShape(g,f),x=g,M=0,S=f.length;S>M;M++)_=f[M],g=g.concat(_);for(var C,A,E,L,R=g.length,z=b.length,N=[],P=0,D=x.length,F=D-1,V=P+1;D>P;P++,F++,V++)F===D&&(F=0),V===D&&(V=0),N[P]=n(x[P],x[F],x[V]);var B,U=[],O=N.concat();for(M=0,S=f.length;S>M;M++){for(_=f[M],B=[],P=0,D=_.length,F=D-1,V=P+1;D>P;P++,F++,V++)F===D&&(F=0),V===D&&(V=0),B[P]=n(_[P],_[F],_[V]);U.push(B),O=O.concat(B)}for(C=0;d>C;C++){for(A=C/d,E=h*(1-A),A=p*Math.sin(A*Math.PI/2),P=0,D=x.length;D>P;P++)L=i(x[P],N[P],A),a(L.x,L.y,-E);for(M=0,S=f.length;S>M;M++)for(_=f[M],B=U[M],P=0,D=_.length;D>P;P++)L=i(_[P],B[P],A),a(L.x,L.y,-E)}for(A=p,P=0;R>P;P++)L=u?i(g[P],O[P],A):g[P],v?a(L.x,L.y+l[0].y,l[0].x):a(L.x,L.y,0);for(C=1;m>=C;C++)for(P=0;R>P;P++)L=u?i(g[P],O[P],A):g[P],v?a(L.x,L.y+l[C-1].y,l[C-1].x):a(L.x,L.y,c/m*C);for(C=d-1;C>=0;C--){for(A=C/d,E=h*(1-A),A=p*Math.sin(A*Math.PI/2),P=0,D=x.length;D>P;P++)L=i(x[P],N[P],A),a(L.x,L.y,c+E);for(M=0,S=f.length;S>M;M++)for(_=f[M],B=U[M],P=0,D=_.length;D>P;P++)L=i(_[P],B[P],A),v?a(L.x,L.y+l[m-1].y,l[m-1].x+E):a(L.x,L.y,c+E)}if(u){for(h=0*R,P=0;z>P;P++)c=b[P],s(c[2]+h,c[1]+h,c[0]+h);for(h=R*(m+2*d),P=0;z>P;P++)c=b[P],s(c[0]+h,c[1]+h,c[2]+h)}else{for(P=0;z>P;P++)c=b[P],s(c[2],c[1],c[0]);for(P=0;z>P;P++)c=b[P],s(c[0]+R*m,c[1]+R*m,c[2]+R*m)}var I=0;for(o(x),I+=x.length,M=0,S=f.length;S>M;M++)_=f[M],o(_),I+=_.length},t.ExtrudeGeometry.__v1=new t.Vector2,t.ExtrudeGeometry.__v2=new t.Vector2,t.ExtrudeGeometry.__v3=new t.Vector2,t.ExtrudeGeometry.__v4=new t.Vector2,t.ExtrudeGeometry.__v5=new t.Vector2,t.ExtrudeGeometry.__v6=new t.Vector2,t.LatheGeometry=function(e,r,i){t.Geometry.call(this),this.steps=r||12,this.angle=i||2*Math.PI;for(var r=this.angle/this.steps,i=[],n=[],o=[],a=[],s=(new t.Matrix4).setRotationZ(r),l=0;l<e.length;l++)this.vertices.push(new t.Vertex(e[l])),i[l]=e[l].clone(),n[l]=this.vertices.length-1;for(var c=0;c<=this.angle+.001;c+=r){for(l=0;l<i.length;l++)c<this.angle?(i[l]=s.multiplyVector3(i[l].clone()),this.vertices.push(new t.Vertex(i[l])),o[l]=this.vertices.length-1):o=a;for(0==c&&(a=n),l=0;l<n.length-1;l++)this.faces.push(new t.Face4(o[l],o[l+1],n[l+1],n[l])),this.faceVertexUvs[0].push([new t.UV(1-c/this.angle,l/e.length),new t.UV(1-c/this.angle,(l+1)/e.length),new t.UV(1-(c-r)/this.angle,(l+1)/e.length),new t.UV(1-(c-r)/this.angle,l/e.length)]);n=o,o=[]}this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},t.LatheGeometry.prototype=new t.Geometry,t.LatheGeometry.prototype.constructor=t.LatheGeometry,t.PlaneGeometry=function(e,r,i,n){t.Geometry.call(this);for(var o=e/2,a=r/2,i=i||1,n=n||1,s=i+1,l=n+1,c=e/i,h=r/n,p=new t.Vector3(0,0,1),e=0;l>e;e++)for(r=0;s>r;r++)this.vertices.push(new t.Vertex(new t.Vector3(r*c-o,-(e*h-a),0)));for(e=0;n>e;e++)for(r=0;i>r;r++)o=new t.Face4(r+s*e,r+s*(e+1),r+1+s*(e+1),r+1+s*e),o.normal.copy(p),o.vertexNormals.push(p.clone(),p.clone(),p.clone(),p.clone()),this.faces.push(o),this.faceVertexUvs[0].push([new t.UV(r/i,e/n),new t.UV(r/i,(e+1)/n),new t.UV((r+1)/i,(e+1)/n),new t.UV((r+1)/i,e/n)]);this.computeCentroids()},t.PlaneGeometry.prototype=new t.Geometry,t.PlaneGeometry.prototype.constructor=t.PlaneGeometry,t.SphereGeometry=function(e,r,i,n,o,a,s){t.Geometry.call(this);var l,c,e=e||50,n=void 0!==n?n:0,o=void 0!==o?o:2*Math.PI,a=void 0!==a?a:0,s=void 0!==s?s:Math.PI,r=Math.max(3,Math.floor(r)||8),i=Math.max(2,Math.floor(i)||6),h=[],p=[];for(c=0;i>=c;c++){var d=[],u=[];for(l=0;r>=l;l++){var f=l/r,m=c/i,g=-e*Math.cos(n+f*o)*Math.sin(a+m*s),b=e*Math.cos(a+m*s),v=e*Math.sin(n+f*o)*Math.sin(a+m*s);
this.vertices.push(new t.Vertex(new t.Vector3(g,b,v))),d.push(this.vertices.length-1),u.push(new t.UV(f,m))}h.push(d),p.push(u)}for(c=0;i>c;c++)for(l=0;r>l;l++){var n=h[c][l+1],o=h[c][l],a=h[c+1][l],s=h[c+1][l+1],d=this.vertices[n].position.clone().normalize(),u=this.vertices[o].position.clone().normalize(),f=this.vertices[a].position.clone().normalize(),m=this.vertices[s].position.clone().normalize(),g=p[c][l+1].clone(),b=p[c][l].clone(),v=p[c+1][l].clone(),x=p[c+1][l+1].clone();Math.abs(this.vertices[n].position.y)==e?(this.faces.push(new t.Face3(n,a,s,[d,f,m])),this.faceVertexUvs[0].push([g,v,x])):Math.abs(this.vertices[a].position.y)==e?(this.faces.push(new t.Face3(n,o,a,[d,u,f])),this.faceVertexUvs[0].push([g,b,v])):(this.faces.push(new t.Face4(n,o,a,s,[d,u,f,m])),this.faceVertexUvs[0].push([g,b,v,x]))}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere={radius:e}},t.SphereGeometry.prototype=new t.Geometry,t.SphereGeometry.prototype.constructor=t.SphereGeometry,t.TextGeometry=function(e,r){var i=new t.TextPath(e,r).toShapes();if(r.amount=void 0!==r.height?r.height:50,void 0===r.bevelThickness&&(r.bevelThickness=10),void 0===r.bevelSize&&(r.bevelSize=8),void 0===r.bevelEnabled&&(r.bevelEnabled=!1),r.bend){var n=i[i.length-1].getBoundingBox().maxX;r.bendPath=new t.QuadraticBezierCurve(new t.Vector2(0,0),new t.Vector2(n/2,120),new t.Vector2(n,0))}t.ExtrudeGeometry.call(this,i,r)},t.TextGeometry.prototype=new t.ExtrudeGeometry,t.TextGeometry.prototype.constructor=t.TextGeometry,t.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(e){var t=e.familyName.toLowerCase();return this.faces[t]=this.faces[t]||{},this.faces[t][e.cssFontWeight]=this.faces[t][e.cssFontWeight]||{},this.faces[t][e.cssFontWeight][e.cssFontStyle]=e,this.faces[t][e.cssFontWeight][e.cssFontStyle]=e},drawText:function(e){for(var r=this.getFace(),i=this.size/r.resolution,n=0,o=(""+e).split(""),a=o.length,s=[],e=0;a>e;e++){var l=new t.Path,l=this.extractGlyphPoints(o[e],r,i,n,l),n=n+l.offset;s.push(l.path)}return{paths:s,offset:n/2}},extractGlyphPoints:function(e,r,i,n,o){var a,s,l,c,h,p,d,u,f,m,g,b=[],v=r.glyphs[e]||r.glyphs["?"];if(v){if(v.o)for(r=v._cachedOutline||(v._cachedOutline=v.o.split(" ")),c=r.length,e=0;c>e;)switch(l=r[e++]){case"m":l=r[e++]*i+n,h=r[e++]*i,b.push(new t.Vector2(l,h)),o.moveTo(l,h);break;case"l":l=r[e++]*i+n,h=r[e++]*i,b.push(new t.Vector2(l,h)),o.lineTo(l,h);break;case"q":if(l=r[e++]*i+n,h=r[e++]*i,u=r[e++]*i+n,f=r[e++]*i,o.quadraticCurveTo(u,f,l,h),a=b[b.length-1])for(p=a.x,d=a.y,a=1,s=this.divisions;s>=a;a++){var x=a/s,y=t.Shape.Utils.b2(x,p,u,l),x=t.Shape.Utils.b2(x,d,f,h);b.push(new t.Vector2(y,x))}break;case"b":if(l=r[e++]*i+n,h=r[e++]*i,u=r[e++]*i+n,f=r[e++]*-i,m=r[e++]*i+n,g=r[e++]*-i,o.bezierCurveTo(l,h,u,f,m,g),a=b[b.length-1])for(p=a.x,d=a.y,a=1,s=this.divisions;s>=a;a++)x=a/s,y=t.Shape.Utils.b3(x,p,u,m,l),x=t.Shape.Utils.b3(x,d,f,g,h),b.push(new t.Vector2(y,x))}return{offset:v.ha*i,points:b,path:o}}}},function(e){var t=function(e){for(var t=e.length,r=0,i=t-1,n=0;t>n;i=n++)r+=e[i].x*e[n].y-e[n].x*e[i].y;return.5*r};return e.Triangulate=function(e,r){var i=e.length;if(3>i)return null;var n,o,a,s=[],l=[],c=[];if(0<t(e))for(o=0;i>o;o++)l[o]=o;else for(o=0;i>o;o++)l[o]=i-1-o;var h=2*i;for(o=i-1;i>2;){if(0>=h--){console.log("Warning, unable to triangulate polygon!");break}n=o,n>=i&&(n=0),o=n+1,o>=i&&(o=0),a=o+1,a>=i&&(a=0);var p;e:{p=e;var d=n,u=o,f=a,m=i,g=l,b=void 0,v=void 0,x=void 0,y=void 0,w=void 0,_=void 0,M=void 0,S=void 0,k=void 0,v=p[g[d]].x,x=p[g[d]].y,y=p[g[u]].x,w=p[g[u]].y,_=p[g[f]].x,M=p[g[f]].y;if(1e-10>(y-v)*(M-x)-(w-x)*(_-v))p=!1;else{for(b=0;m>b;b++)if(b!=d&&b!=u&&b!=f){var S=p[g[b]].x,k=p[g[b]].y,T=void 0,C=void 0,A=void 0,E=void 0,L=void 0,R=void 0,z=void 0,N=void 0,P=void 0,D=void 0,F=void 0,V=void 0,T=A=L=void 0,T=_-y,C=M-w,A=v-_,E=x-M,L=y-v,R=w-x,z=S-v,N=k-x,P=S-y,D=k-w,F=S-_,V=k-M,T=T*D-C*P,L=L*N-R*z,A=A*V-E*F;if(T>=0&&A>=0&&L>=0){p=!1;break e}}p=!0}}if(p){for(s.push([e[l[n]],e[l[o]],e[l[a]]]),c.push([l[n],l[o],l[a]]),n=o,a=o+1;i>a;n++,a++)l[n]=l[a];i--,h=2*i}}return r?c:s},e.Triangulate.area=t,e}(t.FontUtils),self._typeface_js={faces:t.FontUtils.faces,loadFace:t.FontUtils.loadFace},t.TorusGeometry=function(e,r,i,n,o){for(t.Geometry.call(this),this.radius=e||100,this.tube=r||40,this.segmentsR=i||8,this.segmentsT=n||6,this.arc=o||2*Math.PI,o=new t.Vector3,e=[],r=[],i=0;i<=this.segmentsR;i++)for(n=0;n<=this.segmentsT;n++){var a=n/this.segmentsT*this.arc,s=2*i/this.segmentsR*Math.PI;o.x=this.radius*Math.cos(a),o.y=this.radius*Math.sin(a);var l=new t.Vector3;l.x=(this.radius+this.tube*Math.cos(s))*Math.cos(a),l.y=(this.radius+this.tube*Math.cos(s))*Math.sin(a),l.z=this.tube*Math.sin(s),this.vertices.push(new t.Vertex(l)),e.push(new t.UV(n/this.segmentsT,1-i/this.segmentsR)),r.push(l.clone().subSelf(o).normalize())}for(i=1;i<=this.segmentsR;i++)for(n=1;n<=this.segmentsT;n++){var o=(this.segmentsT+1)*i+n-1,a=(this.segmentsT+1)*(i-1)+n-1,s=(this.segmentsT+1)*(i-1)+n,l=(this.segmentsT+1)*i+n,c=new t.Face4(o,a,s,l,[r[o],r[a],r[s],r[l]]);c.normal.addSelf(r[o]),c.normal.addSelf(r[a]),c.normal.addSelf(r[s]),c.normal.addSelf(r[l]),c.normal.normalize(),this.faces.push(c),this.faceVertexUvs[0].push([e[o].clone(),e[a].clone(),e[s].clone(),e[l].clone()])}this.computeCentroids()},t.TorusGeometry.prototype=new t.Geometry,t.TorusGeometry.prototype.constructor=t.TorusGeometry,t.TorusKnotGeometry=function(e,r,i,n,o,a,s){function l(e,r,i,n,o,a){var s=Math.cos(e);return Math.cos(r),r=Math.sin(e),e*=i/n,i=Math.cos(e),s*=.5*o*(2+i),r=.5*o*(2+i)*r,o=.5*a*o*Math.sin(e),new t.Vector3(s,r,o)}for(t.Geometry.call(this),this.radius=e||200,this.tube=r||40,this.segmentsR=i||64,this.segmentsT=n||8,this.p=o||2,this.q=a||3,this.heightScale=s||1,this.grid=Array(this.segmentsR),i=new t.Vector3,n=new t.Vector3,o=new t.Vector3,e=0;e<this.segmentsR;++e)for(this.grid[e]=Array(this.segmentsT),r=0;r<this.segmentsT;++r){var c=2*(e/this.segmentsR)*this.p*Math.PI,s=2*(r/this.segmentsT)*Math.PI,a=l(c,s,this.q,this.p,this.radius,this.heightScale),c=l(c+.01,s,this.q,this.p,this.radius,this.heightScale);i.sub(c,a),n.add(c,a),o.cross(i,n),n.cross(o,i),o.normalize(),n.normalize(),c=-this.tube*Math.cos(s),s=this.tube*Math.sin(s),a.x+=c*n.x+s*o.x,a.y+=c*n.y+s*o.y,a.z+=c*n.z+s*o.z,this.grid[e][r]=this.vertices.push(new t.Vertex(new t.Vector3(a.x,a.y,a.z)))-1}for(e=0;e<this.segmentsR;++e)for(r=0;r<this.segmentsT;++r){var o=(e+1)%this.segmentsR,a=(r+1)%this.segmentsT,i=this.grid[e][r],n=this.grid[o][r],o=this.grid[o][a],a=this.grid[e][a],s=new t.UV(e/this.segmentsR,r/this.segmentsT),c=new t.UV((e+1)/this.segmentsR,r/this.segmentsT),h=new t.UV((e+1)/this.segmentsR,(r+1)/this.segmentsT),p=new t.UV(e/this.segmentsR,(r+1)/this.segmentsT);this.faces.push(new t.Face4(i,n,o,a)),this.faceVertexUvs[0].push([s,c,h,p])}this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},t.TorusKnotGeometry.prototype=new t.Geometry,t.TorusKnotGeometry.prototype.constructor=t.TorusKnotGeometry,t.PolyhedronGeometry=function(e,r,i,n){function o(e){var r=new t.Vertex(e.normalize());r.index=c.vertices.push(r)-1;var i=Math.atan2(e.z,-e.x)/2/Math.PI+.5,e=Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))/Math.PI+.5;return r.uv=new t.UV(i,e),r}function a(e,r,i,n){1>n?(n=new t.Face3(e.index,r.index,i.index,[e.position.clone(),r.position.clone(),i.position.clone()]),n.centroid.addSelf(e.position).addSelf(r.position).addSelf(i.position).divideScalar(3),n.normal=n.centroid.clone().normalize(),c.faces.push(n),n=Math.atan2(n.centroid.z,-n.centroid.x),c.faceVertexUvs[0].push([l(e.uv,e.position,n),l(r.uv,r.position,n),l(i.uv,i.position,n)])):(n-=1,a(e,s(e,r),s(e,i),n),a(s(e,r),r,s(r,i),n),a(s(e,i),s(r,i),i,n),a(s(e,r),s(r,i),s(e,i),n))}function s(e,r){d[e.index]||(d[e.index]=[]),d[r.index]||(d[r.index]=[]);var i=d[e.index][r.index];return void 0===i&&(d[e.index][r.index]=d[r.index][e.index]=i=o((new t.Vector3).add(e.position,r.position).divideScalar(2))),i}function l(e,r,i){return 0>i&&1===e.u&&(e=new t.UV(e.u-1,e.v)),0===r.x&&0===r.z&&(e=new t.UV(i/2/Math.PI+.5,e.v)),e}t.Geometry.call(this);for(var i=i||1,n=n||0,c=this,h=0,p=e.length;p>h;h++)o(new t.Vector3(e[h][0],e[h][1],e[h][2]));for(var d=[],e=this.vertices,h=0,p=r.length;p>h;h++)a(e[r[h][0]],e[r[h][1]],e[r[h][2]],n);for(this.mergeVertices(),h=0,p=this.vertices.length;p>h;h++)this.vertices[h].position.multiplyScalar(i);this.boundingSphere={radius:i}},t.PolyhedronGeometry.prototype=new t.Geometry,t.PolyhedronGeometry.prototype.constructor=t.PolyhedronGeometry,t.IcosahedronGeometry=function(e,r){var i=(1+Math.sqrt(5))/2;t.PolyhedronGeometry.call(this,[[-1,i,0],[1,i,0],[-1,-i,0],[1,-i,0],[0,-1,i],[0,1,i],[0,-1,-i],[0,1,-i],[i,0,-1],[i,0,1],[-i,0,-1],[-i,0,1]],[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]],e,r)},t.IcosahedronGeometry.prototype=new t.Geometry,t.IcosahedronGeometry.prototype.constructor=t.IcosahedronGeometry,t.OctahedronGeometry=function(e,r){t.PolyhedronGeometry.call(this,[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],[[0,2,4],[0,4,3],[0,3,5],[0,5,2],[1,2,5],[1,5,3],[1,3,4],[1,4,2]],e,r)},t.OctahedronGeometry.prototype=new t.Geometry,t.OctahedronGeometry.prototype.constructor=t.OctahedronGeometry,t.TetrahedronGeometry=function(e,r){t.PolyhedronGeometry.call(this,[[1,1,1],[-1,-1,1],[-1,1,-1],[1,-1,-1]],[[2,1,0],[0,3,2],[1,3,0],[2,3,1]],e,r)},t.TetrahedronGeometry.prototype=new t.Geometry,t.TetrahedronGeometry.prototype.constructor=t.TetrahedronGeometry,t.AxisHelper=function(){t.Object3D.call(this);var e=new t.Geometry;e.vertices.push(new t.Vertex),e.vertices.push(new t.Vertex(new t.Vector3(0,100,0)));var r,i=new t.CylinderGeometry(0,5,25,5,1);r=new t.Line(e,new t.LineBasicMaterial({color:16711680})),r.rotation.z=-Math.PI/2,this.add(r),r=new t.Mesh(i,new t.MeshBasicMaterial({color:16711680})),r.position.x=100,r.rotation.z=-Math.PI/2,this.add(r),r=new t.Line(e,new t.LineBasicMaterial({color:65280})),this.add(r),r=new t.Mesh(i,new t.MeshBasicMaterial({color:65280})),r.position.y=100,this.add(r),r=new t.Line(e,new t.LineBasicMaterial({color:255})),r.rotation.x=Math.PI/2,this.add(r),r=new t.Mesh(i,new t.MeshBasicMaterial({color:255})),r.position.z=100,r.rotation.x=Math.PI/2,this.add(r)},t.AxisHelper.prototype=new t.Object3D,t.AxisHelper.prototype.constructor=t.AxisHelper,t.CameraHelper=function(e){function r(e,t,r){i(e,r),i(t,r)}function i(e,r){n.lineGeometry.vertices.push(new t.Vertex(new t.Vector3)),n.lineGeometry.colors.push(new t.Color(r)),void 0===n.pointMap[e]&&(n.pointMap[e]=[]),n.pointMap[e].push(n.lineGeometry.vertices.length-1)}t.Object3D.call(this);var n=this;this.lineGeometry=new t.Geometry,this.lineMaterial=new t.LineBasicMaterial({color:16777215,vertexColors:t.FaceColors}),this.pointMap={},r("n1","n2",16755200),r("n2","n4",16755200),r("n4","n3",16755200),r("n3","n1",16755200),r("f1","f2",16755200),r("f2","f4",16755200),r("f4","f3",16755200),r("f3","f1",16755200),r("n1","f1",16755200),r("n2","f2",16755200),r("n3","f3",16755200),r("n4","f4",16755200),r("p","n1",16711680),r("p","n2",16711680),r("p","n3",16711680),r("p","n4",16711680),r("u1","u2",43775),r("u2","u3",43775),r("u3","u1",43775),r("c","t",16777215),r("p","c",3355443),r("cn1","cn2",3355443),r("cn3","cn4",3355443),r("cf1","cf2",3355443),r("cf3","cf4",3355443),this.update(e),this.lines=new t.Line(this.lineGeometry,this.lineMaterial,t.LinePieces),this.add(this.lines)},t.CameraHelper.prototype=new t.Object3D,t.CameraHelper.prototype.constructor=t.CameraHelper,t.CameraHelper.prototype.update=function(e){function r(e,r,n,o){if(t.CameraHelper.__v.set(r,n,o),t.CameraHelper.__projector.unprojectVector(t.CameraHelper.__v,t.CameraHelper.__c),e=i.pointMap[e],void 0!==e)for(r=0,n=e.length;n>r;r++)i.lineGeometry.vertices[e[r]].position.copy(t.CameraHelper.__v)}var i=this;t.CameraHelper.__c.projectionMatrix.copy(e.projectionMatrix),r("c",0,0,-1),r("t",0,0,1),r("n1",-1,-1,-1),r("n2",1,-1,-1),r("n3",-1,1,-1),r("n4",1,1,-1),r("f1",-1,-1,1),r("f2",1,-1,1),r("f3",-1,1,1),r("f4",1,1,1),r("u1",.7,1.1,-1),r("u2",-.7,1.1,-1),r("u3",0,2,-1),r("cf1",-1,0,1),r("cf2",1,0,1),r("cf3",0,-1,1),r("cf4",0,1,1),r("cn1",-1,0,-1),r("cn2",1,0,-1),r("cn3",0,-1,-1),r("cn4",0,1,-1),this.lineGeometry.__dirtyVertices=!0},t.CameraHelper.__projector=new t.Projector,t.CameraHelper.__v=new t.Vector3,t.CameraHelper.__c=new t.Camera,t.SubdivisionModifier=function(e){this.subdivisions=void 0===e?1:e,this.useOldVertexColors=!1,this.supportUVs=!0},t.SubdivisionModifier.prototype.constructor=t.SubdivisionModifier,t.SubdivisionModifier.prototype.modify=function(e){for(var t=this.subdivisions;0<t--;)this.smooth(e)},t.SubdivisionModifier.prototype.smooth=function(e){function r(e,r,i,n,o,a){var s=new t.Face4(e,r,i,n,null,o.color,o.material);if(d.useOldVertexColors){s.vertexColors=[];for(var l,c,u,f=0;4>f;f++){u=a[f],l=new t.Color,l.setRGB(0,0,0);for(var m=0;m<u.length;m++)c=o.vertexColors[u[m]-1],l.r+=c.r,l.g+=c.g,l.b+=c.b;l.r/=u.length,l.g/=u.length,l.b/=u.length,s.vertexColors[f]=l}}h.push(s),(!d.supportUVs||0!=v.length)&&p.push([v[e],v[r],v[i],v[n]])}function i(e,t){return Math.min(e,t)+"_"+Math.max(e,t)}var n,o,a,s,l,c=[],h=[],p=[],d=this,u=e.vertices,c=e.faces,f=u.concat(),m=[],g={},b={},v=[],x=e.faceVertexUvs[0];for(n=0,o=x.length;o>n;n++)for(a=0,s=x[n].length;s>a;a++)l=c[n]["abcd".charAt(a)],v[l]||(v[l]=x[n][a]);var y;for(n=0,o=c.length;o>n;n++)l=c[n],m.push(l.centroid),f.push(new t.Vertex(l.centroid)),d.supportUVs&&0!=v.length&&(y=new t.UV,l instanceof t.Face3?(y.u=v[l.a].u+v[l.b].u+v[l.c].u,y.v=v[l.a].v+v[l.b].v+v[l.c].v,y.u/=3,y.v/=3):l instanceof t.Face4&&(y.u=v[l.a].u+v[l.b].u+v[l.c].u+v[l.d].u,y.v=v[l.a].v+v[l.b].v+v[l.c].v+v[l.d].v,y.u/=4,y.v/=4),v.push(y));o=function(e){function r(e,t,r){void 0===e[t]&&(e[t]=[]),e[t].push(r)}var n,o,a,s,l={};for(n=0,o=e.faces.length;o>n;n++)a=e.faces[n],a instanceof t.Face3?(s=i(a.a,a.b),r(l,s,n),s=i(a.b,a.c),r(l,s,n),s=i(a.c,a.a),r(l,s,n)):a instanceof t.Face4&&(s=i(a.a,a.b),r(l,s,n),s=i(a.b,a.c),r(l,s,n),s=i(a.c,a.d),r(l,s,n),s=i(a.d,a.a),r(l,s,n));return l}(e);var w,_,M=0,x=u.length,S={},k={},T=function(e,t){void 0===S[e]&&(S[e]=[]),S[e].push(t)},C=function(e,t){void 0===k[e]&&(k[e]={}),k[e][t]=null};for(n in o){for(y=o[n],w=n.split("_"),_=w[0],w=w[1],T(_,[_,w]),T(w,[_,w]),a=0,s=y.length;s>a;a++)l=y[a],C(_,l,n),C(w,l,n);2>y.length&&(b[n]=!0)}for(n in o)y=o[n],l=y[0],y=y[1],w=n.split("_"),_=w[0],w=w[1],s=new t.Vector3,b[n]?(s.addSelf(u[_].position),s.addSelf(u[w].position),s.multiplyScalar(.5)):(s.addSelf(m[l]),s.addSelf(m[y]),s.addSelf(u[_].position),s.addSelf(u[w].position),s.multiplyScalar(.25)),g[n]=x+c.length+M,f.push(new t.Vertex(s)),M++,d.supportUVs&&0!=v.length&&(y=new t.UV,y.u=v[_].u+v[w].u,y.v=v[_].v+v[w].v,y.u/=2,y.v/=2,v.push(y));var A,E;w=["123","12","2","23"],s=["123","23","3","31"];var T=["123","31","1","12"],C=["1234","12","2","23"],L=["1234","23","3","34"],R=["1234","34","4","41"],z=["1234","41","1","12"];for(n=0,o=m.length;o>n;n++)l=c[n],y=x+n,l instanceof t.Face3?(M=i(l.a,l.b),_=i(l.b,l.c),A=i(l.c,l.a),r(y,g[M],l.b,g[_],l,w),r(y,g[_],l.c,g[A],l,s),r(y,g[A],l.a,g[M],l,T)):l instanceof t.Face4?(M=i(l.a,l.b),_=i(l.b,l.c),A=i(l.c,l.d),E=i(l.d,l.a),r(y,g[M],l.b,g[_],l,C),r(y,g[_],l.c,g[A],l,L),r(y,g[A],l.d,g[E],l,R),r(y,g[E],l.a,g[M],l,z)):console.log("face should be a face!",l);for(c=f,f=new t.Vector3,g=new t.Vector3,n=0,o=u.length;o>n;n++)if(void 0!==S[n]){f.set(0,0,0),g.set(0,0,0),l=new t.Vector3(0,0,0),y=0;for(a in k[n])f.addSelf(m[a]),y++;for(M=0,x=S[n].length,a=0;x>a;a++)b[i(S[n][a][0],S[n][a][1])]&&M++;if(2!=M){for(f.divideScalar(y),a=0;x>a;a++)y=S[n][a],y=u[y[0]].position.clone().addSelf(u[y[1]].position).divideScalar(2),g.addSelf(y);g.divideScalar(x),l.addSelf(u[n].position),l.multiplyScalar(x-3),l.addSelf(f),l.addSelf(g.multiplyScalar(2)),l.divideScalar(x),c[n].position=l}}e.vertices=c,e.faces=h,e.faceVertexUvs[0]=p,delete e.__tmpVertices,e.computeCentroids(),e.computeFaceNormals(),e.computeVertexNormals()},t.Loader=function(e){this.statusDomElement=(this.showStatus=e)?t.Loader.prototype.addStatusElement():null,this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}},t.Loader.prototype={constructor:t.Loader,crossOrigin:"anonymous",addStatusElement:function(){var e=document.createElement("div");return e.style.position="absolute",e.style.right="0px",e.style.top="0px",e.style.fontSize="0.8em",e.style.textAlign="left",e.style.background="rgba(0,0,0,0.25)",e.style.color="#fff",e.style.width="120px",e.style.padding="0.5em 0.5em 0.5em 0.5em",e.style.zIndex=1e3,e.innerHTML="Loading ...",e},updateProgress:function(e){var t="Loaded ",t=e.total?t+((100*e.loaded/e.total).toFixed(0)+"%"):t+((e.loaded/1e3).toFixed(2)+" KB");this.statusDomElement.innerHTML=t},extractUrlBase:function(e){return e=e.split("/"),e.pop(),(1>e.length?".":e.join("/"))+"/"},initMaterials:function(e,r,i){e.materials=[];for(var n=0;n<r.length;++n)e.materials[n]=t.Loader.prototype.createMaterial(r[n],i)},hasNormals:function(e){var r,i,n=e.materials.length;for(i=0;n>i;i++)if(r=e.materials[i],r instanceof t.ShaderMaterial)return!0;return!1},createMaterial:function(e,r){function i(e){return e=Math.log(e)/Math.LN2,Math.floor(e)==e}function n(e){return e=Math.log(e)/Math.LN2,Math.pow(2,Math.round(e))}function o(e,t){var r=new Image;r.onload=function(){if(i(this.width)&&i(this.height))e.image=this;else{var t=n(this.width),r=n(this.height);e.image.width=t,e.image.height=r,e.image.getContext("2d").drawImage(this,0,0,t,r)}e.needsUpdate=!0},r.crossOrigin=l.crossOrigin,r.src=t}function a(e,i,n,a,s,l){var c=document.createElement("canvas");e[i]=new t.Texture(c),e[i].sourceFile=n,a&&(e[i].repeat.set(a[0],a[1]),1!=a[0]&&(e[i].wrapS=t.RepeatWrapping),1!=a[1]&&(e[i].wrapT=t.RepeatWrapping)),s&&e[i].offset.set(s[0],s[1]),l&&(a={repeat:t.RepeatWrapping,mirror:t.MirroredRepeatWrapping},void 0!==a[l[0]]&&(e[i].wrapS=a[l[0]]),void 0!==a[l[1]]&&(e[i].wrapT=a[l[1]])),o(e[i],r+"/"+n)}function s(e){return(255*e[0]<<16)+(255*e[1]<<8)+255*e[2]}var l=this,c="MeshLambertMaterial",h={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,wireframe:e.wireframe};if(e.shading&&("Phong"==e.shading?c="MeshPhongMaterial":"Basic"==e.shading&&(c="MeshBasicMaterial")),e.blending&&("Additive"==e.blending?h.blending=t.AdditiveBlending:"Subtractive"==e.blending?h.blending=t.SubtractiveBlending:"Multiply"==e.blending&&(h.blending=t.MultiplyBlending)),(void 0!==e.transparent||1>e.opacity)&&(h.transparent=e.transparent),void 0!==e.depthTest&&(h.depthTest=e.depthTest),void 0!==e.vertexColors&&("face"==e.vertexColors?h.vertexColors=t.FaceColors:e.vertexColors&&(h.vertexColors=t.VertexColors)),e.colorDiffuse?h.color=s(e.colorDiffuse):e.DbgColor&&(h.color=e.DbgColor),e.colorSpecular&&(h.specular=s(e.colorSpecular)),e.colorAmbient&&(h.ambient=s(e.colorAmbient)),e.transparency&&(h.opacity=e.transparency),e.specularCoef&&(h.shininess=e.specularCoef),e.mapDiffuse&&r&&a(h,"map",e.mapDiffuse,e.mapDiffuseRepeat,e.mapDiffuseOffset,e.mapDiffuseWrap),e.mapLight&&r&&a(h,"lightMap",e.mapLight,e.mapLightRepeat,e.mapLightOffset,e.mapLightWrap),e.mapNormal&&r&&a(h,"normalMap",e.mapNormal,e.mapNormalRepeat,e.mapNormalOffset,e.mapNormalWrap),e.mapSpecular&&r&&a(h,"specularMap",e.mapSpecular,e.mapSpecularRepeat,e.mapSpecularOffset,e.mapSpecularWrap),e.mapNormal){var c=t.ShaderUtils.lib.normal,p=t.UniformsUtils.clone(c.uniforms);p.tNormal.texture=h.normalMap,e.mapNormalFactor&&(p.uNormalScale.value=e.mapNormalFactor),h.map&&(p.tDiffuse.texture=h.map,p.enableDiffuse.value=!0),h.specularMap&&(p.tSpecular.texture=h.specularMap,p.enableSpecular.value=!0),h.lightMap&&(p.tAO.texture=h.lightMap,p.enableAO.value=!0),p.uDiffuseColor.value.setHex(h.color),p.uSpecularColor.value.setHex(h.specular),p.uAmbientColor.value.setHex(h.ambient),p.uShininess.value=h.shininess,void 0!==h.opacity&&(p.uOpacity.value=h.opacity),h=new t.ShaderMaterial({fragmentShader:c.fragmentShader,vertexShader:c.vertexShader,uniforms:p,lights:!0,fog:!0})}else h=new t[c](h);return void 0!==e.DbgName&&(h.name=e.DbgName),h}},t.BinaryLoader=function(e){t.Loader.call(this,e)},t.BinaryLoader.prototype=new t.Loader,t.BinaryLoader.prototype.constructor=t.BinaryLoader,t.BinaryLoader.prototype.supr=t.Loader.prototype,t.BinaryLoader.prototype.load=function(e,r,i,n){var i=i?i:this.extractUrlBase(e),n=n?n:this.extractUrlBase(e),o=this.showProgress?t.Loader.prototype.updateProgress:null;this.onLoadStart(),this.loadAjaxJSON(this,e,r,i,n,o)},t.BinaryLoader.prototype.loadAjaxJSON=function(e,t,r,i,n,o){var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4==a.readyState)if(200==a.status||0==a.status){var s=JSON.parse(a.responseText);e.loadAjaxBuffers(s,r,n,i,o)}else console.error("THREE.BinaryLoader: Couldn't load ["+t+"] ["+a.status+"]")},a.open("GET",t,!0),a.overrideMimeType&&a.overrideMimeType("text/plain; charset=x-user-defined"),a.setRequestHeader("Content-Type","text/plain"),a.send(null)},t.BinaryLoader.prototype.loadAjaxBuffers=function(e,r,i,n,o){var a=new XMLHttpRequest,s=i+"/"+e.buffers,l=0;a.onreadystatechange=function(){4==a.readyState?200==a.status||0==a.status?t.BinaryLoader.prototype.createBinModel(a.response,r,n,e.materials):console.error("THREE.BinaryLoader: Couldn't load ["+s+"] ["+a.status+"]"):3==a.readyState?o&&(0==l&&(l=a.getResponseHeader("Content-Length")),o({total:l,loaded:a.responseText.length})):2==a.readyState&&(l=a.getResponseHeader("Content-Length"))},a.open("GET",s,!0),a.responseType="arraybuffer",a.send(null)},t.BinaryLoader.prototype.createBinModel=function(e,r,i,n){var o=function(r){function i(e){return e%4?4-e%4:0}function o(e,t){return new Uint8Array(e,t,1)[0]}function a(e,t){return new Uint32Array(e,t,1)[0]}function s(r,i){var n,o,a,s,l,c,h,p,d=new Uint32Array(e,i,3*r);for(n=0;r>n;n++){o=d[3*n],a=d[3*n+1],s=d[3*n+2],l=P[2*o],o=P[2*o+1],c=P[2*a],h=P[2*a+1],a=P[2*s],p=P[2*s+1],s=R.faceVertexUvs[0];var u=[];u.push(new t.UV(l,o)),u.push(new t.UV(c,h)),u.push(new t.UV(a,p)),s.push(u)}}function l(r,i){var n,o,a,s,l,c,h,p,d,u,f=new Uint32Array(e,i,4*r);for(n=0;r>n;n++){o=f[4*n],a=f[4*n+1],s=f[4*n+2],l=f[4*n+3],c=P[2*o],o=P[2*o+1],h=P[2*a],d=P[2*a+1],p=P[2*s],u=P[2*s+1],s=P[2*l],a=P[2*l+1],l=R.faceVertexUvs[0];var m=[];m.push(new t.UV(c,o)),m.push(new t.UV(h,d)),m.push(new t.UV(p,u)),m.push(new t.UV(s,a)),l.push(m)}}function c(r,i,n){for(var o,a,s,l,i=new Uint32Array(e,i,3*r),c=new Uint16Array(e,n,r),n=0;r>n;n++)o=i[3*n],a=i[3*n+1],s=i[3*n+2],l=c[n],R.faces.push(new t.Face3(o,a,s,null,null,l))}function h(r,i,n){for(var o,a,s,l,c,i=new Uint32Array(e,i,4*r),h=new Uint16Array(e,n,r),n=0;r>n;n++)o=i[4*n],a=i[4*n+1],s=i[4*n+2],l=i[4*n+3],c=h[n],R.faces.push(new t.Face4(o,a,s,l,null,null,c))}function p(r,i,n,o){for(var a,s,l,c,h,p,d,i=new Uint32Array(e,i,3*r),n=new Uint32Array(e,n,3*r),u=new Uint16Array(e,o,r),o=0;r>o;o++){a=i[3*o],s=i[3*o+1],l=i[3*o+2],h=n[3*o],p=n[3*o+1],d=n[3*o+2],c=u[o];var f=N[3*p],m=N[3*p+1];p=N[3*p+2];var g=N[3*d],b=N[3*d+1];d=N[3*d+2],R.faces.push(new t.Face3(a,s,l,[new t.Vector3(N[3*h],N[3*h+1],N[3*h+2]),new t.Vector3(f,m,p),new t.Vector3(g,b,d)],null,c))}}function d(r,i,n,o){for(var a,s,l,c,h,p,d,u,f,i=new Uint32Array(e,i,4*r),n=new Uint32Array(e,n,4*r),m=new Uint16Array(e,o,r),o=0;r>o;o++){a=i[4*o],s=i[4*o+1],l=i[4*o+2],c=i[4*o+3],p=n[4*o],d=n[4*o+1],u=n[4*o+2],f=n[4*o+3],h=m[o];var g=N[3*d],b=N[3*d+1];d=N[3*d+2];var v=N[3*u],x=N[3*u+1];u=N[3*u+2];var y=N[3*f],w=N[3*f+1];f=N[3*f+2],R.faces.push(new t.Face4(a,s,l,c,[new t.Vector3(N[3*p],N[3*p+1],N[3*p+2]),new t.Vector3(g,b,d),new t.Vector3(v,x,u),new t.Vector3(y,w,f)],null,h))}}var u,f,m,g,b,v,x,y,w,_,M,S,k,T,C,A,E,L,R=this,z=0,N=[],P=[];t.Geometry.call(this),t.Loader.prototype.initMaterials(R,n,r),function(e,t,r){for(var e=new Uint8Array(e,t,r),i="",n=0;r>n;n++)i+=String.fromCharCode(e[t+n]);return i}(e,z,12),u=o(e,z+12),o(e,z+13),o(e,z+14),o(e,z+15),f=o(e,z+16),m=o(e,z+17),g=o(e,z+18),b=o(e,z+19),v=a(e,z+20),x=a(e,z+20+4),y=a(e,z+20+8),r=a(e,z+20+12),w=a(e,z+20+16),_=a(e,z+20+20),M=a(e,z+20+24),S=a(e,z+20+28),k=a(e,z+20+32),T=a(e,z+20+36),C=a(e,z+20+40),z+=u,u=3*f+b,L=4*f+b,A=r*u,E=w*(u+3*m),f=_*(u+3*g),b=M*(u+3*m+3*g),u=S*L,m=k*(L+4*m),g=T*(L+4*g),z+=function(r){var i,n,o,a,r=new Float32Array(e,r,3*v);for(i=0;v>i;i++)n=r[3*i],o=r[3*i+1],a=r[3*i+2],R.vertices.push(new t.Vertex(new t.Vector3(n,o,a)));return 3*v*Float32Array.BYTES_PER_ELEMENT}(z),z+=function(t){if(x){var r,i,n,o,t=new Int8Array(e,t,3*x);for(r=0;x>r;r++)i=t[3*r],n=t[3*r+1],o=t[3*r+2],N.push(i/127,n/127,o/127)}return 3*x*Int8Array.BYTES_PER_ELEMENT}(z),z+=i(3*x),z+=function(t){if(y){var r,i,n,t=new Float32Array(e,t,2*y);for(r=0;y>r;r++)i=t[2*r],n=t[2*r+1],P.push(i,n)}return 2*y*Float32Array.BYTES_PER_ELEMENT}(z),A=z+A+i(2*r),E=A+E+i(2*w),f=E+f+i(2*_),b=f+b+i(2*M),u=b+u+i(2*S),m=u+m+i(2*k),g=m+g+i(2*T),function(e){if(_){var t=e+3*_*Uint32Array.BYTES_PER_ELEMENT;c(_,e,t+3*_*Uint32Array.BYTES_PER_ELEMENT),s(_,t)}}(E),function(e){if(M){var t=e+3*M*Uint32Array.BYTES_PER_ELEMENT,r=t+3*M*Uint32Array.BYTES_PER_ELEMENT;p(M,e,t,r+3*M*Uint32Array.BYTES_PER_ELEMENT),s(M,r)}}(f),function(e){if(T){var t=e+4*T*Uint32Array.BYTES_PER_ELEMENT;h(T,e,t+4*T*Uint32Array.BYTES_PER_ELEMENT),l(T,t)}}(m),function(e){if(C){var t=e+4*C*Uint32Array.BYTES_PER_ELEMENT,r=t+4*C*Uint32Array.BYTES_PER_ELEMENT;d(C,e,t,r+4*C*Uint32Array.BYTES_PER_ELEMENT),l(C,r)}}(g),r&&c(r,z,z+3*r*Uint32Array.BYTES_PER_ELEMENT),function(e){if(w){var t=e+3*w*Uint32Array.BYTES_PER_ELEMENT;p(w,e,t,t+3*w*Uint32Array.BYTES_PER_ELEMENT)}}(A),S&&h(S,b,b+4*S*Uint32Array.BYTES_PER_ELEMENT),function(e){if(k){var t=e+4*k*Uint32Array.BYTES_PER_ELEMENT;d(k,e,t,t+4*k*Uint32Array.BYTES_PER_ELEMENT)}}(u),this.computeCentroids(),this.computeFaceNormals(),t.Loader.prototype.hasNormals(this)&&this.computeTangents()};o.prototype=new t.Geometry,o.prototype.constructor=o,r(new o(i))},t.ColladaLoader=function(){function e(e,n,o){if(Q=e,n=n||et,void 0!==o&&(e=o.split("/"),e.pop(),Z=(1>e.length?".":e.join("/"))+"/"),(e=Q.evaluate("//dae:asset",Q,B,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext())&&e.childNodes)for(o=0;o<e.childNodes.length;o++){var c=e.childNodes[o];switch(c.nodeName){case"unit":(c=c.getAttribute("meter"))&&parseFloat(c);break;case"up_axis":pt=c.textContent.charAt(0)}}if(ht.convertUpAxis&&pt!==ht.upAxis)switch(pt){case"X":dt="Y"===ht.upAxis?"XtoY":"XtoZ";break;case"Y":dt="X"===ht.upAxis?"YtoX":"YtoZ";break;case"Z":dt="X"===ht.upAxis?"ZtoX":"ZtoY"}else dt=null;for(rt=r("//dae:library_images/dae:image",s,"image"),at=r("//dae:library_materials/dae:material",k,"material"),st=r("//dae:library_effects/dae:effect",L,"effect"),ot=r("//dae:library_geometries/dae:geometry",b,"geometry"),lt=r(".//dae:library_cameras/dae:camera",F,"camera"),nt=r("//dae:library_controllers/dae:controller",l,"controller"),it=r("//dae:library_animations/dae:animation",z,"animation"),q=r(".//dae:library_visual_scenes/dae:visual_scene",p,"visual_scene"),K=[],$=[],(e=Q.evaluate(".//dae:scene/dae:instance_visual_scene",Q,B,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext())?(e=e.getAttribute("url").replace(/^#/,""),X=q[0<e.length?e:"visual_scene0"]):X=null,J=new t.Object3D,e=0;e<X.nodes.length;e++)J.add(a(X.nodes[e]));return Y=[],i(J),e={scene:J,morphs:K,skins:$,animations:Y,dae:{images:rt,materials:at,cameras:lt,effects:st,geometries:ot,controllers:nt,animations:it,visualScenes:q,scene:X}},n&&n(e),e}function r(e,t,r){for(var e=Q.evaluate(e,Q,B,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null),i={},n=e.iterateNext(),o=0;n;)n=(new t).parse(n),n.id&&0!=n.id.length||(n.id=r+o++),i[n.id]=n,n=e.iterateNext();return i}function i(e){var t=X.getChildById(e.name,!0),r=null;if(t&&t.keys){r={fps:60,hierarchy:[{node:t,keys:t.keys,sids:t.sids}],node:e,name:"animation_"+e.name,length:0},Y.push(r);for(var n=0,o=t.keys.length;o>n;n++)r.length=Math.max(r.length,t.keys[n].time)}else r={hierarchy:[{keys:[],sids:[]}]};for(n=0,o=e.children.length;o>n;n++)for(var t=0,a=i(e.children[n]).hierarchy.length;a>t;t++)r.hierarchy.push({keys:[],sids:[]});return r}function n(e,r,i,o){if(e.world=e.world||new t.Matrix4,e.world.copy(e.matrix),e.channels&&e.channels.length){var a=e.channels[0].sampler.output[i];a instanceof t.Matrix4&&e.world.copy(a)}for(o&&e.world.multiply(o,e.world),r.push(e),o=0;o<e.nodes.length;o++)n(e.nodes[o],r,i,e.world)}function o(e,r,i){var o,a=nt[r.url];if(a&&a.skin)if(r.skeleton&&r.skeleton.length){var i=1e6,s=-i,l=0;for(o in it)for(var c=it[o],h=0;h<c.sampler.length;h++){var p=c.sampler[h];p.create(),i=Math.min(i,p.startTime),s=Math.max(s,p.endTime),l=Math.max(l,p.input.length)}o=l;for(var d,u,f,r=X.getChildById(r.skeleton[0],!0)||X.getChildBySid(r.skeleton[0],!0),s=new t.Vector3,h=0;h<e.vertices.length;h++)a.skin.bindShapeMatrix.multiplyVector3(e.vertices[h].position);for(i=0;o>i;i++){for(l=[],c=[],h=0;h<e.vertices.length;h++)c.push(new t.Vertex(new t.Vector3));for(n(r,l,i),h=l,p=a.skin,u=0;u<h.length;u++)if(d=h[u],f=-1,"JOINT"==d.type){for(var m=0;m<p.joints.length;m++)if(d.sid==p.joints[m]){f=m;break}if(!(f>=0))throw"ColladaLoader: Could not find joint '"+d.sid+"'.";for(m=p.invBindMatrices[f],d.invBindMatrix=m,d.skinningMatrix=new t.Matrix4,d.skinningMatrix.multiply(d.world,m),d.weights=[],m=0;m<p.weights.length;m++)for(var g=0;g<p.weights[m].length;g++){var b=p.weights[m][g];b.joint==f&&d.weights.push(b)}}for(h=0;h<l.length;h++)if("JOINT"==l[h].type)for(p=0;p<l[h].weights.length;p++)d=l[h].weights[p],u=d.index,d=d.weight,f=e.vertices[u],u=c[u],s.x=f.position.x,s.y=f.position.y,s.z=f.position.z,l[h].skinningMatrix.multiplyVector3(s),u.position.x+=s.x*d,u.position.y+=s.y*d,u.position.z+=s.z*d;e.morphTargets.push({name:"target_"+i,vertices:c})}}else console.log("ColladaLoader: Could not find the skeleton for the skin. ");else console.log("ColladaLoader: Could not find skin controller.")}function a(e){var r,i,n,s,l=new t.Object3D;for(n=0;n<e.controllers.length;n++){var c=nt[e.controllers[n].url];switch(c.type){case"skin":if(ot[c.skin.source]){var h=new g;h.url=c.skin.source,h.instance_material=e.controllers[n].instance_material,e.geometries.push(h),r=e.controllers[n]}else nt[c.skin.source]&&(i=c=nt[c.skin.source],c.morph&&ot[c.morph.source])&&(h=new g,h.url=c.morph.source,h.instance_material=e.controllers[n].instance_material,e.geometries.push(h));break;case"morph":ot[c.morph.source]&&(h=new g,h.url=c.morph.source,h.instance_material=e.controllers[n].instance_material,e.geometries.push(h),i=e.controllers[n]),console.log("ColladaLoader: Morph-controller partially supported.")}}for(n=0;n<e.geometries.length;n++){var p,c=e.geometries[n],h=c.instance_material,c=ot[c.url],d={},u=[],m=0;if(c&&c.mesh&&c.mesh.primitives){if(0==l.name.length&&(l.name=c.id),h)for(s=0;s<h.length;s++){p=h[s];var b=at[p.target],v=st[b.instance_effect.url].shader;v.material.opacity=v.material.opacity?v.material.opacity:1,d[p.symbol]=m,u.push(v.material),p=v.material,p.name=null==b.name||""===b.name?b.id:b.name,m++}if(h=p||new t.MeshLambertMaterial({color:14540253,shading:t.FlatShading}),c=c.mesh.geometry3js,m>1)for(h=new t.MeshFaceMaterial,c.materials=u,s=0;s<c.faces.length;s++)u=c.faces[s],u.materialIndex=d[u.daeMaterial];if(void 0!==r)o(c,r),h.morphTargets=!0,h=new t.SkinnedMesh(c,h),h.skeleton=r.skeleton,h.skinController=nt[r.url],h.skinInstanceController=r,h.name="skin_"+$.length,$.push(h);else if(void 0!==i){if(s=c,d=i instanceof f?nt[i.url]:i,d&&d.morph){for(d=d.morph,u=0;u<d.targets.length;u++)m=ot[d.targets[u]],m.mesh&&m.mesh.primitives&&m.mesh.primitives.length&&(m=m.mesh.primitives[0].geometry,m.vertices.length===s.vertices.length&&s.morphTargets.push({name:"target_1",vertices:m.vertices}));s.morphTargets.push({name:"target_Z",vertices:s.vertices})}else console.log("could not find morph controller!");h.morphTargets=!0,h=new t.Mesh(c,h),h.name="morph_"+K.length,K.push(h)}else h=new t.Mesh(c,h);
1<e.geometries.length?l.add(h):l=h}}for(n=0;n<e.cameras.length;n++)l=lt[e.cameras[n].url],l=new t.PerspectiveCamera(l.fov,l.aspect_ratio,l.znear,l.zfar);for(l.name=e.id||"",l.matrix=e.matrix,n=e.matrix.decompose(),l.position=n[0],l.quaternion=n[1],l.useQuaternion=!0,l.scale=n[2],ht.centerGeometry&&l.geometry&&(n=t.GeometryUtils.center(l.geometry),l.quaternion.multiplyVector3(n.multiplySelf(l.scale)),l.position.subSelf(n)),n=0;n<e.nodes.length;n++)l.add(a(e.nodes[n],e));return l}function s(){this.init_from=this.id=""}function l(){this.type=this.name=this.id="",this.morph=this.skin=null}function c(){this.weights=this.targets=this.source=this.method=null}function h(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function p(){this.name=this.id="",this.nodes=[],this.scene=new t.Object3D}function d(){this.sid=this.name=this.id="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new t.Matrix4}function u(){this.type=this.sid="",this.data=[],this.obj=null}function f(){this.url="",this.skeleton=[],this.instance_material=[]}function m(){this.target=this.symbol=""}function g(){this.url="",this.instance_material=[]}function b(){this.id="",this.mesh=null}function v(e){this.geometry=e.id,this.primitives=[],this.geometry3js=this.vertices=null}function x(){}function y(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new t.Geometry}function w(){this.source="",this.stride=this.count=0,this.params=[]}function _(){this.input={}}function M(){this.semantic="",this.offset=0,this.source="",this.set=0}function S(e){this.id=e,this.type=null}function k(){this.name=this.id="",this.instance_effect=null}function T(){this.color=new t.Color(0),this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texOpts=this.texcoord=this.texture=null}function C(e,t){this.type=e,this.effect=t,this.material=null}function A(e){this.effect=e,this.format=this.init_from=null}function E(e){this.effect=e,this.mipfilter=this.magfilter=this.minfilter=this.wrap_t=this.wrap_s=this.source=null}function L(){this.name=this.id="",this.sampler=this.surface=this.shader=null}function R(){this.url=""}function z(){this.name=this.id="",this.source={},this.sampler=[],this.channel=[]}function N(e){this.animation=e,this.target=this.source="",this.member=this.arrIndices=this.arrSyntax=this.dotSyntax=this.sid=this.fullSid=null}function P(e){this.id="",this.animation=e,this.inputs=[],this.endTime=this.startTime=this.interpolation=this.strideOut=this.output=this.input=null,this.duration=0}function D(e){this.targets=[],this.time=e}function F(){this.name=this.id=""}function V(){this.url=""}function B(e){return"dae"==e?"http://www.collada.org/2005/11/COLLADASchema":null}function U(e){for(var e=I(e),t=[],r=0,i=e.length;i>r;r++)t.push(parseFloat(e[r]));return t}function O(e){for(var e=I(e),t=[],r=0,i=e.length;i>r;r++)t.push(parseInt(e[r],10));return t}function I(e){return 0<e.length?e.replace(/^\s+/,"").replace(/\s+$/,"").split(/\s+/):[]}function j(e,t,r){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):r}function W(e,t){if(ht.convertUpAxis&&pt!==ht.upAxis)switch(dt){case"XtoY":var r=e[0];e[0]=t*e[1],e[1]=r;break;case"XtoZ":r=e[2],e[2]=e[1],e[1]=e[0],e[0]=r;break;case"YtoX":r=e[0],e[0]=e[1],e[1]=t*r;break;case"YtoZ":r=e[1],e[1]=t*e[2],e[2]=r;break;case"ZtoX":r=e[0],e[0]=e[1],e[1]=e[2],e[2]=r;break;case"ZtoY":r=e[1],e[1]=e[2],e[2]=t*r}}function H(e,r){var i=[e[r],e[r+1],e[r+2]];return W(i,-1),new t.Vector3(i[0],i[1],i[2])}function G(e){if(ht.convertUpAxis){var r=[e[0],e[4],e[8]];W(r,-1),e[0]=r[0],e[4]=r[1],e[8]=r[2],r=[e[1],e[5],e[9]],W(r,-1),e[1]=r[0],e[5]=r[1],e[9]=r[2],r=[e[2],e[6],e[10]],W(r,-1),e[2]=r[0],e[6]=r[1],e[10]=r[2],r=[e[0],e[1],e[2]],W(r,-1),e[0]=r[0],e[1]=r[1],e[2]=r[2],r=[e[4],e[5],e[6]],W(r,-1),e[4]=r[0],e[5]=r[1],e[6]=r[2],r=[e[8],e[9],e[10]],W(r,-1),e[8]=r[0],e[9]=r[1],e[10]=r[2],r=[e[3],e[7],e[11]],W(r,-1),e[3]=r[0],e[7]=r[1],e[11]=r[2]}return new t.Matrix4(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}var X,Y,q,Z,K,$,Q=null,J=null,et=null,tt={},rt={},it={},nt={},ot={},at={},st={},lt={},ct=t.SmoothShading,ht={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y"},pt="Y",dt=null,ut=Math.PI/180;return s.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];"init_from"==r.nodeName&&(this.init_from=r.textContent)}return this},l.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"skin":this.skin=(new h).parse(r),this.type=r.nodeName;break;case"morph":this.morph=(new c).parse(r),this.type=r.nodeName}}return this},c.prototype.parse=function(e){var t,r={},i=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(1==n.nodeType)switch(n.nodeName){case"source":n=(new S).parse(n),r[n.id]=n;break;case"targets":i=this.parseInputs(n);break;default:console.log(n.nodeName)}}for(t=0;t<i.length;t++)switch(e=i[t],n=r[e.source],e.semantic){case"MORPH_TARGET":this.targets=n.read();break;case"MORPH_WEIGHT":this.weights=n.read()}return this},c.prototype.parseInputs=function(e){for(var t=[],r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"input":t.push((new M).parse(i))}}return t},h.prototype.parse=function(e){var t,r,i={};this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var n=0;n<e.childNodes.length;n++){var o=e.childNodes[n];if(1==o.nodeType)switch(o.nodeName){case"bind_shape_matrix":o=U(o.textContent),this.bindShapeMatrix=G(o);break;case"source":o=(new S).parse(o),i[o.id]=o;break;case"joints":t=o;break;case"vertex_weights":r=o;break;default:console.log(o.nodeName)}}return this.parseJoints(t,i),this.parseWeights(r,i),this},h.prototype.parseJoints=function(e,t){for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"input":var i=(new M).parse(i),n=t[i.source];"JOINT"==i.semantic?this.joints=n.read():"INV_BIND_MATRIX"==i.semantic&&(this.invBindMatrices=n.read())}}},h.prototype.parseWeights=function(e,t){for(var r,i,n=[],o=0;o<e.childNodes.length;o++){var a=e.childNodes[o];if(1==a.nodeType)switch(a.nodeName){case"input":n.push((new M).parse(a));break;case"v":r=O(a.textContent);break;case"vcount":i=O(a.textContent)}}for(o=a=0;o<i.length;o++){for(var s=i[o],l=[],c=0;s>c;c++){for(var h={},p=0;p<n.length;p++){var d=n[p],u=r[a+d.offset];switch(d.semantic){case"JOINT":h.joint=u;break;case"WEIGHT":h.weight=t[d.source].data[u]}}l.push(h),a+=n.length}for(c=0;c<l.length;c++)l[c].index=o;this.weights.push(l)}},p.prototype.getChildById=function(e,t){for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildById(e,t);if(i)return i}return null},p.prototype.getChildBySid=function(e,t){for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildBySid(e,t);if(i)return i}return null},p.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"node":this.nodes.push((new d).parse(r))}}return this},d.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var r=this.channels[t],i=r.target.split("/");i.shift();var n,o=i.shift(),a=0<=o.indexOf("."),s=0<=o.indexOf("(");if(a)i=o.split("."),o=i.shift(),i.shift();else if(s)for(n=o.split("("),o=n.shift(),i=0;i<n.length;i++)n[i]=parseInt(n[i].replace(/\)/,""));if(o==e)return r.info={sid:o,dotSyntax:a,arrSyntax:s,arrIndices:n},r}return null},d.prototype.getChildById=function(e,t){if(this.id==e)return this;if(t)for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildById(e,t);if(i)return i}return null},d.prototype.getChildBySid=function(e,t){if(this.sid==e)return this;if(t)for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildBySid(e,t);if(i)return i}return null},d.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid==e)return this.transforms[t];return null},d.prototype.parse=function(e){var r;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.type="JOINT"==this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.controllers=[],this.matrix=new t.Matrix4;for(var i=0;i<e.childNodes.length;i++)if(r=e.childNodes[i],1==r.nodeType)switch(r.nodeName){case"node":this.nodes.push((new d).parse(r));break;case"instance_camera":this.cameras.push((new V).parse(r));break;case"instance_controller":this.controllers.push((new f).parse(r));break;case"instance_geometry":this.geometries.push((new g).parse(r));break;case"instance_light":break;case"instance_node":r=r.getAttribute("url").replace(/^#/,""),(r=Q.evaluate(".//dae:library_nodes//dae:node[@id='"+r+"']",Q,B,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext())&&this.nodes.push((new d).parse(r));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new u).parse(r));break;case"extra":break;default:console.log(r.nodeName)}e=[],i=1e6,r=-1e6;for(var n in it)for(var o=it[n],a=0;a<o.channel.length;a++){var s=o.channel[a],l=o.sampler[a];n=s.target.split("/")[0],n==this.id&&(l.create(),s.sampler=l,i=Math.min(i,l.startTime),r=Math.max(r,l.endTime),e.push(s))}if(e.length&&(this.startTime=i,this.endTime=r),(this.channels=e)&&this.channels.length){for(n=[],e=[],i=0,o=this.channels.length;o>i;i++){if(r=this.channels[i],a=r.fullSid,s=r.member,ht.convertUpAxis)switch(s){case"X":switch(dt){case"XtoY":case"XtoZ":case"YtoX":s="Y";break;case"ZtoX":s="Z"}break;case"Y":switch(dt){case"XtoY":case"YtoX":case"ZtoX":s="X";break;case"XtoZ":case"YtoZ":case"ZtoY":s="Z"}break;case"Z":switch(dt){case"XtoZ":s="X";break;case"YtoZ":case"ZtoX":case"ZtoY":s="Y"}}var l=r.sampler,c=l.input,h=this.getTransformBySid(r.sid);if(h){-1===e.indexOf(a)&&e.push(a),r=0;for(var p=c.length;p>r;r++){var m,b=c[r],v=l.getData(h.type,r);m=null;for(var x=0,y=n.length;y>x&&null==m;x++){var w=n[x];if(w.time===b)m=w;else if(w.time>b)break}if(!m){for(m=new D(b),x=-1,y=0,w=n.length;w>y&&-1==x;y++)n[y].time>=b&&(x=y);b=x,n.splice(-1==b?n.length:b,0,m)}m.addTarget(a,h,s,v)}}else console.log('Could not find transform "'+r.sid+'" in node '+this.id)}for(i=0;i<e.length;i++)for(o=e[i],r=0;r<n.length;r++)if(m=n[r],!m.hasTarget(o)){l=n,a=m,h=r,s=o,c=void 0;e:{for(c=h?h-1:0,c=c>=0?c:c+l.length;c>=0;c--)if(p=l[c],p.hasTarget(s)){c=p;break e}c=null}p=void 0;e:{for(h+=1;h<l.length;h++)if(p=l[h],p.hasTarget(s))break e;p=null}if(c&&p){if(l=(a.time-c.time)/(p.time-c.time),c=c.getTarget(s),h=p.getTarget(s).data,p=c.data,v=void 0,p.length)for(v=[],b=0;b<p.length;++b)v[b]=p[b]+(h[b]-p[b])*l;else v=p+(h-p)*l;a.addTarget(s,c.transform,c.member,v)}}this.keys=n,this.sids=e}return this.updateMatrix(),this},d.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},u.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=U(e.textContent),this.convert(),this},u.prototype.convert=function(){switch(this.type){case"matrix":this.obj=G(this.data);break;case"rotate":this.angle=this.data[3]*ut;case"translate":W(this.data,-1),this.obj=new t.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":W(this.data,1),this.obj=new t.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},u.prototype.apply=function(e){switch(this.type){case"matrix":e.multiplySelf(this.obj);break;case"translate":e.translate(this.obj);break;case"rotate":e.rotateByAxis(this.obj,this.angle);break;case"scale":e.scale(this.obj)}},u.prototype.update=function(e,t){switch(this.type){case"matrix":console.log("Currently not handling matrix transform updates");break;case"translate":case"scale":switch(t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":switch(t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=e*ut;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=e[3]*ut}}},f.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"skeleton":this.skeleton.push(r.textContent.replace(/^#/,""));break;case"bind_material":if(r=Q.evaluate(".//dae:instance_material",r,B,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null))for(var i=r.iterateNext();i;)this.instance_material.push((new m).parse(i)),i=r.iterateNext()}}return this},m.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},g.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType&&"bind_material"==r.nodeName){if(e=Q.evaluate(".//dae:instance_material",r,B,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null))for(t=e.iterateNext();t;)this.instance_material.push((new m).parse(t)),t=e.iterateNext();break}}return this},b.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"mesh":this.mesh=new v(this).parse(r)}}return this},v.prototype.parse=function(e){this.primitives=[];var r;for(r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];switch(i.nodeName){case"source":var n=i.getAttribute("id");void 0==tt[n]&&(tt[n]=new S(n).parse(i));break;case"vertices":this.vertices=(new _).parse(i);break;case"triangles":this.primitives.push((new y).parse(i));break;case"polygons":console.warn("polygon holes not yet supported!");case"polylist":this.primitives.push((new x).parse(i))}}for(this.geometry3js=new t.Geometry,e=tt[this.vertices.input.POSITION.source].data,r=0;r<e.length;r+=3)this.geometry3js.vertices.push(new t.Vertex(H(e,r)));for(r=0;r<this.primitives.length;r++)e=this.primitives[r],e.setVertices(this.vertices),this.handlePrimitive(e,this.geometry3js);return this.geometry3js.computeCentroids(),this.geometry3js.computeFaceNormals(),this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this.geometry3js.computeBoundingBox(),this},v.prototype.handlePrimitive=function(e,r){var i,n,o,a,s,l,c=0,h=e.p,p=e.inputs,d=0,u=3,f=0,m=[];for(i=0;i<p.length;i++){o=p[i];var g=o.offset+1,f=g>f?g:f;switch(o.semantic){case"TEXCOORD":m.push(o.set)}}for(;c<h.length;){var b=[],v=[],g={},x=[];for(e.vcount&&(u=e.vcount[d++]),i=0;u>i;i++)for(n=0;n<p.length;n++)switch(o=p[n],l=tt[o.source],a=h[c+i*f+o.offset],s=l.accessor.params.length,s*=a,o.semantic){case"VERTEX":b.push(a);break;case"NORMAL":v.push(H(l.data,s));break;case"TEXCOORD":void 0===g[o.set]&&(g[o.set]=[]),g[o.set].push(new t.UV(l.data[s],1-l.data[s+1]));break;case"COLOR":x.push((new t.Color).setRGB(l.data[s],l.data[s+1],l.data[s+2]))}if(n=null,i=[],0==v.length)if(o=this.vertices.input.NORMAL)for(l=tt[o.source],s=l.accessor.params.length,o=0,a=b.length;a>o;o++)v.push(H(l.data,b[o]*s));else r.calcNormals=!0;if(3===u)i.push(new t.Face3(b[0],b[1],b[2],v,x.length?x:new t.Color));else if(4===u)i.push(new t.Face4(b[0],b[1],b[2],b[3],v,x.length?x:new t.Color));else if(u>4&&ht.subdivideFaces)for(x=x.length?x:new t.Color,n=1;u-1>n;)i.push(new t.Face3(b[0],b[n],b[n+1],[v[0],v[n++],v[n]],x));if(i.length)for(o=0,a=i.length;a>o;o++)for(n=i[o],n.daeMaterial=e.material,r.faces.push(n),n=0;n<m.length;n++)b=g[m[n]],b=u>4?[b[0],b[o+1],b[o+2]]:4===u?[b[0],b[1],b[2],b[3]]:[b[0],b[1],b[2]],r.faceVertexUvs[n]||(r.faceVertexUvs[n]=[]),r.faceVertexUvs[n].push(b);else console.log("dropped face with vcount "+u+" for geometry with id: "+r.id);c+=f*u}},x.prototype=new y,x.prototype.constructor=x,y.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source==e.id&&(this.inputs[t].source=e.input.POSITION.source)},y.prototype.parse=function(e){this.inputs=[],this.material=e.getAttribute("material"),this.count=j(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"input":this.inputs.push((new M).parse(e.childNodes[t]));break;case"vcount":this.vcount=O(r.textContent);break;case"p":this.p=O(r.textContent)}}return this},w.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=j(e,"count",0),this.stride=j(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if("param"==r.nodeName){var i={};i.name=r.getAttribute("name"),i.type=r.getAttribute("type"),this.params.push(i)}}return this},_.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if("input"==e.childNodes[t].nodeName){var r=(new M).parse(e.childNodes[t]);this.input[r.semantic]=r}return this},M.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=j(e,"set",-1),this.offset=j(e,"offset",0),"TEXCOORD"==this.semantic&&0>this.set&&(this.set=0),this},S.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"bool_array":for(var i=I(r.textContent),n=[],o=0,a=i.length;a>o;o++)n.push("true"==i[o]||"1"==i[o]?!0:!1);this.data=n,this.type=r.nodeName;break;case"float_array":this.data=U(r.textContent),this.type=r.nodeName;break;case"int_array":this.data=O(r.textContent),this.type=r.nodeName;break;case"IDREF_array":case"Name_array":this.data=I(r.textContent),this.type=r.nodeName;break;case"technique_common":for(i=0;i<r.childNodes.length;i++)if("accessor"==r.childNodes[i].nodeName){this.accessor=(new w).parse(r.childNodes[i]);break}}}return this},S.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(t=0;t<this.data.length;t+=16){var r=this.data.slice(t,t+16),r=G(r);e.push(r)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},k.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if("instance_effect"==e.childNodes[t].nodeName){this.instance_effect=(new R).parse(e.childNodes[t]);break}return this},T.prototype.isColor=function(){return null==this.texture},T.prototype.isTexture=function(){return null!=this.texture},T.prototype.parse=function(e){for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"color":i=U(i.textContent),this.color=new t.Color(0),this.color.setRGB(i[0],i[1],i[2]),this.color.a=i[3];break;case"texture":this.texture=i.getAttribute("texture"),this.texcoord=i.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(i)}}return this},T.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1],e.childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]));for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[r.nodeName]=parseFloat(r.textContent);break;case"wrapU":case"wrapV":this.texOpts[r.nodeName]=parseInt(r.textContent);break;default:this.texOpts[r.nodeName]=r.textContent}}return this},C.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"ambient":case"emission":case"diffuse":case"specular":case"transparent":this[r.nodeName]=(new T).parse(r);break;case"shininess":case"reflectivity":case"transparency":var i;i=Q.evaluate(".//dae:float",r,B,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);for(var n=i.iterateNext(),o=[];n;)o.push(n),n=i.iterateNext();i=o,0<i.length&&(this[r.nodeName]=parseFloat(i[0].textContent))}}return this.create(),this},C.prototype.create=function(){var e,r={},i=void 0!==this.transparency&&1>this.transparency;for(e in this)switch(e){case"ambient":case"emission":case"diffuse":case"specular":var n=this[e];if(n instanceof T)if(n.isTexture()){if(this.effect.sampler&&this.effect.surface&&this.effect.sampler.source==this.effect.surface.sid){var o=rt[this.effect.surface.init_from];o&&(o=t.ImageUtils.loadTexture(Z+o.init_from),o.wrapS=n.texOpts.wrapU?t.RepeatWrapping:t.ClampToEdgeWrapping,o.wrapT=n.texOpts.wrapV?t.RepeatWrapping:t.ClampToEdgeWrapping,o.offset.x=n.texOpts.offsetU,o.offset.y=n.texOpts.offsetV,o.repeat.x=n.texOpts.repeatU,o.repeat.y=n.texOpts.repeatV,r.map=o)}}else"diffuse"==e?r.color=n.color.getHex():i||(r[e]=n.color.getHex());break;case"shininess":case"reflectivity":r[e]=this[e];break;case"transparency":i&&(r.transparent=!0,r.opacity=this[e],i=!0)}return r.shading=ct,this.material=new t.MeshLambertMaterial(r)},A.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"init_from":this.init_from=r.textContent;break;case"format":this.format=r.textContent;break;default:console.log("unhandled Surface prop: "+r.nodeName)}}return this},E.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"source":this.source=r.textContent;break;case"minfilter":this.minfilter=r.textContent;break;case"magfilter":this.magfilter=r.textContent;break;case"mipfilter":this.mipfilter=r.textContent;break;case"wrap_s":this.wrap_s=r.textContent;break;case"wrap_t":this.wrap_t=r.textContent;break;default:console.log("unhandled Sampler2D prop: "+r.nodeName)}}return this},L.prototype.create=function(){return null==this.shader?null:void 0},L.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(r))}}return this},L.prototype.parseNewparam=function(e){for(var t=e.getAttribute("sid"),r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"surface":this.surface=new A(this).parse(i),this.surface.sid=t;break;case"sampler2D":this.sampler=new E(this).parse(i),this.sampler.sid=t;break;case"extra":break;default:console.log(i.nodeName)}}},L.prototype.parseProfileCOMMON=function(e){for(var t,r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"profile_COMMON":this.parseProfileCOMMON(i);break;case"technique":t=i;break;case"newparam":this.parseNewparam(i);break;case"extra":break;default:console.log(i.nodeName)}}return t},L.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new C(r.nodeName,this).parse(r)}}},R.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},z.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"source":r=(new S).parse(r),this.source[r.id]=r;break;case"sampler":this.sampler.push(new P(this).parse(r));break;case"channel":this.channel.push(new N(this).parse(r))}}return this},N.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/");t.shift();var e=t.shift(),r=0<=e.indexOf("."),i=0<=e.indexOf("(");if(r)t=e.split("."),this.sid=t.shift(),this.member=t.shift();else if(i){t=e.split("("),this.sid=t.shift();for(var n=0;n<t.length;n++)t[n]=parseInt(t[n].replace(/\)/,""));this.arrIndices=t}else this.sid=e;return this.fullSid=e,this.dotSyntax=r,this.arrSyntax=i,this},P.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"input":this.inputs.push((new M).parse(r))}}return this},P.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],r=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=r.read();break;case"OUTPUT":this.output=r.read(),this.strideOut=r.accessor.stride;break;case"INTERPOLATION":this.interpolation=r.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.duration=this.endTime=this.startTime=0,this.input.length){for(this.startTime=1e8,this.endTime=-1e8,e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},P.prototype.getData=function(e,t){var r;if(1<this.strideOut){r=[];for(var t=t*this.strideOut,i=0;i<this.strideOut;++i)r[i]=this.output[t+i];if(3===this.strideOut)switch(e){case"rotate":case"translate":W(r,-1);break;case"scale":W(r,1)}}else r=this.output[t];return r},D.prototype.addTarget=function(e,t,r,i){this.targets.push({sid:e,member:r,transform:t,data:i})},D.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var r=this.targets[t];(!e||r.sid===e)&&r.transform.update(r.data,r.member)}},D.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},D.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},D.prototype.interpolate=function(e,t){for(var r=0;r<this.targets.length;++r){var i=this.targets[r],n=e.getTarget(i.sid);if(n){var o=(t-this.time)/(e.time-this.time),a=n.data,s=i.data;if((0>o||o>1)&&(console.log("Key.interpolate: Warning! Scale out of bounds:"+o),o=0>o?0:1),s.length)for(var n=[],l=0;l<s.length;++l)n[l]=s[l]+(a[l]-s[l])*o;else n=s+(a-s)*o}else n=i.data;i.transform.update(n,i.member)}},F.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"optics":this.parseOptics(r)}}return this},F.prototype.parseOptics=function(e){for(var t=0;t<e.childNodes.length;t++)if("technique_common"==e.childNodes[t].nodeName)for(var r=e.childNodes[t],i=0;i<r.childNodes.length;i++)if("perspective"==r.childNodes[i].nodeName)for(var n=r.childNodes[i],o=0;o<n.childNodes.length;o++){var a=n.childNodes[o];switch(a.nodeName){case"xfov":this.fov=a.textContent;break;case"znear":this.znear=.4;break;case"zfar":this.zfar=1e15;break;case"aspect_ratio":this.aspect_ratio=a.textContent}}return this},V.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},{load:function(t,r,i){var n=0;if(document.implementation&&document.implementation.createDocument){var o=new XMLHttpRequest;o.overrideMimeType&&o.overrideMimeType("text/xml"),o.onreadystatechange=function(){4==o.readyState?(0==o.status||200==o.status)&&(o.responseXML?(et=r,e(o.responseXML,void 0,t)):console.error("ColladaLoader: Empty or non-existing file ("+t+")")):3==o.readyState&&i&&(0==n&&(n=o.getResponseHeader("Content-Length")),i({total:n,loaded:o.responseText.length}))},o.open("GET",t,!0),o.send(null)}else alert("Don't know how to parse XML!")},parse:e,setPreferredShading:function(e){ct=e},applySkin:o,geometries:ot,options:ht}},t.JSONLoader=function(e){t.Loader.call(this,e)},t.JSONLoader.prototype=new t.Loader,t.JSONLoader.prototype.constructor=t.JSONLoader,t.JSONLoader.prototype.supr=t.Loader.prototype,t.JSONLoader.prototype.load=function(e,t,r){r=r?r:this.extractUrlBase(e),this.onLoadStart(),this.loadAjaxJSON(this,e,t,r)},t.JSONLoader.prototype.loadAjaxJSON=function(e,t,r,i,n){var o=new XMLHttpRequest,a=0;o.onreadystatechange=function(){if(o.readyState===o.DONE)if(200===o.status||0===o.status){if(o.responseText){var s=JSON.parse(o.responseText);e.createModel(s,r,i)}else console.warn("THREE.JSONLoader: ["+t+"] seems to be unreachable or file there is empty");e.onLoadComplete()}else console.error("THREE.JSONLoader: Couldn't load ["+t+"] ["+o.status+"]");else o.readyState===o.LOADING?n&&(0===a&&(a=o.getResponseHeader("Content-Length")),n({total:a,loaded:o.responseText.length})):o.readyState===o.HEADERS_RECEIVED&&(a=o.getResponseHeader("Content-Length"))},o.open("GET",t,!0),o.overrideMimeType&&o.overrideMimeType("text/plain; charset=x-user-defined"),o.setRequestHeader("Content-Type","text/plain"),o.send(null)},t.JSONLoader.prototype.createModel=function(e,r,i){var n=new t.Geometry,o=void 0!==e.scale?1/e.scale:1;this.initMaterials(n,e.materials,i),function(r){var i,o,a,s,l,c,h,p,d,u,f,m,g,b,v=e.faces;c=e.vertices;var x=e.normals,y=e.colors,w=0;for(i=0;i<e.uvs.length;i++)e.uvs[i].length&&w++;for(i=0;w>i;i++)n.faceUvs[i]=[],n.faceVertexUvs[i]=[];for(s=0,l=c.length;l>s;)h=new t.Vertex,h.position.x=c[s++]*r,h.position.y=c[s++]*r,h.position.z=c[s++]*r,n.vertices.push(h);for(s=0,l=v.length;l>s;){if(r=v[s++],c=1&r,a=2&r,i=4&r,o=8&r,p=16&r,h=32&r,u=64&r,r&=128,c?(f=new t.Face4,f.a=v[s++],f.b=v[s++],f.c=v[s++],f.d=v[s++],c=4):(f=new t.Face3,f.a=v[s++],f.b=v[s++],f.c=v[s++],c=3),a&&(a=v[s++],f.materialIndex=a),a=n.faces.length,i)for(i=0;w>i;i++)m=e.uvs[i],d=v[s++],b=m[2*d],d=m[2*d+1],n.faceUvs[i][a]=new t.UV(b,d);if(o)for(i=0;w>i;i++){for(m=e.uvs[i],g=[],o=0;c>o;o++)d=v[s++],b=m[2*d],d=m[2*d+1],g[o]=new t.UV(b,d);n.faceVertexUvs[i][a]=g}if(p&&(p=3*v[s++],o=new t.Vector3,o.x=x[p++],o.y=x[p++],o.z=x[p],f.normal=o),h)for(i=0;c>i;i++)p=3*v[s++],o=new t.Vector3,o.x=x[p++],o.y=x[p++],o.z=x[p],f.vertexNormals.push(o);if(u&&(h=v[s++],h=new t.Color(y[h]),f.color=h),r)for(i=0;c>i;i++)h=v[s++],h=new t.Color(y[h]),f.vertexColors.push(h);n.faces.push(f)}}(o),function(){var r,i,o,a;if(e.skinWeights)for(r=0,i=e.skinWeights.length;i>r;r+=2)o=e.skinWeights[r],a=e.skinWeights[r+1],n.skinWeights.push(new t.Vector4(o,a,0,0));if(e.skinIndices)for(r=0,i=e.skinIndices.length;i>r;r+=2)o=e.skinIndices[r],a=e.skinIndices[r+1],n.skinIndices.push(new t.Vector4(o,a,0,0));n.bones=e.bones,n.animation=e.animation}(),function(r){if(void 0!==e.morphTargets){var i,o,a,s,l,c,h,p,d;for(i=0,o=e.morphTargets.length;o>i;i++)for(n.morphTargets[i]={},n.morphTargets[i].name=e.morphTargets[i].name,n.morphTargets[i].vertices=[],p=n.morphTargets[i].vertices,d=e.morphTargets[i].vertices,a=0,s=d.length;s>a;a+=3)l=d[a]*r,c=d[a+1]*r,h=d[a+2]*r,p.push(new t.Vertex(new t.Vector3(l,c,h)))}if(void 0!==e.morphColors)for(i=0,o=e.morphColors.length;o>i;i++)for(n.morphColors[i]={},n.morphColors[i].name=e.morphColors[i].name,n.morphColors[i].colors=[],s=n.morphColors[i].colors,l=e.morphColors[i].colors,r=0,a=l.length;a>r;r+=3)c=new t.Color(16755200),c.setRGB(l[r],l[r+1],l[r+2]),s.push(c)}(o),n.computeCentroids(),n.computeFaceNormals(),this.hasNormals(n)&&n.computeTangents(),r(n)},t.SceneLoader=function(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){},this.callbackSync=function(){},this.callbackProgress=function(){}},t.SceneLoader.prototype.constructor=t.SceneLoader,t.SceneLoader.prototype.load=function(e,t){var r=this,i=new XMLHttpRequest;i.onreadystatechange=function(){if(4==i.readyState)if(200==i.status||0==i.status){var n=JSON.parse(i.responseText);r.createScene(n,t,e)}else console.error("THREE.SceneLoader: Couldn't load ["+e+"] ["+i.status+"]")},i.open("GET",e,!0),i.overrideMimeType&&i.overrideMimeType("text/plain; charset=x-user-defined"),i.setRequestHeader("Content-Type","text/plain"),i.send(null)
},t.SceneLoader.prototype.createScene=function(e,r,i){function n(e,t){return"relativeToHTML"==t?e:V+"/"+e}function o(){var e;for(p in E.objects)if(!D.objects[p])if(g=E.objects[p],void 0!==g.geometry){if(k=D.geometries[g.geometry]){if(e=!1,T=D.materials[g.materials[0]],(e=T instanceof t.ShaderMaterial)&&k.computeTangents(),x=g.position,y=g.rotation,w=g.quaternion,_=g.scale,w=0,0==g.materials.length&&(T=new t.MeshFaceMaterial),1<g.materials.length&&(T=new t.MeshFaceMaterial),e=new t.Mesh(k,T),e.name=p,e.position.set(x[0],x[1],x[2]),w?(e.quaternion.set(w[0],w[1],w[2],w[3]),e.useQuaternion=!0):e.rotation.set(y[0],y[1],y[2]),e.scale.set(_[0],_[1],_[2]),e.visible=g.visible,D.scene.add(e),D.objects[p]=e,g.castsShadow){var r=new t.ShadowVolume(k);D.scene.add(r),r.position=e.position,r.rotation=e.rotation,r.scale=e.scale}g.trigger&&"none"!=g.trigger.toLowerCase()&&(r={type:g.trigger,object:g},D.triggers[e.name]=r)}}else x=g.position,y=g.rotation,w=g.quaternion,_=g.scale,w=0,e=new t.Object3D,e.name=p,e.position.set(x[0],x[1],x[2]),w?(e.quaternion.set(w[0],w[1],w[2],w[3]),e.useQuaternion=!0):e.rotation.set(y[0],y[1],y[2]),e.scale.set(_[0],_[1],_[2]),e.visible=void 0!==g.visible?g.visible:!1,D.scene.add(e),D.objects[p]=e,D.empties[p]=e,g.trigger&&"none"!=g.trigger.toLowerCase()&&(r={type:g.trigger,object:g},D.triggers[e.name]=r)}function a(e){return function(t){D.geometries[e]=t,o(),R-=1,F.onLoadComplete(),l()}}function s(e){return function(t){D.geometries[e]=t}}function l(){F.callbackProgress({totalModels:N,totalTextures:P,loadedModels:N-R,loadedTextures:P-z},D),F.onLoadProgress(),0==R&&0==z&&r(D)}var c,h,p,d,u,f,m,g,b,v,x,y,w,_,M,S,k,T,C,A,E,L,R,z,N,P,D,F=this,V=t.Loader.prototype.extractUrlBase(i);E=e,i=new t.BinaryLoader,L=new t.JSONLoader,z=R=0,D={scene:new t.Scene,geometries:{},materials:{},textures:{},objects:{},cameras:{},lights:{},fogs:{},triggers:{},empties:{}},E.transform&&(e=E.transform.position,b=E.transform.rotation,M=E.transform.scale,e&&D.scene.position.set(e[0],e[1],e[2]),b&&D.scene.rotation.set(b[0],b[1],b[2]),M&&D.scene.scale.set(M[0],M[1],M[2]),(e||b||M)&&D.scene.updateMatrix()),e=function(){z-=1,l(),F.onLoadComplete()};for(u in E.cameras)M=E.cameras[u],"perspective"==M.type?C=new t.PerspectiveCamera(M.fov,M.aspect,M.near,M.far):"ortho"==M.type&&(C=new t.OrthographicCamera(M.left,M.right,M.top,M.bottom,M.near,M.far)),x=M.position,b=M.target,M=M.up,C.position.set(x[0],x[1],x[2]),C.target=new t.Vector3(b[0],b[1],b[2]),M&&C.up.set(M[0],M[1],M[2]),D.cameras[u]=C;for(d in E.lights)b=E.lights[d],u=void 0!==b.color?b.color:16777215,C=void 0!==b.intensity?b.intensity:1,"directional"==b.type?(x=b.direction,v=new t.DirectionalLight(u,C),v.position.set(x[0],x[1],x[2]),v.position.normalize()):"point"==b.type?(x=b.position,v=b.distance,v=new t.PointLight(u,C,v),v.position.set(x[0],x[1],x[2])):"ambient"==b.type&&(v=new t.AmbientLight(u)),D.scene.add(v),D.lights[d]=v;for(f in E.fogs)d=E.fogs[f],"linear"==d.type?A=new t.Fog(0,d.near,d.far):"exp2"==d.type&&(A=new t.FogExp2(0,d.density)),M=d.color,A.color.setRGB(M[0],M[1],M[2]),D.fogs[f]=A;D.cameras&&E.defaults.camera&&(D.currentCamera=D.cameras[E.defaults.camera]),D.fogs&&E.defaults.fog&&(D.scene.fog=D.fogs[E.defaults.fog]),M=E.defaults.bgcolor,D.bgColor=new t.Color,D.bgColor.setRGB(M[0],M[1],M[2]),D.bgColorAlpha=E.defaults.bgalpha;for(c in E.geometries)f=E.geometries[c],("bin_mesh"==f.type||"ascii_mesh"==f.type)&&(R+=1,F.onLoadStart());N=R;for(c in E.geometries)f=E.geometries[c],"cube"==f.type?(k=new t.CubeGeometry(f.width,f.height,f.depth,f.segmentsWidth,f.segmentsHeight,f.segmentsDepth,null,f.flipped,f.sides),D.geometries[c]=k):"plane"==f.type?(k=new t.PlaneGeometry(f.width,f.height,f.segmentsWidth,f.segmentsHeight),D.geometries[c]=k):"sphere"==f.type?(k=new t.SphereGeometry(f.radius,f.segmentsWidth,f.segmentsHeight),D.geometries[c]=k):"cylinder"==f.type?(k=new t.CylinderGeometry(f.topRad,f.botRad,f.height,f.radSegs,f.heightSegs),D.geometries[c]=k):"torus"==f.type?(k=new t.TorusGeometry(f.radius,f.tube,f.segmentsR,f.segmentsT),D.geometries[c]=k):"icosahedron"==f.type?(k=new t.IcosahedronGeometry(f.radius,f.subdivisions),D.geometries[c]=k):"bin_mesh"==f.type?i.load(n(f.url,E.urlBaseType),a(c)):"ascii_mesh"==f.type?L.load(n(f.url,E.urlBaseType),a(c)):"embedded_mesh"==f.type&&(f=E.embeds[f.id],f.metadata=E.metadata,f&&L.createModel(f,s(c),""));for(m in E.textures)if(c=E.textures[m],c.url instanceof Array)for(z+=c.url.length,f=0;f<c.url.length;f++)F.onLoadStart();else z+=1,F.onLoadStart();P=z;for(m in E.textures){if(c=E.textures[m],void 0!=c.mapping&&void 0!=t[c.mapping]&&(c.mapping=new t[c.mapping]),c.url instanceof Array){for(f=[],A=0;A<c.url.length;A++)f[A]=n(c.url[A],E.urlBaseType);f=t.ImageUtils.loadTextureCube(f,c.mapping,e)}else f=t.ImageUtils.loadTexture(n(c.url,E.urlBaseType),c.mapping,e),void 0!=t[c.minFilter]&&(f.minFilter=t[c.minFilter]),void 0!=t[c.magFilter]&&(f.magFilter=t[c.magFilter]),c.repeat&&(f.repeat.set(c.repeat[0],c.repeat[1]),1!=c.repeat[0]&&(f.wrapS=t.RepeatWrapping),1!=c.repeat[1]&&(f.wrapT=t.RepeatWrapping)),c.offset&&f.offset.set(c.offset[0],c.offset[1]),c.wrap&&(A={repeat:t.RepeatWrapping,mirror:t.MirroredRepeatWrapping},void 0!==A[c.wrap[0]]&&(f.wrapS=A[c.wrap[0]]),void 0!==A[c.wrap[1]]&&(f.wrapT=A[c.wrap[1]]));D.textures[m]=f}for(h in E.materials){m=E.materials[h];for(S in m.parameters)"envMap"==S||"map"==S||"lightMap"==S?m.parameters[S]=D.textures[m.parameters[S]]:"shading"==S?m.parameters[S]="flat"==m.parameters[S]?t.FlatShading:t.SmoothShading:"blending"==S?m.parameters[S]=t[m.parameters[S]]?t[m.parameters[S]]:t.NormalBlending:"combine"==S?m.parameters[S]="MixOperation"==m.parameters[S]?t.MixOperation:t.MultiplyOperation:"vertexColors"==S&&("face"==m.parameters[S]?m.parameters[S]=t.FaceColors:m.parameters[S]&&(m.parameters[S]=t.VertexColors));void 0!==m.parameters.opacity&&1>m.parameters.opacity&&(m.parameters.transparent=!0),m.parameters.normalMap?(e=t.ShaderUtils.lib.normal,c=t.UniformsUtils.clone(e.uniforms),f=m.parameters.color,A=m.parameters.specular,i=m.parameters.ambient,L=m.parameters.shininess,c.tNormal.texture=D.textures[m.parameters.normalMap],m.parameters.normalMapFactor&&(c.uNormalScale.value=m.parameters.normalMapFactor),m.parameters.map&&(c.tDiffuse.texture=m.parameters.map,c.enableDiffuse.value=!0),m.parameters.lightMap&&(c.tAO.texture=m.parameters.lightMap,c.enableAO.value=!0),m.parameters.specularMap&&(c.tSpecular.texture=D.textures[m.parameters.specularMap],c.enableSpecular.value=!0),c.uDiffuseColor.value.setHex(f),c.uSpecularColor.value.setHex(A),c.uAmbientColor.value.setHex(i),c.uShininess.value=L,m.parameters.opacity&&(c.uOpacity.value=m.parameters.opacity),T=new t.ShaderMaterial({fragmentShader:e.fragmentShader,vertexShader:e.vertexShader,uniforms:c,lights:!0,fog:!0})):T=new t[m.type](m.parameters),D.materials[h]=T}o(),F.callbackSync(D),l()},t.UTF8Loader=function(){},t.UTF8Loader.prototype.load=function(e,r,i){var n=new XMLHttpRequest,o=void 0!==i.scale?i.scale:1,a=void 0!==i.offsetX?i.offsetX:0,s=void 0!==i.offsetY?i.offsetY:0,l=void 0!==i.offsetZ?i.offsetZ:0;n.onreadystatechange=function(){4==n.readyState?200==n.status||0==n.status?t.UTF8Loader.prototype.createModel(n.responseText,r,o,a,s,l):console.error("THREE.UTF8Loader: Couldn't load ["+e+"] ["+n.status+"]"):3!=n.readyState&&2==n.readyState&&n.getResponseHeader("Content-Length")},n.open("GET",e,!0),n.send(null)},t.UTF8Loader.prototype.decompressMesh=function(e){var t=e.charCodeAt(0);t>=57344&&(t-=2048),t++;for(var r=new Float32Array(8*t),i=1,n=0;8>n;n++){for(var o=0,a=0;t>a;++a){var s=e.charCodeAt(a+i),o=o+(s>>1^-(1&s));r[8*a+n]=o}i+=t}for(t=e.length-i,o=new Uint16Array(t),n=a=0;t>n;n++)s=e.charCodeAt(n+i),o[n]=a-s,0==s&&a++;return[r,o]},t.UTF8Loader.prototype.createModel=function(e,r,i,n,o,a){var s=function(){var r=this;r.materials=[],t.Geometry.call(this);var s=t.UTF8Loader.prototype.decompressMesh(e),l=[],c=[];!function(e,s,l){for(var c,h,p,d=e.length;d>l;l+=s)c=e[l],h=e[l+1],p=e[l+2],c=c/16383*i,h=h/16383*i,p=p/16383*i,c+=n,h+=o,p+=a,r.vertices.push(new t.Vertex(new t.Vector3(c,h,p)))}(s[0],8,0),function(e,t,r){for(var i,n,o=e.length;o>r;r+=t)i=e[r],n=e[r+1],i/=1023,n/=1023,c.push(i,1-n)}(s[0],8,3),function(e,t,r){for(var i,n,o,a=e.length;a>r;r+=t)i=e[r],n=e[r+1],o=e[r+2],i=(i-512)/511,n=(n-512)/511,o=(o-512)/511,l.push(i,n,o)}(s[0],8,5),function(e){var i,n,o,a,s,h,p,d,u,f=e.length;for(i=0;f>i;i+=3){n=e[i],o=e[i+1],a=e[i+2],s=r,d=n,u=o,h=a;var m=l[3*o],g=l[3*o+1],b=l[3*o+2],v=l[3*a],x=l[3*a+1],y=l[3*a+2];p=new t.Vector3(l[3*n],l[3*n+1],l[3*n+2]),m=new t.Vector3(m,g,b),v=new t.Vector3(v,x,y),s.faces.push(new t.Face3(d,u,h,[p,m,v],null,0)),s=c[2*n],n=c[2*n+1],h=c[2*o],p=c[2*o+1],d=c[2*a],u=c[2*a+1],a=r.faceVertexUvs[0],o=h,h=p,p=[],p.push(new t.UV(s,n)),p.push(new t.UV(o,h)),p.push(new t.UV(d,u)),a.push(p)}}(s[1]),this.computeCentroids(),this.computeFaceNormals()};s.prototype=new t.Geometry,s.prototype.constructor=s,r(new s)},t.MarchingCubes=function(e,r){t.Object3D.call(this),this.material=r,this.init=function(e){this.resolution=e,this.isolation=80,this.size=e,this.size2=this.size*this.size,this.size3=this.size2*this.size,this.halfsize=this.size/2,this.delta=2/this.size,this.yd=this.size,this.zd=this.size2,this.field=new Float32Array(this.size3),this.normal_cache=new Float32Array(3*this.size3),this.vlist=new Float32Array(36),this.nlist=new Float32Array(36),this.firstDraw=!0,this.maxCount=4096,this.count=0,this.hasNormal=this.hasPos=!1,this.positionArray=new Float32Array(3*this.maxCount),this.normalArray=new Float32Array(3*this.maxCount)},this.lerp=function(e,t,r){return e+(t-e)*r},this.VIntX=function(e,t,r,i,n,o,a,s,l,c){n=(n-l)/(c-l),l=this.normal_cache,t[i]=o+n*this.delta,t[i+1]=a,t[i+2]=s,r[i]=this.lerp(l[e],l[e+3],n),r[i+1]=this.lerp(l[e+1],l[e+4],n),r[i+2]=this.lerp(l[e+2],l[e+5],n)},this.VIntY=function(e,t,r,i,n,o,a,s,l,c){n=(n-l)/(c-l),l=this.normal_cache,t[i]=o,t[i+1]=a+n*this.delta,t[i+2]=s,t=e+3*this.yd,r[i]=this.lerp(l[e],l[t],n),r[i+1]=this.lerp(l[e+1],l[t+1],n),r[i+2]=this.lerp(l[e+2],l[t+2],n)},this.VIntZ=function(e,t,r,i,n,o,a,s,l,c){n=(n-l)/(c-l),l=this.normal_cache,t[i]=o,t[i+1]=a,t[i+2]=s+n*this.delta,t=e+3*this.zd,r[i]=this.lerp(l[e],l[t],n),r[i+1]=this.lerp(l[e+1],l[t+1],n),r[i+2]=this.lerp(l[e+2],l[t+2],n)},this.compNorm=function(e){var t=3*e;0===this.normal_cache[t]&&(this.normal_cache[t]=this.field[e-1]-this.field[e+1],this.normal_cache[t+1]=this.field[e-this.yd]-this.field[e+this.yd],this.normal_cache[t+2]=this.field[e-this.zd]-this.field[e+this.zd])},this.polygonize=function(e,r,i,n,o,a){var s=n+1,l=n+this.yd,c=n+this.zd,h=s+this.yd,p=s+this.zd,d=n+this.yd+this.zd,u=s+this.yd+this.zd,f=0,m=this.field[n],g=this.field[s],b=this.field[l],v=this.field[h],x=this.field[c],y=this.field[p],w=this.field[d],_=this.field[u];o>m&&(f|=1),o>g&&(f|=2),o>b&&(f|=8),o>v&&(f|=4),o>x&&(f|=16),o>y&&(f|=32),o>w&&(f|=128),o>_&&(f|=64);var M=t.edgeTable[f];if(0===M)return 0;var S=this.delta,k=e+S,T=r+S,S=i+S;for(1&M&&(this.compNorm(n),this.compNorm(s),this.VIntX(3*n,this.vlist,this.nlist,0,o,e,r,i,m,g)),2&M&&(this.compNorm(s),this.compNorm(h),this.VIntY(3*s,this.vlist,this.nlist,3,o,k,r,i,g,v)),4&M&&(this.compNorm(l),this.compNorm(h),this.VIntX(3*l,this.vlist,this.nlist,6,o,e,T,i,b,v)),8&M&&(this.compNorm(n),this.compNorm(l),this.VIntY(3*n,this.vlist,this.nlist,9,o,e,r,i,m,b)),16&M&&(this.compNorm(c),this.compNorm(p),this.VIntX(3*c,this.vlist,this.nlist,12,o,e,r,S,x,y)),32&M&&(this.compNorm(p),this.compNorm(u),this.VIntY(3*p,this.vlist,this.nlist,15,o,k,r,S,y,_)),64&M&&(this.compNorm(d),this.compNorm(u),this.VIntX(3*d,this.vlist,this.nlist,18,o,e,T,S,w,_)),128&M&&(this.compNorm(c),this.compNorm(d),this.VIntY(3*c,this.vlist,this.nlist,21,o,e,r,S,x,w)),256&M&&(this.compNorm(n),this.compNorm(c),this.VIntZ(3*n,this.vlist,this.nlist,24,o,e,r,i,m,x)),512&M&&(this.compNorm(s),this.compNorm(p),this.VIntZ(3*s,this.vlist,this.nlist,27,o,k,r,i,g,y)),1024&M&&(this.compNorm(h),this.compNorm(u),this.VIntZ(3*h,this.vlist,this.nlist,30,o,k,T,i,v,_)),2048&M&&(this.compNorm(l),this.compNorm(d),this.VIntZ(3*l,this.vlist,this.nlist,33,o,e,T,i,b,w)),f<<=4,o=n=0;-1!=t.triTable[f+o];)e=f+o,r=e+1,i=e+2,this.posnormtriv(this.vlist,this.nlist,3*t.triTable[e],3*t.triTable[r],3*t.triTable[i],a),o+=3,n++;return n},this.posnormtriv=function(e,t,r,i,n,o){var a=3*this.count;this.positionArray[a]=e[r],this.positionArray[a+1]=e[r+1],this.positionArray[a+2]=e[r+2],this.positionArray[a+3]=e[i],this.positionArray[a+4]=e[i+1],this.positionArray[a+5]=e[i+2],this.positionArray[a+6]=e[n],this.positionArray[a+7]=e[n+1],this.positionArray[a+8]=e[n+2],this.normalArray[a]=t[r],this.normalArray[a+1]=t[r+1],this.normalArray[a+2]=t[r+2],this.normalArray[a+3]=t[i],this.normalArray[a+4]=t[i+1],this.normalArray[a+5]=t[i+2],this.normalArray[a+6]=t[n],this.normalArray[a+7]=t[n+1],this.normalArray[a+8]=t[n+2],this.hasNormal=this.hasPos=!0,this.count+=3,this.count>=this.maxCount-3&&o(this)},this.begin=function(){this.count=0,this.hasNormal=this.hasPos=!1},this.end=function(e){if(0!==this.count){for(var t=3*this.count;t<this.positionArray.length;t++)this.positionArray[t]=0;e(this)}},this.addBall=function(e,t,r,i,n){var o=this.size*Math.sqrt(i/n),a=r*this.size,s=t*this.size,l=e*this.size,c=Math.floor(a-o);1>c&&(c=1),a=Math.floor(a+o),a>this.size-1&&(a=this.size-1);var h=Math.floor(s-o);1>h&&(h=1),s=Math.floor(s+o),s>this.size-1&&(s=this.size-1);var p=Math.floor(l-o);1>p&&(p=1),o=Math.floor(l+o),o>this.size-1&&(o=this.size-1);for(var d,u,f,m,g,b,v,l=c;a>l;l++)for(f=this.size2*l,g=l/this.size-r,b=g*g,c=h;s>c;c++)for(u=f+this.size*c,d=c/this.size-t,v=d*d,d=p;o>d;d++)m=d/this.size-e,m=i/(1e-6+m*m+v+b)-n,m>0&&(this.field[u+d]+=m)},this.addPlaneX=function(e,t){var r,i,n,o,a,s=this.size,l=this.yd,c=this.zd,h=this.field,p=s*Math.sqrt(e/t);for(p>s&&(p=s),r=0;p>r;r++)if(i=r/s,i*=i,o=e/(1e-4+i)-t,o>0)for(i=0;s>i;i++)for(a=r+i*l,n=0;s>n;n++)h[c*n+a]+=o},this.addPlaneY=function(e,t){var r,i,n,o,a,s,l=this.size,c=this.yd,h=this.zd,p=this.field,d=l*Math.sqrt(e/t);for(d>l&&(d=l),i=0;d>i;i++)if(r=i/l,r*=r,o=e/(1e-4+r)-t,o>0)for(a=i*c,r=0;l>r;r++)for(s=a+r,n=0;l>n;n++)p[h*n+s]+=o},this.addPlaneZ=function(e,t){var r,i,n,o,a,s,l=this.size,c=this.yd,h=this.zd,p=this.field,d=l*Math.sqrt(e/t);for(d>l&&(d=l),n=0;d>n;n++)if(r=n/l,r*=r,o=e/(1e-4+r)-t,o>0)for(a=h*n,i=0;l>i;i++)for(s=a+i*c,r=0;l>r;r++)p[s+r]+=o},this.reset=function(){var e;for(e=0;e<this.size3;e++)this.normal_cache[3*e]=0,this.field[e]=0},this.render=function(e){this.begin();var t,r,i,n,o,a,s,l,c,h=this.size-2;for(n=1;h>n;n++)for(c=this.size2*n,s=(n-this.halfsize)/this.halfsize,i=1;h>i;i++)for(l=c+this.size*i,a=(i-this.halfsize)/this.halfsize,r=1;h>r;r++)o=(r-this.halfsize)/this.halfsize,t=l+r,this.polygonize(o,a,s,t,this.isolation,e);this.end(e)},this.generateGeometry=function(){var e=0,r=new t.Geometry,i=[];return this.render(function(n){var o,a,s,l,c,h,p,d;for(o=0;o<n.count;o++)p=3*o,c=p+1,d=p+2,a=n.positionArray[p],s=n.positionArray[c],l=n.positionArray[d],h=new t.Vector3(a,s,l),a=n.normalArray[p],s=n.normalArray[c],l=n.normalArray[d],p=new t.Vector3(a,s,l),p.normalize(),c=new t.Vertex(h),r.vertices.push(c),i.push(p);for(h=n.count/3,o=0;h>o;o++)p=3*(e+o),c=p+1,d=p+2,a=i[p],s=i[c],l=i[d],p=new t.Face3(p,c,d,[a,s,l]),r.faces.push(p);e+=h,n.count=0}),r},this.init(e)},t.MarchingCubes.prototype=new t.Object3D,t.MarchingCubes.prototype.constructor=t.MarchingCubes,t.edgeTable=new Int32Array([0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0]),t.triTable=new Int32Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),t.LensFlare=function(e,r,i,n,o){t.Object3D.call(this),this.lensFlares=[],this.positionScreen=new t.Vector3,this.customUpdateCallback=void 0,void 0!==e&&this.add(e,r,i,n,o)},t.LensFlare.prototype=new t.Object3D,t.LensFlare.prototype.constructor=t.LensFlare,t.LensFlare.prototype.supr=t.Object3D.prototype,t.LensFlare.prototype.add=function(e,r,i,n,o,a){void 0===r&&(r=-1),void 0===i&&(i=0),void 0===a&&(a=1),void 0===o&&(o=new t.Color(16777215)),void 0===n&&(n=t.NormalBlending),i=Math.min(i,Math.max(0,i)),this.lensFlares.push({texture:e,size:r,distance:i,x:0,y:0,z:0,scale:1,rotation:1,opacity:a,color:o,blending:n})},t.LensFlare.prototype.updateLensFlares=function(){var e,t,r=this.lensFlares.length,i=2*-this.positionScreen.x,n=2*-this.positionScreen.y;for(e=0;r>e;e++)t=this.lensFlares[e],t.x=this.positionScreen.x+i*t.distance,t.y=this.positionScreen.y+n*t.distance,t.wantedRotation=.25*t.x*Math.PI,t.rotation+=.25*(t.wantedRotation-t.rotation)},t.LensFlarePlugin=function(){function e(e){var t=r.createProgram(),i=r.createShader(r.FRAGMENT_SHADER),n=r.createShader(r.VERTEX_SHADER);return r.shaderSource(i,e.fragmentShader),r.shaderSource(n,e.vertexShader),r.compileShader(i),r.compileShader(n),r.attachShader(t,i),r.attachShader(t,n),r.linkProgram(t),t}var r,i,n,o,a,s,l,c,h,p,d,u,f;this.init=function(m){r=m.context,i=m,n=new Float32Array(16),o=new Uint16Array(6),m=0,n[m++]=-1,n[m++]=-1,n[m++]=0,n[m++]=0,n[m++]=1,n[m++]=-1,n[m++]=1,n[m++]=0,n[m++]=1,n[m++]=1,n[m++]=1,n[m++]=1,n[m++]=-1,n[m++]=1,n[m++]=0,n[m++]=1,m=0,o[m++]=0,o[m++]=1,o[m++]=2,o[m++]=0,o[m++]=2,o[m++]=3,a=r.createBuffer(),s=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,a),r.bufferData(r.ARRAY_BUFFER,n,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,s),r.bufferData(r.ELEMENT_ARRAY_BUFFER,o,r.STATIC_DRAW),l=r.createTexture(),c=r.createTexture(),r.bindTexture(r.TEXTURE_2D,l),r.texImage2D(r.TEXTURE_2D,0,r.RGB,16,16,0,r.RGB,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.bindTexture(r.TEXTURE_2D,c),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,16,16,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),0>=r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS)?(h=!1,p=e(t.ShaderFlares.lensFlare)):(h=!0,p=e(t.ShaderFlares.lensFlareVertexTexture)),d={},u={},d.vertex=r.getAttribLocation(p,"position"),d.uv=r.getAttribLocation(p,"uv"),u.renderType=r.getUniformLocation(p,"renderType"),u.map=r.getUniformLocation(p,"map"),u.occlusionMap=r.getUniformLocation(p,"occlusionMap"),u.opacity=r.getUniformLocation(p,"opacity"),u.color=r.getUniformLocation(p,"color"),u.scale=r.getUniformLocation(p,"scale"),u.rotation=r.getUniformLocation(p,"rotation"),u.screenPosition=r.getUniformLocation(p,"screenPosition"),f=!1},this.render=function(e,n,o,m){var e=e.__webglFlares,g=e.length;if(g){var b=new t.Vector3,v=m/o,x=.5*o,y=.5*m,w=16/m,_=new t.Vector2(w*v,w),M=new t.Vector3(1,1,0),S=new t.Vector2(1,1),k=u,w=d;r.useProgram(p),f||(r.enableVertexAttribArray(d.vertex),r.enableVertexAttribArray(d.uv),f=!0),r.uniform1i(k.occlusionMap,0),r.uniform1i(k.map,1),r.bindBuffer(r.ARRAY_BUFFER,a),r.vertexAttribPointer(w.vertex,2,r.FLOAT,!1,16,0),r.vertexAttribPointer(w.uv,2,r.FLOAT,!1,16,8),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,s),r.disable(r.CULL_FACE),r.depthMask(!1);var T,C,A,E,L;for(T=0;g>T;T++)if(w=16/m,_.set(w*v,w),E=e[T],b.set(E.matrixWorld.n14,E.matrixWorld.n24,E.matrixWorld.n34),n.matrixWorldInverse.multiplyVector3(b),n.projectionMatrix.multiplyVector3(b),M.copy(b),S.x=M.x*x+x,S.y=M.y*y+y,h||0<S.x&&S.x<o&&0<S.y&&S.y<m)for(r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,l),r.copyTexImage2D(r.TEXTURE_2D,0,r.RGB,S.x-8,S.y-8,16,16,0),r.uniform1i(k.renderType,0),r.uniform2f(k.scale,_.x,_.y),r.uniform3f(k.screenPosition,M.x,M.y,M.z),r.disable(r.BLEND),r.enable(r.DEPTH_TEST),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,c),r.copyTexImage2D(r.TEXTURE_2D,0,r.RGBA,S.x-8,S.y-8,16,16,0),r.uniform1i(k.renderType,1),r.disable(r.DEPTH_TEST),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,l),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0),E.positionScreen.copy(M),E.customUpdateCallback?E.customUpdateCallback(E):E.updateLensFlares(),r.uniform1i(k.renderType,2),r.enable(r.BLEND),C=0,A=E.lensFlares.length;A>C;C++)L=E.lensFlares[C],.001<L.opacity&&.001<L.scale&&(M.x=L.x,M.y=L.y,M.z=L.z,w=L.size*L.scale/m,_.x=w*v,_.y=w,r.uniform3f(k.screenPosition,M.x,M.y,M.z),r.uniform2f(k.scale,_.x,_.y),r.uniform1f(k.rotation,L.rotation),r.uniform1f(k.opacity,L.opacity),r.uniform3f(k.color,L.color.r,L.color.g,L.color.b),i.setBlending(L.blending),i.setTexture(L.texture,1),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0));r.enable(r.CULL_FACE),r.enable(r.DEPTH_TEST),r.depthMask(!0)
}}},t.ShadowMapPlugin=function(){var e,r,i,n,o=new t.Frustum,a=new t.Matrix4,s=new t.Vector3,l=new t.Vector3;this.init=function(o){e=o.context,r=o;var o=t.ShaderLib.depthRGBA,a=t.UniformsUtils.clone(o.uniforms);i=new t.ShaderMaterial({fragmentShader:o.fragmentShader,vertexShader:o.vertexShader,uniforms:a}),n=new t.ShaderMaterial({fragmentShader:o.fragmentShader,vertexShader:o.vertexShader,uniforms:a,morphTargets:!0}),i._shadowPass=!0,n._shadowPass=!0},this.render=function(e,t){r.shadowMapEnabled&&r.shadowMapAutoUpdate&&this.update(e,t)},this.update=function(c,h){var p,d,u,f,m,g,b,v,x,y=[];for(f=0,e.clearColor(1,1,1,1),e.disable(e.BLEND),r.shadowMapCullFrontFaces&&e.cullFace(e.FRONT),r.setDepthTest(!0),p=0,d=c.__lights.length;d>p;p++)if(u=c.__lights[p],u.castShadow)if(u instanceof t.DirectionalLight&&u.shadowCascade)for(m=0;m<u.shadowCascadeCount;m++){var w;if(u.shadowCascadeArray[m])w=u.shadowCascadeArray[m];else{x=u,b=m,w=new t.DirectionalLight,w.isVirtual=!0,w.onlyShadow=!0,w.castShadow=!0,w.shadowCameraNear=x.shadowCameraNear,w.shadowCameraFar=x.shadowCameraFar,w.shadowCameraLeft=x.shadowCameraLeft,w.shadowCameraRight=x.shadowCameraRight,w.shadowCameraBottom=x.shadowCameraBottom,w.shadowCameraTop=x.shadowCameraTop,w.shadowCameraVisible=x.shadowCameraVisible,w.shadowDarkness=x.shadowDarkness,w.shadowBias=x.shadowCascadeBias[b],w.shadowMapWidth=x.shadowCascadeWidth[b],w.shadowMapHeight=x.shadowCascadeHeight[b],w.pointsWorld=[],w.pointsFrustum=[],v=w.pointsWorld,g=w.pointsFrustum;for(var _=0;8>_;_++)v[_]=new t.Vector3,g[_]=new t.Vector3;v=x.shadowCascadeNearZ[b],x=x.shadowCascadeFarZ[b],g[0].set(-1,-1,v),g[1].set(1,-1,v),g[2].set(-1,1,v),g[3].set(1,1,v),g[4].set(-1,-1,x),g[5].set(1,-1,x),g[6].set(-1,1,x),g[7].set(1,1,x),w.originalCamera=h,g=new t.Gyroscope,g.position=u.shadowCascadeOffset,g.add(w),g.add(w.target),h.add(g),u.shadowCascadeArray[m]=w,console.log("Created virtualLight",w)}b=u,v=m,x=b.shadowCascadeArray[v],x.position.copy(b.position),x.target.position.copy(b.target.position),x.lookAt(x.target),x.shadowCameraVisible=b.shadowCameraVisible,x.shadowDarkness=b.shadowDarkness,x.shadowBias=b.shadowCascadeBias[v],g=b.shadowCascadeNearZ[v],b=b.shadowCascadeFarZ[v],x=x.pointsFrustum,x[0].z=g,x[1].z=g,x[2].z=g,x[3].z=g,x[4].z=b,x[5].z=b,x[6].z=b,x[7].z=b,y[f]=w,f++}else y[f]=u,f++;for(p=0,d=y.length;d>p;p++){if(u=y[p],u.shadowMap||(u.shadowMap=new t.WebGLRenderTarget(u.shadowMapWidth,u.shadowMapHeight,{minFilter:t.LinearFilter,magFilter:t.LinearFilter,format:t.RGBAFormat}),u.shadowMapSize=new t.Vector2(u.shadowMapWidth,u.shadowMapHeight),u.shadowMatrix=new t.Matrix4),!u.shadowCamera){if(u instanceof t.SpotLight)u.shadowCamera=new t.PerspectiveCamera(u.shadowCameraFov,u.shadowMapWidth/u.shadowMapHeight,u.shadowCameraNear,u.shadowCameraFar);else{if(!(u instanceof t.DirectionalLight)){console.error("Unsupported light type for shadow");continue}u.shadowCamera=new t.OrthographicCamera(u.shadowCameraLeft,u.shadowCameraRight,u.shadowCameraTop,u.shadowCameraBottom,u.shadowCameraNear,u.shadowCameraFar)}c.add(u.shadowCamera),r.autoUpdateScene&&c.updateMatrixWorld()}if(u.shadowCameraVisible&&!u.cameraHelper&&(u.cameraHelper=new t.CameraHelper(u.shadowCamera),u.shadowCamera.add(u.cameraHelper)),u.isVirtual&&w.originalCamera==h){for(m=h,f=u.shadowCamera,g=u.pointsFrustum,x=u.pointsWorld,s.set(1/0,1/0,1/0),l.set(-1/0,-1/0,-1/0),b=0;8>b;b++)v=x[b],v.copy(g[b]),t.ShadowMapPlugin.__projector.unprojectVector(v,m),f.matrixWorldInverse.multiplyVector3(v),v.x<s.x&&(s.x=v.x),v.x>l.x&&(l.x=v.x),v.y<s.y&&(s.y=v.y),v.y>l.y&&(l.y=v.y),v.z<s.z&&(s.z=v.z),v.z>l.z&&(l.z=v.z);f.left=s.x,f.right=l.x,f.top=l.y,f.bottom=s.y,f.updateProjectionMatrix()}for(f=u.shadowMap,g=u.shadowMatrix,m=u.shadowCamera,m.position.copy(u.matrixWorld.getPosition()),m.lookAt(u.target.matrixWorld.getPosition()),m.updateMatrixWorld(),m.matrixWorldInverse.getInverse(m.matrixWorld),u.cameraHelper&&(u.cameraHelper.lines.visible=u.shadowCameraVisible),u.shadowCameraVisible&&u.cameraHelper.update(u.shadowCamera),g.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),g.multiplySelf(m.projectionMatrix),g.multiplySelf(m.matrixWorldInverse),m._viewMatrixArray||(m._viewMatrixArray=new Float32Array(16)),m.matrixWorldInverse.flattenToArray(m._viewMatrixArray),m._projectionMatrixArray||(m._projectionMatrixArray=new Float32Array(16)),m.projectionMatrix.flattenToArray(m._projectionMatrixArray),a.multiply(m.projectionMatrix,m.matrixWorldInverse),o.setFromMatrix(a),r.setRenderTarget(f),r.clear(),x=c.__webglObjects,u=0,f=x.length;f>u;u++)b=x[u],g=b.object,b.render=!1,!g.visible||!g.castShadow||g instanceof t.Mesh&&g.frustumCulled&&!o.contains(g)||(g.matrixWorld.flattenToArray(g._objectMatrixArray),g._modelViewMatrix.multiplyToArray(m.matrixWorldInverse,g.matrixWorld,g._modelViewMatrixArray),b.render=!0);for(u=0,f=x.length;f>u;u++)b=x[u],b.render&&(g=b.object,b=b.buffer,r.setObjectFaces(g),v=g.customDepthMaterial?g.customDepthMaterial:g.geometry.morphTargets.length?n:i,b instanceof t.BufferGeometry?r.renderBufferDirect(m,c.__lights,null,v,b,g):r.renderBuffer(m,c.__lights,null,v,b,g));for(x=c.__webglObjectsImmediate,u=0,f=x.length;f>u;u++)b=x[u],g=b.object,g.visible&&g.castShadow&&(g.matrixAutoUpdate&&g.matrixWorld.flattenToArray(g._objectMatrixArray),g._modelViewMatrix.multiplyToArray(m.matrixWorldInverse,g.matrixWorld,g._modelViewMatrixArray),r.renderImmediateObject(m,c.__lights,null,i,g))}p=r.getClearColor(),d=r.getClearAlpha(),e.clearColor(p.r,p.g,p.b,d),e.enable(e.BLEND),r.shadowMapCullFrontFaces&&e.cullFace(e.BACK)}},t.ShadowMapPlugin.__projector=new t.Projector,t.SpritePlugin=function(){function e(e,t){return t.z-e.z}var r,i,n,o,a,s,l,c,h,p;this.init=function(e){r=e.context,i=e,n=new Float32Array(16),o=new Uint16Array(6),e=0,n[e++]=-1,n[e++]=-1,n[e++]=0,n[e++]=1,n[e++]=1,n[e++]=-1,n[e++]=1,n[e++]=1,n[e++]=1,n[e++]=1,n[e++]=1,n[e++]=0,n[e++]=-1,n[e++]=1,n[e++]=0,e=n[e++]=0,o[e++]=0,o[e++]=1,o[e++]=2,o[e++]=0,o[e++]=2,o[e++]=3,a=r.createBuffer(),s=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,a),r.bufferData(r.ARRAY_BUFFER,n,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,s),r.bufferData(r.ELEMENT_ARRAY_BUFFER,o,r.STATIC_DRAW);var e=t.ShaderSprite.sprite,d=r.createProgram(),u=r.createShader(r.FRAGMENT_SHADER),f=r.createShader(r.VERTEX_SHADER);r.shaderSource(u,e.fragmentShader),r.shaderSource(f,e.vertexShader),r.compileShader(u),r.compileShader(f),r.attachShader(d,u),r.attachShader(d,f),r.linkProgram(d),l=d,c={},h={},c.position=r.getAttribLocation(l,"position"),c.uv=r.getAttribLocation(l,"uv"),h.uvOffset=r.getUniformLocation(l,"uvOffset"),h.uvScale=r.getUniformLocation(l,"uvScale"),h.rotation=r.getUniformLocation(l,"rotation"),h.scale=r.getUniformLocation(l,"scale"),h.alignment=r.getUniformLocation(l,"alignment"),h.color=r.getUniformLocation(l,"color"),h.map=r.getUniformLocation(l,"map"),h.opacity=r.getUniformLocation(l,"opacity"),h.useScreenCoordinates=r.getUniformLocation(l,"useScreenCoordinates"),h.affectedByDistance=r.getUniformLocation(l,"affectedByDistance"),h.screenPosition=r.getUniformLocation(l,"screenPosition"),h.modelViewMatrix=r.getUniformLocation(l,"modelViewMatrix"),h.projectionMatrix=r.getUniformLocation(l,"projectionMatrix"),p=!1},this.render=function(t,n,o,d){var t=t.__webglSprites,u=t.length;if(u){var f=c,m=h,g=d/o,o=.5*o,b=.5*d,v=!0;r.useProgram(l),p||(r.enableVertexAttribArray(f.position),r.enableVertexAttribArray(f.uv),p=!0),r.disable(r.CULL_FACE),r.enable(r.BLEND),r.depthMask(!0),r.bindBuffer(r.ARRAY_BUFFER,a),r.vertexAttribPointer(f.position,2,r.FLOAT,!1,16,0),r.vertexAttribPointer(f.uv,2,r.FLOAT,!1,16,8),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,s),r.uniformMatrix4fv(m.projectionMatrix,!1,n._projectionMatrixArray),r.activeTexture(r.TEXTURE0),r.uniform1i(m.map,0);for(var x,y=[],f=0;u>f;f++)x=t[f],x.visible&&0!==x.opacity&&(x.useScreenCoordinates?x.z=-x.position.z:(x._modelViewMatrix.multiplyToArray(n.matrixWorldInverse,x.matrixWorld,x._modelViewMatrixArray),x.z=-x._modelViewMatrix.n34));for(t.sort(e),f=0;u>f;f++)x=t[f],x.visible&&0!==x.opacity&&x.map&&x.map.image&&x.map.image.width&&(x.useScreenCoordinates?(r.uniform1i(m.useScreenCoordinates,1),r.uniform3f(m.screenPosition,(x.position.x-o)/o,(b-x.position.y)/b,Math.max(0,Math.min(1,x.position.z)))):(r.uniform1i(m.useScreenCoordinates,0),r.uniform1i(m.affectedByDistance,x.affectedByDistance?1:0),r.uniformMatrix4fv(m.modelViewMatrix,!1,x._modelViewMatrixArray)),n=x.map.image.width/(x.scaleByViewport?d:1),y[0]=n*g*x.scale.x,y[1]=n*x.scale.y,r.uniform2f(m.uvScale,x.uvScale.x,x.uvScale.y),r.uniform2f(m.uvOffset,x.uvOffset.x,x.uvOffset.y),r.uniform2f(m.alignment,x.alignment.x,x.alignment.y),r.uniform1f(m.opacity,x.opacity),r.uniform3f(m.color,x.color.r,x.color.g,x.color.b),r.uniform1f(m.rotation,x.rotation),r.uniform2fv(m.scale,y),x.mergeWith3D&&!v?(r.enable(r.DEPTH_TEST),v=!0):!x.mergeWith3D&&v&&(r.disable(r.DEPTH_TEST),v=!1),i.setBlending(x.blending),i.setTexture(x.map,0),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0));r.enable(r.CULL_FACE),r.enable(r.DEPTH_TEST),r.depthMask(!0)}}},t.WebGLRenderer&&(t.AnaglyphWebGLRenderer=function(e){t.WebGLRenderer.call(this,e),this.autoUpdateScene=!1;var r,i,n,o,a=this,s=this.setSize,l=this.render,c=new t.PerspectiveCamera,h=new t.PerspectiveCamera,p=new t.Matrix4,d=new t.Matrix4;c.matrixAutoUpdate=h.matrixAutoUpdate=!1;var e={minFilter:t.LinearFilter,magFilter:t.NearestFilter,format:t.RGBAFormat},u=new t.WebGLRenderTarget(512,512,e),f=new t.WebGLRenderTarget(512,512,e),m=new t.PerspectiveCamera(53,1,1,1e4);m.position.z=2;var e=new t.ShaderMaterial({uniforms:{mapLeft:{type:"t",value:0,texture:u},mapRight:{type:"t",value:1,texture:f}},vertexShader:"varying vec2 vUv;\nvoid main() {\nvUv = vec2( uv.x, 1.0 - uv.y );\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D mapLeft;\nuniform sampler2D mapRight;\nvarying vec2 vUv;\nvoid main() {\nvec4 colorL, colorR;\nvec2 uv = vUv;\ncolorL = texture2D( mapLeft, uv );\ncolorR = texture2D( mapRight, uv );\ngl_FragColor = vec4( colorL.g * 0.7 + colorL.b * 0.3, colorR.g, colorR.b, colorL.a + colorR.a ) * 1.1;\n}"}),g=new t.Scene;g.add(new t.Mesh(new t.PlaneGeometry(2,2),e)),g.add(m),this.setSize=function(e,t){s.call(a,e,t),u.width=e,u.height=t,f.width=e,f.height=t},this.render=function(e,t){if(e.updateMatrixWorld(),r!==t.aspect||i!==t.near||n!==t.far||o!==t.fov){r=t.aspect,i=t.near,n=t.far,o=t.fov;var s,b=t.projectionMatrix.clone(),v=.5*(125/30),x=v*i/125,y=i*Math.tan(o*Math.PI/360);p.n14=v,d.n14=-v,v=-y*r+x,s=y*r+x,b.n11=2*i/(s-v),b.n13=(s+v)/(s-v),c.projectionMatrix.copy(b),v=-y*r-x,s=y*r-x,b.n11=2*i/(s-v),b.n13=(s+v)/(s-v),h.projectionMatrix.copy(b)}c.matrixWorld.copy(t.matrixWorld).multiplySelf(d),c.position.copy(t.position),c.near=t.near,c.far=t.far,l.call(a,e,c,u,!0),h.matrixWorld.copy(t.matrixWorld).multiplySelf(p),h.position.copy(t.position),h.near=t.near,h.far=t.far,l.call(a,e,h,f,!0),g.updateMatrixWorld(),l.call(a,g,m)}}),t.WebGLRenderer&&(t.CrosseyedWebGLRenderer=function(e){t.WebGLRenderer.call(this,e),this.autoClear=!1;var r,i,n=this,o=this.setSize,a=this.render,s=new t.PerspectiveCamera;s.target=new t.Vector3(0,0,0);var l=new t.PerspectiveCamera;l.target=new t.Vector3(0,0,0),n.separation=10,e&&void 0!==e.separation&&(n.separation=e.separation),this.setSize=function(e,t){o.call(n,e,t),r=e/2,i=t},this.render=function(e,t){this.clear(),s.fov=t.fov,s.aspect=.5*t.aspect,s.near=t.near,s.far=t.far,s.updateProjectionMatrix(),s.position.copy(t.position),s.target.copy(t.target),s.translateX(n.separation),s.lookAt(s.target),l.projectionMatrix=s.projectionMatrix,l.position.copy(t.position),l.target.copy(t.target),l.translateX(-n.separation),l.lookAt(l.target),this.setViewport(0,0,r,i),a.call(n,e,s),this.setViewport(r,0,r,i),a.call(n,e,l,!1)}}),t.ShaderFlares={lensFlareVertexTexture:{vertexShader:"uniform vec3 screenPosition;\nuniform vec2 scale;\nuniform float rotation;\nuniform int renderType;\nuniform sampler2D occlusionMap;\nattribute vec2 position;\nattribute vec2 uv;\nvarying vec2 vUV;\nvarying float vVisibility;\nvoid main() {\nvUV = uv;\nvec2 pos = position;\nif( renderType == 2 ) {\nvec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) ) +\ntexture2D( occlusionMap, vec2( 0.5, 0.1 ) ) +\ntexture2D( occlusionMap, vec2( 0.9, 0.1 ) ) +\ntexture2D( occlusionMap, vec2( 0.9, 0.5 ) ) +\ntexture2D( occlusionMap, vec2( 0.9, 0.9 ) ) +\ntexture2D( occlusionMap, vec2( 0.5, 0.9 ) ) +\ntexture2D( occlusionMap, vec2( 0.1, 0.9 ) ) +\ntexture2D( occlusionMap, vec2( 0.1, 0.5 ) ) +\ntexture2D( occlusionMap, vec2( 0.5, 0.5 ) );\nvVisibility = (       visibility.r / 9.0 ) *\n( 1.0 - visibility.g / 9.0 ) *\n(       visibility.b / 9.0 ) *\n( 1.0 - visibility.a / 9.0 );\npos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;\npos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;\n}\ngl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );\n}",fragmentShader:"precision mediump float;\nuniform sampler2D map;\nuniform float opacity;\nuniform int renderType;\nuniform vec3 color;\nvarying vec2 vUV;\nvarying float vVisibility;\nvoid main() {\nif( renderType == 0 ) {\ngl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );\n} else if( renderType == 1 ) {\ngl_FragColor = texture2D( map, vUV );\n} else {\nvec4 texture = texture2D( map, vUV );\ntexture.a *= opacity * vVisibility;\ngl_FragColor = texture;\ngl_FragColor.rgb *= color;\n}\n}"},lensFlare:{vertexShader:"uniform vec3 screenPosition;\nuniform vec2 scale;\nuniform float rotation;\nuniform int renderType;\nattribute vec2 position;\nattribute vec2 uv;\nvarying vec2 vUV;\nvoid main() {\nvUV = uv;\nvec2 pos = position;\nif( renderType == 2 ) {\npos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;\npos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;\n}\ngl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );\n}",fragmentShader:"precision mediump float;\nuniform sampler2D map;\nuniform sampler2D occlusionMap;\nuniform float opacity;\nuniform int renderType;\nuniform vec3 color;\nvarying vec2 vUV;\nvoid main() {\nif( renderType == 0 ) {\ngl_FragColor = vec4( texture2D( map, vUV ).rgb, 0.0 );\n} else if( renderType == 1 ) {\ngl_FragColor = texture2D( map, vUV );\n} else {\nfloat visibility = texture2D( occlusionMap, vec2( 0.5, 0.1 ) ).a +\ntexture2D( occlusionMap, vec2( 0.9, 0.5 ) ).a +\ntexture2D( occlusionMap, vec2( 0.5, 0.9 ) ).a +\ntexture2D( occlusionMap, vec2( 0.1, 0.5 ) ).a;\nvisibility = ( 1.0 - visibility / 4.0 );\nvec4 texture = texture2D( map, vUV );\ntexture.a *= opacity * visibility;\ngl_FragColor = texture;\ngl_FragColor.rgb *= color;\n}\n}"}},t.ShaderSprite={sprite:{vertexShader:"uniform int useScreenCoordinates;\nuniform int affectedByDistance;\nuniform vec3 screenPosition;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform float rotation;\nuniform vec2 scale;\nuniform vec2 alignment;\nuniform vec2 uvOffset;\nuniform vec2 uvScale;\nattribute vec2 position;\nattribute vec2 uv;\nvarying vec2 vUV;\nvoid main() {\nvUV = uvOffset + uv * uvScale;\nvec2 alignedPosition = position + alignment;\nvec2 rotatedPosition;\nrotatedPosition.x = ( cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y ) * scale.x;\nrotatedPosition.y = ( sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y ) * scale.y;\nvec4 finalPosition;\nif( useScreenCoordinates != 0 ) {\nfinalPosition = vec4( screenPosition.xy + rotatedPosition, screenPosition.z, 1.0 );\n} else {\nfinalPosition = projectionMatrix * modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\nfinalPosition.xy += rotatedPosition * ( affectedByDistance == 1 ? 1.0 : finalPosition.z );\n}\ngl_Position = finalPosition;\n}",fragmentShader:"precision mediump float;\nuniform vec3 color;\nuniform sampler2D map;\nuniform float opacity;\nvarying vec2 vUV;\nvoid main() {\nvec4 texture = texture2D( map, vUV );\ngl_FragColor = vec4( color * texture.xyz, texture.a * opacity );\n}"}},e.exports=t},27:function(e,t,r){var i=r(1);e.exports=function(e,t,n,o,a){t=t||i.attrs,n=n||i.escape,o=o||i.rethrow,a=a||i.merge;var s=[];s.push('<h1>three.js canvas - camera - orthographic example</h1><div class="three-container"></div><h2>test1/index.js</h2><pre class="pre-scrollable"><code>');var l=r(34);s.push(n(null==l?"":l)),s.push("</code></pre><h2>test1/content.jade</h2><pre><code>");var l=r(31);return s.push(n(null==l?"":l)),s.push("</code></pre>"),s.join("")}},31:function(e){e.exports='h1 three.js canvas - camera - orthographic example\r\n.three-container\r\nh2 test1/index.js\r\npre.pre-scrollable: code= require("!raw!./index.js")\r\nh2 test1/content.jade\r\npre: code= require("!raw!./content.jade")'},34:function(e){e.exports='exports.render = function() {\r\n	return require("./content.jade")();\r\n};\r\n\r\nexports.start = function() {\r\n	var THREE = require("three");\r\n	require("jquery");\r\n\r\n	// three.js canvas - camera - orthographic example\r\n\r\n	var container, stats;\r\n	var camera, scene, renderer;\r\n\r\n	init();\r\n	animate();\r\n\r\n	function init() {\r\n\r\n		camera = new THREE.OrthographicCamera( -400, 400, 400, -400, - 2000, 1000 );\r\n		camera.position.x = 200;\r\n		camera.position.y = 100;\r\n		camera.position.z = 200;\r\n\r\n		scene = new THREE.Scene();\r\n\r\n		scene.add( camera );\r\n\r\n		// Grid\r\n\r\n		var geometry = new THREE.Geometry();\r\n		geometry.vertices.push( new THREE.Vertex( new THREE.Vector3( - 500, 0, 0 ) ) );\r\n		geometry.vertices.push( new THREE.Vertex( new THREE.Vector3( 500, 0, 0 ) ) );\r\n\r\n		for ( var i = 0; i <= 20; i ++ ) {\r\n\r\n			var line = new THREE.Line( geometry, new THREE.LineBasicMaterial( { color: 0x000000, opacity: 0.2 } ) );\r\n			line.position.z = ( i * 50 ) - 500;\r\n			scene.add( line );\r\n\r\n			line = new THREE.Line( geometry, new THREE.LineBasicMaterial( { color: 0x000000, opacity: 0.2 } ) );\r\n			line.position.x = ( i * 50 ) - 500;\r\n			line.rotation.y = 90 * Math.PI / 180;\r\n			scene.add( line );\r\n\r\n		}\r\n\r\n		// Cubes\r\n\r\n		geometry = new THREE.CubeGeometry( 50, 50, 50 );\r\n		var material = new THREE.MeshLambertMaterial( { color: 0xffffff, shading: THREE.FlatShading, overdraw: true } );\r\n\r\n		for ( i = 0; i < 100; i ++ ) {\r\n\r\n			var cube = new THREE.Mesh( geometry, material );\r\n\r\n			cube.scale.y = Math.floor( Math.random() * 2 + 1 );\r\n\r\n			cube.position.x = Math.floor( ( Math.random() * 1000 - 500 ) / 50 ) * 50 + 25;\r\n			cube.position.y = ( cube.scale.y * 50 ) / 2;\r\n			cube.position.z = Math.floor( ( Math.random() * 1000 - 500 ) / 50 ) * 50 + 25;\r\n\r\n			scene.add(cube);\r\n\r\n		}\r\n\r\n		// Lights\r\n\r\n		var ambientLight = new THREE.AmbientLight( Math.random() * 0x10 );\r\n		scene.add( ambientLight );\r\n\r\n		var directionalLight = new THREE.DirectionalLight( Math.random() * 0xffffff );\r\n		directionalLight.position.x = Math.random() - 0.5;\r\n		directionalLight.position.y = Math.random() - 0.5;\r\n		directionalLight.position.z = Math.random() - 0.5;\r\n		directionalLight.position.normalize();\r\n		scene.add( directionalLight );\r\n\r\n		directionalLight = new THREE.DirectionalLight( Math.random() * 0xffffff );\r\n		directionalLight.position.x = Math.random() - 0.5;\r\n		directionalLight.position.y = Math.random() - 0.5;\r\n		directionalLight.position.z = Math.random() - 0.5;\r\n		directionalLight.position.normalize();\r\n		scene.add( directionalLight );\r\n\r\n		renderer = new THREE.CanvasRenderer();\r\n		renderer.setSize( 400, 400 );\r\n\r\n		$(".three-container").append(renderer.domElement);\r\n	}\r\n\r\n	function animate() {\r\n		if($(".three-container").length > 0) {\r\n			requestAnimationFrame( animate );\r\n			render();\r\n		}\r\n	}\r\n	function render() {\r\n		var timer = new Date().getTime() * 0.0001;\r\n\r\n		camera.position.x = Math.cos( timer ) * 200;\r\n		camera.position.z = Math.sin( timer ) * 200;\r\n		camera.lookAt( scene.position );\r\n\r\n		renderer.render( scene, camera );\r\n	}\r\n};'},35:function(e,t,r){e.exports=r(26)}});
/*
//@ sourceMappingURL=5703ab8723fa6840204f/js/2.js.map
*/